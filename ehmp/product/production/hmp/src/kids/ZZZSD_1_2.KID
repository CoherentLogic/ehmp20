KIDS Distribution saved on Mar 13, 2015@16:32:50
ROUTINE FIXES FOR SCHEDULING PACKAGE ERRORS
**KIDS**:ZZZSD*1.0*2^

**INSTALL NAME**
ZZZSD*1.0*2
"BLD",8785,0)
ZZZSD*1.0*2^^0^3150313^n
"BLD",8785,1,0)
^^41^41^3150313^
"BLD",8785,1,1,0)
 
"BLD",8785,1,2,0)
restore all these routines due to the unreleased patch 260003 from WV
"BLD",8785,1,3,0)
 
"BLD",8785,1,4,0)
SCMCQK
"BLD",8785,1,5,0)
SCMCQK1
"BLD",8785,1,6,0)
SCMCQK2
"BLD",8785,1,7,0)
SCMCU1
"BLD",8785,1,8,0)
SDAM10
"BLD",8785,1,9,0)
SDAM2
"BLD",8785,1,10,0)
SDAM3
"BLD",8785,1,11,0)
SDAMEP1
"BLD",8785,1,12,0)
SDAMEP2
"BLD",8785,1,13,0)
SDAMEP3
"BLD",8785,1,14,0)
SDAMEVT
"BLD",8785,1,15,0)
SDAMN
"BLD",8785,1,16,0)
SDAMWI
"BLD",8785,1,17,0)
SDAMWI1
"BLD",8785,1,18,0)
SDCD
"BLD",8785,1,19,0)
SDCI
"BLD",8785,1,20,0)
SDCNP
"BLD",8785,1,21,0)
SDCNP1A
"BLD",8785,1,22,0)
SDCNSLT
"BLD",8785,1,23,0)
SDCO1
"BLD",8785,1,24,0)
SDCO3
"BLD",8785,1,25,0)
SDCOAM
"BLD",8785,1,26,0)
SDCODEL
"BLD",8785,1,27,0)
SDDSO
"BLD",8785,1,28,0)
SDM
"BLD",8785,1,29,0)
SDM0
"BLD",8785,1,30,0)
SDM1
"BLD",8785,1,31,0)
SDM1A
"BLD",8785,1,32,0)
SDM2
"BLD",8785,1,33,0)
SDM3
"BLD",8785,1,34,0)
SDMM
"BLD",8785,1,35,0)
SDMM1
"BLD",8785,1,36,0)
SDMULT1
"BLD",8785,1,37,0)
SDPPTEM
"BLD",8785,1,38,0)
SDWLD
"BLD",8785,1,39,0)
SDWLDISP
"BLD",8785,1,40,0)
SDWLI
"BLD",8785,1,41,0)
SDASO
"BLD",8785,4,0)
^9.64PA^^
"BLD",8785,6.3)
3
"BLD",8785,"INID")
^^
"BLD",8785,"KRN",0)
^9.67PA^779.2^20
"BLD",8785,"KRN",.4,0)
.4
"BLD",8785,"KRN",.4,"NM",0)
^9.68A^^
"BLD",8785,"KRN",.401,0)
.401
"BLD",8785,"KRN",.402,0)
.402
"BLD",8785,"KRN",.403,0)
.403
"BLD",8785,"KRN",.5,0)
.5
"BLD",8785,"KRN",.84,0)
.84
"BLD",8785,"KRN",3.6,0)
3.6
"BLD",8785,"KRN",3.8,0)
3.8
"BLD",8785,"KRN",9.2,0)
9.2
"BLD",8785,"KRN",9.8,0)
9.8
"BLD",8785,"KRN",9.8,"NM",0)
^9.68A^39^38
"BLD",8785,"KRN",9.8,"NM",1,0)
SCMCQK^^0^B23522932
"BLD",8785,"KRN",9.8,"NM",2,0)
SCMCQK1^^0^B106090791
"BLD",8785,"KRN",9.8,"NM",3,0)
SCMCQK2^^0^B59731461
"BLD",8785,"KRN",9.8,"NM",4,0)
SCMCU1^^0^B1877247
"BLD",8785,"KRN",9.8,"NM",5,0)
SDAM10^^0^B8926237
"BLD",8785,"KRN",9.8,"NM",6,0)
SDAM2^^0^B28969353
"BLD",8785,"KRN",9.8,"NM",7,0)
SDAM3^^0^B10895275
"BLD",8785,"KRN",9.8,"NM",8,0)
SDAMEP1^^0^B26683496
"BLD",8785,"KRN",9.8,"NM",9,0)
SDAMEP2^^0^B30443820
"BLD",8785,"KRN",9.8,"NM",10,0)
SDAMEP3^^0^B19773146
"BLD",8785,"KRN",9.8,"NM",11,0)
SDAMEVT^^0^B27512966
"BLD",8785,"KRN",9.8,"NM",12,0)
SDAMN^^0^B7272637
"BLD",8785,"KRN",9.8,"NM",14,0)
SDCD^^0^B9650048
"BLD",8785,"KRN",9.8,"NM",15,0)
SDCNP^^0^B16969835
"BLD",8785,"KRN",9.8,"NM",16,0)
SDCI^^0^B2053343
"BLD",8785,"KRN",9.8,"NM",17,0)
SDCNP1A^^0^B29978567
"BLD",8785,"KRN",9.8,"NM",18,0)
SDCNSLT^^0^B40644653
"BLD",8785,"KRN",9.8,"NM",19,0)
SDCO1^^0^B29919726
"BLD",8785,"KRN",9.8,"NM",20,0)
SDCO3^^0^B3913935
"BLD",8785,"KRN",9.8,"NM",21,0)
SDCOAM^^0^B20810656
"BLD",8785,"KRN",9.8,"NM",22,0)
SDCODEL^^0^B9522371
"BLD",8785,"KRN",9.8,"NM",23,0)
SDDSO^^0^B9613097
"BLD",8785,"KRN",9.8,"NM",24,0)
SDM^^0^B33704414
"BLD",8785,"KRN",9.8,"NM",25,0)
SDM0^^0^B88208979
"BLD",8785,"KRN",9.8,"NM",26,0)
SDM1^^0^B53130837
"BLD",8785,"KRN",9.8,"NM",27,0)
SDM1A^^0^B59959589
"BLD",8785,"KRN",9.8,"NM",28,0)
SDM2^^0^B24545266
"BLD",8785,"KRN",9.8,"NM",29,0)
SDM3^^0^B13081176
"BLD",8785,"KRN",9.8,"NM",30,0)
SDMM^^0^B45359086
"BLD",8785,"KRN",9.8,"NM",31,0)
SDMM1^^0^B15400257
"BLD",8785,"KRN",9.8,"NM",32,0)
SDMULT1^^0^B14570449
"BLD",8785,"KRN",9.8,"NM",33,0)
SDPPTEM^^0^B45405058
"BLD",8785,"KRN",9.8,"NM",34,0)
SDWLD^^0^B24813208
"BLD",8785,"KRN",9.8,"NM",35,0)
SDWLDISP^^0^B62805335
"BLD",8785,"KRN",9.8,"NM",36,0)
SDWLI^^0^B73452514
"BLD",8785,"KRN",9.8,"NM",37,0)
SDAMWI^^0^B13138913
"BLD",8785,"KRN",9.8,"NM",38,0)
SDAMWI1^^0^B10737470
"BLD",8785,"KRN",9.8,"NM",39,0)
SDASO^^0^B9030001
"BLD",8785,"KRN",9.8,"NM","B","SCMCQK",1)

"BLD",8785,"KRN",9.8,"NM","B","SCMCQK1",2)

"BLD",8785,"KRN",9.8,"NM","B","SCMCQK2",3)

"BLD",8785,"KRN",9.8,"NM","B","SCMCU1",4)

"BLD",8785,"KRN",9.8,"NM","B","SDAM10",5)

"BLD",8785,"KRN",9.8,"NM","B","SDAM2",6)

"BLD",8785,"KRN",9.8,"NM","B","SDAM3",7)

"BLD",8785,"KRN",9.8,"NM","B","SDAMEP1",8)

"BLD",8785,"KRN",9.8,"NM","B","SDAMEP2",9)

"BLD",8785,"KRN",9.8,"NM","B","SDAMEP3",10)

"BLD",8785,"KRN",9.8,"NM","B","SDAMEVT",11)

"BLD",8785,"KRN",9.8,"NM","B","SDAMN",12)

"BLD",8785,"KRN",9.8,"NM","B","SDAMWI",37)

"BLD",8785,"KRN",9.8,"NM","B","SDAMWI1",38)

"BLD",8785,"KRN",9.8,"NM","B","SDASO",39)

"BLD",8785,"KRN",9.8,"NM","B","SDCD",14)

"BLD",8785,"KRN",9.8,"NM","B","SDCI",16)

"BLD",8785,"KRN",9.8,"NM","B","SDCNP",15)

"BLD",8785,"KRN",9.8,"NM","B","SDCNP1A",17)

"BLD",8785,"KRN",9.8,"NM","B","SDCNSLT",18)

"BLD",8785,"KRN",9.8,"NM","B","SDCO1",19)

"BLD",8785,"KRN",9.8,"NM","B","SDCO3",20)

"BLD",8785,"KRN",9.8,"NM","B","SDCOAM",21)

"BLD",8785,"KRN",9.8,"NM","B","SDCODEL",22)

"BLD",8785,"KRN",9.8,"NM","B","SDDSO",23)

"BLD",8785,"KRN",9.8,"NM","B","SDM",24)

"BLD",8785,"KRN",9.8,"NM","B","SDM0",25)

"BLD",8785,"KRN",9.8,"NM","B","SDM1",26)

"BLD",8785,"KRN",9.8,"NM","B","SDM1A",27)

"BLD",8785,"KRN",9.8,"NM","B","SDM2",28)

"BLD",8785,"KRN",9.8,"NM","B","SDM3",29)

"BLD",8785,"KRN",9.8,"NM","B","SDMM",30)

"BLD",8785,"KRN",9.8,"NM","B","SDMM1",31)

"BLD",8785,"KRN",9.8,"NM","B","SDMULT1",32)

"BLD",8785,"KRN",9.8,"NM","B","SDPPTEM",33)

"BLD",8785,"KRN",9.8,"NM","B","SDWLD",34)

"BLD",8785,"KRN",9.8,"NM","B","SDWLDISP",35)

"BLD",8785,"KRN",9.8,"NM","B","SDWLI",36)

"BLD",8785,"KRN",19,0)
19
"BLD",8785,"KRN",19,"NM",0)
^9.68A^^
"BLD",8785,"KRN",19.1,0)
19.1
"BLD",8785,"KRN",19.1,"NM",0)
^9.68A^^
"BLD",8785,"KRN",101,0)
101
"BLD",8785,"KRN",409.61,0)
409.61
"BLD",8785,"KRN",771,0)
771
"BLD",8785,"KRN",779.2,0)
779.2
"BLD",8785,"KRN",870,0)
870
"BLD",8785,"KRN",8989.51,0)
8989.51
"BLD",8785,"KRN",8989.52,0)
8989.52
"BLD",8785,"KRN",8994,0)
8994
"BLD",8785,"KRN","B",.4,.4)

"BLD",8785,"KRN","B",.401,.401)

"BLD",8785,"KRN","B",.402,.402)

"BLD",8785,"KRN","B",.403,.403)

"BLD",8785,"KRN","B",.5,.5)

"BLD",8785,"KRN","B",.84,.84)

"BLD",8785,"KRN","B",3.6,3.6)

"BLD",8785,"KRN","B",3.8,3.8)

"BLD",8785,"KRN","B",9.2,9.2)

"BLD",8785,"KRN","B",9.8,9.8)

"BLD",8785,"KRN","B",19,19)

"BLD",8785,"KRN","B",19.1,19.1)

"BLD",8785,"KRN","B",101,101)

"BLD",8785,"KRN","B",409.61,409.61)

"BLD",8785,"KRN","B",771,771)

"BLD",8785,"KRN","B",779.2,779.2)

"BLD",8785,"KRN","B",870,870)

"BLD",8785,"KRN","B",8989.51,8989.51)

"BLD",8785,"KRN","B",8989.52,8989.52)

"BLD",8785,"KRN","B",8994,8994)

"BLD",8785,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",8785,"QUES",0)
^9.62^^
"BLD",8785,"REQB",0)
^9.611^^
"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
38
"RTN","SCMCQK")
0^1^B23522932
"RTN","SCMCQK",1,0)
SCMCQK ;ALB/REW - Single Pt Tm/Pt Tm Pos Assign and Discharge ; 5/17/12 1:39pm
"RTN","SCMCQK",2,0)
 ;;5.3;Scheduling;**148,177,297,563,598**;AUG 13, 1993;Build 3
"RTN","SCMCQK",3,0)
 ;
"RTN","SCMCQK",4,0)
 ;
"RTN","SCMCQK",5,0)
 ; Reference/ICR
"RTN","SCMCQK",6,0)
 ; ^DPT(DFN,.35)/10035
"RTN","SCMCQK",7,0)
 ;
"RTN","SCMCQK",8,0)
 ;
"RTN","SCMCQK",9,0)
EN ; - main call
"RTN","SCMCQK",10,0)
 W !,"Primary Care Team/PC Assignment/Unassignment",!
"RTN","SCMCQK",11,0)
 W !,?6,"Prior to using this option, PCMM's Graphical User Interface (GUI)"
"RTN","SCMCQK",12,0)
 W !,?6,"must be used to:"
"RTN","SCMCQK",13,0)
 W !,?10,"1) Setup active primary care and non-primary care team(s)"
"RTN","SCMCQK",14,0)
 W !,?10,"2) Setup active PC and non-primary care Practitioner position(s)"
"RTN","SCMCQK",15,0)
 W !,?10,"3) Setup any necessary preceptor/preceptee relationships"
"RTN","SCMCQK",16,0)
 W !,?10,"4) Assign practitioner to position(s)"
"RTN","SCMCQK",17,0)
 W !!?6,"A patient can only have one PC team and one"
"RTN","SCMCQK",18,0)
 W !?6,"PC Position assignment on a given day.  The patient must be"
"RTN","SCMCQK",19,0)
 W !?6,"assigned to a position's team to be assigned to the position."
"RTN","SCMCQK",20,0)
 W !!?6,"Note: You must use the PCMM GUI if the patient was:"
"RTN","SCMCQK",21,0)
 W !?10,"o unassigned from PC assignment today or in the future"
"RTN","SCMCQK",22,0)
 W !?10,"o assigned to a future PC assignment."
"RTN","SCMCQK",23,0)
 N DFN
"RTN","SCMCQK",24,0)
 F  S DFN=$$PATIENT() Q:DFN<0  D PAT
"RTN","SCMCQK",25,0)
 Q
"RTN","SCMCQK",26,0)
 ;
"RTN","SCMCQK",27,0)
PAT ;process patient
"RTN","SCMCQK",28,0)
 Q:'$G(DFN)
"RTN","SCMCQK",29,0)
 N SCTPSTAT,SCTMSTAT,SCSTAT,SCTM,SCTP,SDDOD,SDDODRES,SDUSRANS
"RTN","SCMCQK",30,0)
 ;If patient is deceased prompt user to continue SD*5.3*563
"RTN","SCMCQK",31,0)
 I $P($G(^DPT(DFN,.35)),U)'="" D  I SDUSRANS'="Y" Q
"RTN","SCMCQK",32,0)
 .S SDDOD=$P(^DPT(DFN,.35),U)
"RTN","SCMCQK",33,0)
 .S SDDODRES=$$FMTE^XLFDT(SDDOD)
"RTN","SCMCQK",34,0)
 .W !!,"This Patient is deceased as of "_SDDODRES_". Would you like to continue?"
"RTN","SCMCQK",35,0)
 .S DIR(0)="SA^Y:YES;N:NO"
"RTN","SCMCQK",36,0)
 .S DIR("B")="NO"
"RTN","SCMCQK",37,0)
 .S DIR("?")="[Y]ES=continue with current patient, [N]o=select a new patient or quit"
"RTN","SCMCQK",38,0)
 .W ! D ^DIR K DIR S SDUSRANS=Y
"RTN","SCMCQK",39,0)
 .I $D(DIRUT) K DIRUT,DUOUT,DTOUT,X,Y Q
"RTN","SCMCQK",40,0)
 ;End SD*5.3*563
"RTN","SCMCQK",41,0)
 W !,"Checking PC Team and Position Status...",!
"RTN","SCMCQK",42,0)
 ;display PC info, check if patient has a current PC team
"RTN","SCMCQK",43,0)
 D PCMM^SCRPU4(DFN,DT)
"RTN","SCMCQK",44,0)
 D DSPL^SCMCQK2
"RTN","SCMCQK",45,0)
 N DATA
"RTN","SCMCQK",46,0)
 S DATA=$$IU^SCMCTSK1(DFN)
"RTN","SCMCQK",47,0)
 I $E(DATA)=1 I $D(^XUSEC("SC PCMM SETUP",+$G(DUZ))) D
"RTN","SCMCQK",48,0)
 .;If patient is deceased do not allow reactivation SD*5.3*598
"RTN","SCMCQK",49,0)
 .I $P($G(^DPT(DFN,.35)),U)'="" Q
"RTN","SCMCQK",50,0)
 .;If the team or position are not currently active do not allow reactivation SD*5.3*598
"RTN","SCMCQK",51,0)
 .I '$$ACTHISTB^SCAPMCU2(404.58,$P(DATA,"~",3))!('$$ACTHISTB^SCAPMCU2(404.59,$P(DATA,"~",5))) Q
"RTN","SCMCQK",52,0)
 .W !,"This patient was inactivated from "_$P(DATA,"~",2)_" TEAM"
"RTN","SCMCQK",53,0)
 .W !,$P(DATA,"~",4)_" Position"
"RTN","SCMCQK",54,0)
 .W !,"Do you wish to reactivate" S %=2 D YN^DICN
"RTN","SCMCQK",55,0)
 .I %=1 D FILEIN^SCMCTSK3(.DATA,+$P(DATA,"~",6))
"RTN","SCMCQK",56,0)
 W !,"Do you want to make a primary care assignment/unassignment" S %=1 D YN^DICN Q:%<0
"RTN","SCMCQK",57,0)
 I %=2 G NPC^SCMCQK2
"RTN","SCMCQK",58,0)
 ;below functions return status^message^pointer
"RTN","SCMCQK",59,0)
 S SCTMSTAT=$$YSPTTMPC^SCMCTMU2(DFN,DT)  ;ok to assign new PC team?
"RTN","SCMCQK",60,0)
 S SCTPSTAT=$$YSPTTPPC^SCMCTPU2(DFN,DT,1)  ;ok to assign new PC prac?
"RTN","SCMCQK",61,0)
 ;what is current/future PC assignment status?
"RTN","SCMCQK",62,0)
 S SCSTAT=$S((SCTMSTAT&SCTPSTAT):"NONE",('SCTMSTAT&SCTPSTAT):"TEAM",('SCTMSTAT&'SCTPSTAT):"BOTH",1:"ERROR")  ;error if PC pract w/o PC team assignment
"RTN","SCMCQK",63,0)
 W:SCSTAT="NONE" !,"No current PC Team/PC Practitioner Assignments"
"RTN","SCMCQK",64,0)
 IF $S(SCTMSTAT:0,(SCTMSTAT["future"):1,1:0) W !,$P(SCTMSTAT,U,2) S SCSTAT="FUTURE"
"RTN","SCMCQK",65,0)
 IF $S(SCTPSTAT:0,(SCTPSTAT["future"):1,1:0) W !,$P(SCTPSTAT,U,2) S SCSTAT="FUTURE"
"RTN","SCMCQK",66,0)
 S SCTM=$P(SCTMSTAT,U,3)
"RTN","SCMCQK",67,0)
 S SCTP=$P(SCTPSTAT,U,3)
"RTN","SCMCQK",68,0)
 D @SCSTAT
"RTN","SCMCQK",69,0)
 D BREAK
"RTN","SCMCQK",70,0)
 Q
"RTN","SCMCQK",71,0)
 ;
"RTN","SCMCQK",72,0)
BREAK ;
"RTN","SCMCQK",73,0)
 N DIR,X,Y
"RTN","SCMCQK",74,0)
 S DIR(0)="EA",DIR("A",1)="",DIR("A")="Press enter to continue."
"RTN","SCMCQK",75,0)
 D ^DIR
"RTN","SCMCQK",76,0)
 Q
"RTN","SCMCQK",77,0)
 ;
"RTN","SCMCQK",78,0)
NONE ;
"RTN","SCMCQK",79,0)
 N SCASSDT
"RTN","SCMCQK",80,0)
 D ASTM^SCMCQK1
"RTN","SCMCQK",81,0)
 Q
"RTN","SCMCQK",82,0)
TEAM ;
"RTN","SCMCQK",83,0)
 N DIR,X,Y,SCDISCH,SCASSDT,SCSELECT
"RTN","SCMCQK",84,0)
 S DIR(0)="SO^1:POSITION ASSIGNMENT - BY PRACTITIONER NAME;2:POSITION ASSIGNMENT - BY POSITION NAME;3:TEAM UNASSIGNMENT"
"RTN","SCMCQK",85,0)
 D ^DIR
"RTN","SCMCQK",86,0)
 IF $P(Y,U,1)=1!($P(Y,U,1)=2) D
"RTN","SCMCQK",87,0)
 .S SCSELECT=$S($P(Y,U,1)=1:"PRACT",1:"POSIT")
"RTN","SCMCQK",88,0)
 .D ASTP^SCMCQK1
"RTN","SCMCQK",89,0)
 ELSE  D:$P(Y,U,1)=3 UNTM^SCMCQK1
"RTN","SCMCQK",90,0)
 Q
"RTN","SCMCQK",91,0)
 ;
"RTN","SCMCQK",92,0)
BOTH ;
"RTN","SCMCQK",93,0)
 N DIR,X,Y,SCDISCH
"RTN","SCMCQK",94,0)
 S DIR(0)="SO^1:PC ASSIGNMENT UNASSIGNMENT;2:TEAM UNASSIGNMENT"
"RTN","SCMCQK",95,0)
 D ^DIR
"RTN","SCMCQK",96,0)
 IF $P(Y,U,1)=1 D
"RTN","SCMCQK",97,0)
 .D UNTP^SCMCQK1
"RTN","SCMCQK",98,0)
 ELSE  D:$P(Y,U,1)=2 UNTM^SCMCQK1
"RTN","SCMCQK",99,0)
 Q
"RTN","SCMCQK",100,0)
 ;
"RTN","SCMCQK",101,0)
FUTURE ;
"RTN","SCMCQK",102,0)
 W !,"This patient has future assignments for Primary Care"
"RTN","SCMCQK",103,0)
 W !,"Team and/or Practitioner"
"RTN","SCMCQK",104,0)
 W !!!,"You must use PCMM's Graphical User Interface to change"
"RTN","SCMCQK",105,0)
 Q
"RTN","SCMCQK",106,0)
 ;
"RTN","SCMCQK",107,0)
ERROR ;
"RTN","SCMCQK",108,0)
 W !,"This patient has NO active Primary Care Team, but does have"
"RTN","SCMCQK",109,0)
 W !,"an active PC Position Assignment"
"RTN","SCMCQK",110,0)
 W !!!,"You must use PCMM's Graphical User Interface to correct"
"RTN","SCMCQK",111,0)
 Q
"RTN","SCMCQK",112,0)
 ;
"RTN","SCMCQK",113,0)
PATIENT() ;Return Patient DFN or -1
"RTN","SCMCQK",114,0)
 ;
"RTN","SCMCQK",115,0)
 N DIC,X,Y
"RTN","SCMCQK",116,0)
 W !!!
"RTN","SCMCQK",117,0)
 S DIC=2
"RTN","SCMCQK",118,0)
 S DIC(0)="AEMQZ"
"RTN","SCMCQK",119,0)
 D ^DIC
"RTN","SCMCQK",120,0)
 Q $S($D(DTOUT):-1,$D(DUOUT):-1,(Y<0):-1,1:+Y)
"RTN","SCMCQK1")
0^2^B106090791
"RTN","SCMCQK1",1,0)
SCMCQK1 ;ALBOI/REW - Single Pt Tm/Pt Tm Pos Assign and Discharge;11/07/02 ; 6/13/12 3:38pm
"RTN","SCMCQK1",2,0)
 ;;5.3;Scheduling;**148,177,231,264,436,297,446,524,535,563**;AUG 13, 1993;Build 3
"RTN","SCMCQK1",3,0)
 ;
"RTN","SCMCQK1",4,0)
 ;
"RTN","SCMCQK1",5,0)
 ; Reference/ICR
"RTN","SCMCQK1",6,0)
 ; ^DPT(DFN,.35)/10035
"RTN","SCMCQK1",7,0)
 ;
"RTN","SCMCQK1",8,0)
 ;
"RTN","SCMCQK1",9,0)
 ;04/25/2006 SD*5.3*446 INTER-FACILITY TRANSFER
"RTN","SCMCQK1",10,0)
UNTP ;unassign patient from pc prac position
"RTN","SCMCQK1",11,0)
 I '$G(SCTP) W !,"No position defined" Q
"RTN","SCMCQK1",12,0)
 N OK,SCER,SCCL,SCBEGIN,SCN,SCLIST,SCEND,SCINCL,SCLSEQ,SCDATES,SCDTS
"RTN","SCMCQK1",13,0)
 S OK=0
"RTN","SCMCQK1",14,0)
 W !,"About to Unassign "_$$NAME(DFN)_" from: ",!,?8,$$POSITION(SCTP)_" position   ["_$P($$GETPRTP^SCAPMCU2(SCTP,DT),U,2)_"]"
"RTN","SCMCQK1",15,0)
 S SCDISCH=$$DATE("D",DFN) ;SD*5.3*563 pass DFN
"RTN","SCMCQK1",16,0)
 G:SCDISCH<1 QTUNTP
"RTN","SCMCQK1",17,0)
 G:'$$CONFIRM() QTUNTP
"RTN","SCMCQK1",18,0)
 S OK=$$INPTSCTP^SCAPMC22(DFN,SCTP,SCDISCH,.SCER)  ; og/sd/524
"RTN","SCMCQK1",19,0)
 G:OK'>0 QTUNTP
"RTN","SCMCQK1",20,0)
 ;comment out following lines in SD*5.3*535 - clinic enrollment no longer used
"RTN","SCMCQK1",21,0)
 ;S SCCL=$P($G(^SCTM(404.57,+$G(SCTP),0)),U,9)
"RTN","SCMCQK1",22,0)
 ;I SCCL D DISCL
"RTN","SCMCQK1",23,0)
QTUNTP W !,"Position Unassignment "_$S(OK:"made.",1:"NOT made.")
"RTN","SCMCQK1",24,0)
 Q
"RTN","SCMCQK1",25,0)
ENRCL ; no longer used with SD*5.3*535
"RTN","SCMCQK1",26,0)
 Q
"RTN","SCMCQK1",27,0)
 N SCRESTA,SCREST,SCCLNM,SCTM
"RTN","SCMCQK1",28,0)
 N SCCL
"RTN","SCMCQK1",29,0)
 F SCCL=0:0 S SCCL=$O(^SCTM(404.57,+$G(SCTP),5,SCCL)) Q:'SCCL  D
"RTN","SCMCQK1",30,0)
 .Q:$$ACTCL(DFN,SCCL)
"RTN","SCMCQK1",31,0)
 .W !!!,"The "_$$POSITION(SCTP)_" is associated with the ",$$CLINIC(SCCL)_" clinic."
"RTN","SCMCQK1",32,0)
 .;SCRESTA = Array of pt's teams causing restricted consults
"RTN","SCMCQK1",33,0)
 .N SCRESTA
"RTN","SCMCQK1",34,0)
 .S SCREST=$$RESTPT^SCAPMCU4(DFN,DT,"SCRESTA")
"RTN","SCMCQK1",35,0)
 .I SCREST D
"RTN","SCMCQK1",36,0)
 ..N SCTM
"RTN","SCMCQK1",37,0)
 ..S SCCLNM=Y
"RTN","SCMCQK1",38,0)
 ..W !,?5,"Patient has restricted consults due to team assignment(s):"
"RTN","SCMCQK1",39,0)
 ..S SCTM=0
"RTN","SCMCQK1",40,0)
 ..F  S SCTM=$O(SCRESTA(SCTM)) Q:'SCTM  W !,?10,SCRESTA(SCTM)
"RTN","SCMCQK1",41,0)
 .I SCREST&'$G(SCOKCONS) D  G QTECL
"RTN","SCMCQK1",42,0)
 ..W !,?5,"This patient may only be enrolled in clinics via"
"RTN","SCMCQK1",43,0)
 ..W !,?15,"Edit Clinic Enrollment Data option"
"RTN","SCMCQK1",44,0)
 .W !,"Do you wish to enroll the patient from this clinic on "
"RTN","SCMCQK1",45,0)
 .S Y=SCASSDT X ^DD("DD") W Y,"?"
"RTN","SCMCQK1",46,0)
 .I $$YESNO() D
"RTN","SCMCQK1",47,0)
 ..W !,"Clinic Enrollment"
"RTN","SCMCQK1",48,0)
 ..I $$ACPTCL^SCAPMC18(DFN,SCCL,,SCASSDT,"SCENER") W " made"
"RTN","SCMCQK1",49,0)
 ..E  W "NOT made "
"RTN","SCMCQK1",50,0)
QTECL Q
"RTN","SCMCQK1",51,0)
DISCL ; no longer used with SD*5.3*535
"RTN","SCMCQK1",52,0)
 Q
"RTN","SCMCQK1",53,0)
 N SCCL F SCCL=0:0 S SCCL=$O(^SCTM(404.57,+$G(SCTP),5,SCCL)) Q:'SCCL  D
"RTN","SCMCQK1",54,0)
 .Q:'$$ACTCL(DFN,SCCL)
"RTN","SCMCQK1",55,0)
 .W !,$$NAME(DFN)," is enrolled in the associated "_$$CLINIC(SCCL)_" clinic."
"RTN","SCMCQK1",56,0)
 .W !,"Do you wish to discharge the patient from this clinic on "
"RTN","SCMCQK1",57,0)
 .S Y=SCDISCH X ^DD("DD") W Y,"?"
"RTN","SCMCQK1",58,0)
 .Q:'$$YESNO()
"RTN","SCMCQK1",59,0)
 .N SDFN,SDCLN S SDFN=DFN,SDCLN=SCCL
"RTN","SCMCQK1",60,0)
 .N DFN D ^SDCD
"RTN","SCMCQK1",61,0)
QTDCL Q
"RTN","SCMCQK1",62,0)
UNTM ;
"RTN","SCMCQK1",63,0)
 ;assign patient from pc team (and pc position if possible)
"RTN","SCMCQK1",64,0)
 N OK,SCER,SCBEGIN,SCN,SCLIST,SCEND,SCINCL,SCLSEQ,SCDATES,SCDTS,OK2,OK3
"RTN","SCMCQK1",65,0)
 S OK=0
"RTN","SCMCQK1",66,0)
 W !!,"About to Unassign "_$$NAME(DFN)_" from "_$$TEAMNM(SCTM)_" team"
"RTN","SCMCQK1",67,0)
 W:'SCTPSTAT !,?5,"AND from "_$$POSITION(SCTP)_" position  ["_$$WRITETP^SCMCDD1(SCTP)_"]"
"RTN","SCMCQK1",68,0)
 S SCDISCH=$$DATE("D",DFN) ;SD*5.3*563 pass DFN
"RTN","SCMCQK1",69,0)
 G:SCDISCH<1 QTUNTM
"RTN","SCMCQK1",70,0)
 G:'$$CONFIRM() QTUNTM
"RTN","SCMCQK1",71,0)
 IF 'SCTPSTAT D  G:OK2'>0 QTUNTM
"RTN","SCMCQK1",72,0)
 .W !,"PC assignment unassigned."
"RTN","SCMCQK1",73,0)
 .S OK2=$$INPTSCTP^SCAPMC22(DFN,SCTP,SCDISCH,.SCER)
"RTN","SCMCQK1",74,0)
 .IF OK2>0 D
"RTN","SCMCQK1",75,0)
 ..W "made."
"RTN","SCMCQK1",76,0)
 ..S SCCL=$P(^SCTM(404.57,SCTP,0),U,9)
"RTN","SCMCQK1",77,0)
 ..;D:SCCL DISCL ;commented out in SD*5.3*535
"RTN","SCMCQK1",78,0)
 S OK3=$$ALLPOS()
"RTN","SCMCQK1",79,0)
 IF $$OKINPTTM^SCMCTMU2(DFN,SCTM,SCDISCH) D
"RTN","SCMCQK1",80,0)
 .S OK=$$INPTSCTM^SCAPMC7(DFN,SCTM,SCDISCH,.SCER)
"RTN","SCMCQK1",81,0)
 ELSE  D
"RTN","SCMCQK1",82,0)
 .W !,"Future/Current Patient-Position Assignment exists"
"RTN","SCMCQK1",83,0)
QTUNTM W !,"Team Unassignment "_$S(OK:"made",1:"NOT made.")
"RTN","SCMCQK1",84,0)
 Q
"RTN","SCMCQK1",85,0)
ALLPOS() ;unassign all patient-positions for team
"RTN","SCMCQK1",86,0)
 ;not stand-alone - needs dfn,sctm
"RTN","SCMCQK1",87,0)
 ;return 1=No positions left assigned|0=At least 1 position assigned
"RTN","SCMCQK1",88,0)
 N OK,SCDT1,SCPTTPX,SCERRR,SCTP,SCCNT,SCPTTPI,SCLOC,SCNODE,SCPTTP2
"RTN","SCMCQK1",89,0)
 S SCDT1("BEGIN")=SCDISCH+1
"RTN","SCMCQK1",90,0)
 S SCDT1("END")=3990101
"RTN","SCMCQK1",91,0)
 S SCDT1("INCL")=0  ;anytime from now to future
"RTN","SCMCQK1",92,0)
 S OK=$$TPPT^SCAPMC23(DFN,"SCDT1",,,,,,"SCPTTPX",.SCERRR)
"RTN","SCMCQK1",93,0)
 S (SCTP,SCCNT)=0
"RTN","SCMCQK1",94,0)
 W !,"Checking for other position assignments to team..."
"RTN","SCMCQK1",95,0)
 F  S SCTP=$O(SCPTTPX("SCTP",SCTM,SCTP)) Q:'SCTP  S SCCNT=SCCNT+1 D
"RTN","SCMCQK1",96,0)
 .S SCPTTPI=$O(SCPTTPX("SCTP",SCTM,SCTP,9999999),-1)
"RTN","SCMCQK1",97,0)
 .S SCLOC=$O(SCPTTPX("SCTP",SCTM,SCTP,SCPTTPI,0))
"RTN","SCMCQK1",98,0)
 .S SCNODE=SCPTTPX(SCLOC)
"RTN","SCMCQK1",99,0)
 .S SCPTTP2(SCTP)=""
"RTN","SCMCQK1",100,0)
 .W !,?3,$P(SCNODE,U,2),"   ",$P(SCNODE,U,8)
"RTN","SCMCQK1",101,0)
 .IF $P(SCNODE,U,6)!(SCDISCH'>$P(SCNODE,U,5)) D
"RTN","SCMCQK1",102,0)
 ..W !,?5,"Unassignment date already exists or unassignment after assignment date"
"RTN","SCMCQK1",103,0)
 ..W !,?15,"- Correct via PCMM GUI"
"RTN","SCMCQK1",104,0)
 ..S OK=0
"RTN","SCMCQK1",105,0)
 W !,?5,$S(SCCNT:SCCNT,1:"No")_" current/future position assignment(s)"
"RTN","SCMCQK1",106,0)
 G:'OK!('SCCNT) QTALL
"RTN","SCMCQK1",107,0)
 W !!,"About to unassign the above patient-position assignments"
"RTN","SCMCQK1",108,0)
 IF '$$CONFIRM S OK=0 G QTALL
"RTN","SCMCQK1",109,0)
 S SCTP=0
"RTN","SCMCQK1",110,0)
 F  S SCTP=$O(SCPTTP2(SCTP)) Q:'SCTP  D  Q:'OK
"RTN","SCMCQK1",111,0)
 .S OK=$$INPTSCTP^SCAPMC22(DFN,SCTP,SCDISCH,.SCER)
"RTN","SCMCQK1",112,0)
 .W:'OK !,?10,"Problem with unassignment, correct via PCMM GUI"
"RTN","SCMCQK1",113,0)
QTALL Q OK
"RTN","SCMCQK1",114,0)
ASTM ;assign patient to PC team
"RTN","SCMCQK1",115,0)
 N DIC,Y,OK,SCTM,SCTMFLDS,SCER,SCBEGIN,SCN,SCLIST,SCEND,SCINCL,SCLSEQ,SCDATES,SCDTS
"RTN","SCMCQK1",116,0)
 S OK=0
"RTN","SCMCQK1",117,0)
 W !!,"About to Assign "_$$NAME(DFN)_" to a primary care team"
"RTN","SCMCQK1",118,0)
 I $$SC(DFN) W !!,"********** This patient is 50 percent or greater service-connected ************"
"RTN","SCMCQK1",119,0)
 S DIC="^SCTM(404.51,"
"RTN","SCMCQK1",120,0)
 S DIC(0)="AEMQZ"
"RTN","SCMCQK1",121,0)
 S DIC("S")="IF $$ACTTM^SCMCTMU(Y,DT)&($P($G(^SCTM(404.51,Y,0)),U,5))"
"RTN","SCMCQK1",122,0)
 ;select from active teams that can be PC Teams
"RTN","SCMCQK1",123,0)
 D ^DIC
"RTN","SCMCQK1",124,0)
 G:Y<1 QTASTM
"RTN","SCMCQK1",125,0)
 S SCTM=+Y
"RTN","SCMCQK1",126,0)
 ;The following logic to present warning message added per SD*5.3*436
"RTN","SCMCQK1",127,0)
 I $P($G(^SCTM(404.51,SCTM,0)),U,10) D  G:'SCFLAG QTASTM
"RTN","SCMCQK1",128,0)
 .S SCFLAG=0
"RTN","SCMCQK1",129,0)
 .W !!,"This team is closed to further patient assignments.  While you are"
"RTN","SCMCQK1",130,0)
 .W !,"not currently prevented from assigning this patient, you may want to"
"RTN","SCMCQK1",131,0)
 .W !,"check before continuing."
"RTN","SCMCQK1",132,0)
 .Q:'$$YESNO1()  ; new function call per SD*5.3*436
"RTN","SCMCQK1",133,0)
 .Q:'$$CONFIRM()
"RTN","SCMCQK1",134,0)
 .S SCFLAG=1 W !
"RTN","SCMCQK1",135,0)
 S SCASSDT=$$DATE("A",DFN) ;SD*5.3*563 Pass DFN
"RTN","SCMCQK1",136,0)
 G:SCASSDT<1 QTASTM
"RTN","SCMCQK1",137,0)
 S SCTMCT=$$TEAMCNT^SCAPMCU1(SCTM)
"RTN","SCMCQK1",138,0)
 S SCTMMAX=$P($$GETEAM^SCAPMCU3(SCTM),"^",8)
"RTN","SCMCQK1",139,0)
 I SCTMCT'<SCTMMAX  D  G QTASTM:$$WAITYN(),QTASTM:'$$YESNO2()
"RTN","SCMCQK1",140,0)
 .W !,"This assignment will reach or exceeded the maximum set for this team."
"RTN","SCMCQK1",141,0)
 .W !,"Currently assigned: "_SCTMCT
"RTN","SCMCQK1",142,0)
 .W !,"Maximum set for team: "_SCTMMAX
"RTN","SCMCQK1",143,0)
 I SCTMCT<SCTMMAX,'$$CONFIRM() G QTASTM
"RTN","SCMCQK1",144,0)
 S SCTM=+Y
"RTN","SCMCQK1",145,0)
 ;setup fields
"RTN","SCMCQK1",146,0)
 S SCTMFLDS(.08)=1 ;primary care assignment
"RTN","SCMCQK1",147,0)
 S SCTMFLDS(.11)=$G(DUZ,.5)
"RTN","SCMCQK1",148,0)
 D NOW^%DTC S SCTMFLDS(.12)=%
"RTN","SCMCQK1",149,0)
 IF $$ACPTTM^SCAPMC(DFN,SCTM,"SCTMFLDS",SCASSDT,"SCTPTME") D
"RTN","SCMCQK1",150,0)
 .S SCSELECT=$$SELPOS()
"RTN","SCMCQK1",151,0)
 .D:$L(SCSELECT) ASTP ;prompt for position prompt
"RTN","SCMCQK1",152,0)
 .S OK=1
"RTN","SCMCQK1",153,0)
QTASTM W !,"Team Assignment "_$S(OK:"made",1:"NOT made.")
"RTN","SCMCQK1",154,0)
 S:$D(SDWLPCMM) SDWLPCMM=OK  ; 446
"RTN","SCMCQK1",155,0)
 Q
"RTN","SCMCQK1",156,0)
ASTP ;assign patient to PC practitioner
"RTN","SCMCQK1",157,0)
 N DIC,Y,OK,SCCL,X,SCTPFLDS,SCER,SCBEGIN,SCN,SCLIST,SCEND,SCINCL,SCLSEQ,SCDATES,SCDTS
"RTN","SCMCQK1",158,0)
 S OK=0
"RTN","SCMCQK1",159,0)
 W !!,"About to Assign "_$$NAME(DFN)_" to PC Position Assignment"
"RTN","SCMCQK1",160,0)
 I $$SC(DFN) W !!,"********** This patient is 50 percent or greater service-connected ************"
"RTN","SCMCQK1",161,0)
 ;lookup to display only position and [practitioner]
"RTN","SCMCQK1",162,0)
 IF SCSELECT="PRACT" D
"RTN","SCMCQK1",163,0)
 .S DIC("W")="N SCP1 S SCP1=$G(^SCTM(404.52,Y,0)) W ""    ["",$P($G(^VA(200,+$P(SCP1,U,3),0)),U,1),""]"""
"RTN","SCMCQK1",164,0)
 .S DIC("A")="POSITION's Current PRACTITIONER: "
"RTN","SCMCQK1",165,0)
 .S DIC="^SCTM(404.52,"
"RTN","SCMCQK1",166,0)
 .;Must be from team, must be activation,must not have future inactivation
"RTN","SCMCQK1",167,0)
 .S DIC("S")="I $$PRACSCR^SCMCQK1(Y)"
"RTN","SCMCQK1",168,0)
 .S D="C"
"RTN","SCMCQK1",169,0)
 ELSE  D
"RTN","SCMCQK1",170,0)
 .S DIC="^SCTM(404.57,"
"RTN","SCMCQK1",171,0)
 .S D="B"
"RTN","SCMCQK1",172,0)
 .S DIC("A")="POSITION's Name: "
"RTN","SCMCQK1",173,0)
 .S DIC("S")="I $$POSSCR^SCMCQK1(Y)"
"RTN","SCMCQK1",174,0)
 S DIC(0)="AEMQZ"
"RTN","SCMCQK1",175,0)
 D MIX^DIC1
"RTN","SCMCQK1",176,0)
 G:Y<1 QTASTP
"RTN","SCMCQK1",177,0)
 IF SCSELECT="PRACT" D
"RTN","SCMCQK1",178,0)
 .S SCTP=$P(Y,U,2)
"RTN","SCMCQK1",179,0)
 ELSE  D
"RTN","SCMCQK1",180,0)
 .S SCTP=$P(Y,U,1)
"RTN","SCMCQK1",181,0)
 S SCASSDT=$$DATE("A",DFN) ;SD*5.3*563 Pass DFN
"RTN","SCMCQK1",182,0)
 G:SCASSDT<1 QTASTP
"RTN","SCMCQK1",183,0)
 S SCTMCT=$$PCPOSCNT^SCAPMCU1(SCTP),SCTMMAX=+$P($G(^SCTM(404.57,SCTP,0)),U,8)
"RTN","SCMCQK1",184,0)
 I SCTMCT'<SCTMMAX D  G QTASTP:$$WAITYN,QTASTP:'$$YESNO2
"RTN","SCMCQK1",185,0)
 .W !,"This assignment will reach or exceeded the maximum set for this position."
"RTN","SCMCQK1",186,0)
 .W !,"Currently assigned: "_SCTMCT
"RTN","SCMCQK1",187,0)
 .W !,"Maximum set for position: "_SCTMMAX
"RTN","SCMCQK1",188,0)
 G:'$$CONFIRM() QTASTP
"RTN","SCMCQK1",189,0)
 ;setup fields
"RTN","SCMCQK1",190,0)
 S SCTPFLDS(.03)=SCASSDT
"RTN","SCMCQK1",191,0)
 S SCTPFLDS(.05)=1 ;pc pract role
"RTN","SCMCQK1",192,0)
 S SCTPFLDS(.06)=$G(DUZ,.5)
"RTN","SCMCQK1",193,0)
 D NOW^%DTC S SCTPFLDS(.07)=%
"RTN","SCMCQK1",194,0)
 IF $$ACPTTP^SCAPMC21(DFN,SCTP,"SCTPFLDS",SCASSDT,"SCTPTME",0) D
"RTN","SCMCQK1",195,0)
 .S OK=1
"RTN","SCMCQK1",196,0)
 .S SCCL=$O(^SCTM(404.57,+$G(SCTP),5,0))
"RTN","SCMCQK1",197,0)
 .D:SCCL ENRCL
"RTN","SCMCQK1",198,0)
QTASTP W !,"Position Assignment "_$S(OK:"made",1:"NOT made.")
"RTN","SCMCQK1",199,0)
 S:$D(SDWLPCMM) SDWLPCMM=OK ;446
"RTN","SCMCQK1",200,0)
 Q
"RTN","SCMCQK1",201,0)
NAME(DFN) ;return patient name
"RTN","SCMCQK1",202,0)
 Q $P($G(^DPT(DFN,0)),U,1)
"RTN","SCMCQK1",203,0)
POSITION(SCTP) ;return position name
"RTN","SCMCQK1",204,0)
 Q $P($G(^SCTM(404.57,SCTP,0)),U,1)
"RTN","SCMCQK1",205,0)
TEAMNM(SCTM) ;return team name
"RTN","SCMCQK1",206,0)
 Q $P($G(^SCTM(404.51,SCTM,0)),U,1)
"RTN","SCMCQK1",207,0)
CLINIC(SCCL) ;return clinic name
"RTN","SCMCQK1",208,0)
 Q $P($G(^SC(+SCCL,0)),U,1)
"RTN","SCMCQK1",209,0)
YESNO() ;
"RTN","SCMCQK1",210,0)
 N DIR,X,Y
"RTN","SCMCQK1",211,0)
 S DIR(0)="Y",DIR("B")="YES"
"RTN","SCMCQK1",212,0)
 D ^DIR
"RTN","SCMCQK1",213,0)
 Q Y>0
"RTN","SCMCQK1",214,0)
YESNO1() ; added per SD*5.3*436
"RTN","SCMCQK1",215,0)
 N DIR,X,Y
"RTN","SCMCQK1",216,0)
 S DIR(0)="Y",DIR("A")="Do you wish to assign this patient now (Yes/No)?"
"RTN","SCMCQK1",217,0)
 S DIR("B")="NO"
"RTN","SCMCQK1",218,0)
 D ^DIR
"RTN","SCMCQK1",219,0)
 Q Y>0
"RTN","SCMCQK1",220,0)
YESNO2() ;
"RTN","SCMCQK1",221,0)
 N DIR,X,Y
"RTN","SCMCQK1",222,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","SCMCQK1",223,0)
 S DIR("A")="Do you wish to continue with the assignment (Yes/No)?"
"RTN","SCMCQK1",224,0)
 D ^DIR
"RTN","SCMCQK1",225,0)
 Q Y>0
"RTN","SCMCQK1",226,0)
CONFIRM() ;confirmation call
"RTN","SCMCQK1",227,0)
 N DIR,X,Y
"RTN","SCMCQK1",228,0)
 S DIR("A")="Are you sure (Yes/No)"
"RTN","SCMCQK1",229,0)
 S DIR(0)="Y"
"RTN","SCMCQK1",230,0)
 D ^DIR
"RTN","SCMCQK1",231,0)
 Q +Y=1
"RTN","SCMCQK1",232,0)
SELPOS() ;return way to select position: 1=PRACT,2=POSIT,3=NONE
"RTN","SCMCQK1",233,0)
 N DIR,X,Y
"RTN","SCMCQK1",234,0)
 W !,"Choose way to select PC POSITION Assignment: "
"RTN","SCMCQK1",235,0)
 S DIR(0)="SO^0:NONE;1:BY PRACTITIONER ASSIGNMENT;2:BY POSITION ASSIGNMENT"
"RTN","SCMCQK1",236,0)
 S DIR("B")=1
"RTN","SCMCQK1",237,0)
 D ^DIR
"RTN","SCMCQK1",238,0)
 Q $S(Y'>0:"",+Y=1:"PRACT",1:"POSIT")
"RTN","SCMCQK1",239,0)
DATE(TYPE,DFN) ;type=A(Assignment) or D(Unassignment)
"RTN","SCMCQK1",240,0)
 ; Returns assignment/unassignment date or "^"
"RTN","SCMCQK1",241,0)
 I '$G(DFN) Q -1
"RTN","SCMCQK1",242,0)
 N DIR,X,Y,SDFLG,SDY
"RTN","SCMCQK1",243,0)
 ;SD*5.3*563 SDFLG=0 allow to proceed with date if prior to DOD
"RTN","SCMCQK1",244,0)
 F  D  Q:SDFLG=0
"RTN","SCMCQK1",245,0)
 .S DIR("A")=$S(TYPE="A":"Assignment",1:"Unassignment")_" date: "
"RTN","SCMCQK1",246,0)
 .S DIR(0)="DA^::EXP"
"RTN","SCMCQK1",247,0)
 .S Y=$S($D(SCDISCH):SCDISCH,$D(SCASSDT):SCASSDT,(TYPE="A"):"TODAY",1:"TODAY-1")
"RTN","SCMCQK1",248,0)
 .X ^DD("DD")
"RTN","SCMCQK1",249,0)
 .S DIR("B")=Y
"RTN","SCMCQK1",250,0)
 .D ^DIR K DIR S SDY=Y
"RTN","SCMCQK1",251,0)
 .I $D(DIRUT) K DIRUT,DUOUT,X,Y S SDFLG=0 Q
"RTN","SCMCQK1",252,0)
 .D WARNMESS^SCMCQK1(SDY,DFN,.SDFLG)
"RTN","SCMCQK1",253,0)
 Q SDY
"RTN","SCMCQK1",254,0)
ACTCL(DFN,SCCL) ;is patient enrolled in clinic? - not called with SD*5.3*535
"RTN","SCMCQK1",255,0)
 Q
"RTN","SCMCQK1",256,0)
 N SCXX
"RTN","SCMCQK1",257,0)
 S SCXX=$O(^DPT(DFN,"DE","B",SCCL,9999),-1)
"RTN","SCMCQK1",258,0)
 Q $S('SCXX:0,($P(^DPT(DFN,"DE",+SCXX,0),U,2)="I"):0,1:1)
"RTN","SCMCQK1",259,0)
PRACSCR(SC40452) ;screen for for file 404.52
"RTN","SCMCQK1",260,0)
 N SCP,SCNODE,OK
"RTN","SCMCQK1",261,0)
 S SCP=$G(^SCTM(404.52,SC40452,0))
"RTN","SCMCQK1",262,0)
 S OK=0
"RTN","SCMCQK1",263,0)
 G:'SCP QTPP
"RTN","SCMCQK1",264,0)
 S SCNODE=$G(^SCTM(404.57,+SCP,0))
"RTN","SCMCQK1",265,0)
 S OK=$S($P(SCNODE,U,2)'=SCTM:0,'$P(SCNODE,U,4):0,($O(^SCTM(404.52,"AIDT",+SCP,1,""))'=-$P(SCP,U,2)):0,($O(^SCTM(404.52,"AIDT",+SCP,0,-$P(SCP,U,2)),-1)):0,($$ACTTP^SCMCTPU(+SCP)>0):1,1:0)
"RTN","SCMCQK1",266,0)
QTPP Q OK
"RTN","SCMCQK1",267,0)
POSSCR(SCTP) ;screen for file 404.57
"RTN","SCMCQK1",268,0)
 N SCNODE
"RTN","SCMCQK1",269,0)
 S SCNODE=$G(^SCTM(404.57,SCTP,0))
"RTN","SCMCQK1",270,0)
 Q $S($P(SCNODE,U,2)'=SCTM:0,'$P(SCNODE,U,4):0,($$ACTTP^SCMCTPU(SCTP)>0):1,1:0)
"RTN","SCMCQK1",271,0)
 Q
"RTN","SCMCQK1",272,0)
WAITYN() ;
"RTN","SCMCQK1",273,0)
 N %,OK,Y
"RTN","SCMCQK1",274,0)
 I SCTMCT<SCTMMAX Q 0
"RTN","SCMCQK1",275,0)
 N A,SC S A=$$ONWAIT^SCMCWAIT(DFN) I A W:(+A=3) !,$P(A,";",2) I $S($G(SCTP):A>1,1:1) Q 0
"RTN","SCMCQK1",276,0)
 N DIR,X,Y
"RTN","SCMCQK1",277,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","SCMCQK1",278,0)
 S DIR("A")="Do you wish to place the patient on the wait list (Yes/No)?"
"RTN","SCMCQK1",279,0)
 D ^DIR
"RTN","SCMCQK1",280,0)
 I Y=1 S Y=$$WAITS^SCMCWAIT(DFN,SCTM,$G(SCTP),$G(SC)) I Y>0 W !,"Patient Placed on Wait List"
"RTN","SCMCQK1",281,0)
 Q Y>0
"RTN","SCMCQK1",282,0)
SC(DFN) ;Is patient 50 to 100%
"RTN","SCMCQK1",283,0)
 D ELIG^VADPT Q $P($G(VAEL(3)),U,2)>49
"RTN","SCMCQK1",284,0)
 ;
"RTN","SCMCQK1",285,0)
WARNMESS(SDY,DFN,SDFLG) ;SD*5.3*563
"RTN","SCMCQK1",286,0)
 ;If the patient is deceased warns the user to choose assignment
"RTN","SCMCQK1",287,0)
 ;date prior to the date of death
"RTN","SCMCQK1",288,0)
 ;SDY - Assignment/Unassignment date
"RTN","SCMCQK1",289,0)
 ;SDFLG=0 - Allow to proceed with the date if prior to DOD
"RTN","SCMCQK1",290,0)
 ;
"RTN","SCMCQK1",291,0)
 N SDDODPAT,SDDODCF
"RTN","SCMCQK1",292,0)
 S SDFLG=1
"RTN","SCMCQK1",293,0)
 I $P($G(^DPT(DFN,.35)),U)="" S SDFLG=0 Q
"RTN","SCMCQK1",294,0)
 I $P($G(^DPT(DFN,.35)),U)'="" D
"RTN","SCMCQK1",295,0)
 .S SDDODPAT=$P($P(^DPT(DFN,.35),U),".")
"RTN","SCMCQK1",296,0)
 .S SDDODCF=$$FMTE^XLFDT(SDDODPAT)
"RTN","SCMCQK1",297,0)
 .I SDY<SDDODPAT S SDFLG=0 Q
"RTN","SCMCQK1",298,0)
 .I SDY>=SDDODPAT D
"RTN","SCMCQK1",299,0)
 ..W !,"Patient is deceased as of "_SDDODCF_". Please use an earlier Assignment date."
"RTN","SCMCQK1",300,0)
 Q
"RTN","SCMCQK2")
0^3^B59731461
"RTN","SCMCQK2",1,0)
SCMCQK2 ;ALB/REW - Single Pt Tm/Pt Tm Pos Assign and Discharge ; 5/16/12 12:09pm
"RTN","SCMCQK2",2,0)
 ;;5.3;Scheduling;**297,563**;AUG 13, 1993;Build 3
"RTN","SCMCQK2",3,0)
 ;
"RTN","SCMCQK2",4,0)
DSPL ;
"RTN","SCMCQK2",5,0)
 N LP,SCD,SCPOS
"RTN","SCMCQK2",6,0)
 S SCTOK=$$TMPT^SCAPMC3(DFN,"SCDT","","SCD","SCER1")
"RTN","SCMCQK2",7,0)
 S SCOK=$$TPPT^SCAPMC(DFN,"","","","","","","SCPOS","SCBKERR")
"RTN","SCMCQK2",8,0)
  ;
"RTN","SCMCQK2",9,0)
  ;loop through positions only getting the ones associated with the team
"RTN","SCMCQK2",10,0)
  ;and that are active.
"RTN","SCMCQK2",11,0)
  ;
"RTN","SCMCQK2",12,0)
  F LP=0:0 S LP=$O(SCPOS(LP)) Q:'LP  D
"RTN","SCMCQK2",13,0)
  .I $P(SCPOS(LP),U,6)]"" K SCPOS(LP) Q
"RTN","SCMCQK2",14,0)
  .S SCPOS("T",$P(SCPOS(LP),U,3),+SCPOS(LP))=SCPOS(LP)
"RTN","SCMCQK2",15,0)
 S CNT=0,POS=0
"RTN","SCMCQK2",16,0)
 F LP=0:0 S LP=$O(SCD(LP)) Q:'LP  S A=SCD(LP) I '$P(A,U,8) D
"RTN","SCMCQK2",17,0)
 .I 'CNT W !!,"NON PC ASSIGNMENTS",!
"RTN","SCMCQK2",18,0)
 .S CNT=CNT+1 W !,CNT,?4,"Non-PC Team: "_$P(A,U,2),?48,"Phone: "_$P($G(^SCTM(404.51,+A,0)),U,2) S DATA(CNT)=+A
"RTN","SCMCQK2",19,0)
 .F I=0:0 S I=$O(SCPOS("T",+A,I)) Q:'I  D
"RTN","SCMCQK2",20,0)
 ..I $P(DATA(CNT),U,2) S CNT=CNT+1
"RTN","SCMCQK2",21,0)
 ..S B=SCPOS("T",+A,I)
"RTN","SCMCQK2",22,0)
 ..S DATA(CNT)=(+A)_U_(+B),POS=1
"RTN","SCMCQK2",23,0)
 ..S SCPR=$$GETPRTP^SCAPMCU2(+B,DT),RES=$$NEWPERSN^SCMCGU(+SCPR,"SCPR")
"RTN","SCMCQK2",24,0)
 ..W:$X>76 !,CNT,?4,"Non-PC Team: "_$P(A,U,2),?48,"Phone: "_$P($G(^SCTM(404.51,+A,0)),U,2)
"RTN","SCMCQK2",25,0)
 ..W !,?7,"Provider: "_$P(SCPR,U,2),?45,"Position: "_$P(B,U,2)_"       "
"RTN","SCMCQK2",26,0)
 ..W !,?10,"Pager: "_$P($G(SCPR(+SCPR)),U,5),?48,"Phone: ",$P($G(SCPR(+SCPR)),U,2),?77," "
"RTN","SCMCQK2",27,0)
 I 'CNT W !,"No active NON PC ASSIGNMENTS for this patient",!
"RTN","SCMCQK2",28,0)
 Q
"RTN","SCMCQK2",29,0)
NPC N SCDT,SCER1,SCD,SCPOS
"RTN","SCMCQK2",30,0)
 D DSPL
"RTN","SCMCQK2",31,0)
 S DIR(0)="SO^0:NONE;1:TEAM ASSIGNMENT;"_$S(CNT:"2:POSITION ASSIGNMENT;3:UNASSIGNMENT;",1:"")
"RTN","SCMCQK2",32,0)
 S DIR("B")=1
"RTN","SCMCQK2",33,0)
 D ^DIR
"RTN","SCMCQK2",34,0)
 I Y=0 Q
"RTN","SCMCQK2",35,0)
 I $D(DIRUT) K DIRUT,X,Y Q  ; Quit operation if the user enters "^" or times out SD*5.3*563
"RTN","SCMCQK2",36,0)
 I Y=1 D ASTM G NPC
"RTN","SCMCQK2",37,0)
READ S:CNT=1 X=1 I CNT>1 W !,"Select 1-"_CNT_": " R X:DTIME  Q:X=U  S X=+X I X>CNT!X<1 G READ
"RTN","SCMCQK2",38,0)
 I Y=3 S DATA=DATA(+X) S SCTPSTAT=1,SCTP=+$P(DATA,U,2),SCTM=+DATA D UNTP:SCTP,UNTM:'SCTP G NPC
"RTN","SCMCQK2",39,0)
 S DATA=DATA(+X),SCTM=+DATA S SCSELECT=$$SELPOS() G NPC:'$L(SCSELECT) D ASTP G NPC
"RTN","SCMCQK2",40,0)
 Q
"RTN","SCMCQK2",41,0)
UNTP ;unassign patient from position
"RTN","SCMCQK2",42,0)
 IF '$G(SCTP) W !,"No position defined" Q
"RTN","SCMCQK2",43,0)
 N OK,SCER,SCCL,SCBEGIN,SCN,SCLIST,SCEND,SCINCL,SCLSEQ,SCDATES,SCDTS
"RTN","SCMCQK2",44,0)
 S OK=0
"RTN","SCMCQK2",45,0)
 W !,"About to Unassign "_$$NAME(DFN)_" from: ",!,?8,$$POSITION(SCTP)_" position   ["_$P($$GETPRTP^SCAPMCU2(SCTP,DT),U,2)_"]"
"RTN","SCMCQK2",46,0)
 S SCDISCH=$$DATE("D",DFN) ;SD*5.3*563 Pass DFN
"RTN","SCMCQK2",47,0)
 G:SCDISCH<1 QTUNTP
"RTN","SCMCQK2",48,0)
 G:'$$CONFIRM() QTUNTP
"RTN","SCMCQK2",49,0)
 S OK=$$INPTSCTP^SCAPMC22(DFN,SCTP,SCDISCH,.SCER)
"RTN","SCMCQK2",50,0)
 G:OK'>0 QTUNTP
"RTN","SCMCQK2",51,0)
 S SCCL=$P($G(^SCTM(404.57,+$G(SCTP),0)),U,9)
"RTN","SCMCQK2",52,0)
QTUNTP W !,"Position Unassignment "_$S(OK:"made.",1:"NOT made.")
"RTN","SCMCQK2",53,0)
 Q
"RTN","SCMCQK2",54,0)
 ;
"RTN","SCMCQK2",55,0)
 ;
"RTN","SCMCQK2",56,0)
UNTM ;
"RTN","SCMCQK2",57,0)
 ;assign patient from non pc team (and pc position if possible)
"RTN","SCMCQK2",58,0)
 N OK,SCER,SCBEGIN,SCN,SCLIST,SCEND,SCINCL,SCLSEQ,SCDATES,SCDTS,OK2,OK3
"RTN","SCMCQK2",59,0)
 S OK=0
"RTN","SCMCQK2",60,0)
 W !!,"About to Unassign "_$$NAME(DFN)_" from "_$$TEAMNM(SCTM)_" team"
"RTN","SCMCQK2",61,0)
 W:'SCTPSTAT !,?5,"AND from "_$$POSITION(SCTP)_" position  ["_$$WRITETP^SCMCDD1(SCTP)_"]"
"RTN","SCMCQK2",62,0)
 S SCDISCH=$$DATE("D",DFN) ;SD*5.3*563 Pass DFN
"RTN","SCMCQK2",63,0)
 G:SCDISCH<1 QTUNTM
"RTN","SCMCQK2",64,0)
 G:'$$CONFIRM() QTUNTM
"RTN","SCMCQK2",65,0)
 IF 'SCTPSTAT D  G:OK2'>0 QTUNTM
"RTN","SCMCQK2",66,0)
 .W !,"Unassigned."
"RTN","SCMCQK2",67,0)
 .S OK2=$$INPTSCTP^SCAPMC22(DFN,SCTP,SCDISCH,.SCER)
"RTN","SCMCQK2",68,0)
 .IF OK2>0 D
"RTN","SCMCQK2",69,0)
 ..W "made."
"RTN","SCMCQK2",70,0)
 ..S SCCL=$P(^SCTM(404.57,SCTP,0),U,9)
"RTN","SCMCQK2",71,0)
 S OK3=$$ALLPOS^SCMCQK1()
"RTN","SCMCQK2",72,0)
 IF $$OKINPTTM^SCMCTMU2(DFN,SCTM,SCDISCH) D
"RTN","SCMCQK2",73,0)
 .S OK=$$INPTSCTM^SCAPMC7(DFN,SCTM,SCDISCH,.SCER)
"RTN","SCMCQK2",74,0)
 ELSE  D
"RTN","SCMCQK2",75,0)
 . W !,"Future/Current Patient-Position Assignment exists"
"RTN","SCMCQK2",76,0)
QTUNTM W !,"Team Unassignment "_$S(OK:"made",1:"NOT made.")
"RTN","SCMCQK2",77,0)
 Q
"RTN","SCMCQK2",78,0)
 ;
"RTN","SCMCQK2",79,0)
ASTM ;assign patient to team
"RTN","SCMCQK2",80,0)
 N DIC,Y,OK,SCTM,SCTMFLDS,SCER,SCBEGIN,SCN,SCLIST,SCEND,SCINCL,SCLSEQ,SCDATES,SCDTS
"RTN","SCMCQK2",81,0)
 S OK=0
"RTN","SCMCQK2",82,0)
 W !!,"About to Assign "_$$NAME(DFN)_" to a non primary care team"
"RTN","SCMCQK2",83,0)
 I $$SC^SCMCQK1(DFN) W !!,"********** This patient is 50 percent or greater service-connected ************"
"RTN","SCMCQK2",84,0)
 S DIC="^SCTM(404.51,"
"RTN","SCMCQK2",85,0)
 S DIC(0)="AEMQZ"
"RTN","SCMCQK2",86,0)
 S DIC("S")="IF $$ACTTM^SCMCTMU(Y,DT) I $$NEW^SCMCQK2()"
"RTN","SCMCQK2",87,0)
 ;  - select from active teams that can not be PC Teams
"RTN","SCMCQK2",88,0)
 D ^DIC
"RTN","SCMCQK2",89,0)
 G:Y<1 QTASTM
"RTN","SCMCQK2",90,0)
 S SCTM=+Y
"RTN","SCMCQK2",91,0)
 S SCASSDT=$$DATE("A",DFN) ;SD*5.3*563 Pass DFN
"RTN","SCMCQK2",92,0)
 G:SCASSDT<1 QTASTM
"RTN","SCMCQK2",93,0)
 S SCTMCT=$$TEAMCNT^SCAPMCU1(SCTM)
"RTN","SCMCQK2",94,0)
 S SCTMMAX=$P($$GETEAM^SCAPMCU3(SCTM),"^",8)
"RTN","SCMCQK2",95,0)
 I SCTMCT'<SCTMMAX  D  G QTASTM:'$$YESNO2()
"RTN","SCMCQK2",96,0)
 .W !,"This assignment will reach or exceeded the maximum set for this team."
"RTN","SCMCQK2",97,0)
 .W !,"Currently assigned: "_SCTMCT
"RTN","SCMCQK2",98,0)
 .W !,"Maximum set for team: "_SCTMMAX
"RTN","SCMCQK2",99,0)
 I SCTMCT<SCTMMAX,'$$CONFIRM() G QTASTM
"RTN","SCMCQK2",100,0)
 S SCTM=+Y
"RTN","SCMCQK2",101,0)
 ;setup fields
"RTN","SCMCQK2",102,0)
 ;S SCTMFLDS(.08)=1 ;primary care assignment
"RTN","SCMCQK2",103,0)
 S SCTMFLDS(.11)=$G(DUZ,.5)
"RTN","SCMCQK2",104,0)
 D NOW^%DTC S SCTMFLDS(.12)=%
"RTN","SCMCQK2",105,0)
 IF $$ACPTTM^SCAPMC(DFN,SCTM,"SCTMFLDS",SCASSDT,"SCTPTME") D
"RTN","SCMCQK2",106,0)
 .S SCSELECT=$$SELPOS()
"RTN","SCMCQK2",107,0)
 .D:$L(SCSELECT) ASTP ;prompt for position prompt
"RTN","SCMCQK2",108,0)
 .S OK=1
"RTN","SCMCQK2",109,0)
QTASTM W !,"Team Assignment "_$S(OK:"made",1:"NOT made.")
"RTN","SCMCQK2",110,0)
 Q
"RTN","SCMCQK2",111,0)
ASTP ;assign patient to practitioner
"RTN","SCMCQK2",112,0)
 N DIC,Y,OK,SCCL,X,SCTPFLDS,SCER,SCBEGIN,SCN,SCLIST,SCEND,SCINCL,SCLSEQ,SCDATES,SCDTS
"RTN","SCMCQK2",113,0)
 S OK=0
"RTN","SCMCQK2",114,0)
 W !!,"About to Assign "_$$NAME(DFN)_" to non PC Position Assignment"
"RTN","SCMCQK2",115,0)
 I $$SC^SCMCQK1(DFN) W !!,"********** This patient is 50 percent or greater service-connected ************"
"RTN","SCMCQK2",116,0)
 ;lookup to display only position and [practitioner]
"RTN","SCMCQK2",117,0)
 IF SCSELECT="PRACT" D
"RTN","SCMCQK2",118,0)
 .S DIC("W")="N SCP1 S SCP1=$G(^SCTM(404.52,Y,0)) W ""    ["",$P($G(^VA(200,+$P(SCP1,U,3),0)),U,1),""]"""
"RTN","SCMCQK2",119,0)
 .S DIC("A")="POSITION's Current PRACTITIONER: "
"RTN","SCMCQK2",120,0)
 .S DIC="^SCTM(404.52,"
"RTN","SCMCQK2",121,0)
 .;Must be from team, must be active,must not have future inactivation
"RTN","SCMCQK2",122,0)
 .S DIC("S")="I $$PRACSCR^SCMCQK2(Y)"
"RTN","SCMCQK2",123,0)
 .S D="C"
"RTN","SCMCQK2",124,0)
 ELSE  D
"RTN","SCMCQK2",125,0)
 .S DIC="^SCTM(404.57,"
"RTN","SCMCQK2",126,0)
 .S D="B"
"RTN","SCMCQK2",127,0)
 .S DIC("A")="POSITION's Name: "
"RTN","SCMCQK2",128,0)
 .S DIC("S")="I $$POSSCR^SCMCQK2(Y)"
"RTN","SCMCQK2",129,0)
 S DIC(0)="AEMQZ"
"RTN","SCMCQK2",130,0)
 D MIX^DIC1
"RTN","SCMCQK2",131,0)
 G:Y<1 QTASTP
"RTN","SCMCQK2",132,0)
 IF SCSELECT="PRACT" D
"RTN","SCMCQK2",133,0)
 .S SCTP=$P(Y,U,2)
"RTN","SCMCQK2",134,0)
 ELSE  D
"RTN","SCMCQK2",135,0)
 .S SCTP=$P(Y,U,1)
"RTN","SCMCQK2",136,0)
 S SCASSDT=$$DATE("A",DFN) ;SD*5.3*563 Pass DFN
"RTN","SCMCQK2",137,0)
 G:SCASSDT<1 QTASTP
"RTN","SCMCQK2",138,0)
 S SCTMCT=$$PCPOSCNT^SCAPMCU1(SCTP),SCTMMAX=+$P($G(^SCTM(404.57,SCTP,0)),U,8)
"RTN","SCMCQK2",139,0)
 I SCTMCT'<SCTMMAX D  G QTASTP:'$$YESNO2
"RTN","SCMCQK2",140,0)
 .W !,"This assignment will reach or exceeded the maximum set for this position."
"RTN","SCMCQK2",141,0)
 .W !,"Currently assigned: "_SCTMCT
"RTN","SCMCQK2",142,0)
 .W !,"Maximum set for position: "_SCTMMAX
"RTN","SCMCQK2",143,0)
 G:'$$CONFIRM() QTASTP
"RTN","SCMCQK2",144,0)
 ;setup fields
"RTN","SCMCQK2",145,0)
 S SCTPFLDS(.03)=SCASSDT
"RTN","SCMCQK2",146,0)
 ;S SCTPFLDS(.05)=1 ;pc pract role
"RTN","SCMCQK2",147,0)
 S SCTPFLDS(.06)=$G(DUZ,.5)
"RTN","SCMCQK2",148,0)
 D NOW^%DTC S SCTPFLDS(.07)=%
"RTN","SCMCQK2",149,0)
 IF $$ACPTTP^SCAPMC21(DFN,SCTP,"SCTPFLDS",SCASSDT,"SCTPTME",0) D
"RTN","SCMCQK2",150,0)
 .S OK=1
"RTN","SCMCQK2",151,0)
 .S SCCL=$P(^SCTM(404.57,SCTP,0),U,9)
"RTN","SCMCQK2",152,0)
QTASTP W !,"Position Assignment "_$S(OK:"made",1:"NOT made.")
"RTN","SCMCQK2",153,0)
 Q
"RTN","SCMCQK2",154,0)
NAME(DFN) ;return patient name
"RTN","SCMCQK2",155,0)
 Q $P($G(^DPT(DFN,0)),U,1)
"RTN","SCMCQK2",156,0)
 ;
"RTN","SCMCQK2",157,0)
POSITION(SCTP) ;return position name
"RTN","SCMCQK2",158,0)
 Q $P($G(^SCTM(404.57,SCTP,0)),U,1)
"RTN","SCMCQK2",159,0)
 ;
"RTN","SCMCQK2",160,0)
TEAMNM(SCTM) ;return team name
"RTN","SCMCQK2",161,0)
 Q $P($G(^SCTM(404.51,SCTM,0)),U,1)
"RTN","SCMCQK2",162,0)
 ;
"RTN","SCMCQK2",163,0)
CLINIC(SCCL) ;return clinic name
"RTN","SCMCQK2",164,0)
 Q $P($G(^SC(+SCCL,0)),U,1)
"RTN","SCMCQK2",165,0)
 ;
"RTN","SCMCQK2",166,0)
YESNO() ;
"RTN","SCMCQK2",167,0)
 N DIR,X,Y
"RTN","SCMCQK2",168,0)
 S DIR(0)="Y",DIR("B")="YES"
"RTN","SCMCQK2",169,0)
 D ^DIR
"RTN","SCMCQK2",170,0)
 Q Y>0
"RTN","SCMCQK2",171,0)
 ;
"RTN","SCMCQK2",172,0)
YESNO2() ;
"RTN","SCMCQK2",173,0)
 N DIR,X,Y
"RTN","SCMCQK2",174,0)
 S DIR(0)="Y",DIR("B")="NO"
"RTN","SCMCQK2",175,0)
 S DIR("A")="Do you wish to continue with the assignment (Yes/No)?"
"RTN","SCMCQK2",176,0)
 D ^DIR
"RTN","SCMCQK2",177,0)
 Q Y>0
"RTN","SCMCQK2",178,0)
CONFIRM() ;confirmation call
"RTN","SCMCQK2",179,0)
 N DIR,X,Y
"RTN","SCMCQK2",180,0)
 S DIR("A")="Are you sure (Yes/No)"
"RTN","SCMCQK2",181,0)
 S DIR(0)="Y"
"RTN","SCMCQK2",182,0)
 D ^DIR
"RTN","SCMCQK2",183,0)
 Q +Y=1
"RTN","SCMCQK2",184,0)
 ;
"RTN","SCMCQK2",185,0)
SELPOS() ;return way to select position: 1=PRACT,2=POSIT,3=NONE
"RTN","SCMCQK2",186,0)
 N DIR,X,Y
"RTN","SCMCQK2",187,0)
 W !,"Choose way to select NON PC POSITION Assignment: "
"RTN","SCMCQK2",188,0)
 S DIR(0)="SO^0:NONE;1:BY PRACTITIONER ASSIGNMENT;2:BY POSITION ASSIGNMENT"
"RTN","SCMCQK2",189,0)
 S DIR("B")=1
"RTN","SCMCQK2",190,0)
 D ^DIR
"RTN","SCMCQK2",191,0)
 Q $S(Y'>0:"",+Y=1:"PRACT",1:"POSIT")
"RTN","SCMCQK2",192,0)
 ;
"RTN","SCMCQK2",193,0)
DATE(TYPE,DFN) ;type=A(Assignment) or D(Unassignment) 
"RTN","SCMCQK2",194,0)
 ; Returns assignment/unassignment date or "^"
"RTN","SCMCQK2",195,0)
 I '$G(DFN) Q -1
"RTN","SCMCQK2",196,0)
 N DIR,X,Y,SDFLG,SDY
"RTN","SCMCQK2",197,0)
 ;SD*5.3*563 SDFLG=0 allow to proceed with date if prior to DOD
"RTN","SCMCQK2",198,0)
 F  D  Q:SDFLG=0
"RTN","SCMCQK2",199,0)
 .S DIR("A")=$S(TYPE="A":"Assignment",1:"Unassignment")_" date: "
"RTN","SCMCQK2",200,0)
 .S DIR(0)="DA^::EXP"
"RTN","SCMCQK2",201,0)
 .S Y=$S($D(SCDISCH):SCDISCH,$D(SCASSDT):SCASSDT,(TYPE="A"):"TODAY",1:"TODAY-1")
"RTN","SCMCQK2",202,0)
 .X ^DD("DD")
"RTN","SCMCQK2",203,0)
 .S DIR("B")=Y
"RTN","SCMCQK2",204,0)
 .D ^DIR K DIR S SDY=Y
"RTN","SCMCQK2",205,0)
 .I $D(DIRUT) K DIRUT,DUOUT,X,Y S SDFLG=0 Q
"RTN","SCMCQK2",206,0)
 .D WARNMESS^SCMCQK1(SDY,DFN,.SDFLG)
"RTN","SCMCQK2",207,0)
 Q SDY
"RTN","SCMCQK2",208,0)
PRACSCR(SC40452) ;screen for for file 404.52
"RTN","SCMCQK2",209,0)
 N SCP,SCNODE,OK
"RTN","SCMCQK2",210,0)
 S SCP=$G(^SCTM(404.52,SC40452,0))
"RTN","SCMCQK2",211,0)
 S OK=0
"RTN","SCMCQK2",212,0)
 G:'SCP QTPP
"RTN","SCMCQK2",213,0)
 S SCNODE=$G(^SCTM(404.57,+SCP,0))
"RTN","SCMCQK2",214,0)
 S OK=$S($P(SCNODE,U,2)'=SCTM:0,$P(SCNODE,U,4):0,($O(^SCTM(404.52,"AIDT",+SCP,1,""))'=-$P(SCP,U,2)):0,($O(^SCTM(404.52,"AIDT",+SCP,0,-$P(SCP,U,2)),-1)):0,($$ACTTP^SCMCTPU(+SCP)>0):1,1:0)
"RTN","SCMCQK2",215,0)
QTPP Q OK
"RTN","SCMCQK2",216,0)
 ;
"RTN","SCMCQK2",217,0)
POSSCR(SCTP) ;screen for file 404.57
"RTN","SCMCQK2",218,0)
 N SCNODE
"RTN","SCMCQK2",219,0)
 S SCNODE=$G(^SCTM(404.57,SCTP,0))
"RTN","SCMCQK2",220,0)
 Q $S($P(SCNODE,U,2)'=SCTM:0,$P(SCNODE,U,4):0,($$ACTTP^SCMCTPU(SCTP)>0):1,1:0)
"RTN","SCMCQK2",221,0)
 Q
"RTN","SCMCQK2",222,0)
NEW() ;
"RTN","SCMCQK2",223,0)
 F I=0:0 S I=$O(SCD(I)) Q:'I  I (+SCD(I))=(+Y) Q
"RTN","SCMCQK2",224,0)
 Q 'I
"RTN","SCMCU1")
0^4^B1877247
"RTN","SCMCU1",1,0)
SCMCU1 ;ALB/CMM - Team Information Display ;7/25/99  18:46
"RTN","SCMCU1",2,0)
 ;;5.3;Scheduling;**41,177**;AUG 13, 1993;Build 3
"RTN","SCMCU1",3,0)
 ;
"RTN","SCMCU1",4,0)
 ;action on Appointment Management
"RTN","SCMCU1",5,0)
 ;
"RTN","SCMCU1",6,0)
SEL ;selection - getting patient
"RTN","SCMCU1",7,0)
 N ENT
"RTN","SCMCU1",8,0)
 I '$D(@VALMAR@("IDX")) S TDFN=$$GETPT() Q
"RTN","SCMCU1",9,0)
 ; ^ no selections available, prompt for patient?
"RTN","SCMCU1",10,0)
 D EN^VALM2(XQORNOD(0),"S")
"RTN","SCMCU1",11,0)
 S ENT=$O(VALMY(0))
"RTN","SCMCU1",12,0)
 I ENT="" S TDFN=$$GETPT() Q
"RTN","SCMCU1",13,0)
 I '$D(^TMP("SDAMIDX",$J,ENT)) S TDFN=0 Q
"RTN","SCMCU1",14,0)
 S TDFN=+$P($G(^TMP("SDAMIDX",$J,ENT)),"^",2)
"RTN","SCMCU1",15,0)
 Q
"RTN","SCMCU1",16,0)
 ;
"RTN","SCMCU1",17,0)
GETPT() ;function to get patient
"RTN","SCMCU1",18,0)
 I $G(VALMHDR(1))?.E1"Patient:".E Q SDFN
"RTN","SCMCU1",19,0)
 N TDFN
"RTN","SCMCU1",20,0)
 S DIC="^DPT(",DIC(0)="AEQM",DIC("A")="Select Patient: "
"RTN","SCMCU1",21,0)
 D ^DIC
"RTN","SCMCU1",22,0)
 K DIC
"RTN","SCMCU1",23,0)
 I X=""!(X["^")!(+Y<0) S TDFN=0
"RTN","SCMCU1",24,0)
 S TDFN=+Y
"RTN","SCMCU1",25,0)
 Q TDFN
"RTN","SCMCU1",26,0)
 ;
"RTN","SCMCU1",27,0)
INIT ;gather team data
"RTN","SCMCU1",28,0)
 N GBL
"RTN","SCMCU1",29,0)
 I TDFN=0 S VALMQUIT="" Q
"RTN","SCMCU1",30,0)
 S GBL="^TMP(""SCTI"","_$J_")"
"RTN","SCMCU1",31,0)
 K @GBL
"RTN","SCMCU1",32,0)
 S SDLN=1
"RTN","SCMCU1",33,0)
 D CNTRL^VALM10(SDLN,15,45,IOINHI,IOINORM)
"RTN","SCMCU1",34,0)
 D TDATA^SDPPTEM(TDFN,.VALMCNT)
"RTN","SCMCU1",35,0)
 Q
"RTN","SCMCU1",36,0)
 ;
"RTN","SCMCU1",37,0)
HDR ;header code
"RTN","SCMCU1",38,0)
 N PTNAME
"RTN","SCMCU1",39,0)
 S PTNAME=$P($G(^DPT(TDFN,0)),"^")
"RTN","SCMCU1",40,0)
 S VALMHDR(2)="Patient: "_PTNAME_"     SSN: "_$P($G(^DPT(TDFN,0)),U,9)
"RTN","SCMCU1",41,0)
 S VALMPGE=1 ;start at page 1
"RTN","SCMCU1",42,0)
 Q
"RTN","SDAM10")
0^5^B8926237
"RTN","SDAM10",1,0)
SDAM10 ;MJK/ALB - Appt Mgt (Patient cont.); 3/18/05 3:51pm  ; Compiled March 31, 2008 16:38:47
"RTN","SDAM10",2,0)
 ;;5.3;Scheduling;**189,258,403,478,491**;Aug 13, 1993;Build 3
"RTN","SDAM10",3,0)
 ;
"RTN","SDAM10",4,0)
HDR ; -- list screen header
"RTN","SDAM10",5,0)
 ;   input:       SDFN := ifn of pat
"RTN","SDAM10",6,0)
 ;  output:  VALMHDR() := hdr array
"RTN","SDAM10",7,0)
 ;
"RTN","SDAM10",8,0)
 N VAERR,VA,X
"RTN","SDAM10",9,0)
 S DFN=SDFN D PID^VADPT
"RTN","SDAM10",10,0)
 S VALMHDR(1)=$E($P("Patient: "_$G(^DPT(SDFN,0)),U),1,46)_" ("_VA("BID")_")"  ;for proper display of patient name for SD*5.3*189
"RTN","SDAM10",11,0)
 S X=$P($$FMT^SDUTL2(SDFN),U,2),X=$S(X["GMT":X,X]"":"MT: "_X,1:"")
"RTN","SDAM10",12,0)
 S VALMHDR(1)=$$SETSTR^VALM1(X,VALMHDR(1),47,15)  ;repositioned header to display clinic or patient name properly for SD*5.3*189
"RTN","SDAM10",13,0)
 S X=$S($D(^DPT(SDFN,.1)):"Ward: "_^(.1),1:"Outpatient")
"RTN","SDAM10",14,0)
 S VALMHDR(1)=$$SETSTR^VALM1(X,VALMHDR(1),81-$L(X),$L(X))
"RTN","SDAM10",15,0)
 Q
"RTN","SDAM10",16,0)
 ;
"RTN","SDAM10",17,0)
PAT ; -- change pat
"RTN","SDAM10",18,0)
 K TMP ;SD/478
"RTN","SDAM10",19,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","SDAM10",20,0)
 K X I $D(XQORNOD(0)) S X=$P($P(XQORNOD(0),U,4),"=",2)
"RTN","SDAM10",21,0)
 I $D(X),X="" R !!,"Select Patient: ",X:DTIME
"RTN","SDAM10",22,0)
 D RT^SDAMEX S DIC="^DPT(",DIC(0)="EMQ" D ^DIC K DIC G PAT:X["?"
"RTN","SDAM10",23,0)
PAT1 S %=1 I Y>0 W !,"   ...OK" D YN^DICN I %=0 W "   Answer with 'Yes' or 'No'" G PAT1
"RTN","SDAM10",24,0)
 I %'=1 S Y=-1
"RTN","SDAM10",25,0)
 I Y<0 D  G PATQ
"RTN","SDAM10",26,0)
 .I $G(DFN)>0,SDAMTYP="P" S VALMSG=$C(7)_"Patient has not been changed."
"RTN","SDAM10",27,0)
 .I $G(DFN)'>0,SDAMTYP="P" S VALMSG=$C(7)_"Patient has not been selected."
"RTN","SDAM10",28,0)
 .I SDAMTYP="C" S VALMSG=$C(7)_"View of clinic remains in affect."
"RTN","SDAM10",29,0)
 .W !!,$G(VALMSG) H 1
"RTN","SDAM10",30,0)
 I SDAMTYP'="P" D CHGCAP^VALM("NAME","Clinic") S SDAMTYP="P"
"RTN","SDAM10",31,0)
 S (DFN,SDFN)=+Y K SDCLN,VADM D DEM^VADPT D BLD^SDAM1 ;SD/491
"RTN","SDAM10",32,0)
PATQ Q
"RTN","SDAM10",33,0)
 ;
"RTN","SDAM10",34,0)
INIT ; -- init bld vars
"RTN","SDAM10",35,0)
 K VALMHDR,SDDA,^TMP("SDAMIDX",$J)
"RTN","SDAM10",36,0)
 D CLEAN^VALM10
"RTN","SDAM10",37,0)
 S VALMBG=1,(VALMCNT,SDACNT)=0,BL="",$P(BL," ",30)="",SDMAX=100
"RTN","SDAM10",38,0)
 S SDAMDD=$P(^DD(2.98,3,0),U,3)
"RTN","SDAM10",39,0)
 ; -- format vars     |- column -| |- width -|
"RTN","SDAM10",40,0)
 S X=VALMDDF("APPT#"),AC=$P(X,U,2),AW=$P(X,U,3) ; A for appt
"RTN","SDAM10",41,0)
 S X=VALMDDF("DATE"),XC=$P(X,U,2),XW=$P(X,U,3) ;  X for date
"RTN","SDAM10",42,0)
 S X=VALMDDF("NAME"),NC=$P(X,U,2),NW=$P(X,U,3) ;  N for name
"RTN","SDAM10",43,0)
 S X=VALMDDF("STAT"),SC=$P(X,U,2),SW=$P(X,U,3) ;  S for status
"RTN","SDAM10",44,0)
 S X=VALMDDF("TIME"),TC=$P(X,U,2),TW=$P(X,U,3) ;  T for time
"RTN","SDAM10",45,0)
 S (CC,CW)="",X=$G(VALMDDF("CONSULT")) I X'="" S CC=$P(X,U,2),CW=$P(X,U,3) ;  C for Consult ;SD/478
"RTN","SDAM10",46,0)
 Q
"RTN","SDAM10",47,0)
 ;
"RTN","SDAM10",48,0)
LARGE ; -- too large note
"RTN","SDAM10",49,0)
 W !!?5,*7,"Note: Ending Date was changed to '",$$FDATE^VALM1(SDEND),"' because"
"RTN","SDAM10",50,0)
 W !?11,"too many appointments met date range criteria." D PAUSE^VALM1
"RTN","SDAM10",51,0)
 Q
"RTN","SDAM10",52,0)
 ;
"RTN","SDAM10",53,0)
NUL ; -- set nul message
"RTN","SDAM10",54,0)
 I '$O(^TMP("SDAM",$J,0)) D SET^SDAM1(" "),SET^SDAM1("    No appointments meet criteria.")
"RTN","SDAM10",55,0)
 Q
"RTN","SDAM10",56,0)
 ;
"RTN","SDAM2")
0^6^B28969353
"RTN","SDAM2",1,0)
SDAM2 ;ALB/MJK - Appt Mgt (cont); 8/18/05 12:10pm  ; Compiled April 16, 2007 09:43:32
"RTN","SDAM2",2,0)
 ;;5.3;Scheduling;**250,296,327,478,446**;Aug 13, 1993;Build 3
"RTN","SDAM2",3,0)
 ;
"RTN","SDAM2",4,0)
CI ; -- protocol SDAM APPT CHECK IN entry pt
"RTN","SDAM2",5,0)
 ; input:  VALMY := array entries
"RTN","SDAM2",6,0)
 ;
"RTN","SDAM2",7,0)
 N %,SDI,SDAT,VALMY,SDAMCIDT,SDCIACT
"RTN","SDAM2",8,0)
 D SEL^VALM2 S SDI=0,SDCIACT=""
"RTN","SDAM2",9,0)
 D NOW^%DTC S SDAMCIDT=$P(%,".")_"."_$E($P(%,".",2)_"0000",1,4)
"RTN","SDAM2",10,0)
 F  S SDI=$O(VALMY(SDI)) Q:'SDI  I $D(^TMP("SDAMIDX",$J,SDI)) K SDAT D
"RTN","SDAM2",11,0)
 .S SDAT=^TMP("SDAMIDX",$J,SDI)
"RTN","SDAM2",12,0)
 .W !,^TMP("SDAM",$J,+SDAT,0)
"RTN","SDAM2",13,0)
 .D:VALMCC SELECT^VALM10(+SDAT,1)
"RTN","SDAM2",14,0)
 .D ONE($P(SDAT,U,2),$P(SDAT,U,4),$P(SDAT,U,3),$P(SDAT,U,5),0,SDAMCIDT)
"RTN","SDAM2",15,0)
 .D:VALMCC SELECT^VALM10(+SDAT,0)
"RTN","SDAM2",16,0)
 S VALMBCK=$S(VALMCC:"",1:"R")
"RTN","SDAM2",17,0)
 Q
"RTN","SDAM2",18,0)
 ;
"RTN","SDAM2",19,0)
ONE(DFN,SDCL,SDT,SDDA,SDASK,SDAMCIDT) ; -- check in one appt
"RTN","SDAM2",20,0)
 ; input:  DFN := ifn of patient
"RTN","SDAM2",21,0)
 ;        SDCL := clinic# 
"RTN","SDAM2",22,0)
 ;         SDT := appt d/t
"RTN","SDAM2",23,0)
 ;        SDDA := ifn in ^SC multiple or null
"RTN","SDAM2",24,0)
 ;       SDASK := ask d/t of ci always [1|yes or 0|no]
"RTN","SDAM2",25,0)
 ;    SDAMCIDT := ci date/time [optional]
"RTN","SDAM2",26,0)
 ;
"RTN","SDAM2",27,0)
 I $D(XRTL) D T0^%ZOSV
"RTN","SDAM2",28,0)
 S:'SDDA SDDA=$$FIND(DFN,SDT,SDCL)
"RTN","SDAM2",29,0)
 I 'SDDA W !!,*7,"You cannot check in this appointment." D PAUSE^VALM1 G ONEQ
"RTN","SDAM2",30,0)
 N SDATA,SDCIHDL,X S SDATA=SDDA_U_DFN_U_SDT_U_SDCL,SDCIHDL=$$HANDLE^SDAMEVT(1)
"RTN","SDAM2",31,0)
 D BEFORE^SDAMEVT(.SDATA,DFN,SDT,SDCL,SDDA,SDCIHDL)
"RTN","SDAM2",32,0)
 I '$D(^SD(409.63,"ACI",1,+SDATA("BEFORE","STATUS"))) W !!,*7,"You cannot check in this appointment." D PAUSE^VALM1 G ONEQ
"RTN","SDAM2",33,0)
 ; *** mt blocking removed
"RTN","SDAM2",34,0)
 ;S X="EASMTCHK" X ^%ZOSF("TEST") I $T,$G(EASACT)'="W",$$MT^EASMTCHK(DFN,"","C",SDT) D PAUSE^VALM1 G ONEQ
"RTN","SDAM2",35,0)
 I $P(SDT,".")>DT W !!,*7,"It is too soon to check in this appointment." D PAUSE^VALM1 G ONEQ
"RTN","SDAM2",36,0)
 S:'$D(^SC(SDCL,"S",0)) ^(0)="^44.001DA^^"
"RTN","SDAM2",37,0)
 S DR="",X=$G(^SC(SDCL,"S",SDT,1,SDDA,"C"))
"RTN","SDAM2",38,0)
 I +X S DR=309
"RTN","SDAM2",39,0)
 ; -- already co'ed
"RTN","SDAM2",40,0)
 I DR="",$P(X,U,3) D
"RTN","SDAM2",41,0)
 .S DR="309//"
"RTN","SDAM2",42,0)
 .I $P(^SC(SDCL,0),U,24)!(SDASK) S DR=DR_$$FTIME^VALM1($P(X,U,3)) Q
"RTN","SDAM2",43,0)
 .S DR=DR_"//^S X="_$P(X,U,3)
"RTN","SDAM2",44,0)
 ;
"RTN","SDAM2",45,0)
 I DR="",$P(^SC(SDCL,0),U,24)!(SDASK) S DR="309//"_$S(SDAMCIDT:$$FTIME^VALM1(SDAMCIDT),1:"NOW")
"RTN","SDAM2",46,0)
 I DR="" S DR="309///"_$S(SDAMCIDT:"/"_SDAMCIDT,1:"NOW")
"RTN","SDAM2",47,0)
 S DA(2)=SDCL,DA(1)=SDT,DA=SDDA,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1," D ^DIE
"RTN","SDAM2",48,0)
 D AFTER^SDAMEVT(.SDATA,DFN,SDT,SDCL,SDDA,SDCIHDL)
"RTN","SDAM2",49,0)
 I '$P(SDATA("AFTER","STATUS"),U,4),'$P(SDATA("BEFORE","STATUS"),U,4) W !?8,*7,"...appointment has not been checked in" D PAUSE^VALM1
"RTN","SDAM2",50,0)
 I SDATA("BEFORE","STATUS")'=SDATA("AFTER","STATUS") D
"RTN","SDAM2",51,0)
 .I $P(SDATA("AFTER","STATUS"),U,4),'$P(SDATA("BEFORE","STATUS"),U,4) W !?8,"...checked in ",$$FTIME^VALM1($P(SDATA("AFTER","STATUS"),U,4))
"RTN","SDAM2",52,0)
 .I $D(SDCIACT) D
"RTN","SDAM2",53,0)
 ..S Y=SDATA("AFTER","STATUS"),Y1=$P(Y,U,4),Y=$P(Y,U,3)
"RTN","SDAM2",54,0)
 ..I $P(SDATA("BEFORE","STATUS"),U,3)'=Y D UPD($$LOWER^VALM1(Y),"STAT",+SDAT,1),UPD("","TIME",+SDAT,1)
"RTN","SDAM2",55,0)
 ..I $P(SDATA("AFTER","STATUS"),U,3)["CHECKED IN" D UPD($S($P(Y1,".")=DT:$$TIME^SDAM1($P(Y1,".",2)),1:"     "),"TIME",+SDAT,1)
"RTN","SDAM2",56,0)
 .D EVT^SDAMEVT(.SDATA,4,0,SDCIHDL) ; 4 := ci evt , 0 := interactive mode
"RTN","SDAM2",57,0)
 I $D(XRT0) S XRTN="SDAM2" D T1^%ZOSV
"RTN","SDAM2",58,0)
ONEQ K DA,DIE,DR,DQ,DE,Y,Y1 Q
"RTN","SDAM2",59,0)
 ;
"RTN","SDAM2",60,0)
 ;
"RTN","SDAM2",61,0)
FIND(DFN,SDT,SDCL) ; -- return appt ifn for pat
"RTN","SDAM2",62,0)
 ;   input:        DFN := ifn of pat.
"RTN","SDAM2",63,0)
 ;                 SDT := appt d/t
"RTN","SDAM2",64,0)
 ;                SDCL := ifn of clinic
"RTN","SDAM2",65,0)
 ;  output: [returned] := ifn if pat has appt on date/time
"RTN","SDAM2",66,0)
 ;
"RTN","SDAM2",67,0)
 N Y
"RTN","SDAM2",68,0)
 S Y=0 F  S Y=$O(^SC(SDCL,"S",SDT,1,Y)) Q:'Y  I $D(^(Y,0)),DFN=+^(0),$D(^DPT(+DFN,"S",SDT,0)),$$VALID(DFN,SDCL,SDT,Y) S CNSTLNK=$P($G(^SC(SDCL,"S",SDT,1,Y,"CONS")),U) K:CNSTLNK="" CNSTLNK Q  ;SD/478
"RTN","SDAM2",69,0)
 Q Y
"RTN","SDAM2",70,0)
 ;
"RTN","SDAM2",71,0)
UPD(TEXT,FLD,LINE,SAVE) ; -- update data for screen
"RTN","SDAM2",72,0)
 D FLDTEXT^VALM10(LINE,FLD,TEXT)
"RTN","SDAM2",73,0)
 D:VALMCC CNTRL^VALM10(LINE,$P(VALMDDF(FLD),U,2),$P(VALMDDF(FLD),U,3),IOINHI,IOINORM,+$G(SAVE))
"RTN","SDAM2",74,0)
 Q
"RTN","SDAM2",75,0)
 ;
"RTN","SDAM2",76,0)
MAKE ; -- make appt action
"RTN","SDAM2",77,0)
 N ORACTION,ORVP,XQORQUIT,SDAMERR
"RTN","SDAM2",78,0)
 D FULL^VALM1
"RTN","SDAM2",79,0)
 W !!,VALMHDR(1)
"RTN","SDAM2",80,0)
 D ^SDM
"RTN","SDAM2",81,0)
 I '$D(SDAMERR) D BLD^SDAM
"RTN","SDAM2",82,0)
 I $D(SDAMERR) D PAUSE^VALM1
"RTN","SDAM2",83,0)
 D SDM^SDKILL S VALMBCK="R"
"RTN","SDAM2",84,0)
 Q
"RTN","SDAM2",85,0)
 ;
"RTN","SDAM2",86,0)
WI ; -- walk-in visit action
"RTN","SDAM2",87,0)
 S VALMBCK="R"
"RTN","SDAM2",88,0)
 D FULL^VALM1
"RTN","SDAM2",89,0)
 I SDAMTYP="P" I $$CL^SDAMWI(SDFN) D BLD^SDAM1
"RTN","SDAM2",90,0)
 I SDAMTYP="C" I $$PT^SDAMWI(SDCLN) D BLD^SDAM3
"RTN","SDAM2",91,0)
 ;evaluate wait list ;SD/327
"RTN","SDAM2",92,0)
EWLCHK ;check if patient has any open EWL entries (SD/372)
"RTN","SDAM2",93,0)
 ;CLN expected as clinic IEN
"RTN","SDAM2",94,0)
 I '$D(DFN) Q
"RTN","SDAM2",95,0)
 Q:'$D(SDT)
"RTN","SDAM2",96,0)
 K ^TMP($J,"SDAMA301"),^TMP($J,"APPT")
"RTN","SDAM2",97,0)
 N SD S SD=SDT
"RTN","SDAM2",98,0)
 I '$D(SC) S SC=+$G(CLN)
"RTN","SDAM2",99,0)
 ;
"RTN","SDAM2",100,0)
 K ^TMP($J,"SDAMA301"),^TMP($J,"APPT")
"RTN","SDAM2",101,0)
 W:$D(IOF) @IOF D APPT^SDWLEVAL(DFN,SD,SC)
"RTN","SDAM2",102,0)
 Q:'$D(^TMP($J,"APPT"))
"RTN","SDAM2",103,0)
 N SDEV D EN^SDWLEVAL(DFN,.SDEV) I SDEV,$L(SDEV(1))>0 D
"RTN","SDAM2",104,0)
 .K ^TMP("SDWLPL",$J),^TMP($J,"SDWLPL")
"RTN","SDAM2",105,0)
 .D INIT^SDWLPL(DFN,"M")
"RTN","SDAM2",106,0)
 .Q:'$D(^TMP($J,"SDWLPL"))
"RTN","SDAM2",107,0)
 .D LIST^SDWLPL("M",DFN)
"RTN","SDAM2",108,0)
 .F  Q:'$D(^TMP($J,"SDWLPL"))  N SDR D ANSW^SDWLEVAL(1,.SDR) I 'SDR D LIST^SDWLPL("M",DFN) D
"RTN","SDAM2",109,0)
 ..F  N SDR  D ANSW^SDWLEVAL(0,.SDR) Q:'$D(^TMP($J,"SDWLPL"))  I 'SDR W !,"MUST ENTER A REASON NOT TO DISPOSITION MATCHED EWL ENTRY",!
"RTN","SDAM2",110,0)
 I $D(^TMP($J,"APPT")) N SDEV D EN^SDWLEVAL(DFN,.SDEV) I SDEV,$L(SDEV(1))>0 D
"RTN","SDAM2",111,0)
 .Q:'$D(^TMP($J,"SDWLPL"))  D ASKREM^SDWLEVAL S SDCTN=1 ;display and process selected open EWL entries
"RTN","SDAM2",112,0)
 .Q
"RTN","SDAM2",113,0)
 Q
"RTN","SDAM2",114,0)
 ;
"RTN","SDAM2",115,0)
DATE ; -- change date range
"RTN","SDAM2",116,0)
 S VALMB=SDBEG D RANGE^VALM11
"RTN","SDAM2",117,0)
 I $S('VALMBEG:1,SDBEG'=VALMBEG:0,1:SDEND=VALMEND) W !!,"Date range was not changed." D PAUSE^VALM1 S VALMBCK="" G DATEQ
"RTN","SDAM2",118,0)
 S SDBEG=VALMBEG,SDEND=VALMEND
"RTN","SDAM2",119,0)
 I SDAMTYP="P" D BLD^SDAM1
"RTN","SDAM2",120,0)
 I SDAMTYP="C" D BLD^SDAM3
"RTN","SDAM2",121,0)
 S VALMBCK="R"
"RTN","SDAM2",122,0)
DATEQ K VALMB,VALMBEG,VALMEND Q
"RTN","SDAM2",123,0)
 ;
"RTN","SDAM2",124,0)
INP(DFN,VDATE) ; -- determine inpat status ; dom is not an inpat appt
"RTN","SDAM2",125,0)
 N SDINP,VAINDT,VADMVT
"RTN","SDAM2",126,0)
 S SDINP="",VAINDT=VDATE D ADM^VADPT2 G INPQ:'VADMVT
"RTN","SDAM2",127,0)
 I $P(^DG(43,1,0),U,21),$P($G(^DIC(42,+$P($G(^DGPM(VADMVT,0)),U,6),0)),U,3)="D" G INPQ
"RTN","SDAM2",128,0)
 S SDINP="I"
"RTN","SDAM2",129,0)
INPQ Q SDINP
"RTN","SDAM2",130,0)
 ;
"RTN","SDAM2",131,0)
VALID(DFN,SDCL,SDT,SDDA) ; -- return valid appt.
"RTN","SDAM2",132,0)
 ; **NOTE:  For speed consideration the ^SC and ^DPT nodes must be
"RTN","SDAM2",133,0)
 ;          check to see they exist prior to calling this entry point.
"RTN","SDAM2",134,0)
 ;   input:        DFN := ifn of pat.
"RTN","SDAM2",135,0)
 ;                 SDT := appt d/t
"RTN","SDAM2",136,0)
 ;                SDCL := ifn of clinic
"RTN","SDAM2",137,0)
 ;                SDDA := ifn of appt
"RTN","SDAM2",138,0)
 ;  output: [returned] := 1 for valid appt., 0 for not valid
"RTN","SDAM2",139,0)
 Q $S($P(^SC(SDCL,"S",SDT,1,SDDA,0),U,9)'="C":1,$P(^DPT(DFN,"S",SDT,0),U,2)["C":1,1:0)
"RTN","SDAM3")
0^7^B10895275
"RTN","SDAM3",1,0)
SDAM3 ;MJK/ALB - Appt Mgt (Clinic) ; 4/21/05 12:23pm
"RTN","SDAM3",2,0)
 ;;5.3;Scheduling;**63,189,380,478,492**;Aug 13, 1993;Build 3
"RTN","SDAM3",3,0)
 ;
"RTN","SDAM3",4,0)
INIT ; -- get init clinic appt data
"RTN","SDAM3",5,0)
 ;  input:        SDCLN := ifn of pat
"RTN","SDAM3",6,0)
 ; output:  ^TMP("SDAM" := appt array
"RTN","SDAM3",7,0)
 S X=$P($G(^DG(43,1,"SCLR")),U,12),SDPRD=$S(X:X,1:2)
"RTN","SDAM3",8,0)
 S X1=DT,X2=-SDPRD D C^%DTC S VALMB=X D RANGE^VALM11
"RTN","SDAM3",9,0)
 I '$D(VALMBEG) S VALMQUIT="" G INITQ
"RTN","SDAM3",10,0)
 S SDBEG=VALMBEG,SDEND=VALMEND
"RTN","SDAM3",11,0)
 D CHGCAP^VALM("NAME","Patient")
"RTN","SDAM3",12,0)
 S X="NO ACTION TAKEN" D LIST^SDAM
"RTN","SDAM3",13,0)
INITQ K VALMB,VALMBEG,VALMEND Q
"RTN","SDAM3",14,0)
 ;
"RTN","SDAM3",15,0)
BLD ; -- scan apts
"RTN","SDAM3",16,0)
 N VA,SDAMDD,SDNAME,SDMAX,SDLARGE,DFN,SDCL,BL,XC,XW,AC,AW,TC,TW,NC,NW,SC,SW,SDT,SDDA ; done for speed see INIT^SDAM10
"RTN","SDAM3",17,0)
 D INIT^SDAM10
"RTN","SDAM3",18,0)
 F SDT=SDBEG:0 S SDT=$O(^SC(SDCLN,"S",SDT)) Q:'SDT!($P(SDT,".",1)>SDEND)  D
"RTN","SDAM3",19,0)
 .F SDDA=0:0 S SDDA=$O(^SC(SDCLN,"S",SDT,1,SDDA)) Q:'SDDA  S CNSTLNK=$P($G(^SC(SDCLN,"S",SDT,1,SDDA,"CONS")),U),CSTAT="" S:CNSTLNK'="" CSTAT=$P($G(^GMR(123,CNSTLNK,0)),U,12) D  ;SD/478
"RTN","SDAM3",20,0)
 ..I $D(^SC(SDCLN,"S",SDT,1,SDDA,0)) S DFN=+^(0) D             ;SD/492
"RTN","SDAM3",21,0)
 ...N NDX,DA,FND                                               ;SD/492
"RTN","SDAM3",22,0)
 ...S (FND,NDX)=""                                             ;SD/492
"RTN","SDAM3",23,0)
 ...F  S NDX=$O(^TMP("SDAMIDX",$J,NDX)) Q:NDX=""  D  Q:FND     ;SD/492
"RTN","SDAM3",24,0)
 ....S DA=^TMP("SDAMIDX",$J,NDX)                               ;SD/492
"RTN","SDAM3",25,0)
 ....I $P(DA,U,2)=DFN,$P(DA,U,3)=SDT,$P(DA,U,4)=SDCLN S FND=1  ;SD/492
"RTN","SDAM3",26,0)
 ...Q:FND                                                      ;SD/492
"RTN","SDAM3",27,0)
 ...D PID^VADPT I $D(^DPT(DFN,"S",SDT,0)),$$VALID^SDAM2(DFN,SDCLN,SDT,SDDA) S SDATA=^DPT(DFN,"S",SDT,0),SDCL=SDCLN,SDNAME=VA("BID")_" "_$P($G(^DPT(DFN,0)),U) D:SDCLN=+SDATA BLD1^SDAM1  ;SD/478,492
"RTN","SDAM3",28,0)
 D NUL^SDAM10,LARGE^SDAM10:$D(SDLARGE)
"RTN","SDAM3",29,0)
 S $P(^TMP("SDAM",$J,0),U,4)=VALMCNT
"RTN","SDAM3",30,0)
 Q
"RTN","SDAM3",31,0)
 ;
"RTN","SDAM3",32,0)
HDR ; -- list screen header
"RTN","SDAM3",33,0)
 ;   input:      SDCLN := ifn of pat
"RTN","SDAM3",34,0)
 ;  output:  VALMHDR() := hdr array
"RTN","SDAM3",35,0)
 ;
"RTN","SDAM3",36,0)
 S VALMHDR(1)=$E($P("Clinic: "_$G(^SC(SDCLN,0)),"^",1),1,45)  ;for proper display of clinic name for SD*5.3*189
"RTN","SDAM3",37,0)
 Q
"RTN","SDAM3",38,0)
 ;
"RTN","SDAM3",39,0)
CLN ; -- change clinic
"RTN","SDAM3",40,0)
 I $G(SDAMLIST)["CANCELLED" S VALMBCK="" W !!,*7,"You must be viewing a patient to list cancelled appointments." D PAUSE^VALM1 G CLNQ
"RTN","SDAM3",41,0)
 D FULL^VALM1 S VALMBCK="R"
"RTN","SDAM3",42,0)
 S X="" I $D(XQORNOD(0)) S X=$P($P(XQORNOD(0),U,4),"=",2)
"RTN","SDAM3",43,0)
 W ! S DIC="^SC(",DIC(0)=$S(X]"":"",1:"A")_"EMQ",DIC("A")="Select Clinic: ",DIC("S")="I $P(^(0),U,3)=""C"",'$G(^(""OOS""))"
"RTN","SDAM3",44,0)
 D ^DIC K DIC
"RTN","SDAM3",45,0)
 I Y<0 D  G CLNQ
"RTN","SDAM3",46,0)
 .I SDAMTYP="C" S VALMSG=$C(7)_"Clinic has not been changed."
"RTN","SDAM3",47,0)
 .I SDAMTYP="P" S VALMSG=$C(7)_"View of patient remains in affect."
"RTN","SDAM3",48,0)
 I SDAMTYP'="C" D CHGCAP^VALM("NAME","Patient") S SDAMTYP="C"
"RTN","SDAM3",49,0)
 N SDRES I SDAMTYP="C" S SDRES=$$CLNCK^SDUTL2(+Y,1) I 'SDRES D  G CLNQ
"RTN","SDAM3",50,0)
 .W !,?5,"Clinic MUST be corrected before continuing." D PAUSE^VALM1
"RTN","SDAM3",51,0)
 S SDCLN=+Y K SDFN D BLD
"RTN","SDAM3",52,0)
CLNQ Q
"RTN","SDAM3",53,0)
 ;
"RTN","SDAMEP1")
0^8^B26683496
"RTN","SDAMEP1",1,0)
SDAMEP1 ;ALB/CAW - Expanded Display (Appt. Data) ; 16 May 2001  4:49 PM  ; Compiled August 22, 2008 12:24:32
"RTN","SDAMEP1",2,0)
 ;;5.3;Scheduling;**20,241,534**;Aug 13, 1993;Build 3
"RTN","SDAMEP1",3,0)
 ;
"RTN","SDAMEP1",4,0)
APDATA ; Appointment Data
"RTN","SDAMEP1",5,0)
 ;
"RTN","SDAMEP1",6,0)
 D SET($$SETSTR^VALM1("*** Appointment Demographics ***","",24,32))
"RTN","SDAMEP1",7,0)
 D CNTRL^VALM10(SDLN,24,32,IOINHI,IOINORM)
"RTN","SDAMEP1",8,0)
 D SET("")
"RTN","SDAMEP1",9,0)
 ;
"RTN","SDAMEP1",10,0)
 S X=""
"RTN","SDAMEP1",11,0)
 S X=$$SETSTR^VALM1("           Name:",X,1,SDWIDTH)
"RTN","SDAMEP1",12,0)
 S X=$$SETSTR^VALM1($P($G(^DPT(DFN,0)),U),X,SDFSTCOL,24)
"RTN","SDAMEP1",13,0)
 S X=$$SETSTR^VALM1("         Clinic:",X,40,SDWIDTH)
"RTN","SDAMEP1",14,0)
 S X=$$SETSTR^VALM1($P($G(^SC(SDCL,0)),U),X,SDSECCOL,24)
"RTN","SDAMEP1",15,0)
 D SET(X)
"RTN","SDAMEP1",16,0)
 ;
"RTN","SDAMEP1",17,0)
 S X=""
"RTN","SDAMEP1",18,0)
 S X=$$SETSTR^VALM1("             ID:",X,1,SDWIDTH)
"RTN","SDAMEP1",19,0)
 S X=$$SETSTR^VALM1(VA("PID"),X,SDFSTCOL,24)
"RTN","SDAMEP1",20,0)
 S X=$$SETSTR^VALM1("      Date/Time:",X,40,SDWIDTH)
"RTN","SDAMEP1",21,0)
 S X=$$SETSTR^VALM1($$FTIME^VALM1(SDT),X,SDSECCOL,24)
"RTN","SDAMEP1",22,0)
 D SET(X)
"RTN","SDAMEP1",23,0)
 ;
"RTN","SDAMEP1",24,0)
 S X=""
"RTN","SDAMEP1",25,0)
 S X=$$SETSTR^VALM1("         Status:",X,1,SDWIDTH)
"RTN","SDAMEP1",26,0)
 S X=$$SETSTR^VALM1($P($$STATUS^SDAM1(DFN,SDT,SDCL,$G(^DPT(DFN,"S",SDT,0)),SDDA),";",3),X,SDFSTCOL,50)
"RTN","SDAMEP1",27,0)
 D SET(X)
"RTN","SDAMEP1",28,0)
 ;
"RTN","SDAMEP1",29,0)
 S SDPV=$P($G(^DPT(DFN,"S",SDT,0)),U,7),SDPOV=$S(SDPV=1:"C&P",SDPV=2:"10-10",SDPV=3:"SCHEDULED",SDPV=4:"UNSCHEDULED",1:"UNKNOWN")
"RTN","SDAMEP1",30,0)
 S X="",X=$$SETSTR^VALM1("Purpose of Vst.:",X,1,16)
"RTN","SDAMEP1",31,0)
 S X=$$SETSTR^VALM1(SDPOV,X,SDFSTCOL,24)
"RTN","SDAMEP1",32,0)
 D SET(X)
"RTN","SDAMEP1",33,0)
 ;
"RTN","SDAMEP1",34,0)
 S X=""
"RTN","SDAMEP1",35,0)
 S X=$$SETSTR^VALM1(" Length of Appt:",X,1,SDWIDTH)
"RTN","SDAMEP1",36,0)
 S X=$$SETSTR^VALM1($G(SDSC(44.003,SDDA,1)),X,SDFSTCOL,4)
"RTN","SDAMEP1",37,0)
 S X=$$SETSTR^VALM1("      Appt Type:",X,40,SDWIDTH)
"RTN","SDAMEP1",38,0)
 S X=$$SETSTR^VALM1(SDPT(2.98,SDT,9.5),X,SDSECCOL,24)
"RTN","SDAMEP1",39,0)
 D SET(X)
"RTN","SDAMEP1",40,0)
 ;
"RTN","SDAMEP1",41,0)
 S X=""
"RTN","SDAMEP1",42,0)
 S X=$$SETSTR^VALM1("            Lab:",X,1,SDWIDTH)
"RTN","SDAMEP1",43,0)
 S X=$$SETSTR^VALM1($P(SDPT(2.98,SDT,5),"@",2),X,SDFSTCOL,5)
"RTN","SDAMEP1",44,0)
 S X=$$SETSTR^VALM1("   Elig of Appt:",X,40,SDWIDTH)
"RTN","SDAMEP1",45,0)
 S X=$$SETSTR^VALM1($G(SDSC(44.003,SDDA,30)),X,SDSECCOL,24)
"RTN","SDAMEP1",46,0)
 D SET(X)
"RTN","SDAMEP1",47,0)
 ;
"RTN","SDAMEP1",48,0)
 S X=""
"RTN","SDAMEP1",49,0)
 S X=$$SETSTR^VALM1("          X-ray:",X,1,SDWIDTH)
"RTN","SDAMEP1",50,0)
 S X=$$SETSTR^VALM1($P(SDPT(2.98,SDT,6),"@",2),X,SDFSTCOL,5)
"RTN","SDAMEP1",51,0)
 S X=$$SETSTR^VALM1("       Overbook:",X,40,SDWIDTH)
"RTN","SDAMEP1",52,0)
 S X=$$SETSTR^VALM1($G(SDSC(44.003,SDDA,9)),X,SDSECCOL,24)
"RTN","SDAMEP1",53,0)
 D SET(X)
"RTN","SDAMEP1",54,0)
 ;
"RTN","SDAMEP1",55,0)
 S X=""
"RTN","SDAMEP1",56,0)
 S X=$$SETSTR^VALM1("            EKG:",X,1,SDWIDTH)
"RTN","SDAMEP1",57,0)
 S X=$$SETSTR^VALM1($P(SDPT(2.98,SDT,7),"@",2),X,SDFSTCOL,5)
"RTN","SDAMEP1",58,0)
 S X=$$SETSTR^VALM1("Collateral Appt:",X,40,SDWIDTH)
"RTN","SDAMEP1",59,0)
 S X=$$SETSTR^VALM1($G(SDPT(2.98,SDT,13)),X,SDSECCOL,17)
"RTN","SDAMEP1",60,0)
 D SET(X)
"RTN","SDAMEP1",61,0)
 ;
"RTN","SDAMEP1",62,0)
 S X=""
"RTN","SDAMEP1",63,0)
 N SDINFL S SDINFL=$L($G(SDSC(44.003,SDDA,3))) ; lenght of INFO STRING
"RTN","SDAMEP1",64,0)
 I SDINFL<64 D
"RTN","SDAMEP1",65,0)
 .S X=$$SETSTR^VALM1("          Other:",X,1,SDWIDTH)
"RTN","SDAMEP1",66,0)
 .S X=$$SETSTR^VALM1($G(SDSC(44.003,SDDA,3)),X,SDFSTCOL,63)
"RTN","SDAMEP1",67,0)
 I SDINFL>63&(SDINFL<143) D
"RTN","SDAMEP1",68,0)
 .S X=$$SETSTR^VALM1("          Other:",X,1,SDWIDTH)
"RTN","SDAMEP1",69,0)
 .S X=$$SETSTR^VALM1($E($G(SDSC(44.003,SDDA,3)),1,64),X,17,80)
"RTN","SDAMEP1",70,0)
 .D SET(X)
"RTN","SDAMEP1",71,0)
 .S X=$$SETSTR^VALM1("",X,1,0)
"RTN","SDAMEP1",72,0)
 .S X=$$SETSTR^VALM1($E($G(SDSC(44.003,SDDA,3)),65,150),X,1,80)
"RTN","SDAMEP1",73,0)
 I SDINFL>142 D
"RTN","SDAMEP1",74,0)
 .S X=$$SETSTR^VALM1("   Other:",X,1,10)
"RTN","SDAMEP1",75,0)
 .S X=$$SETSTR^VALM1($E($G(SDSC(44.003,SDDA,3)),1,70),X,11,80)
"RTN","SDAMEP1",76,0)
 .D SET(X)
"RTN","SDAMEP1",77,0)
 .S X=$$SETSTR^VALM1("",X,1,0)
"RTN","SDAMEP1",78,0)
 .S X=$$SETSTR^VALM1($E($G(SDSC(44.003,SDDA,3)),71,150),X,1,80)
"RTN","SDAMEP1",79,0)
 D SET(X)
"RTN","SDAMEP1",80,0)
 ;
"RTN","SDAMEP1",81,0)
 S (X,SDEIC)="" F SDI=0:0 S SDI=$O(^DPT(DFN,"DE",SDI)) Q:'SDI  I $P(^(SDI,0),U)=SDCL F SDX=0:0 S SDX=$O(^DPT(DFN,"DE",SDI,1,SDX)) Q:'SDX  S SDEN=$G(^DPT(DFN,"DE",SDI,1,SDX,0))
"RTN","SDAMEP1",82,0)
 D ENROLL
"RTN","SDAMEP1",83,0)
 D SET($S($D(SDFLG):X,1:" "))
"RTN","SDAMEP1",84,0)
 S X="",X=$$SETSTR^VALM1($S('$D(SDEN):"",$P(SDEN,U)="":"",$P(SDEN,U,3)="":"Enrollment Date/Time:",1:""),X,4,21)
"RTN","SDAMEP1",85,0)
 I $D(SDEN),+SDEN,$P(SDEN,U,3)="" S X=$$SETSTR^VALM1($$FTIME^VALM1($P(SDEN,U)),X,26,18)
"RTN","SDAMEP1",86,0)
 D SET(X)
"RTN","SDAMEP1",87,0)
 Q
"RTN","SDAMEP1",88,0)
 ;
"RTN","SDAMEP1",89,0)
ENROLL ;
"RTN","SDAMEP1",90,0)
 S SDFLG=1
"RTN","SDAMEP1",91,0)
 S X="",X=$$SETSTR^VALM1("Enrolled in this clinic:",X,1,25)
"RTN","SDAMEP1",92,0)
 S X=$$SETSTR^VALM1($S('$D(SDEN):"NO",$P(SDEN,U)="":"NO",$P(SDEN,U,3)'="":"NO",1:"YES"),X,26,3)
"RTN","SDAMEP1",93,0)
 S X=$$SETSTR^VALM1($S('$D(SDEN):"",$P(SDEN,U)="":"",$P(SDEN,U,3)="":" OPT or AC:",$P(SDEN,U,3)'="":"Disch fm Clinic:",1:""),X,44,17)
"RTN","SDAMEP1",94,0)
 I $D(SDEN),+SDEN,$P(SDEN,U,3)="" S X=$$SETSTR^VALM1($S($P(SDEN,U,2)="A":"AC",1:"OPT"),X,SDSECCOL,3)
"RTN","SDAMEP1",95,0)
 I $D(SDEN),+SDEN,$P(SDEN,U,3)'="" S X=$$SETSTR^VALM1($$FTIME^VALM1($P(SDEN,U,3)),X,62,17)
"RTN","SDAMEP1",96,0)
 Q
"RTN","SDAMEP1",97,0)
SET(X) ; Set in ^TMP global for display
"RTN","SDAMEP1",98,0)
 ;
"RTN","SDAMEP1",99,0)
 S SDLN=SDLN+1,^TMP("SDAMEP",$J,SDLN,0)=X
"RTN","SDAMEP1",100,0)
 Q
"RTN","SDAMEP1",101,0)
 ;
"RTN","SDAMEP1",102,0)
INIT ; -- set up vars
"RTN","SDAMEP1",103,0)
 N DR,DIQ,DIC,DA
"RTN","SDAMEP1",104,0)
 D PID^VADPT6
"RTN","SDAMEP1",105,0)
 S SDFSTCOL=18,SDWIDTH=16,SDSECCOL=57
"RTN","SDAMEP1",106,0)
 I SDDA="" S SDDA=+$$FIND^SDAM2(DFN,SDT,SDCL)
"RTN","SDAMEP1",107,0)
 S SDOE=+$P($G(^DPT(DFN,"S",SDT,0)),"^",20)
"RTN","SDAMEP1",108,0)
 S DIQ="SDPT(",DIC="^DPT(DFN,""S"",",DA=SDT,DR=".01;3;5;6;7;12;13;14;15;16;9.5;17;19;20;25;26;27;28" D EN^DIQ1
"RTN","SDAMEP1",109,0)
 S DIQ="SDSC(",DIC="^SC(SDCL,""S"",SDT,1,",DA=SDDA,DR="1;3;7;8;9;30;309;302;303;304;306" D EN^DIQ1
"RTN","SDAMEP1",110,0)
 I $G(SDOE) S DIQ="SDOE(",DIC="^SCE(",DA=+SDOE,DR=".07" D EN^DIQ1
"RTN","SDAMEP1",111,0)
 I $D(SDSC(44.003,SDDA,30)),SDSC(44.003,SDDA,30)="" S SDSC(44.003,SDDA,30)=$P($G(^DIC(8,+$G(^DPT(DFN,.36)),0)),U)
"RTN","SDAMEP1",112,0)
 I $D(SDSC(44.003,SDDA,9)),SDSC(44.003,SDDA,9)="" S SDSC(44.003,SDDA,9)="NO"
"RTN","SDAMEP1",113,0)
 I $D(SDPT(2.98,SDT,13)),SDPT(2.98,SDT,13)="" S SDPT(2.98,SDT,13)="NO"
"RTN","SDAMEP1",114,0)
 S DIQ(0)="I",DIQ="SDPTI(",DIC="^DPT(DFN,""S"",",DA=SDT,DR="3;20;25;26;27;28" D EN^DIQ1
"RTN","SDAMEP1",115,0)
 Q
"RTN","SDAMEP2")
0^9^B30443820
"RTN","SDAMEP2",1,0)
SDAMEP2 ;ALB/CAW - Extended Display (Patient Data) ; 11/13/02
"RTN","SDAMEP2",2,0)
 ;;5.3;Scheduling;**258,325,441**;Aug 13, 1993;Build 3
"RTN","SDAMEP2",3,0)
 ;
"RTN","SDAMEP2",4,0)
PDATA ; Patient Data
"RTN","SDAMEP2",5,0)
 F SD=0,.11,.13,.32,.322,.321,.36,.52 S SD(SD)=$G(^DPT(DFN,SD))
"RTN","SDAMEP2",6,0)
 S SD("CV")=$$CVEDT^DGCV(DFN,SDT)
"RTN","SDAMEP2",7,0)
 S VAIP("D")="L",VAIP("L")="" D INP^DGPMV10
"RTN","SDAMEP2",8,0)
 S SDFSTCOL=16,SDSECCOL=60
"RTN","SDAMEP2",9,0)
 S X="" D SET^SDAMEP1($$SETSTR^VALM1("*** Patient Information ***",X,25,30))
"RTN","SDAMEP2",10,0)
 D CNTRL^VALM10(SDLN,25,30,IOINHI,IOINORM)
"RTN","SDAMEP2",11,0)
PTDOB ; Date of Birth and SSN Info
"RTN","SDAMEP2",12,0)
 ;
"RTN","SDAMEP2",13,0)
 S X="",X=$$SETSTR^VALM1("Date of Birth:",X,1,14)
"RTN","SDAMEP2",14,0)
 S X=$$SETSTR^VALM1($$FTIME^VALM1($P(SD(0),U,3)),X,SDFSTCOL,18)
"RTN","SDAMEP2",15,0)
 S X=$$SETSTR^VALM1(" ID:",X,55,4)
"RTN","SDAMEP2",16,0)
 S X=$$SETSTR^VALM1(VA("PID"),X,SDSECCOL,20)
"RTN","SDAMEP2",17,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",18,0)
PTSEX ; Sex and Marital Status Info
"RTN","SDAMEP2",19,0)
 ;
"RTN","SDAMEP2",20,0)
 S X="",X=$$SETSTR^VALM1("Sex:",X,11,4)
"RTN","SDAMEP2",21,0)
 S X=$$SETSTR^VALM1($S($P(SD(0),U,2)="F":"FEMALE",$P(SD(0),U,2)="M":"MALE",1:"UNKNOWN"),X,SDFSTCOL,18)
"RTN","SDAMEP2",22,0)
 S X=$$SETSTR^VALM1("Marital Status:",X,44,15)
"RTN","SDAMEP2",23,0)
 S X=$$SETSTR^VALM1($P($G(^DIC(11,+$P(SD(0),U,5),0)),U),X,SDSECCOL,20)
"RTN","SDAMEP2",24,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",25,0)
PTREL ; Religious Pref. Info
"RTN","SDAMEP2",26,0)
 ;
"RTN","SDAMEP2",27,0)
 S X="",X=$$SETSTR^VALM1("Religious Pref.:",X,43,16)
"RTN","SDAMEP2",28,0)
 S X=$$SETSTR^VALM1($P($G(^DIC(13,+$P(SD(0),U,8),0)),U),X,SDSECCOL,20)
"RTN","SDAMEP2",29,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",30,0)
PTMT ; Means Test Info
"RTN","SDAMEP2",31,0)
 ;
"RTN","SDAMEP2",32,0)
 S SDMT=$$LST^DGMTU(DFN),X="" G:$P(SDMT,U,4)="N" PTCO I +SDMT D  G PTMTQ
"RTN","SDAMEP2",33,0)
 .S X=$$SETSTR^VALM1("Means Test:",X,4,11)
"RTN","SDAMEP2",34,0)
 .S X=$$SETSTR^VALM1($P($$FMT^SDUTL2(DFN),U),X,SDFSTCOL,20)
"RTN","SDAMEP2",35,0)
 .S X=$$SETSTR^VALM1("Last Means Test:",X,43,16)
"RTN","SDAMEP2",36,0)
 .S X=$$SETSTR^VALM1($$FDATE^VALM1($P(SDMT,U,2)),X,SDSECCOL,20)
"RTN","SDAMEP2",37,0)
PTCO S SDMT=$$LST^DGMTU(DFN,"",2),X="" I +SDMT D
"RTN","SDAMEP2",38,0)
 .S X=$$SETSTR^VALM1("Co-Pay Test:",X,3,12)
"RTN","SDAMEP2",39,0)
 .S X=$$SETSTR^VALM1($P($$FCO^SDUTL2(DFN),U,2),X,SDFSTCOL,10)
"RTN","SDAMEP2",40,0)
 .S X=$$SETSTR^VALM1("Last Co-Pay Test:",X,42,17)
"RTN","SDAMEP2",41,0)
 .S X=$$SETSTR^VALM1($$FDATE^VALM1($P(SDMT,U,2)),X,SDSECCOL,20)
"RTN","SDAMEP2",42,0)
PTMTQ D SET^SDAMEP1(X)
"RTN","SDAMEP2",43,0)
PTELG ; Primary Eligibility and Period of Service Info
"RTN","SDAMEP2",44,0)
 ;
"RTN","SDAMEP2",45,0)
 S X="",X=$$SETSTR^VALM1("Primary Elig.:",X,1,14)
"RTN","SDAMEP2",46,0)
 S X=$$SETSTR^VALM1($P($G(^DIC(8,+$P(SD(.36),U),0)),U,6),X,SDFSTCOL,21)
"RTN","SDAMEP2",47,0)
 S X=$$SETSTR^VALM1("POS:",X,55,4)
"RTN","SDAMEP2",48,0)
 S X=$$SETSTR^VALM1($P($G(^DIC(21,+$P(SD(.32),U,3),0)),U),X,SDSECCOL,20)
"RTN","SDAMEP2",49,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",50,0)
PTADD ; Patient Address
"RTN","SDAMEP2",51,0)
 ;
"RTN","SDAMEP2",52,0)
 S X="",X=($$SETSTR^VALM1("Address:",X,7,8))
"RTN","SDAMEP2",53,0)
 S X=$$SETSTR^VALM1("Phone:",X,53,6)
"RTN","SDAMEP2",54,0)
 S X=$$SETSTR^VALM1($P(SD(.13),U),X,SDSECCOL,20)
"RTN","SDAMEP2",55,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",56,0)
 S X="",X=($$SETSTR^VALM1($P(SD(.11),U),X,10,30))
"RTN","SDAMEP2",57,0)
 S X=$$SETSTR^VALM1("Cell Phone:",X,48,11)
"RTN","SDAMEP2",58,0)
 S X=$$SETSTR^VALM1($S(($P(SD(.13),U,4)'=""):$P(SD(.13),U,4),1:"UNANSWERED"),X,SDSECCOL,20)
"RTN","SDAMEP2",59,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",60,0)
 S X="",SDPAGFLG=0
"RTN","SDAMEP2",61,0)
 I $P(SD(.11),U,2)'="" D
"RTN","SDAMEP2",62,0)
 .S X="",X=($$SETSTR^VALM1($P(SD(.11),U,2),X,10,30))
"RTN","SDAMEP2",63,0)
 .S X=$$SETSTR^VALM1("Pager #:",X,51,8)
"RTN","SDAMEP2",64,0)
 .S X=$$SETSTR^VALM1($S(($P(SD(.13),U,5)'=""):$P(SD(.13),U,5),1:"UNANSWERED"),X,SDSECCOL,20),SDPAGFLG=1
"RTN","SDAMEP2",65,0)
 D:X'="" SET^SDAMEP1(X)
"RTN","SDAMEP2",66,0)
 ; retrieve country info -- PERM country is piece 10 of .11
"RTN","SDAMEP2",67,0)
 N FILE,CNTRY,FORIEN,FOREIGN
"RTN","SDAMEP2",68,0)
 S FILE=779.004,FORIEN=$P(SD(.11),U,10),CNTRY=$$GET1^DIQ(FILE,FORIEN_",",2),CNTRY=$$UPPER^VALM1(CNTRY),FOREIGN=$$FORIEN^DGADDUTL(FORIEN)
"RTN","SDAMEP2",69,0)
 I 'FOREIGN D 
"RTN","SDAMEP2",70,0)
 . N SDZIP S SDZIP=$P(SD(.11),U,12) S:$E(SDZIP,6,10)'="" SDZIP=$E(SDZIP,1,5)_"-"_$E(SDZIP,6,10)
"RTN","SDAMEP2",71,0)
 . S X="",X=($$SETSTR^VALM1($P(SD(.11),U,4)_", "_$P($G(^DIC(5,+$P(SD(.11),U,5),0)),U)_"  "_SDZIP,X,10,45))
"RTN","SDAMEP2",72,0)
 E  D
"RTN","SDAMEP2",73,0)
 . S X="",X=($$SETSTR^VALM1($P(SD(.11),U,9)_" "_$P(SD(.11),U,4)_" "_$P(SD(.11),U,8),X,10,45))
"RTN","SDAMEP2",74,0)
 I 'SDPAGFLG D
"RTN","SDAMEP2",75,0)
 .S X=$$SETSTR^VALM1("Pager #:",X,51,8)
"RTN","SDAMEP2",76,0)
 .S X=$$SETSTR^VALM1($S(($P(SD(.13),U,5)'=""):$P(SD(.13),U,5),1:"UNANSWERED"),X,SDSECCOL,20)
"RTN","SDAMEP2",77,0)
 D SET^SDAMEP1(X) K SDPAGFLG
"RTN","SDAMEP2",78,0)
 S X="",X=$$SETSTR^VALM1(CNTRY,X,10,45)
"RTN","SDAMEP2",79,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",80,0)
 S X="",X=$$SETSTR^VALM1("EMAIL ADDRESS:",X,1,14)
"RTN","SDAMEP2",81,0)
 S X=$$SETSTR^VALM1($S(($P(SD(.13),U,3)'=""):$P(SD(.13),U,3),1:"UNANSWERED"),X,SDFSTCOL,45)
"RTN","SDAMEP2",82,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",83,0)
PTEXP ; Radiation and Status
"RTN","SDAMEP2",84,0)
 ;
"RTN","SDAMEP2",85,0)
 S X="",X=$$SETSTR^VALM1("Radiation Exposure:",X,1,19)
"RTN","SDAMEP2",86,0)
 S X=$$SETSTR^VALM1($$FYNUNK^SDUTL2($P(SD(.321),U,3)),X,21,7)
"RTN","SDAMEP2",87,0)
 S X=$$SETSTR^VALM1("Status:",X,52,7)
"RTN","SDAMEP2",88,0)
 S A=$S("^3^5^"[("^"_+DGPMVI(2)_"^"):0,1:+DGPMVI(2)),SDST=$S('A:"IN",1:"")_"ACTIVE ",SDSTA=$S("^4^5^"[("^"_+DGPMVI(2)_"^"):"LODGER",1:"INPATIENT")
"RTN","SDAMEP2",89,0)
 I '$D(^DGPM("C",DFN)) S SDST="NO INPT./LOD. ACT.",SDSTA=""
"RTN","SDAMEP2",90,0)
 S X=$$SETSTR^VALM1(SDST_SDSTA,X,SDSECCOL,20)
"RTN","SDAMEP2",91,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",92,0)
PTPOW ; Prisoner of War Info and Last Admission Date
"RTN","SDAMEP2",93,0)
 ;
"RTN","SDAMEP2",94,0)
 S X="",X=$$SETSTR^VALM1("Prisoner of War:",X,4,16)
"RTN","SDAMEP2",95,0)
 S X=$$SETSTR^VALM1($$FYNUNK^SDUTL2($P(SD(.52),U,5)),X,21,7)
"RTN","SDAMEP2",96,0)
 S X=$$SETSTR^VALM1("Last Admit/Lodger Date:",X,36,23)
"RTN","SDAMEP2",97,0)
 I +DGPMVI(13,1) S X=$$SETSTR^VALM1($$FTIME^VALM1(+DGPMVI(13,1)),X,SDSECCOL,18)
"RTN","SDAMEP2",98,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",99,0)
PTAO ; Agent Orange Exposure and Last Discharge Date
"RTN","SDAMEP2",100,0)
 S X="",X=$$SETSTR^VALM1("AO Exp/Loc:",X,9,11)
"RTN","SDAMEP2",101,0)
 S X=$$SETSTR^VALM1($$FYNUNK^SDUTL2($P(SD(.321),U,2))_$S($P(SD(.321),U,13)="V":"/VIET",$P(SD(.321),U,13)="K":"/DMZ",$P(SD(.321),U,13)="O":"/OTH",1:""),X,21,14)
"RTN","SDAMEP2",102,0)
 S X=$$SETSTR^VALM1("Last Disch./Lodger Date:",X,35,24)
"RTN","SDAMEP2",103,0)
 S SDDISCH=+$G(^DGPM(+DGPMVI(17),0))
"RTN","SDAMEP2",104,0)
 I +SDDISCH S X=$$SETSTR^VALM1($$FTIME^VALM1(SDDISCH),X,SDSECCOL,18)
"RTN","SDAMEP2",105,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",106,0)
CV ;Combat vet
"RTN","SDAMEP2",107,0)
 S X="",X=$$SETSTR^VALM1("Combat Veteran:",X,5,15)
"RTN","SDAMEP2",108,0)
 S X=$$SETSTR^VALM1($$FYNUNK^SDUTL2($S($P(SD("CV"),U,1)>0:"Y",1:"N")),X,21,7)
"RTN","SDAMEP2",109,0)
 S X=$$SETSTR^VALM1("Combat Veteran End Date:",X,35,24)
"RTN","SDAMEP2",110,0)
 I $P(SD("CV"),U,1)>0 D
"RTN","SDAMEP2",111,0)
 .S X=$$SETSTR^VALM1($$FTIME^VALM1($P(SD("CV"),U,2)),X,SDSECCOL,18)
"RTN","SDAMEP2",112,0)
 E  S X=$$SETSTR^VALM1("N/A",X,SDSECCOL,3)
"RTN","SDAMEP2",113,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",114,0)
SHAD ;PROJ 112/SHAD
"RTN","SDAMEP2",115,0)
 S X="",X=$$SETSTR^VALM1("PROJ 112/SHAD:",X,6,14)
"RTN","SDAMEP2",116,0)
 S X=$$SETSTR^VALM1($$FYNUNK^SDUTL2($S($P(SD(.321),U,15)>0:"Y",1:"N")),X,21,7)
"RTN","SDAMEP2",117,0)
SWASIA ;SW Asia
"RTN","SDAMEP2",118,0)
 S X=$$SETSTR^VALM1("SW Asia Conditions:",X,40,19)
"RTN","SDAMEP2",119,0)
 S X=$$SETSTR^VALM1($$FYNUNK^SDUTL2($P(SD(.322),U,13)),X,SDSECCOL,20)
"RTN","SDAMEP2",120,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP2",121,0)
 D SET^SDAMEP1("")
"RTN","SDAMEP2",122,0)
 Q
"RTN","SDAMEP3")
0^10^B19773146
"RTN","SDAMEP3",1,0)
SDAMEP3 ;ALB/CAW - Extended Display (Appt. Event Log) ; 16 May 2001  6:31 PM
"RTN","SDAMEP3",2,0)
 ;;5.3;Scheduling;**20,241**;Aug 13, 1993;Build 3
"RTN","SDAMEP3",3,0)
 ;
"RTN","SDAMEP3",4,0)
APLOG ;
"RTN","SDAMEP3",5,0)
 D SET^SDAMEP1("                       *** Appointment Event Log ***")
"RTN","SDAMEP3",6,0)
 D CNTRL^VALM10(SDLN,24,29,IOINHI,IOINORM)
"RTN","SDAMEP3",7,0)
 D SET^SDAMEP1($$EVENT("Event","Date","User"))
"RTN","SDAMEP3",8,0)
 D SET^SDAMEP1($$EVENT("-----","----","----"))
"RTN","SDAMEP3",9,0)
 D SET^SDAMEP1($$EVENT("Appt Made",$S($G(SDSC(44.003,SDDA,8))]"":SDSC(44.003,SDDA,8),1:$G(SDPT(2.98,SDT,20))),$S($G(SDSC(44.003,SDDA,7))]"":SDSC(44.003,SDDA,7),1:$G(SDPT(2.98,SDT,19)))))
"RTN","SDAMEP3",10,0)
 D SET^SDAMEP1($$EVENT("Check In",$G(SDSC(44.003,SDDA,309)),$G(SDSC(44.003,SDDA,302))))
"RTN","SDAMEP3",11,0)
 D SET^SDAMEP1($$EVENT("Check Out",$G(SDSC(44.003,SDDA,303)),$G(SDSC(44.003,SDDA,304))))
"RTN","SDAMEP3",12,0)
 D SET^SDAMEP1($$EVENT("Check Out Entered",$G(SDSC(44.003,SDDA,306)),""))
"RTN","SDAMEP3",13,0)
 D SET^SDAMEP1($$EVENT("No-Show/Cancel",$G(SDPT(2.98,SDT,15)),$G(SDPT(2.98,SDT,14)))),SET^SDAMEP1("")
"RTN","SDAMEP3",14,0)
 ;
"RTN","SDAMEP3",15,0)
 S X=""
"RTN","SDAMEP3",16,0)
 S X=$$SETSTR^VALM1("  Checked Out:",X,7,SDWIDTH)
"RTN","SDAMEP3",17,0)
 S X=$$SETSTR^VALM1($S($G(SDOE(409.68,+SDOE,.07))]"":"YES",1:""),X,SDFSTCOL+5,30)
"RTN","SDAMEP3",18,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP3",19,0)
 ;
"RTN","SDAMEP3",20,0)
 S X=""
"RTN","SDAMEP3",21,0)
 S X=$$SETSTR^VALM1("  Cancel Reason:",X,5,SDWIDTH)
"RTN","SDAMEP3",22,0)
 S X=$$SETSTR^VALM1(SDPT(2.98,SDT,16),X,SDFSTCOL+5,30)
"RTN","SDAMEP3",23,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP3",24,0)
 ;
"RTN","SDAMEP3",25,0)
 S X=""
"RTN","SDAMEP3",26,0)
 S X=$$SETSTR^VALM1("  Cancel Remark:",X,5,SDWIDTH)
"RTN","SDAMEP3",27,0)
 S X=$$SETSTR^VALM1(SDPT(2.98,SDT,17),X,SDFSTCOL+5,50)
"RTN","SDAMEP3",28,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP3",29,0)
 ;
"RTN","SDAMEP3",30,0)
 S X=""
"RTN","SDAMEP3",31,0)
 S X=$$SETSTR^VALM1("  Rebooked Date:",X,5,SDWIDTH)
"RTN","SDAMEP3",32,0)
 S X=$$SETSTR^VALM1(SDPT(2.98,SDT,12),X,SDFSTCOL+5,20)
"RTN","SDAMEP3",33,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP3",34,0)
CWT ;Clinic Wait Time Information
"RTN","SDAMEP3",35,0)
 N SDCWT,SDCWT1,SDCWT2
"RTN","SDAMEP3",36,0)
 ;Get internal data values
"RTN","SDAMEP3",37,0)
 F SDCWT=3,20,25:1:28 S SDCWT(SDCWT)=SDPTI(2.98,SDT,SDCWT,"I")
"RTN","SDAMEP3",38,0)
 ;Wait time data applicable?
"RTN","SDAMEP3",39,0)
 S SDCWT=1 S:$E(SDCWT(3))="C" SDCWT=0
"RTN","SDAMEP3",40,0)
 S SDCWT1=SDCWT(20),SDCWT2=SDCWT(27)
"RTN","SDAMEP3",41,0)
 ;Calculate Wait Time1
"RTN","SDAMEP3",42,0)
 S SDCWT1=$S(SDCWT1<1:"",SDT<SDCWT1:0,1:$$FMDIFF^XLFDT(SDT,SDCWT1,1))
"RTN","SDAMEP3",43,0)
 ;Calculate Wait Time2
"RTN","SDAMEP3",44,0)
 S:'$$CWT3^SCRPW75(SDT,SDCWT(26),SDCWT(27),SDCWT(28),.SDCWT2) SDCWT2=""
"RTN","SDAMEP3",45,0)
 S:+SDCWT1=SDCWT1 SDCWT1=SDCWT1_" day"_$S(SDCWT1=1:"",1:"s")
"RTN","SDAMEP3",46,0)
 S:+SDCWT2=SDCWT2 SDCWT2=SDCWT2_" day"_$S(SDCWT2=1:"",1:"s")
"RTN","SDAMEP3",47,0)
 D SET^SDAMEP1("                      *** Clinic Wait Time Information ***")
"RTN","SDAMEP3",48,0)
 D CNTRL^VALM10(SDLN,20,40,IOINHI,IOINORM)
"RTN","SDAMEP3",49,0)
 D SET^SDAMEP1("")
"RTN","SDAMEP3",50,0)
 ;
"RTN","SDAMEP3",51,0)
 S X=""
"RTN","SDAMEP3",52,0)
 S X=$$SETSTR^VALM1("       Request type:",X,7,SDWIDTH+6)
"RTN","SDAMEP3",53,0)
 S X=$$SETSTR^VALM1($S('SDCWT:"N/A",$G(SDPT(2.98,SDT,25))]"":SDPT(2.98,SDT,25),1:"Unknown"),X,SDFSTCOL+10,50)
"RTN","SDAMEP3",54,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP3",55,0)
 ;
"RTN","SDAMEP3",56,0)
 S X=""
"RTN","SDAMEP3",57,0)
 S X=$$SETSTR^VALM1("'Next Available' Type:",X,5,SDWIDTH+6)
"RTN","SDAMEP3",58,0)
 S X=$$SETSTR^VALM1($S('SDCWT:"N/A",1:SDPT(2.98,SDT,26)),X,SDFSTCOL+10,50)
"RTN","SDAMEP3",59,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP3",60,0)
 ;
"RTN","SDAMEP3",61,0)
 S X=""
"RTN","SDAMEP3",62,0)
 S X=$$SETSTR^VALM1("         Desired date:",X,5,SDWIDTH+6)
"RTN","SDAMEP3",63,0)
 S X=$$SETSTR^VALM1($S('SDCWT:"N/A",1:SDPT(2.98,SDT,27)),X,SDFSTCOL+10,50)
"RTN","SDAMEP3",64,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP3",65,0)
 ;
"RTN","SDAMEP3",66,0)
 S X=""
"RTN","SDAMEP3",67,0)
 S X=$$SETSTR^VALM1("      Follow-up visit:",X,5,SDWIDTH+6)
"RTN","SDAMEP3",68,0)
 S X=$$SETSTR^VALM1($S('SDCWT:"N/A",1:SDPT(2.98,SDT,28)_$S($L(SDPT(2.98,SDT,28)):"  (computed)",1:"")),X,SDFSTCOL+10,50)
"RTN","SDAMEP3",69,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP3",70,0)
 ;
"RTN","SDAMEP3",71,0)
 S X=""
"RTN","SDAMEP3",72,0)
 S X=$$SETSTR^VALM1("    Clinic Wait Time1:",X,5,SDWIDTH+6)
"RTN","SDAMEP3",73,0)
 S X=$$SETSTR^VALM1($S('SDCWT:"N/A",1:SDCWT1),X,SDFSTCOL+10,50)
"RTN","SDAMEP3",74,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP3",75,0)
 ;
"RTN","SDAMEP3",76,0)
 S X=""
"RTN","SDAMEP3",77,0)
 S X=$$SETSTR^VALM1("    Clinic Wait Time2:",X,5,SDWIDTH+6)
"RTN","SDAMEP3",78,0)
 S X=$$SETSTR^VALM1($S('SDCWT:"N/A",1:SDCWT2),X,SDFSTCOL+10,50)
"RTN","SDAMEP3",79,0)
 D SET^SDAMEP1(X)
"RTN","SDAMEP3",80,0)
 D SET^SDAMEP1("")
"RTN","SDAMEP3",81,0)
 I SDCWT D  Q
"RTN","SDAMEP3",82,0)
 .D SET^SDAMEP1("NOTE: Clinic Wait Time1 represents the difference between the date the")
"RTN","SDAMEP3",83,0)
 .D SET^SDAMEP1("      appointment was entered and the date it was performed.  Clinic Wait")
"RTN","SDAMEP3",84,0)
 .D SET^SDAMEP1("      Time2 represents the difference between the 'desired date' and the")
"RTN","SDAMEP3",85,0)
 .D SET^SDAMEP1("      date the appointment was performed.")
"RTN","SDAMEP3",86,0)
 .Q
"RTN","SDAMEP3",87,0)
 D SET^SDAMEP1("")
"RTN","SDAMEP3",88,0)
 D SET^SDAMEP1("NOTE: Clinic Wait Time data is not applicable for appointments that have a")
"RTN","SDAMEP3",89,0)
 D SET^SDAMEP1("      status of 'cancelled by clinic'.")
"RTN","SDAMEP3",90,0)
 D SET^SDAMEP1("")
"RTN","SDAMEP3",91,0)
 Q
"RTN","SDAMEP3",92,0)
 ;
"RTN","SDAMEP3",93,0)
EVENT(TYPE,TIME,USER) ;
"RTN","SDAMEP3",94,0)
 Q $$SETSTR^VALM1(TYPE,$$SETSTR^VALM1(TIME,$$SETSTR^VALM1(USER,"",50,30),25,21),2,20)
"RTN","SDAMEP3",95,0)
 ;
"RTN","SDAMEVT")
0^11^B27512966
"RTN","SDAMEVT",1,0)
SDAMEVT ;ALB/MJK - Appt Event Driver Utilities ; 12/1/91 [ 09/19/96  1:39 PM ]
"RTN","SDAMEVT",2,0)
 ;;5.3;Scheduling;**15,132,443**;Aug 13, 1993;Build 3
"RTN","SDAMEVT",3,0)
 ;
"RTN","SDAMEVT",4,0)
BEFORE(SDATA,DFN,SDT,SDCL,SDDA,SDHDL) ; -- get before values
"RTN","SDAMEVT",5,0)
 K ^TMP("SDAMEVT",$J)
"RTN","SDAMEVT",6,0)
 D CAPTURE("BEFORE",.SDATA,.DFN,.SDT,.SDCL,.SDDA,.SDHDL)
"RTN","SDAMEVT",7,0)
 Q
"RTN","SDAMEVT",8,0)
 ;
"RTN","SDAMEVT",9,0)
AFTER(SDATA,DFN,SDT,SDCL,SDDA,SDHDL) ; -- get after values
"RTN","SDAMEVT",10,0)
 D CAPTURE("AFTER",.SDATA,.DFN,.SDT,.SDCL,.SDDA,.SDHDL)
"RTN","SDAMEVT",11,0)
 Q
"RTN","SDAMEVT",12,0)
 ;
"RTN","SDAMEVT",13,0)
HANDLE(SDORG) ; -- get evt handle
"RTN","SDAMEVT",14,0)
 ;  SDORG = originating process (1=appt , 2=a/e , 3=disp)
"RTN","SDAMEVT",15,0)
 S (Y,^($J))=$G(^TMP("SDEVT HANDLE",$J))+1
"RTN","SDAMEVT",16,0)
 Q Y
"RTN","SDAMEVT",17,0)
 ;
"RTN","SDAMEVT",18,0)
CLEAN(SDHDL) ;
"RTN","SDAMEVT",19,0)
 K ^TMP("SDEVT",$J,SDHDL)
"RTN","SDAMEVT",20,0)
 Q
"RTN","SDAMEVT",21,0)
 ;
"RTN","SDAMEVT",22,0)
HDLKILL ; -- kill off handle data
"RTN","SDAMEVT",23,0)
 K SDHDL,^TMP("SDEVT HANDLE",$J),^TMP("SDEVT",$J)
"RTN","SDAMEVT",24,0)
 Q
"RTN","SDAMEVT",25,0)
 ;
"RTN","SDAMEVT",26,0)
CAPTURE(SDCAP,SDATA,DFN,SDT,SDCL,SDDA,SDHDL) ;
"RTN","SDAMEVT",27,0)
 N Z
"RTN","SDAMEVT",28,0)
 S (Z,^TMP("SDAMEVT",$J,SDCAP,"DPT"),^TMP("SDEVT",$J,SDHDL,1,"DPT",0,SDCAP))=$G(^DPT(DFN,"S",SDT,0))
"RTN","SDAMEVT",29,0)
 S (^TMP("SDAMEVT",$J,SDCAP,"SC"),^TMP("SDEVT",$J,SDHDL,1,"SC",0,SDCAP))=$G(^SC(SDCL,"S",SDT,1,+SDDA,0))
"RTN","SDAMEVT",30,0)
 S (^TMP("SDAMEVT",$J,SDCAP,"STATUS"),SDATA(SDCAP,"STATUS"))=$TR($$STATUS^SDAM1(DFN,SDT,SDCL,Z,SDDA),";","^")
"RTN","SDAMEVT",31,0)
 D:$P(Z,U,20) OE(.SDCAP,1,$P(Z,U,20),.SDHDL)
"RTN","SDAMEVT",32,0)
 Q
"RTN","SDAMEVT",33,0)
 ;
"RTN","SDAMEVT",34,0)
 ;
"RTN","SDAMEVT",35,0)
EVT(SDATA,SDAMEVT,SDMODE,SDHDL) ; -- calls the sdam event protocol
"RTN","SDAMEVT",36,0)
 N OROLD
"RTN","SDAMEVT",37,0)
 K DTOUT,DIROUT
"RTN","SDAMEVT",38,0)
 I $G(SDATA("BEFORE","STATUS"))=$G(SDATA("AFTER","STATUS")),'$$COMP^SDAMEVT4(SDHDL,SDAMEVT) G EVTQ  ; SD*5.3*443
"RTN","SDAMEVT",39,0)
 S:$P(SDATA,U,3) $P(SDATA,U,5)=$$REQ^SDM1A(+$P(SDATA,U,3))
"RTN","SDAMEVT",40,0)
 S X=+$O(^ORD(101,"B","SDAM APPOINTMENT EVENTS",0))_";ORD(101,"
"RTN","SDAMEVT",41,0)
 D EN^XQOR
"RTN","SDAMEVT",42,0)
EVTQ K XQORPOP,X,^TMP("SDAMEVT",$J) D CLEAN(SDHDL) Q
"RTN","SDAMEVT",43,0)
 ;
"RTN","SDAMEVT",44,0)
 ;
"RTN","SDAMEVT",45,0)
MAKE(DFN,SDT,SDCL,SDDA,SDMODE) ; -- make appt event #1
"RTN","SDAMEVT",46,0)
 N SDATA,%,SDMKHDL,SDHDL K ^TMP("SDAMEVT",$J)
"RTN","SDAMEVT",47,0)
 S SDMKHDL=$$HANDLE(1)
"RTN","SDAMEVT",48,0)
 S (^TMP("SDAMEVT",$J,"BEFORE","DPT"),^TMP("SDAMEVT",$J,"BEFORE","SC"),SDATA("BEFORE","STATUS"),^TMP("SDAMEVT",$J,"BEFORE","STATUS"),^TMP("SDEVT",$J,SDMKHDL,1,"DPT",0,"BEFORE"),^TMP("SDEVT",$J,SDMKHDL,1,"SC",0,"BEFORE"))=""
"RTN","SDAMEVT",49,0)
 D AFTER(.SDATA,DFN,SDT,SDCL,SDDA,SDMKHDL)
"RTN","SDAMEVT",50,0)
 S SDATA=SDDA_U_DFN_U_SDT_U_SDCL
"RTN","SDAMEVT",51,0)
 D EVT(.SDATA,1,+$G(SDAMODE),SDMKHDL)
"RTN","SDAMEVT",52,0)
 ; -- if appt d/t is less than NOW then check-in
"RTN","SDAMEVT",53,0)
 D NOW^%DTC
"RTN","SDAMEVT",54,0)
 I SDT<% W:'$G(SDMODE) ! D
"RTN","SDAMEVT",55,0)
 .N SDACT,SDCOQUIT
"RTN","SDAMEVT",56,0)
 .S SDDA=+SDATA,DFN=$P(SDATA,U,2),SDT=$P(SDATA,U,3),SDCL=$P(SDATA,U,4) K SDATA
"RTN","SDAMEVT",57,0)
 .I $$REQ^SDM1A(SDT)="CO",'$G(SDCOACT) D
"RTN","SDAMEVT",58,0)
 ..S SDACT=$S(SDT<DT:"CO",1:$$ASK^SDAMEX) I SDACT']"" S SDCOQUIT=1 Q
"RTN","SDAMEVT",59,0)
 ..I SDACT="CO" D CO^SDCO1(DFN,SDT,SDCL,SDDA,0,SDT)
"RTN","SDAMEVT",60,0)
 .I '$G(SDCOQUIT),$G(SDACT)'="CO" D ONE^SDAM2(DFN,SDCL,SDT,SDDA,0,SDT)
"RTN","SDAMEVT",61,0)
 Q
"RTN","SDAMEVT",62,0)
 ;
"RTN","SDAMEVT",63,0)
 ;
"RTN","SDAMEVT",64,0)
CANCEL(SDATA,DFN,SDT,SDCL,SDDA,SDMODE,SDHDL) ; -- cancel event #2
"RTN","SDAMEVT",65,0)
 D AFTER(.SDATA,DFN,SDT,SDCL,SDDA,SDHDL)
"RTN","SDAMEVT",66,0)
 I "^5^7^9^10^"[("^"_+SDATA("AFTER","STATUS")_"^"),$P($G(^DPT(DFN,"S",SDT,0)),"^",20) D EN^SDCODEL(+$P(^(0),"^",20),0,SDHDL),OENUL^SDAMEVT1("AFTER",SDHDL)
"RTN","SDAMEVT",67,0)
 S SDATA=SDDA_U_DFN_U_SDT_U_SDCL
"RTN","SDAMEVT",68,0)
 D EVT(.SDATA,2,0,SDHDL)
"RTN","SDAMEVT",69,0)
 Q
"RTN","SDAMEVT",70,0)
 ;
"RTN","SDAMEVT",71,0)
 ;
"RTN","SDAMEVT",72,0)
NOSHOW(SDATA,DFN,SDT,SDCL,SDDA,SDMODE,SDHDL) ; -- no-show event #3
"RTN","SDAMEVT",73,0)
 D AFTER(.SDATA,DFN,SDT,SDCL,SDDA,SDHDL)
"RTN","SDAMEVT",74,0)
 I "^4^6^"[("^"_+SDATA("AFTER","STATUS")_"^"),$P($G(^DPT(DFN,"S",SDT,0)),"^",20) D EN^SDCODEL(+$P(^(0),"^",20),0,SDHDL),OENUL^SDAMEVT1("AFTER",SDHDL)
"RTN","SDAMEVT",75,0)
 S SDATA=SDDA_U_DFN_U_SDT_U_SDCL
"RTN","SDAMEVT",76,0)
 D EVT(.SDATA,3,0,SDHDL)
"RTN","SDAMEVT",77,0)
 Q
"RTN","SDAMEVT",78,0)
 ;
"RTN","SDAMEVT",79,0)
OE(SDCAP,SDORG,SDOE,SDHDL) ; -- set up encounter data
"RTN","SDAMEVT",80,0)
 N I,OP,FILE,X,SDKID
"RTN","SDAMEVT",81,0)
 ;
"RTN","SDAMEVT",82,0)
 ; -- set up 'OP'posite variable
"RTN","SDAMEVT",83,0)
 S OP=$S(SDCAP="BEFORE":"AFTER",1:"BEFORE")
"RTN","SDAMEVT",84,0)
 ;
"RTN","SDAMEVT",85,0)
 ; -- set zero of oe
"RTN","SDAMEVT",86,0)
 S X=$G(^SCE(SDOE,0))
"RTN","SDAMEVT",87,0)
 S ^TMP("SDEVT",$J,SDHDL,SDORG,"SDOE",SDOE,0,SDCAP)=X
"RTN","SDAMEVT",88,0)
 S:'$D(^TMP("SDEVT",$J,SDHDL,SDORG,"SDOE",SDOE,0,OP)) ^(OP)=""
"RTN","SDAMEVT",89,0)
 ;
"RTN","SDAMEVT",90,0)
 ; -- save other data
"RTN","SDAMEVT",91,0)
 S FILE=409.42
"RTN","SDAMEVT",92,0)
 S I=0 F  S I=$O(^SDD(FILE,"OE",SDOE,I)) Q:'I  D
"RTN","SDAMEVT",93,0)
 . S X=$G(^SDD(FILE,I,0))
"RTN","SDAMEVT",94,0)
 . S ^TMP("SDEVT",$J,SDHDL,SDORG,"SDOE",SDOE,"CL",I,0,SDCAP)=X
"RTN","SDAMEVT",95,0)
 . S:'$D(^TMP("SDEVT",$J,SDHDL,SDORG,"SDOE",SDOE,"CL",I,0,OP)) ^(OP)=""
"RTN","SDAMEVT",96,0)
 ;
"RTN","SDAMEVT",97,0)
 IF SDORG'=1,SDORG'=3 G OEQ
"RTN","SDAMEVT",98,0)
 ;
"RTN","SDAMEVT",99,0)
 ; -- gets children oe's
"RTN","SDAMEVT",100,0)
 S SDKID=0
"RTN","SDAMEVT",101,0)
 F  S SDKID=$O(^SCE("APAR",SDOE,SDKID)) Q:'SDKID  D
"RTN","SDAMEVT",102,0)
 . S X=$G(^SCE(SDKID,0))
"RTN","SDAMEVT",103,0)
 . IF $P(X,U,8)'=4 Q  ; -- must be a credit stop encounter
"RTN","SDAMEVT",104,0)
 . S ^TMP("SDEVT",$J,SDHDL,4,"SDOE",SDKID,0,SDCAP)=X
"RTN","SDAMEVT",105,0)
 . S:'$D(^TMP("SDEVT",$J,SDHDL,4,"SDOE",SDKID,0,OP)) ^(OP)=""
"RTN","SDAMEVT",106,0)
OEQ Q
"RTN","SDAMEVT",107,0)
 ;
"RTN","SDAMEVT",108,0)
OECHG(SDORG,SDHDL) ; -- compare befores and afters
"RTN","SDAMEVT",109,0)
 N Y,I,SDOE S (Y,SDOE)=0
"RTN","SDAMEVT",110,0)
 F  S SDOE=$O(^TMP("SDEVT",$J,SDHDL,SDORG,"SDOE",SDOE)) Q:'SDOE  D  Q:Y
"RTN","SDAMEVT",111,0)
 . S I=0
"RTN","SDAMEVT",112,0)
 . F  S I=$O(^TMP("SDEVT",$J,SDHDL,SDORG,"SDOE",SDOE,"CL",I)) Q:'I  I $G(^(I,0,"BEFORE"))='$G(^("AFTER")) S Y=1 Q
"RTN","SDAMEVT",113,0)
 Q Y
"RTN","SDAMEVT",114,0)
 ;
"RTN","SDAMEVT",115,0)
OEVT(SDOE,SDCAP,SDHDL,SDATA,SDOE0) ; -- event driver calls by oe
"RTN","SDAMEVT",116,0)
 ; SDATA only required for appts
"RTN","SDAMEVT",117,0)
 ; SDOE0 only required for check out deletion AFTER
"RTN","SDAMEVT",118,0)
 ;
"RTN","SDAMEVT",119,0)
 N SD0,SDORG,SDT,DFN,SDDA,SDCL,SDOEP
"RTN","SDAMEVT",120,0)
 S SD0=$S($D(^SCE(SDOE,0)):^(0),1:$G(SDOE0)),SDOEP=$P(SD0,U,6)
"RTN","SDAMEVT",121,0)
 I SD0']""!(SDOEP) G OEVTQ
"RTN","SDAMEVT",122,0)
 S SDT=+SD0,DFN=+$P(SD0,U,2),SDCL=+$P(SD0,U,4),SDORG=+$P(SD0,U,8),SDDA=$P(SD0,U,9)
"RTN","SDAMEVT",123,0)
 I SDCAP="BEFORE" D
"RTN","SDAMEVT",124,0)
 .I SDORG=1 D BEFORE(.SDATA,DFN,SDT,SDCL,SDDA,SDHDL) Q
"RTN","SDAMEVT",125,0)
 .I SDORG=2 D BEFORE^SDAMEVT2(SDOE,SDHDL) Q
"RTN","SDAMEVT",126,0)
 .I SDORG=3 D BEFORE^SDAMEVT3(DFN,SDT,9,SDHDL)
"RTN","SDAMEVT",127,0)
 I SDCAP="AFTER" D
"RTN","SDAMEVT",128,0)
 .I SDORG=1 S SDATA=SDDA_"^"_DFN_"^"_SDT_"^"_SDCL D AFTER(.SDATA,DFN,SDT,SDCL,SDDA,SDHDL),EVT(.SDATA,5,0,SDHDL) Q
"RTN","SDAMEVT",129,0)
 .I SDORG=2 D EVT^SDAMEVT2(SDOE,7,SDHDL) Q
"RTN","SDAMEVT",130,0)
 .I SDORG=3 D EVT^SDAMEVT3(DFN,SDT,9,SDHDL)
"RTN","SDAMEVT",131,0)
OEVTQ Q
"RTN","SDAMEVT",132,0)
 ;
"RTN","SDAMEVT",133,0)
 ; -- SEE SDAMEVT0 FOR DOC ON VARIABLES
"RTN","SDAMN")
0^12^B7272637
"RTN","SDAMN",1,0)
SDAMN ;ALB/MJK - No-Show Appt Action ; 2/4/92
"RTN","SDAMN",2,0)
 ;;5.3;Scheduling;**478**;Aug 13, 1993;Build 3
"RTN","SDAMN",3,0)
 ;
"RTN","SDAMN",4,0)
EN ; -- protocol SDAM APPT NO-SHOW entry pt
"RTN","SDAMN",5,0)
 ; input:  VALMY := array entries
"RTN","SDAMN",6,0)
 ;
"RTN","SDAMN",7,0)
 N VALMY,SDI,SDAT,SDTIME,SDNSACT,DFN,SDCL,SDT,SDSTB,SDSTA,SDSTOP
"RTN","SDAMN",8,0)
 S VALMBCK="",(SDNSACT,SDSTOP)=0
"RTN","SDAMN",9,0)
 D SEL^VALM2 G ENQ:'$O(VALMY(0))
"RTN","SDAMN",10,0)
 D FULL^VALM1 S VALMBCK="R",SDI=0
"RTN","SDAMN",11,0)
 F  S SDI=$O(VALMY(SDI)) Q:'SDI  I $D(^TMP("SDAMIDX",$J,SDI)) K SDAT S SDAT=^(SDI) D  Q:SDSTOP
"RTN","SDAMN",12,0)
 .D NOW^%DTC S SDTIME=%
"RTN","SDAMN",13,0)
 .W !,^TMP("SDAM",$J,+SDAT,0),!
"RTN","SDAMN",14,0)
 .S DFN=+$P(SDAT,U,2),SDT=+$P(SDAT,U,3),SDCL=+$P(SDAT,U,4)
"RTN","SDAMN",15,0)
 .S SDSTB=$$STATUS^SDAM1(DFN,SDT,SDCL,$G(^DPT(DFN,"S",SDT,0))) ; before status
"RTN","SDAMN",16,0)
 .Q:'$$CHK
"RTN","SDAMN",17,0)
 .S SDSTOP=$$NS(DFN,SDT,SDCL,SDTIME,.SDNSACT)
"RTN","SDAMN",18,0)
 .S SDSTA=$$STATUS^SDAM1(DFN,SDT,SDCL,$G(^DPT(DFN,"S",SDT,0))) ; after status
"RTN","SDAMN",19,0)
 .I 'SDNSACT,'$$UPD(SDSTB,SDSTA,SDAT,$G(CNSTLNK)) S SDNSACT=2
"RTN","SDAMN",20,0)
 ; values for SDNSACT :   0 = no re-build
"RTN","SDAMN",21,0)
 ;                        1 = re-build because of re-book
"RTN","SDAMN",22,0)
 ;                        2 = re-build because after not for list
"RTN","SDAMN",23,0)
 I SDNSACT,SDAMTYP="P" D BLD^SDAM1
"RTN","SDAMN",24,0)
 I SDNSACT,SDAMTYP="C" D BLD^SDAM3
"RTN","SDAMN",25,0)
ENQ Q
"RTN","SDAMN",26,0)
 ;
"RTN","SDAMN",27,0)
NS(DFN,SDT,SC,SDTIME,SDNSACT) ; execute no-show code
"RTN","SDAMN",28,0)
 ; input:   DFN := pt file ifn
"RTN","SDAMN",29,0)
 ;          SDT := d/t of appt
"RTN","SDAMN",30,0)
 ;           SC := clinic ifn
"RTN","SDAMN",31,0)
 ;       SDTIME := now
"RTN","SDAMN",32,0)
 ;      SDNSACT := ns processing flag
"RTN","SDAMN",33,0)
 ;     [return] := did user uparrow [ 0|no , 1|yes]
"RTN","SDAMN",34,0)
 ;
"RTN","SDAMN",35,0)
 N SDI,SDCP,SDYES,SDINP,SDLT1,SDLT,SDDT,SDMSG,A,L,I,SDV1,SDCL
"RTN","SDAMN",36,0)
 K ^UTILITY($J)
"RTN","SDAMN",37,0)
 D LO^DGUTL S SDLT1="",SDYES="",SDDT=DT,I=SDT,SDT=$P(I,".")
"RTN","SDAMN",38,0)
 S SDMSG=" DOES NOT HAVE A NO-SHOW LETTER ASSIGNED TO IT!"
"RTN","SDAMN",39,0)
 S SDV1=$O(^DG(40.8,0)) D DIV^SDUTL I $T S SDV1=$P($G(^SC(SC,0)),U,15)
"RTN","SDAMN",40,0)
 D EN1^SDN,73^SDN,PAUSE^VALM1
"RTN","SDAMN",41,0)
NSQ Q 'Y
"RTN","SDAMN",42,0)
 ;
"RTN","SDAMN",43,0)
CHK() ; -- check if status of appt permits no-show
"RTN","SDAMN",44,0)
 N SDOK S SDOK=1
"RTN","SDAMN",45,0)
 I '$D(^SD(409.63,"ANS",1,+SDSTB)) S SDOK=0,X="You cannot execute no-show processing for this appointment."
"RTN","SDAMN",46,0)
 I SDOK,SDT>SDTIME S SDOK=1,X="It is too soon to no-show this appointment."
"RTN","SDAMN",47,0)
 I 'SDOK W !!,*7,X K VALMY(SDI) D PAUSE^VALM1
"RTN","SDAMN",48,0)
 Q SDOK
"RTN","SDAMN",49,0)
 ;
"RTN","SDAMN",50,0)
UPD(BEFORE,AFTER,SDAT,CNST) ; can just the 1 display line be changed w/o re-build
"RTN","SDAMN",51,0)
 ; input:   BEFORE := before status info in $$STATUS format
"RTN","SDAMN",52,0)
 ;           AFTER := after     "     "   "     "      "
"RTN","SDAMN",53,0)
 ;            SDAT := selected VALMY entry's data
"RTN","SDAMN",54,0)
 ;            CNST := consult status (null, consult link ien)
"RTN","SDAMN",55,0)
 N Y S Y=0
"RTN","SDAMN",56,0)
 I +BEFORE=+AFTER S Y=1 G UPDQ
"RTN","SDAMN",57,0)
 I $D(SDAMLIST(+AFTER)) S Y=1 I $D(SDAMLIST("SCR")) X SDAMLIST("SCR") S Y=$T
"RTN","SDAMN",58,0)
 I 'Y,$P(SDAMLIST,U)="ALL" S Y=1
"RTN","SDAMN",59,0)
 I Y D
"RTN","SDAMN",60,0)
 . S ^TMP("SDAM",$J,+SDAT,0)=$$SETFLD^VALM1($P(AFTER,";",3),^TMP("SDAM",$J,+SDAT,0),"STAT")
"RTN","SDAMN",61,0)
 . I '$G(CNST) S ^TMP("SDAM",$J,+SDAT,0)=$$SETFLD^VALM1("    ",^TMP("SDAM",$J,+SDAT,0),"CONSULT")
"RTN","SDAMN",62,0)
UPDQ Q Y
"RTN","SDAMWI")
0^37^B13138913
"RTN","SDAMWI",1,0)
SDAMWI ;ALB/MJK - Unscheduled Appointments ; 5/3/05 5:50pm
"RTN","SDAMWI",2,0)
 ;;5.3;Scheduling;**63,94,241,250,296,380,327**;Aug 13, 1993;Build 3
"RTN","SDAMWI",3,0)
 ;
"RTN","SDAMWI",4,0)
EN(DFN,SC) ; -- main entry point
"RTN","SDAMWI",5,0)
 ;    input: DFN ; SC := clinic#
"RTN","SDAMWI",6,0)
 ; returned: success or fail := 1/0
"RTN","SDAMWI",7,0)
 ;
"RTN","SDAMWI",8,0)
 N SDY,SDAPTYP,SDRE,SDRE1,SDIN,SDSL,SDD,SDALLE,SDATD,SDDECOD,SDEC,SDEMP,SDOEL,SDPL,SDRT,SDSC,SDTTM,COLLAT,SDX,SDSTART,ORDER,SDREP,SDDA,SDCL
"RTN","SDAMWI",9,0)
 D 2^VADPT I +VADM(6) W !!?5,*7,"o  Patient has died!" D PAUSE^VALM1 S SDY=0 G ENQ
"RTN","SDAMWI",10,0)
 S SDCL=SC,SDSL=$S($D(^SC(SC,"SL")):+^("SL"),1:""),SDD=0
"RTN","SDAMWI",11,0)
 K SDRE,SDIN,SDRE1
"RTN","SDAMWI",12,0)
 I $D(^SC(SC,"I")) S Y=^("I"),SDIN=+Y,SDRE=+$P(Y,U,2),SDRE1=$$FDATE^VALM1(SDRE)
"RTN","SDAMWI",13,0)
 I $D(SDIN),SDIN,SDIN'>DT,SDRE,SDRE>DT W !!?5,*7,"o  Clinic is inactive from ",$$FTIME^VALM1(SDIN)," to "_SDRE1 D PAUSE^VALM1 S SDY=0 G ENQ
"RTN","SDAMWI",14,0)
 I $D(SDIN),SDIN,SDIN'>DT,'SDRE W !!?5,*7,"o  Clinic is inactive as of ",$$FTIME^VALM1(SDIN) D PAUSE^VALM1 S SDY=0 G ENQ
"RTN","SDAMWI",15,0)
 N SDRES S SDRES=$$CLNCK^SDUTL2(SC,1)
"RTN","SDAMWI",16,0)
 I 'SDRES W !,?5,*7,"o  Clinic MUST be corrected before continuing." D PAUSE^VALM1 S SDY=0 G ENQ
"RTN","SDAMWI",17,0)
 I '$$TIME(.DFN,.SC,.SDT) D WL^SDM1(SC) S SDY=0 G ENQ ;SD/327
"RTN","SDAMWI",18,0)
 S Y=SDT D ^SDM4 I X="^" S SDY=0 G ENQ
"RTN","SDAMWI",19,0)
 ; ** SD*5.3*250 MT Blocking check removed
"RTN","SDAMWI",20,0)
 ;S X="EASMTCHK" X ^%ZOSF("TEST") I $T N EASACT S EASACT="W" I $$MT^EASMTCHK(DFN,+$G(SDAPTYP),EASACT) D PAUSE^VALM1 S SDY=0 G ENQ
"RTN","SDAMWI",21,0)
 ;-- get sub-category for appointment type
"RTN","SDAMWI",22,0)
 S SDXSCAT=$$SUB^DGSAUTL(SDAPTYP,2,"")
"RTN","SDAMWI",23,0)
 S SDY=$$MAKE^SDAMWI1(DFN,SDCL,SDT)
"RTN","SDAMWI",24,0)
 K SDXSCAT
"RTN","SDAMWI",25,0)
ENQ D KVAR^VADPT
"RTN","SDAMWI",26,0)
 Q SDY
"RTN","SDAMWI",27,0)
 ;
"RTN","SDAMWI",28,0)
TIME(DFN,SC,SDT) ; -- get appt date/time
"RTN","SDAMWI",29,0)
 ;    input: DFN ; SC := clinic#
"RTN","SDAMWI",30,0)
 ;   output: SDT := date/time of wi appt
"RTN","SDAMWI",31,0)
 ; returned: success or fail := 1/0
"RTN","SDAMWI",32,0)
 ;
"RTN","SDAMWI",33,0)
 N SDY,%DT
"RTN","SDAMWI",34,0)
ASK R !!,"APPOINTMENT TIME: NOW// ",X:DTIME S X=$$UPPER^VALM1(X)
"RTN","SDAMWI",35,0)
 I X["^"!('$T) S SDY=0 G TIMEQ
"RTN","SDAMWI",36,0)
 I X?.E1"?" D  G ASK
"RTN","SDAMWI",37,0)
 .W !,"  Enter a time or date@time for the appointment or return for 'NOW'."
"RTN","SDAMWI",38,0)
 .W !,"The date must be today or earlier."
"RTN","SDAMWI",39,0)
 S:X=""!(X="N")!(X="NO") X="NOW"
"RTN","SDAMWI",40,0)
 I X'="NOW",X'["@" S X="T@"_X
"RTN","SDAMWI",41,0)
 S %DT="TEP",%DT(0)=-(DT+1) D ^%DT G ASK:Y<0 S SDT=Y
"RTN","SDAMWI",42,0)
 G:'$$CANCHK(.SC,.SDT) ASK
"RTN","SDAMWI",43,0)
 I $D(^DPT(DFN,"S",SDT,0)) W !?5,*7,"o  Patient already has an appt on ",$$FTIME^VALM1(SDT) G ASK
"RTN","SDAMWI",44,0)
 S SDY=1
"RTN","SDAMWI",45,0)
TIMEQ Q SDY
"RTN","SDAMWI",46,0)
 ;
"RTN","SDAMWI",47,0)
CANCHK(SC,SDT) ; -- is clinic cancelled for date
"RTN","SDAMWI",48,0)
 ;    input: SC := clinic# ; SDT := date/time of wi appt
"RTN","SDAMWI",49,0)
 ; returned: success or fail := 1/0
"RTN","SDAMWI",50,0)
 ;
"RTN","SDAMWI",51,0)
 N SDY
"RTN","SDAMWI",52,0)
 S SDY=1
"RTN","SDAMWI",53,0)
 I $D(^SC(SC,"ST",$P(SDT,"."))),'$D(^SC(SC,"ST",$P(SDT,"."),"CAN")) G CANCHKQ
"RTN","SDAMWI",54,0)
 I $D(^SC(SC,"ST",$P(SDT,"."),"CAN")),$G(^SC(SC,"ST",$P(SDT,"."),1))["CANCEL" W !?5,*7,"o  This date's clinic has been cancelled!" S SDY=0 G CANCHKQ
"RTN","SDAMWI",55,0)
 I $D(^SC(SC,"ST",$P(SDT,"."),"CAN")),$G(^SC(SC,"ST",$P(SDT,"."),1))'["CANCEL" W !?5,*7,"o  Warning: Part of this day's clinic has been cancelled!" G CANCHKQ
"RTN","SDAMWI",56,0)
 S SDY=$$AVAIL(.SC,.SDT)
"RTN","SDAMWI",57,0)
CANCHKQ Q SDY
"RTN","SDAMWI",58,0)
 ;
"RTN","SDAMWI",59,0)
AVAIL(SC,SDT) ; -- does clinic meet
"RTN","SDAMWI",60,0)
 ;    input: SC := clinic# ; SDT := date/time of wi appt
"RTN","SDAMWI",61,0)
 ; returned: success or fail := 1/0
"RTN","SDAMWI",62,0)
 ;
"RTN","SDAMWI",63,0)
 N SDY
"RTN","SDAMWI",64,0)
 S X=$P(SDT,".") D DOW^SDM0
"RTN","SDAMWI",65,0)
 I $D(^SC(SC,"T"_Y)) S Z=$O(^SC(SC,"T"_Y,DT)) I Z'="",$D(^SC(SC,"T"_Y,Z,1)),^(1)]"" S SDY=1 G AVAILQ
"RTN","SDAMWI",66,0)
 W !?5,*7,"o  Clinic does not meet on this date!" S SDY=0
"RTN","SDAMWI",67,0)
AVAILQ Q SDY
"RTN","SDAMWI",68,0)
 ;
"RTN","SDAMWI",69,0)
CL(DFN) ; -- make wi appt
"RTN","SDAMWI",70,0)
 ;    input: DFN
"RTN","SDAMWI",71,0)
 ; returned: success or fail := 1/0
"RTN","SDAMWI",72,0)
 ;
"RTN","SDAMWI",73,0)
 S DIC="^SC(",DIC(0)="AEMQ",DIC("A")="Select Clinic: ",DIC("S")="I $P(^(0),U,3)=""C"",'$G(^(""OOS""))"
"RTN","SDAMWI",74,0)
 D ^DIC K DIC
"RTN","SDAMWI",75,0)
 I Y<0 S SDY=0 G CLQ
"RTN","SDAMWI",76,0)
 S SC=+Y S SDY=$$EN(.DFN,.SC)
"RTN","SDAMWI",77,0)
CLQ Q SDY
"RTN","SDAMWI",78,0)
 ;
"RTN","SDAMWI",79,0)
PT(SC) ;
"RTN","SDAMWI",80,0)
 ;    input:  SC := clinic#
"RTN","SDAMWI",81,0)
 ; returned: success or fail := 1/0
"RTN","SDAMWI",82,0)
 ;
"RTN","SDAMWI",83,0)
 S DIC="^DPT(",DIC(0)="AEMQ",DIC("A")="Select Patient: "
"RTN","SDAMWI",84,0)
 D ^DIC K DIC
"RTN","SDAMWI",85,0)
 I Y<0 S SDY=0 G PTQ
"RTN","SDAMWI",86,0)
 S DFN=+Y S SDY=$$EN(.DFN,.SC)
"RTN","SDAMWI",87,0)
PTQ Q SDY
"RTN","SDAMWI",88,0)
 ;
"RTN","SDAMWI1")
0^38^B10737470
"RTN","SDAMWI1",1,0)
SDAMWI1 ;ALB/MJK - Walk-Ins (cont.) ; 6/17/09 4:00pm
"RTN","SDAMWI1",2,0)
 ;;5.3;Scheduling;**94,167,206,168,544**;Aug 13, 1993;Build 3
"RTN","SDAMWI1",3,0)
 ;
"RTN","SDAMWI1",4,0)
MAKE(DFN,SDCL,SDT) ; -- set globals for appt
"RTN","SDAMWI1",5,0)
 ;    input:     DFN ; SDCL := clinic# ; SDT := appt d/t
"RTN","SDAMWI1",6,0)
 ; returned: success := 1
"RTN","SDAMWI1",7,0)
 ;
"RTN","SDAMWI1",8,0)
 N SD,SDINP,SC,DA,DIK
"RTN","SDAMWI1",9,0)
 S SC=SDCL,X=SDT,SDINP=$$INP^SDAM2(DFN,SDT)
"RTN","SDAMWI1",10,0)
 S SD=SDT D EN1^SDM3
"RTN","SDAMWI1",11,0)
 S:'$D(^DPT(DFN,"S",0)) ^(0)="^2.98P^^"
"RTN","SDAMWI1",12,0)
 S ^DPT(DFN,"S",SDT,0)=SC_"^"_$$STATUS^SDM1A(SC,SDINP,SDT)_"^^^^^4^^^^^^^^^"_SDAPTYP_"^^"_$G(DUZ)_"^"_DT_"^^^^^"_$G(SDXSCAT)_"^W^0"
"RTN","SDAMWI1",13,0)
 ;xref DATE APPT. MADE field
"RTN","SDAMWI1",14,0)
 D
"RTN","SDAMWI1",15,0)
 .N DIV
"RTN","SDAMWI1",16,0)
 .S DA=SDT,DA(1)=DFN,DIK="^DPT(DA(1),""S"",",DIK(1)=20 D EN1^DIK
"RTN","SDAMWI1",17,0)
 .Q
"RTN","SDAMWI1",18,0)
 F I=1:1 I '$D(^SC(SC,"S",SDT,1,I)) S:'$D(^(0)) ^(0)="^44.003PA^^" S ^(I,0)=DFN_"^"_SDSL_"^^^^"_DUZ_"^"_DT,^SC(SC,"S",SDT,0)=SDT,SDDA=I D RT,EVT,DUAL,ROUT(DFN) Q
"RTN","SDAMWI1",19,0)
 ;update availability grid
"RTN","SDAMWI1",20,0)
 N HSI,SDDIF,SI,SL,STARTDAY,STR,SDNOT,X,SB,Y,S,I,ST,SS,SM
"RTN","SDAMWI1",21,0)
 S SD=SDT,SC=SDCL
"RTN","SDAMWI1",22,0)
 I '$D(^SC(SC,"ST",$P(SD,"."),1)) Q 1
"RTN","SDAMWI1",23,0)
  S SL=^SC(+SC,"SL"),X=$P(SL,U,3),STARTDAY=$S($L(X):X,1:8),SB=STARTDAY-1/100,X=$P(SL,U,6),HSI=$S(X=1:X,X:X,1:4),SI=$S(X="":4,X<3:4,X:X,1:4),STR="#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz",SDDIF=$S(HSI<3:8/HSI,1:2) K Y
"RTN","SDAMWI1",24,0)
SC L +^SC(SC,"ST",$P(SD,"."),1):5 G:'$T SC S S=^SC(SC,"ST",$P(SD,"."),1) S I=SD#1-SB*100,ST=I#1*SI\.6+($P(I,".")*SI),SS=SL*HSI/60*SDDIF+ST+ST G C:(I<1!'$F(S,"["))&(S'["CAN")
"RTN","SDAMWI1",25,0)
 S SM=0
"RTN","SDAMWI1",26,0)
 I SM<7 S %=$F(S,"[",SS-1) S:'%!($P(SL,"^",6)<3) %=999 I $F(S,"]",SS)'<%!(SDDIF=2&$E(S,ST+ST+1,SS-1)["[") S SM=7
"RTN","SDAMWI1",27,0)
SP I ST+ST>$L(S) S S=S_"  " G SP
"RTN","SDAMWI1",28,0)
 S SDNOT=1 F I=ST+ST:SDDIF:SS-SDDIF S ST=$E(S,I+1) S:ST="" ST=" " S Y=$E(STR,$F(STR,ST)-2) G C:S["CAN"!(ST="X"&($D(^SC(+SC,"ST",$P(SD,"."),"CAN")))),C:Y="" S:Y'?1NL&(SM<6) SM=6 S ST=$E(S,I+2,999) S:ST="" ST=" " S S=$E(S,1,I)_Y_ST
"RTN","SDAMWI1",29,0)
 S ^SC(+SC,"ST",$P(SD,"."),1)=S
"RTN","SDAMWI1",30,0)
C L -^SC(+SC,"ST",$P(SD,"."),1)
"RTN","SDAMWI1",31,0)
 Q 1
"RTN","SDAMWI1",32,0)
 ;
"RTN","SDAMWI1",33,0)
RT ; -- request record
"RTN","SDAMWI1",34,0)
 S SDRT="A",SDTTM=SDT,SDPL=I,SDSC=SC D RT^SDUTL
"RTN","SDAMWI1",35,0)
 Q
"RTN","SDAMWI1",36,0)
 ;
"RTN","SDAMWI1",37,0)
ROUT(DFN) ; -- print routing slip
"RTN","SDAMWI1",38,0)
 S DIR("A")="DO YOU WANT TO PRINT A ROUTING SLIP NOW",DIR(0)="Y"
"RTN","SDAMWI1",39,0)
 W ! D ^DIR K DIR G ROUTQ:$D(DIRUT)!(Y=0)
"RTN","SDAMWI1",40,0)
 K IOP S (SDX,SDSTART,ORDER,SDREP)="" D EN^SDROUT1
"RTN","SDAMWI1",41,0)
ROUTQ Q
"RTN","SDAMWI1",42,0)
 ;
"RTN","SDAMWI1",43,0)
DUAL ; -- ask elig if pt has more than one
"RTN","SDAMWI1",44,0)
 I $O(VAEL(1,0))>0 S SDEMP="" D ELIG^SDM4:"369"[SDAPTYP S SDEMP=$S(SDDECOD:SDDECOD,1:SDEMP) I +SDEMP S $P(^SC(SC,"S",SDT,1,I,0),"^",10)=+SDEMP K SDEMP
"RTN","SDAMWI1",45,0)
 Q
"RTN","SDAMWI1",46,0)
 ;
"RTN","SDAMWI1",47,0)
EVT ; -- separate if need to NEW vars
"RTN","SDAMWI1",48,0)
 N I,DIV D MAKE^SDAMEVT(DFN,SDT,SDCL,SDDA,0)
"RTN","SDAMWI1",49,0)
 Q
"RTN","SDASO")
0^39^B9030001
"RTN","SDASO",1,0)
SDASO ;MAN/GRR - APPEND TESTS TO PENDING APPOINTMENT ; 22 DEC 83  11:02 am
"RTN","SDASO",2,0)
 ;;5.3;Scheduling;;Aug 13, 1993;Build 3
"RTN","SDASO",3,0)
 S:'$D(DTIME) DTIME=300 D:'$D(DT) DT^SDUTL S HDT=DT,APL=""
"RTN","SDASO",4,0)
RD S DIC="^DPT(",DIC(0)="AEQM",CNT=0 D ^DIC G:"^"[X END I Y<0 W !,*7,*7,"PATIENT NOT FOUND",*7,*7 G RD
"RTN","SDASO",5,0)
 S DFN=+Y,NAME=$P(Y,"^",2) W ! I $N(^DPT(DFN,"S",HDT))'>0 G NO
"RTN","SDASO",6,0)
 S NDT=HDT,L=0 F J=1:1 S NDT=$N(^DPT(DFN,"S",NDT)) Q:NDT'>0  I $S($P(^(NDT,0),"^",2)']"":1,$P(^(0),"^",2)["I":1,1:0) D CHKSO S SC=+^(0),L=L+1 D FLEN S Z(L)=NDT_"^"_SC_"^"_APL_"^"_COMMENT
"RTN","SDASO",7,0)
 G:L'>0 NO F ZZ=1:1:L W !!,ZZ,") " S Y=$P($P(Z(ZZ),"^",1),".",1) D DT^SDM0 S X=$P(Z(ZZ),"^",1) X ^DD("FUNC",2,1) W " ",$J(X,8)," (",$P(Z(ZZ),"^",3)," MINUTES)  ",$P(^SC($P(Z(ZZ),"^",2),0),"^",1)," ",$P(Z(ZZ),"^",4)
"RTN","SDASO",8,0)
WH R !!,"SCHEDULE TESTS FOR WHICH NUMBERED APPOINTMENT: ",APP:DTIME G:APP=""!(APP="^") RD I APP?."?" D HLP G WH
"RTN","SDASO",9,0)
 I APP'?1N.N W !,"INVALID ENTRY, MUST BE NUMERIC" G WH
"RTN","SDASO",10,0)
 I $L(APP)>5 W !,"ENTER A NUMBER BETWEEN 1 AND ",ZZ G WH
"RTN","SDASO",11,0)
 I APP<1!(APP>ZZ) W !,"ENTER A NUMBER BETWEEN 1 AND ",ZZ G WH
"RTN","SDASO",12,0)
 I $$CO(DFN,+Z(APP),"add") G WH
"RTN","SDASO",13,0)
 S SD=$P(Z(APP),"^",1) S CNT=CNT+1,Y=SD D DTS^SDUTL S SODT=Y,SDWR=0,(LAB,XRAY,EKG)="" D ORD^SDM3 G RD
"RTN","SDASO",14,0)
NOPE W:'CNT !,*7,"NOTHING SCHEDULED" G RD
"RTN","SDASO",15,0)
NO W !,"NO PENDING APPOINTMENTS",*7,*7,*7
"RTN","SDASO",16,0)
 G RD
"RTN","SDASO",17,0)
FLEN I $D(^SC(SC,"S",NDT)) F ZL=0:0 S ZL=$N(^SC(SC,"S",NDT,1,ZL)) Q:ZL<0  I +^(ZL,0)=DFN S APL=$P(^SC(SC,"S",NDT,1,ZL,0),"^",2) Q
"RTN","SDASO",18,0)
 Q
"RTN","SDASO",19,0)
CHKSO S COMMENT="",SDAPAV=^(0),SDANAM="LAB"_U_"XRAY"_U_"EKG" F SDJ=3,4,5 I $P(SDAPAV,"^",SDJ)]"" S:$L(COMMENT) COMMENT=COMMENT_"," S COMMENT=COMMENT_$S(SDJ=3:"LAB",SDJ=4:"XRAY",1:"EKG"),@($P(SDANAM,U,SDJ-2))=$P(SDAPAV,U,SDJ)
"RTN","SDASO",20,0)
 ;NAKED REFERENCE - ^DPT(DFN,"S",Date,0)
"RTN","SDASO",21,0)
 S:$L(COMMENT) COMMENT="("_COMMENT_" TEST SCHEDULED)" Q
"RTN","SDASO",22,0)
END K CNT,NDT,L,J,HDT,SC,SD,APL,COMMENT,Z,ZZ,APP,ZL,SDJ,X,%DT,DIC,DFN,NAME,Y,POP,SDAPAV,SDTY Q
"RTN","SDASO",23,0)
HLP W !,"Enter the number that corresponds to the appointment." Q
"RTN","SDASO",24,0)
 ;
"RTN","SDASO",25,0)
CO(DFN,SDT,ACTION) ; -- can action be performed ; has appt been co'ed
"RTN","SDASO",26,0)
 N Y
"RTN","SDASO",27,0)
 S Y=0
"RTN","SDASO",28,0)
 I $P($G(^SCE(+$P(^DPT(DFN,"S",SDT,0),U,20),0)),U,12)=2 D
"RTN","SDASO",29,0)
 .S Y=1
"RTN","SDASO",30,0)
 .W !,*7,"This appointment has been checked out!"
"RTN","SDASO",31,0)
 .W !,"Please use Add/Edit stop code functionality to ",ACTION," the appropriate test."
"RTN","SDASO",32,0)
 Q Y
"RTN","SDCD")
0^14^B9650048
"RTN","SDCD",1,0)
SDCD ;BSN/GRR - DISCHARGE PATIENT FROM CLINIC ;3/15/91  11:24 ;
"RTN","SDCD",2,0)
 ;;5.3;Scheduling;**41,148**;AUG 13, 1993;Build 3
"RTN","SDCD",3,0)
15 D:'$D(DT) DT^SDUTL I '$G(SDFN) S DIC="^DPT(",DIC(0)="AEQM" D ^DIC G:Y=-1 QUIT
"RTN","SDCD",4,0)
 S:$G(SDFN) Y=+SDFN S DA(2)=+Y
"RTN","SDCD",5,0)
 I '$G(SDCLN) G:'$D(^DPT(+Y,"DE")) NOPE S DIC="^DPT("_DA(2)_",""DE"",",DIC("S")="I $P(^(0),""^"",2)']""""",VAUTSTR="clinic",VAUTNI=2,VAUTVB="VAUTC" D FIRST^VAUTOMA K DIC("S") Q:Y<0
"RTN","SDCD",6,0)
 I $G(SDCLN) D  G QUIT:'$O(VAUTC(0))
"RTN","SDCD",7,0)
 .S VAUTC=0,VAUTC(+$O(^DPT(DA(2),"DE","B",+SDCLN,99999),-1))=+SDCLN
"RTN","SDCD",8,0)
 .I '$O(VAUTC(0)) W !!,*7,">>> Patient not enrolled in '",$S($D(^SC(+SDCLN,0)):$P(^(0),"^"),1:"Unknown"),"' clinic." S SDAMERR=1
"RTN","SDCD",9,0)
 I VAUTC=1 F I=0:0 S I=$O(^DPT(DA(2),"DE",I)) Q:'I  S CLINIC=^DPT(DA(2),"DE",I,0) I $P(CLINIC,U,2)']"" S VAUTC(I)=+CLINIC
"RTN","SDCD",10,0)
 D BEFORE^SCMCEV3(DA(2)) ;setup before values
"RTN","SDCD",11,0)
 F I=0:0 S I=$O(VAUTC(I)) Q:'I  S DA(1)=I,SC=VAUTC(I) D DIS
"RTN","SDCD",12,0)
 I '$O(VAUTC(0)) W !!,*7,">>> Patient is not actively enrolled in any clinics." S SDAMERR=1
"RTN","SDCD",13,0)
 I '$D(SDAMERR) D AFTER^SCMCEV3(DA(2)) ;setup after values
"RTN","SDCD",14,0)
 ;call team event driver
"RTN","SDCD",15,0)
 I '$D(SDAMERR) D INVOKE^SCMCEV3(DA(2))
"RTN","SDCD",16,0)
 G 15:'$G(SDFN)
"RTN","SDCD",17,0)
QUIT ;
"RTN","SDCD",18,0)
 K CLINIC,DFN,SC,SDF,SDST,VAUTC,VAUTD,VAUTNI,VAUSTR,VAUTVB,DIC
"RTN","SDCD",19,0)
 Q
"RTN","SDCD",20,0)
DIS ;
"RTN","SDCD",21,0)
 S SDF=0
"RTN","SDCD",22,0)
 I $P(^DPT(DA(2),"DE",DA(1),0),"^",2)]"" W *7,*7,!,"PATIENT ALREADY DISCHARGED FROM '",$S($D(^SC(SC,0)):$P(^(0),U),1:"UNKNOWN"),"' CLINIC",*7,*7 S SDAMERR=1 Q
"RTN","SDCD",23,0)
 W !!,"***Discharging patient from ",$S($D(^SC(SC,0)):$P(^(0),U),1:"UNKNOWN")," Clinic***",!
"RTN","SDCD",24,0)
 F XX=DT_.2359:0 S XX=$O(^DPT(DA(2),"S",XX)) Q:XX'>0  I $P(^(XX,0),"^",1)=SC,$P(^(0),"^",2)=""!($P(^(0),"^",2)="I") W !?10,*7,"PATIENT HAS FUTURE APPOINTMENT(S) IN THIS CLINIC" S SDF=1
"RTN","SDCD",25,0)
 I 'SDF F XX=0:0 S XX=$O(^DPT(DA(2),"DE",DA(1),1,XX)) Q:XX=""  D STAT I SDST']"" S DIE="^DPT("_DA(2)_",""DE"","_DA(1)_",1,",DA=XX,DR="3"_$S($G(SCDISCH):"///"_SCDISCH,1:"")_";I 'X S Y=0;I X S XD=1;4" D ^DIE
"RTN","SDCD",26,0)
 W !,*7,"Patient ",$S('$D(XD):"NOT ",XD=2:"ALREADY ",1:""),"Discharged from clinic !!",! S:SDF SDF=0,SDAMERR=1 K XD
"RTN","SDCD",27,0)
 Q
"RTN","SDCD",28,0)
NOPE W !,*7,"PATIENT NOT ENROLLED IN ANY CLINICS!!" G QUIT:$G(SDFN),15
"RTN","SDCD",29,0)
STAT ;ck if already discharged
"RTN","SDCD",30,0)
 S SDST=$P(^DPT(DA(2),"DE",DA(1),1,XX,0),U,3) Q:SDST']""
"RTN","SDCD",31,0)
 S DIE="^DPT("_DA(2)_",""DE"","_DA(1)_",1,",DA=XX,DR="3////^S X=SDST"
"RTN","SDCD",32,0)
 L @(DIE_XX_")"):2 G:'$T STAT D ^DIE L  S:'$D(XD) XD=2 Q
"RTN","SDCI")
0^16^B2053343
"RTN","SDCI",1,0)
SDCI ;SF/GFT,MAN/GRR - CHECK-IN/UNSCHEDULED APPOINTMENT ; 20 SEP 84  8:20 am
"RTN","SDCI",2,0)
 ;;5.3;Scheduling;;Aug 13, 1993;Build 3
"RTN","SDCI",3,0)
 ;
"RTN","SDCI",4,0)
PT ;
"RTN","SDCI",5,0)
 N DFN,SDT,SC,SDT,SDDQ,SDD
"RTN","SDCI",6,0)
 W !! S DIC="^DPT(",DIC(0)="AEQMZ" D ^DIC K DIC G PTQ:Y<0
"RTN","SDCI",7,0)
 S DFN=+Y,SDT=DT,SDD=0
"RTN","SDCI",8,0)
 F  S SDT=$O(^DPT(DFN,"S",SDT)) Q:$P(SDT,".")-DT  S X=$G(^(SDT,0)) I $P(X,U,2)'["C",$P(X,U,2)'["N"!($P(X,U,2)="NT") S SC=+X D
"RTN","SDCI",9,0)
 .S SDDA=0 F  S SDDA=+$O(^SC(SC,"S",SDT,1,SDDA)) Q:'$D(^(SDDA,0))  I DFN=+^(0) D  Q
"RTN","SDCI",10,0)
 ..W !!,"Appointment at "_$E(SDT_"000",9,12)_" on ",$$FDATE^VALM1(SDT)," in "_$P(^SC(SC,0),U)
"RTN","SDCI",11,0)
 ..D ONE^SDAM2(DFN,SC,SDT,SDDA,1,"") S SDD=SDD+1
"RTN","SDCI",12,0)
 ;
"RTN","SDCI",13,0)
 W:'SDD *7,!,"This patient has no appointments scheduled today."
"RTN","SDCI",14,0)
 W ! S DIR("A")="Do you want to add a new 'unscheduled' appointment'",DIR(0)="Y"
"RTN","SDCI",15,0)
 D ^DIR K DIR G PTQ:Y'=1
"RTN","SDCI",16,0)
 S SDY=$$CL^SDAMWI(DFN)
"RTN","SDCI",17,0)
PTQ Q
"RTN","SDCNP")
0^15^B16969835
"RTN","SDCNP",1,0)
SDCNP ;ALB/LDB - CANCEL SINGLE OR MULTIPLE APPOINTMENTS FOR PATIENT ; 3/2/05 2:33pm
"RTN","SDCNP",2,0)
 ;;5.3;Scheduling;**32,116,478**;Aug 13, 1993;Build 3
"RTN","SDCNP",3,0)
 K ORACTION
"RTN","SDCNP",4,0)
RD G END:$D(ORACTION)!($D(SDAMTYP)) S DIC="^DPT(",DIC(0)="AEQM" D ^DIC G:X=""!(X="^") END I Y<0 W !,*7,*7,"PATIENT NOT FOUND",*7,*7 G RD
"RTN","SDCNP",5,0)
 S (DA,DFN)=+Y,NAME=$P(Y,"^",2)
"RTN","SDCNP",6,0)
EN D DT^SDUTL:'$D(DT) S HDT=DT,APL="" D NOW^%DTC S (SDTM,HDT)=$J(%,".",4),(SDERR,CNT)=0
"RTN","SDCNP",7,0)
SEL R !,"DO YOU WANT TO CANCEL (P)AST OR (F)UTURE APPOINTMENTS? F// ",X9:DTIME G:X9["^"!('$T) END S:X9="" X9="F" S X9=$$UP^XLFSTR(X9) I "FP"'[X9!(X9["?") W !,"Enter a P to cancel past appointments or F to cancel future appointments" G SEL
"RTN","SDCNP",8,0)
 S SDPV=$S(X9=""!(X9["F"):"",1:1)
"RTN","SDCNP",9,0)
 S SDERR=0 W ! I ('$O(^DPT(DFN,"S",$P(SDTM,".")))&'SDPV)!(SDPV&($O(^DPT(DFN,"S",0))'<SDTM)) G NO^SDCNP0
"RTN","SDCNP",10,0)
STAT R !,"APPOINTMENTS CANCELLED BY (P)ATIENT OR BY (C)LINIC? P// ",SDWH:DTIME G:SDWH="^"!('$T) END S SDWH=$$UP^XLFSTR(SDWH) I SDWH'="",SDWH'["P",SDWH'["C" W !,"Enter a P for by Patient or a C for by Clinic" G STAT
"RTN","SDCNP",11,0)
 S SDWH=$S(SDWH["P":"PC",SDWH="":"PC",1:"C"),SDCP=$S(SDWH="C":0,1:1)
"RTN","SDCNP",12,0)
RSN S SDSCRPC=$S(SDWH["P":"P",1:"C"),DIC="^SD(409.2,",DIC(0)="AEQM",DIC("S")="I '$P(^(0),U,4),(SDSCRPC_""B""[$P(^(0),U,2))" D ^DIC G:X="^" END S SDSCR=$S(X="":X,1:+Y) K SDSCRPC,DIC I X="" G RSN
"RTN","SDCNP",13,0)
REM R !,"CANCELLATION REMARKS: ",SDREM:DTIME G:SDREM["^"!('$T) END G:SDREM="" W  ;SD/478
"RTN","SDCNP",14,0)
 S TMPD=SDREM ;SD/478
"RTN","SDCNP",15,0)
 I $L(SDREM)<3!($L(SDREM)>160)!(SDREM?."?") W !,*7,"Must be 3 to 160 characters in length" G REM
"RTN","SDCNP",16,0)
 I SDREM'?.ANP W !,*7,"NO CONTROL CHARACTERS" G REM
"RTN","SDCNP",17,0)
W K Z,Z1,ZX W !!,"READY TO CANCEL ",$S('SDPV:"PENDING",1:"PREVIOUS")," APPTS",!
"RTN","SDCNP",18,0)
DATE I SDPV S %DT="AEXP",%DT("A")="DISPLAY APPTS STARTING WITH DATE: FIRST// " S %DT(0)="-NOW" D ^%DT G:X["^" END S HDT=$S(Y>0:Y,1:0) K %DT
"RTN","SDCNP",19,0)
 G ^SDCNP0
"RTN","SDCNP",20,0)
END D END^SDAUT2 K %,%DT,%H,%I,%Y,A,A1,A2,A8,A9,B,ADDR,DTOUT,ANS,APL,APP,APPZ,AT,CNT,C,CDATE,CHAR,CLIN,CNN,COMMENT,COV,D0,DA,DATE,DGPGM,DGVAR,DI,DIC,DIE,DIPGM,DIV,DK,DL,DOW,DR,DUPE,ENDATE,GDATE,HDT,HSI,I,J,L,L1,L5,LL,NAME,NDT,NDATE,M1,M8,MAX
"RTN","SDCNP",21,0)
 K PDAT,POP,Q,Q1,S,S1,S2,S3,S5,S9,SD0,SD2,SB,SC,SD,SDA,SDAP,SD1,SDCL,SDCP,SDCNT,SDCNT1,SDCTR,SDCTRL,SDDH,SDDI,SDDIF,SDDK,SDDM,SDDT,SDDT1,SDEND,SDERR,SDFOR,SDINP,SDIO,SDJ,SDJ1,SDLET,SDLN,SDLN1,SDLN2,SDMSG,SDMDT,SDNODE,SDP,SDP1,SDPV,SDPT,SDPRT,SDR
"RTN","SDCNP",22,0)
 K A0,A1,A3,A5,ALL,SDREM,SDS,SDRT,SDTADE,SDTADB,SDPRT,SDSCR,SDSOH,SDA,SDT,SDTH,SDT1,SDTTM,SDX,SDX1,SDV,SDV2,SL,SM,STARTDAY,STIME,STR,TIME,SDTM,SDWH,SDXX,X1,X3,X8,X9,SI,SS,ST,SDSTRTDT,X,Y,Z,Z0,Z1,Z5,Z6,Z7,Z9,ZL,ZX,^UTILITY($J)
"RTN","SDCNP",23,0)
 K MESS,MIN,DIW,DIWF,DIWL,DIWR,DIWT,DN,DQ,L0,SDADD,SDC,SDDAT,SDHX,SDT0,SD20,TST,TMPD Q
"RTN","SDCNP",24,0)
OERR S XQORQUIT=1 Q:'$D(ORVP)  S (DA,DFN)=+ORVP,NAME=$S($D(^DPT(DFN,0)):$P(^(0),"^",1),1:"") D EN N PAUSE W !,"Press Return to continue: " R PAUSE:DTIME K PAUSE Q
"RTN","SDCNP1A")
0^17^B29978567
"RTN","SDCNP1A",1,0)
SDCNP1A ;ALB/LDB - CANCEL APPT. (continued) ; 5/26/05 10:59am
"RTN","SDCNP1A",2,0)
 ;;5.3;Scheduling;**167,340,398,478,517**;Aug 13, 1993;Build 3
"RTN","SDCNP1A",3,0)
LOOP S SDCNT1=0 F SDAP=0:0 S SDAP=$O(^UTILITY($J,"SDCNP2","REBK",DFN,SDAP)) Q:SDAP'>0  S SDP1=^(SDAP),S1=$P(SDP1,"^",2),S9=$P(^SC(S1,0),"^") D SDDT Q:X8="^"  D RBK S MAX=1
"RTN","SDCNP1A",4,0)
 Q
"RTN","SDCNP1A",5,0)
SDDT W !!,"IN ",S9 D:'$D(DT) DT^SDUTL D DT S %DT="AEX",%DT("A")="START REBOOKING FROM WHAT DATE: "_D S %DT(0)=DT D ^%DT K %DT S X8=X Q:$D(DTOUT)!(X="^")  S:X8="" Y=DT G:Y<0 SDDT S SDDT=+Y\1 K X,Y,DIC S X1=SDDT,X2=DT D ^%DTC
"RTN","SDCNP1A",6,0)
 S (M8,MAX)=0,S1=$P(SDP1,"^",2),S2=$P(SDP1,"^"),M1=$S($D(^SC(S1,"SDP")):$P(^("SDP"),"^",4),1:0) D MAX G:M8 SDDT
"RTN","SDCNP1A",7,0)
 I S2>DT S X1=SDDT,X2=1 D C^%DTC S SDDT=X
"RTN","SDCNP1A",8,0)
 Q
"RTN","SDCNP1A",9,0)
MAX I X>M1 S M8=1 W !!,"Exceeds maximum number of days for rebooking in ",S9 S MAX=0
"RTN","SDCNP1A",10,0)
 Q
"RTN","SDCNP1A",11,0)
RBK S GDATE=S2,SC=S1,LEN=$P(SDP1,"^",6),A=DFN_"^"_LEN,(CDATE,DATE)=SDDT D OVR1,SDIN D ^SDAUT1 D:'MAX NRBK D:MAX ^SDAUT2,SDNP K SDIN Q
"RTN","SDCNP1A",12,0)
OVR1 N X S SL=$S($D(^SC(SC,"SL")):^("SL"),1:"") Q:'SL  S X=$P(SL,U,6),SI=$S(X="":4,X<3:4,X:X,1:4),X=$P(SL,U,3),STARTDAY=$S($L(X):X,1:8),SDSTRTDT=$S(DT>DATE:DT,1:DATE),STIME=$S($D(^SC(SC,"SDP")):$P(^("SDP"),U,3),1:"0800"),SDSTRTDT=SDSTRTDT+2
"RTN","SDCNP1A",13,0)
 Q
"RTN","SDCNP1A",14,0)
SDIN I $D(^SC(SC,"I")) S SDIN=+^("I") Q
"RTN","SDCNP1A",15,0)
 Q
"RTN","SDCNP1A",16,0)
SDNP S SDCL(SDAP)=SC_"^"_GDATE_"^"_NDATE S:NDATE SDCNT1=SDCNT1+1 Q
"RTN","SDCNP1A",17,0)
NRBK W !,"NO REBOOKING ALLOWED FOR ",$P(^SC(SC,0),"^") Q
"RTN","SDCNP1A",18,0)
DT S X1=$P(DT,"."),X2=10 D C^%DTC S Y=X D D^DIQ S D=Y_"//" Q
"RTN","SDCNP1A",19,0)
PROT S SDPRT=0 I $D(^SC(+I,"SDPROT")),$P(^("SDPROT"),U)="Y",'$D(^SC(+I,"SDPRIV",DUZ)) W !,*7,"Appt. in ",$P(^SC(+I,0),"^")," NOT CANCELLED ",!,"Access to this clinic is restricted to only privileged users!",*7 S SDPRT=1 Q
"RTN","SDCNP1A",20,0)
 Q
"RTN","SDCNP1A",21,0)
 ;SD/517 added new IF statement, changed For loop & added 2 new linetags
"RTN","SDCNP1A",22,0)
FLEN S (ZPL,SDSP)=""  ;SD/517
"RTN","SDCNP1A",23,0)
 S COV=$S($P(^DPT(DFN,"S",NDT,0),"^",11)=1:" (COLLATERAL) ",1:"") I $D(^SC(SC,"S",NDT)) S ZL=0 F  S ZL=$O(^SC(SC,"S",NDT,1,ZL)) Q:'ZL  D
"RTN","SDCNP1A",24,0)
 .I '$D(^SC(SC,"S",NDT,1,ZL,0)) D FLEN1 Q
"RTN","SDCNP1A",25,0)
 .I +^SC(SC,"S",NDT,1,ZL,0)=DFN S APL=$P(^(0),U,2),SDSP=$P($G(^SC(SC,"S",NDT,1,ZL,"CONS")),U)
"RTN","SDCNP1A",26,0)
 .Q
"RTN","SDCNP1A",27,0)
 ;S COV=$S($P(^DPT(DFN,"S",NDT,0),"^",11)=1:" (COLLATERAL) ",1:"") I $D(^SC(SC,"S",NDT)) F ZL=0:0 S ZL=$O(^SC(SC,"S",NDT,1,ZL)) Q:ZL'>0  I +^(ZL,0)=DFN S APL=$P(^(0),"^",2),SDSP=$P($G(^SC(SC,"S",NDT,1,ZL,"CONS")),U) Q  ;SD/478
"RTN","SDCNP1A",28,0)
 Q
"RTN","SDCNP1A",29,0)
 ;
"RTN","SDCNP1A",30,0)
 ;SD/517 added new linetag to kill any lingering "C" nodes
"RTN","SDCNP1A",31,0)
FLEN1 Q:'$D(^SC(SC,"S",NDT,1,ZL,"C"))
"RTN","SDCNP1A",32,0)
 S DA(2)=SC,DA(1)=NDT,DA=ZL,DIK="^SC("_DA(2)_",""S"","_DA(1)_",1," D ^DIK
"RTN","SDCNP1A",33,0)
 Q
"RTN","SDCNP1A",34,0)
 ;
"RTN","SDCNP1A",35,0)
LOOP1 S SDCNT1=0 F L=0:0 S L=$O(^UTILITY($J,"SDCNP",L)) Q:L'>0  I ^(L)["JUST CANCELLED" S $P(SDCL(L),"^")=$P(^(L),"^",2),$P(SDCL(L),"^",2)=$P(^(L),"^")
"RTN","SDCNP1A",36,0)
 K ^UTILITY($J) Q
"RTN","SDCNP1A",37,0)
SDLET N NDT,GDT
"RTN","SDCNP1A",38,0)
 U IO D Q
"RTN","SDCNP1A",39,0)
 F SDP=0:0 S SDP=$O(SDCL(SDP)) Q:SDP'>0  D
"RTN","SDCNP1A",40,0)
 . S SDP1=SDCL(SDP),SDC=+SDP1,GDT=$P(SDP1,"^",2),NDT=$P(SDP1,"^",3),SDV1=$P(^SC(SDC,0),"^",15)
"RTN","SDCNP1A",41,0)
 . D B I (SDB)!(SDK) Q
"RTN","SDCNP1A",42,0)
 . S:'SDV1 SDV1=+$O(^DG(40.8,0))
"RTN","SDCNP1A",43,0)
 . D F S:SDLET ^UTILITY($J,SDLET,+A,GDT)=SDC_"^"_NDT
"RTN","SDCNP1A",44,0)
 F SDLET=0:0 S SDLET=$O(^UTILITY($J,SDLET)) Q:SDLET'>0  F B0=0:0 S A1=B0,B0=$O(^UTILITY($J,SDLET,B0)) D:'B0 R Q:'B0  D:A1&(A1'=B0) R S A=B0 D ^SDLT,APP
"RTN","SDCNP1A",45,0)
 I $D(^UTILITY($J,"NO")) W @IOF,! F SC=0:0 S SC=$O(^UTILITY($J,"NO",SC)) Q:SC'>0  W !,$P(^SC(SC,0),"^")," Clinic is not assigned a letter",!!
"RTN","SDCNP1A",46,0)
E I $D(^TMP($J,"BADADD")) D BADADD^SDLT K ^TMP($J,"BADADD") I $E(IOST,1,2)="C-" S DIR(0)="E" D ^DIR K ^DIR(0)
"RTN","SDCNP1A",47,0)
 ;I $G(SDB),SDB W !!,"BAD ADDRESS INDICATOR FOR THIS PATIENT. NO LETTER WILL BE PRINTED." S DIR(0)="E" D ^DIR K DIR(0)
"RTN","SDCNP1A",48,0)
 I $G(SDK),'SDK W !!,"NO LETTER CAN BE PRINTED FOR THIS PATIENT." S DIR(0)="E" D ^DIR K DIR(0)
"RTN","SDCNP1A",49,0)
 K A,SDCL D CLOSE^DGUTQ
"RTN","SDCNP1A",50,0)
Q K A1,SDFORM,SDLET,SDNDT,SDP1,SDV1,^UTILITY($J),SDB,SDK Q
"RTN","SDCNP1A",51,0)
F S SDFORM="" I $D(^DG(40.8,SDV1,"LTR")),^("LTR") S SDFORM=^("LTR")
"RTN","SDCNP1A",52,0)
 S SDLET="" I $D(^SC(SDC,"LTR")) S:SDWH["P" SDLET=$P(^("LTR"),"^",4) S:SDWH'["P" SDLET=$P(^("LTR"),"^",3)
"RTN","SDCNP1A",53,0)
 I 'SDLET S ^UTILITY($J,"NO",SDC)=""
"RTN","SDCNP1A",54,0)
 Q
"RTN","SDCNP1A",55,0)
R I $D(^UTILITY($J,"R",SDLET,A1)) W !!,"The appointment(s) have been rescheduled as follows:",! F A2=0:0 S A2=$O(^UTILITY($J,"R",SDLET,A1,A2)) Q:A2'>0  S (X,SDX)=A2,SDC=+^(A2),A=A1,SDS=^DPT(DFN,"S",SDX,0) D WRAPP^SDLT K X,SDX
"RTN","SDCNP1A",56,0)
 D REST^SDLT Q
"RTN","SDCNP1A",57,0)
APP F SDX=0:0 S SDX=$O(^UTILITY($J,SDLET,A,SDX)) Q:SDX'>0  S S=^DPT(+A,"S",SDX,0),SDC=+^(0) D WRAPP^SDLT I $P(^UTILITY($J,SDLET,A,SDX),"^",2) S ^UTILITY($J,"R",SDLET,A,$P(^UTILITY($J,SDLET,A,SDX),"^",2))=$P(^(SDX),"^")
"RTN","SDCNP1A",58,0)
 Q
"RTN","SDCNP1A",59,0)
CKK I $L(SDDI)>4!($L(SDDM)>4) S SDERR=1 W !,"There is no appointment number ",$S($L(SDDI)>5:SDDI,1:SDDM) Q
"RTN","SDCNP1A",60,0)
 Q
"RTN","SDCNP1A",61,0)
CKK1 F Z0=SDDI,SDDM Q:'SDDI!('SDDM&(SDDI-Z0))  S SDERR=0 S:$L(Z0)>5 SDERR=1 Q:SDERR  S:$L(SDDI)<5 SDDI=+SDDI S:$L(SDDM)<5 SDDM=+SDDM I $L(Z0)>5!('$D(^UTILITY($J,"SDCNP",Z0,"CNT"))) S SDERR=1 Q
"RTN","SDCNP1A",62,0)
 W:SDERR !,*7,"There is no appointment number ",Z0 H 2 Q
"RTN","SDCNP1A",63,0)
CKK2 F Z0=SDDI,SDDM Q:'SDDI!('SDDM&(SDDI-Z0))  S SDERR=0 S:$L(Z0)>5 SDERR=1 Q:SDERR  S:$L(SDDI)<5 SDDI=+SDDI S:$L(SDDM)<5 SDDM=+SDDM I $L(Z0)>5!('$D(^UTILITY($J,"SDCNP2",DFN,Z0))) S SDERR=1 Q
"RTN","SDCNP1A",64,0)
 W:SDERR !,*7,"There is no appointment number ",Z0 Q
"RTN","SDCNP1A",65,0)
B S SDB=$$BADADR^DGUTL3(+A)
"RTN","SDCNP1A",66,0)
 S:SDB ^TMP($J,"BADADD",$P(^DPT(+A,0),"^"),+A)=""
"RTN","SDCNP1A",67,0)
CHECK S SDK=0 I $S('$D(^DPT(+A,.35)):1,$P(^(.35),"^",1)']"":1,1:0),$D(^DPT(+A,"S",GDT,0)),$S($P(^(0),"^",2)["N":1,$D(SDCP)&$P(^(0),"^",2)["C":1,1:0),$P(^(0),"^",14)=SDTIME!(SDTIME="*"),'$D(^DPT(+A,.1)) S SDK=1
"RTN","SDCNP1A",68,0)
 Q
"RTN","SDCNSLT")
0^18^B40644653
"RTN","SDCNSLT",1,0)
SDCNSLT ;ALB/HAG-LINK APPOINTMENTS TO CONSULTS; 4/12/05 3:44pm  ; Compiled February 5, 2007 14:09:59
"RTN","SDCNSLT",2,0)
 ;;5.3;Scheduling;**478,496**;Aug 13, 1993;Build 3
"RTN","SDCNSLT",3,0)
A ;===GET ACTIVE AND PENDING CONSULT
"RTN","SDCNSLT",4,0)
 N A,ND,CNT,CONS,CPRSTAT,DTENTR,DTIN,DTLMT,DTR,NOS,NOSHOW,SENDER,SERVICE,SRV,P8,PROC,PT,PTNM,STATUS
"RTN","SDCNSLT",5,0)
 K TMP S NOSHOW="no-show",CNT=0,$P(DSH,"-",IOM-1)="",PT=DFN,X1=DT,X2=-365 D C^%DTC S DTLMT=X
"RTN","SDCNSLT",6,0)
 S A=":" F  S A=$O(^GMR(123,"F",PT,A),-1) Q:'+A  S ND=$G(^GMR(123,A,0)) Q:ND=""  S PROC=$P($G(^GMR(123,A,1.11)),U),DTENTR=$P(ND,U) I DTENTR>DTLMT S CPRSTAT=$P(ND,U,12) D:CPRSTAT=5!(CPRSTAT=6)!(CPRSTAT=8)!(CPRSTAT=13)
"RTN","SDCNSLT",7,0)
 .I STPCOD'="" S SRV=$P(ND,U,5) Q:'+SRV  I $D(^GMR(123.5,"AB1",STPCOD,SRV)) S PTIEN=$P(ND,U,2) D
"RTN","SDCNSLT",8,0)
 ..I CPRSTAT=8 S SHOW=0 Q:$D(^SC("AWAS1",A))  S NOS=$O(^GMR(123,A,40,":"),-1) Q:'+NOS  S X2=$P($G(^GMR(123,A,40,NOS,0)),U),X1=DT D ^%DTC Q:X'=""&(X>180)  D SCHED(PTIEN,STPCOD,.SHOW) Q:'SHOW
"RTN","SDCNSLT",9,0)
 ..;CPRSTAT 13 is a cancel
"RTN","SDCNSLT",10,0)
 ..I CPRSTAT=13 S NOS=$O(^GMR(123,A,40,":"),-1) Q:'+NOS  S NOS=$O(^GMR(123,A,40,NOS),-1) Q:'+NOS  S X2=$P($G(^GMR(123,A,40,NOS,0)),U),X1=DT D ^%DTC Q:X'=""&(X>180)  S COMMENT=$G(^GMR(123,A,40,NOS,1,1,0)) Q:COMMENT'[NOSHOW
"RTN","SDCNSLT",11,0)
 ..S:+PTIEN PTNM=$P(^DPT(PTIEN,0),U) S SERVICE=$P(^GMR(123.5,SRV,0),U),STATUS=$P(^ORD(100.01,CPRSTAT,0),U),SENDER=$P(ND,U,14) S:+SENDER SENDER=$P(^VA(200,SENDER,0),U)
"RTN","SDCNSLT",12,0)
 ..S Y=DTENTR D DD^%DT S DTIN=Y,DTR=$E(DTENTR,4,5)_"/"_$E(DTENTR,6,7)_"/"_$E(DTENTR,2,3)_"@"_$P(Y,"@",2)
"RTN","SDCNSLT",13,0)
 ..S CNT=CNT+1,TMP(CNT)=PTIEN_U_SERVICE_U_SENDER_U_STATUS_U_DTR_U_A_U_DTIN_U_$P(ND,U,17)_U_PROC
"RTN","SDCNSLT",14,0)
 Q:'$D(TMP)
"RTN","SDCNSLT",15,0)
QST N DIR,DTOUT,DUOUT,CNSULT
"RTN","SDCNSLT",16,0)
 S DIR(0)="Y",DIR("A")="Will this appointment be for a CONSULT/PROCEDURE",DIR("B")="YES",DIR("?")="Answer 'Y'es if appointment is for a Consult or Procedure." W ! D ^DIR S CNSULT=Y
"RTN","SDCNSLT",17,0)
 I CNSULT[U!(CNSULT=0)!(CNSULT="") K TMP Q
"RTN","SDCNSLT",18,0)
HDR W !!,"Please select from the list of consult(s), press 0 for none.",!
"RTN","SDCNSLT",19,0)
 W !,PTNM,!!,"#  Service",?27,"Sending Provider",?45,"Request Date",?60,"Cons #",?68,"Reqst Type",!,DSH
"RTN","SDCNSLT",20,0)
 S A=0 F  S A=$O(TMP(A)) Q:'+A  S ND=TMP(A),P8=$P(ND,U,8) W !,A,". ",$S(P8="P":$E($P(ND,U,9),1,23),1:$E($P(ND,U,2),1,23)),?27,$E($P(ND,U,3),1,17),?45,$E($P(ND,U,5),1,14)," ",$P(ND,U,6) W ?68,$S(P8="P":"Procedure",P8="C":"Consult",1:"")
"RTN","SDCNSLT",21,0)
 W !
"RTN","SDCNSLT",22,0)
READ R !,"Select Consult: ",CONS:DTIME G:CONS="" A
"RTN","SDCNSLT",23,0)
 I CONS=0!(CONS[U) W " ... NONE." K TMP Q
"RTN","SDCNSLT",24,0)
 I "? "[CONS W !," Select consult by number on the left side." G READ
"RTN","SDCNSLT",25,0)
 I '$D(TMP(CONS)) W *7," ?? Select consult by number on the left side." G READ
"RTN","SDCNSLT",26,0)
 S CNSLTLNK=$P(TMP(CONS),U,6)
"RTN","SDCNSLT",27,0)
 Q
"RTN","SDCNSLT",28,0)
SCHED(PTIEN,STPCOD,SHOW) ;===CONSULT IS SCHEDULE NOW CHECK IF IT HAS APPOINTMENT BY STOP CODE.
"RTN","SDCNSLT",29,0)
 N APT,CLNC,B,S1,S2,S3,S4,STOP,STOPCOD,X,Y
"RTN","SDCNSLT",30,0)
 S %DT="ST",X="T-1" D ^%DT S APT=Y,S1=0,STOP=0 F  S APT=$O(^DPT(PTIEN,"S",APT)) Q:'+APT!(STOP)  S S1=1,CLNC=$P(^DPT(PTIEN,"S",APT,0),U) I CLNC'="" S STOPCOD=$P(^SC(CLNC,0),U,7) I STOPCOD'="" S S2=0 I STOPCOD=STPCOD S S2=1 D
"RTN","SDCNSLT",31,0)
 .S S3=0,S4=0,B=0 F  S B=$O(^SC(CLNC,"S",APT,1,B)) Q:'+B!(STOP)  S S3=1 D
"RTN","SDCNSLT",32,0)
 ..I ($P($G(^SC(CLNC,"S",APT,1,B,0)),U)=PTIEN) S S4=1,STOP=1,SHOW=0
"RTN","SDCNSLT",33,0)
 I S1=0 S SHOW=1 Q  ;show if no appointment in the patient side
"RTN","SDCNSLT",34,0)
 I S2=0 S SHOW=1 Q  ;show if stop code does not match
"RTN","SDCNSLT",35,0)
 I S3=0 S SHOW=1 Q  ;show if no appointment in the clinic
"RTN","SDCNSLT",36,0)
 I S4=0 S SHOW=1 Q  ;show if patient does not match in appointment
"RTN","SDCNSLT",37,0)
 Q
"RTN","SDCNSLT",38,0)
LINK(SC,SDY,SD,CNSLTLNK) ;===LINK APPOINTMENT TO CONSULT
"RTN","SDCNSLT",39,0)
 N DA,DIE,DR,TDA,X
"RTN","SDCNSLT",40,0)
 S TDA=SDY,DA(2)=SC,DA(1)=SD,DA=TDA,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1,",DR="688////^S X=CNSLTLNK" D ^DIE
"RTN","SDCNSLT",41,0)
 Q
"RTN","SDCNSLT",42,0)
EDITCS(SD,TMPD,TMPYCLNC,CNSLTLNK) ;===MARK CONSULT AS SCHEDULED
"RTN","SDCNSLT",43,0)
 N CSCHDT,SNDPRV,TME,X,Y,COMMENT,ER
"RTN","SDCNSLT",44,0)
 S %DT="ST",X="NOW" D ^%DT S CSCHDT=Y
"RTN","SDCNSLT",45,0)
 S SNDPRV=$P($G(^GMR(123,CNSLTLNK,0)),U,14),Y=SD D DD^%DT S TME=$P($P(Y,"@",2),":",1,2)
"RTN","SDCNSLT",46,0)
 S COMMENT(1)=$P(TMPYCLNC,U,2)_" Consult Appt. on "_$E(SD,4,5)_"/"_$E(SD,6,7)_"/"_$E(SD,2,3)_" @ "_TME
"RTN","SDCNSLT",47,0)
 S COMMENT(2)=TMPD
"RTN","SDCNSLT",48,0)
 D SCH^SDQQCN2(.ER,CNSLTLNK,SNDPRV,CSCHDT,0,,.COMMENT) K COMMENT
"RTN","SDCNSLT",49,0)
 Q
"RTN","SDCNSLT",50,0)
CANCEL ;===appt was cancelled then mark consult as edit/resubmit, add comment.
"RTN","SDCNSLT",51,0)
 N APPT,CONSULT,CPRSSTAT,ER,GM40,GMRND,SDPATNT,USER,SNDPRV,J
"RTN","SDCNSLT",52,0)
 ;Variables CNDIE, CNDA and CNINDX used in calling routine for Cancel letter printed comment in consult.
"RTN","SDCNSLT",53,0)
 S:$D(SCLNK) CONSULT=SCLNK
"RTN","SDCNSLT",54,0)
 S:'$D(SCLNK) CONSULT=$P($G(^SC(SDSC,"S",SDTTM,1,SDPL,"CONS")),U)
"RTN","SDCNSLT",55,0)
 Q:'+CONSULT
"RTN","SDCNSLT",56,0)
 S:$D(SCSNOD) SDPATNT=$P(SCSNOD,U)
"RTN","SDCNSLT",57,0)
 S:'$D(SCSNOD) SDPATNT=$P($G(^SC(SDSC,"S",SDTTM,1,SDPL,0)),U)
"RTN","SDCNSLT",58,0)
 S CPRSSTAT=$P($G(^GMR(123,CONSULT,0)),U,12) I CPRSSTAT'="" S CPRSSTAT=$P($G(^ORD(100.01,CPRSSTAT,0)),U) Q:CPRSSTAT'="SCHEDULED"
"RTN","SDCNSLT",59,0)
 S SNDPRV=$P($G(^GMR(123,CONSULT,0)),U,14)
"RTN","SDCNSLT",60,0)
 S USER=$P(^VA(200,DUZ,0),U),Y=SDTTM D DD^%DT S APPT=$E(SDTTM,4,5)_"/"_$E(SDTTM,6,7)_"/"_$E(SDTTM,2,3)_" @ "_$P(Y,"@",2)
"RTN","SDCNSLT",61,0)
 S COMMENT(1)=$P(^SC(SDSC,0),U)_" Appt. on "_APPT_" was cancelled"_$S($D(SDWH):$S(SDWH["P":" by the Patient.",SDWH["C":" by the Clinic.",1:"."),$D(SDADM):" for administrative purposes.",1:", whole clinic.")
"RTN","SDCNSLT",62,0)
 S CNINDX=2 S:$D(TMPD) COMMENT(2)="Remarks: "_TMPD,CNINDX=CNINDX+1 K TMPD
"RTN","SDCNSLT",63,0)
 N SDERR S SDERR=$$STATUS^GMRCGUIS(CONSULT,6,3,SNDPRV,"","",.COMMENT)
"RTN","SDCNSLT",64,0)
 S CNDIE="^GMR(123,"_CONSULT_",40,",CNDA=+$G(COMMENT(0))
"RTN","SDCNSLT",65,0)
 K COMMENT,DA
"RTN","SDCNSLT",66,0)
 S AUTO(SDSC,SDTTM,SDPATNT)=CONSULT
"RTN","SDCNSLT",67,0)
 S DA(2)=SDSC,DA(1)=SDTTM,DA=SDPL,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1,",DR="688///@" D ^DIE
"RTN","SDCNSLT",68,0)
 K SCSNOD,SDADM,SCLNK
"RTN","SDCNSLT",69,0)
 Q
"RTN","SDCNSLT",70,0)
AUTOREB(SC,NDATE,LNK,CY) ;===AUTO REBOOK
"RTN","SDCNSLT",71,0)
 N DIC,DA,DIE,DR,Y,TME,SNDPRV,CSCHDT,COMMENT,ER
"RTN","SDCNSLT",72,0)
 S DA(2)=SC,DA(1)=NDATE,DA=CY,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1,",DR="688////^S X=LNK" D ^DIE
"RTN","SDCNSLT",73,0)
 S Y=NDATE D DD^%DT S TME=$P(Y,"@",2)
"RTN","SDCNSLT",74,0)
 S COMMENT(1)=$P(^SC(SC,0),U)_" Consult Appt. on "_$E(NDATE,4,5)_"/"_$E(NDATE,6,7)_"/"_$E(NDATE,2,3)_" @ "_TME_" (Auto Rebooked)."
"RTN","SDCNSLT",75,0)
 S %DT="ST",X="NOW" D ^%DT S CSCHDT=Y
"RTN","SDCNSLT",76,0)
 S SNDPRV=$P($G(^GMR(123,LNK,0)),U,14)
"RTN","SDCNSLT",77,0)
 D SCH^SDQQCN2(.ER,LNK,SNDPRV,CSCHDT,0,,.COMMENT) K COMMENT
"RTN","SDCNSLT",78,0)
 Q
"RTN","SDCNSLT",79,0)
NOSHOW(SC,SDDTM,CNPAT,CNSTLNK,CN,AUTO,NSDIE,NSDA) ;
"RTN","SDCNSLT",80,0)
 ;Appt. was a NoShow, then mark Consult as Edit/Resubmit, add comment using silent call to notify user.
"RTN","SDCNSLT",81,0)
 ;Variables NSDIE and NSDA used in calling routine for NoShow letter printed comment in consult.
"RTN","SDCNSLT",82,0)
 N CSNOD,CPRSSTAT,NOSHOW,CSRQSRV,TPRNT,CSPRT,USER,Y,APPT,COMMENT,DA,DIC,DUZ2,DIC,DR,GM40,GMRND,ER,SNDPRV,J
"RTN","SDCNSLT",83,0)
 S CSNOD=$G(^GMR(123,CNSTLNK,0)),CPRSSTAT=$P(CSNOD,U,12),SNDPRV=$P(CSNOD,U,14),NOSHOW="no-show",AUTO(SC,SDDTM,CNPAT)=CNSTLNK
"RTN","SDCNSLT",84,0)
 I CPRSSTAT'="" S CPRSSTAT=$P($G(^ORD(100.01,CPRSSTAT,0)),U) Q:CPRSSTAT'="SCHEDULED"
"RTN","SDCNSLT",85,0)
 S CSRQSRV=$P(CSNOD,U,5) I CSRQSRV'="" S TPRNT=$P($G(^GMR(123.5,CSRQSRV,123)),U,9) I TPRNT'="" S:$P($G(^%ZIS(1,TPRNT,0)),U)'="" CSPRT=$P(^(0),U) ;reprint consult
"RTN","SDCNSLT",86,0)
 S USER=$P(^VA(200,DUZ,0),U),Y=SDDTM D DD^%DT S APPT=$E(SDDTM,4,5)_"/"_$E(SDDTM,6,7)_"/"_$E(SDDTM,2,3)_" @ "_$P(Y,"@",2)
"RTN","SDCNSLT",87,0)
 S COMMENT(1)=$P(^SC(SC,0),U)_" Appt. on "_APPT_" was a "_NOSHOW_"." ;no-show is a key word used by a search do not change
"RTN","SDCNSLT",88,0)
 N SDERR S SDERR=$$STATUS^GMRCGUIS(CNSTLNK,6,3,SNDPRV,"","",.COMMENT)
"RTN","SDCNSLT",89,0)
 S NSDIE="^GMR(123,"_CNSTLNK_",40,",NSDA=+$G(COMMENT(0))
"RTN","SDCNSLT",90,0)
 K COMMENT,DA
"RTN","SDCNSLT",91,0)
 S DA(2)=SC,DA(1)=SDDTM,DA=CN,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1,",DR="688///@" D ^DIE
"RTN","SDCNSLT",92,0)
 I $D(CSPRT) D EN^GMRCP5(CNSTLNK,"C",CSPRT)
"RTN","SDCNSLT",93,0)
 K CNSTLNK Q
"RTN","SDCO1")
0^19^B29919726
"RTN","SDCO1",1,0)
SDCO1 ;ALB/RMO - Appointment - Check Out;Apr 23 1999  ; 12/11/08 5:30pm  ; Compiled December 12, 2008 13:01:34
"RTN","SDCO1",2,0)
 ;;5.3;Scheduling;**27,132,149,193,250,296,446,538**;08/13/93;Build 3
"RTN","SDCO1",3,0)
 ;
"RTN","SDCO1",4,0)
 ;check out if sd/369 is released before 446!!!
"RTN","SDCO1",5,0)
 ;
"RTN","SDCO1",6,0)
EN ;Entry point for SDCO APPT CHECK OUT protocol
"RTN","SDCO1",7,0)
 N SDCOALBF,SDCOAP,SDCOBG,SDCODT,VALMY
"RTN","SDCO1",8,0)
 S VALMBCK=""
"RTN","SDCO1",9,0)
 D EN^VALM2(XQORNOD(0))
"RTN","SDCO1",10,0)
 D FULL^VALM1
"RTN","SDCO1",11,0)
 S SDCOAP=0 D NOW^%DTC S SDCODT=$P(%,".")_"."_$E($P(%,".",2)_"0000",1,4)
"RTN","SDCO1",12,0)
 F  S SDCOAP=$O(VALMY(SDCOAP)) Q:'SDCOAP  D
"RTN","SDCO1",13,0)
 .I $D(^TMP("SDAMIDX",$J,SDCOAP)) K SDAT S SDAT=^(SDCOAP) D
"RTN","SDCO1",14,0)
 ..W !!,^TMP("SDAM",$J,+SDAT,0)
"RTN","SDCO1",15,0)
 ..I $$CHK^SDCOU(SDCOAP) D CO(+$P(SDAT,"^",2),+$P(SDAT,"^",3),+$P(SDAT,"^",4),+$P(SDAT,"^",5),0,SDCODT,"CO",+SDAT,.SDCOALBF)
"RTN","SDCO1",16,0)
 I $G(SDCOALBF) S SDCOBG=VALMBG W ! D BLD^SDAM S:$D(@VALMAR@(SDCOBG,0)) VALMBG=SDCOBG
"RTN","SDCO1",17,0)
 S VALMBCK="R"
"RTN","SDCO1",18,0)
 K SDAT
"RTN","SDCO1",19,0)
 Q
"RTN","SDCO1",20,0)
 ;
"RTN","SDCO1",21,0)
CO(DFN,SDT,SDCL,SDDA,SDASK,SDCODT,SDCOACT,SDLNE,SDCOALBF) ;Appt Check Out
"RTN","SDCO1",22,0)
 ; Input  -- DFN      Patient file IEN
"RTN","SDCO1",23,0)
 ;           SDT      Appointment Date/Time
"RTN","SDCO1",24,0)
 ;           SDCL     Hospital Location file IEN for Appt
"RTN","SDCO1",25,0)
 ;           SDDA     IEN in ^SC multiple or null [Optional]
"RTN","SDCO1",26,0)
 ;           SDASK    Ask Check Out Date/Time     [Optional]
"RTN","SDCO1",27,0)
 ;           SDCODT   Date/Time of Check Out      [Optional]
"RTN","SDCO1",28,0)
 ;           SDCOACT  Appt Mgmt Check Out Action  [Optional]
"RTN","SDCO1",29,0)
 ;           SDLNE    Appt Mgmt Line Number       [Optional]
"RTN","SDCO1",30,0)
 ; Output -- SDCOALBF Re-build Appt Mgmt List
"RTN","SDCO1",31,0)
 I $D(XRTL) D T0^%ZOSV
"RTN","SDCO1",32,0)
 N SDCOQUIT,SDOE,SDATA
"RTN","SDCO1",33,0)
 S:'SDDA SDDA=$$FIND^SDAM2(DFN,SDT,SDCL)
"RTN","SDCO1",34,0)
 I 'SDDA W !!,*7,">>> You cannot check out this appointment." D PAUSE^VALM1 G COQ
"RTN","SDCO1",35,0)
 S SDATA=$G(^DPT(DFN,"S",SDT,0))
"RTN","SDCO1",36,0)
 ; ** MT Blocking removed
"RTN","SDCO1",37,0)
 ;S X="EASMTCHK" X ^%ZOSF("TEST") I $T,$G(EASACT)'="W",$$MT^EASMTCHK(DFN,$P($G(SDATA),U,16),"C",$G(SDT)) D PAUSE^VALM1 G COQ
"RTN","SDCO1",38,0)
 ;
"RTN","SDCO1",39,0)
 ;-- if new encounter, pass to PCE
"RTN","SDCO1",40,0)
 I $$NEW^SDPCE(SDT) D  S VALMBCK="R",SDCOALBF=1 G COQ
"RTN","SDCO1",41,0)
 . N SDCOED
"RTN","SDCO1",42,0)
 . S SDOE=$$GETAPT^SDVSIT2(DFN,SDT,SDCL)
"RTN","SDCO1",43,0)
 . ;
"RTN","SDCO1",44,0)
 . ; -- has appt already been checked out
"RTN","SDCO1",45,0)
 . S SDCOED=$$CHK($TR($$STATUS^SDAM1(DFN,SDT,SDCL,SDATA,SDDA),";","^"))
"RTN","SDCO1",46,0)
 . ;
"RTN","SDCO1",47,0)
 . ; -- if not checked out then do interview process
"RTN","SDCO1",48,0)
 . IF '$$CODT^SDCOU(DFN,SDT,SDCL) D
"RTN","SDCO1",49,0)
 . . N SDCOMKF,SDTRES
"RTN","SDCO1",50,0)
 . . ;
"RTN","SDCO1",51,0)
 . . ; -- first, check if should make follow-up appt
"RTN","SDCO1",52,0)
 . . IF $G(SDCOACT)="CO",'SDCOED D
"RTN","SDCO1",53,0)
 . . . N SDCOMKF
"RTN","SDCO1",54,0)
 . . . D MC^SDCO5(SDOE,1,.SDCOMKF,.SDCOQUIT) Q:$D(SDCOQUIT)
"RTN","SDCO1",55,0)
 . . . ;
"RTN","SDCO1",56,0)
 . . . ; -- Set flag to re-build appointment list
"RTN","SDCO1",57,0)
 . . . IF $G(SDCOMKF) S SDCOALBF=1
"RTN","SDCO1",58,0)
 . . ;
"RTN","SDCO1",59,0)
 . . ; -- c/o interview if user didn't quit
"RTN","SDCO1",60,0)
 . . I '$D(SDCOQUIT),'SDCOED D
"RTN","SDCO1",61,0)
 . . . N SDAPTYP
"RTN","SDCO1",62,0)
 . . . S SDTRES=$$INTV^PXAPI("INTV","SD","PIMS",$P($G(^SCE(+SDOE,0)),U,5),$P($G(^SCE(+SDOE,0)),U,4),DFN)
"RTN","SDCO1",63,0)
 . . . Q:SDTRES<0
"RTN","SDCO1",64,0)
 . . . ;
"RTN","SDCO1",65,0)
 . . . ; -- ask user if they want to see c/o screen
"RTN","SDCO1",66,0)
 . . . S SDGAFC=$$ASK^SDCO6
"RTN","SDCO1",67,0)
 . . . I 'SDGAFC D
"RTN","SDCO1",68,0)
 . . . .N SDELIG
"RTN","SDCO1",69,0)
 . . . .S SDELIG=$$ELSTAT^SDUTL2(DFN)
"RTN","SDCO1",70,0)
 . . . .I $$MHCLIN^SDUTL2(SDCL),'($$COLLAT^SDUTL2(SDELIG)!$P(SDATA,U,11)) D
"RTN","SDCO1",71,0)
 . . . . .I $$NEWGAF^SDUTL2(DFN) D
"RTN","SDCO1",72,0)
 . . . . . .I '$$GAFCM^SDUTL2() S SDGAFC=1
"RTN","SDCO1",73,0)
 . . .I SDGAFC D EN^SDCO(SDOE,,1)
"RTN","SDCO1",74,0)
 . ;
"RTN","SDCO1",75,0)
 . ; -- if already checked out then show c/o screen
"RTN","SDCO1",76,0)
 . E  D EN^SDCO(SDOE,,1)
"RTN","SDCO1",77,0)
 ;
"RTN","SDCO1",78,0)
 ; -- view if old encounters
"RTN","SDCO1",79,0)
 S SDOE=$$GETAPT^SDVSIT2(DFN,SDT,SDCL)
"RTN","SDCO1",80,0)
 D EN^SDCO(SDOE,,1)
"RTN","SDCO1",81,0)
 ;
"RTN","SDCO1",82,0)
COQ K % D EWLCHK Q
"RTN","SDCO1",83,0)
 Q
"RTN","SDCO1",84,0)
EWLCHK ;check if patient has any open EWL entries (SD/372)
"RTN","SDCO1",85,0)
 ;get appointment
"RTN","SDCO1",86,0)
 ;
"RTN","SDCO1",87,0)
 K ^TMP($J,"SDAMA301"),^TMP($J,"APPT")
"RTN","SDCO1",88,0)
 W:$D(IOF) @IOF D APPT^SDWLEVAL(DFN,SDT,SDCL)
"RTN","SDCO1",89,0)
 Q:'$D(^TMP($J,"APPT"))
"RTN","SDCO1",90,0)
 N SDEV D EN^SDWLEVAL(DFN,.SDEV) I SDEV,$L(SDEV(1))>0 D
"RTN","SDCO1",91,0)
 .K ^TMP("SDWLPL",$J),^TMP($J,"SDWLPL")
"RTN","SDCO1",92,0)
 .D INIT^SDWLPL(DFN,"M")
"RTN","SDCO1",93,0)
 .Q:'$D(^TMP($J,"SDWLPL"))
"RTN","SDCO1",94,0)
 .D LIST^SDWLPL("M",DFN)
"RTN","SDCO1",95,0)
 .F  Q:'$D(^TMP($J,"SDWLPL"))  N SDR D ANSW^SDWLEVAL(1,.SDR) I 'SDR D LIST^SDWLPL("M",DFN) D
"RTN","SDCO1",96,0)
 ..F  N SDR  D ANSW^SDWLEVAL(0,.SDR) Q:'$D(^TMP($J,"SDWLPL"))  I 'SDR W !!,"MUST ACCEPT OR ENTER A REASON NOT TO DISPOSITION MATCHED EWL ENTRY",!
"RTN","SDCO1",97,0)
 ..Q
"RTN","SDCO1",98,0)
 .Q
"RTN","SDCO1",99,0)
 Q
"RTN","SDCO1",100,0)
 ;
"RTN","SDCO1",101,0)
BEFORE(SDATA,DFN,SDT,SDCL,SDDA,SDHDL) ; -- event driver before ; not used
"RTN","SDCO1",102,0)
 S SDATA=SDDA_"^"_DFN_"^"_SDT_"^"_SDCL,SDHDL=$$HANDLE^SDAMEVT(1)
"RTN","SDCO1",103,0)
 D BEFORE^SDAMEVT(.SDATA,DFN,SDT,SDCL,SDDA,SDHDL)
"RTN","SDCO1",104,0)
 Q
"RTN","SDCO1",105,0)
 ;
"RTN","SDCO1",106,0)
AFTER(SDATA,DFN,SDT,SDCL,SDDA,SDHDL,SDLNE) ; -- event driver after ; not used
"RTN","SDCO1",107,0)
 D AFTER^SDAMEVT(.SDATA,DFN,SDT,SDCL,SDDA,SDHDL)
"RTN","SDCO1",108,0)
 D:$G(SDLNE) UPD(DFN,SDT,SDCL,SDLNE,SDATA("BEFORE","STATUS"),SDATA("AFTER","STATUS"))
"RTN","SDCO1",109,0)
 D EVT^SDAMEVT(.SDATA,5,0,SDHDL)
"RTN","SDCO1",110,0)
 Q
"RTN","SDCO1",111,0)
 ;
"RTN","SDCO1",112,0)
UPD(DFN,SDT,SDCL,SDLNE,SDSTB,SDSTA) ; -- update appt mgmt screen ; used by AFTER but AFTER is not used
"RTN","SDCO1",113,0)
 N SDAMBOLD
"RTN","SDCO1",114,0)
 I $P(SDSTB,"^",3)'=$P(SDSTA,"^",3) D UPD^SDAM2($$LOWER^VALM1($P(SDSTA,"^",3)),"STAT",SDLNE),UPD^SDAM2("","TIME",SDLNE) S SDAMBOLD(DFN,SDT,SDCL)=""
"RTN","SDCO1",115,0)
 I $P(SDSTA,"^",3)["CHECKED OUT",$P($P(SDSTA,"^",5),".")=DT D UPD^SDAM2($$TIME^SDAM1($P($P(SDSTA,"^",5),".",2)),"TIME",SDLNE)
"RTN","SDCO1",116,0)
 Q
"RTN","SDCO1",117,0)
 ;
"RTN","SDCO1",118,0)
ELIG(DFN,SDT,SDCL,SDDA) ; -- update elig if blank
"RTN","SDCO1",119,0)
 N X,DR
"RTN","SDCO1",120,0)
 I $P(^SC(SDCL,"S",SDT,1,SDDA,0),U,10)="" D
"RTN","SDCO1",121,0)
 .S X=+$G(^DPT(DFN,.36)),X=$S('$D(^DIC(8,X,0)):"",$P(^(0),U,4)=6:"",1:X)
"RTN","SDCO1",122,0)
 .I X]"" S DR="30////^S X="_X D DIE(SDCL,SDT,SDDA,DR)
"RTN","SDCO1",123,0)
 Q
"RTN","SDCO1",124,0)
 ;
"RTN","SDCO1",125,0)
CHK(SDSTB) ; -- is appointment checked out
"RTN","SDCO1",126,0)
 N Y
"RTN","SDCO1",127,0)
 I "^2^8^12^"[("^"_+SDSTB_"^"),$P(SDSTB,"^",3)["CHECKED OUT" S Y=1
"RTN","SDCO1",128,0)
 Q +$G(Y)
"RTN","SDCO1",129,0)
 ;
"RTN","SDCO1",130,0)
DT(DFN,SDT,SDCL,SDDA,SDASK,SDCODT,SDCOQUIT) ;Update Check Out Date
"RTN","SDCO1",131,0)
 N %DT,DR,SDCIDT,X
"RTN","SDCO1",132,0)
 S:'$D(^SC(SDCL,"S",0)) ^(0)="^44.001DA^^"
"RTN","SDCO1",133,0)
 S DR="",SDCIDT=$P($G(^SC(SDCL,"S",SDT,1,SDDA,"C")),"^"),X=$P($G(^("C")),"^",3)
"RTN","SDCO1",134,0)
 I X G DTQ:'SDASK  S DR="303R"
"RTN","SDCO1",135,0)
 I DR="",$P(^SC(SDCL,0),U,24),$$REQ^SDM1A(SDT)="CO" S DR="303R//"_$S($G(SDCODT):$$FTIME^VALM1($S(SDCODT<SDCIDT:SDCIDT,1:SDCODT)),1:"NOW")
"RTN","SDCO1",136,0)
 I DR="" S DR="303R///"_$S($G(SDCODT):"/"_$S(SDCODT<SDCIDT:SDCIDT,1:SDCODT),1:"NOW")
"RTN","SDCO1",137,0)
 S DR="S SDCOQUIT="""";"_DR_";K SDCOQUIT"
"RTN","SDCO1",138,0)
 D DIE(SDCL,SDT,SDDA,DR)
"RTN","SDCO1",139,0)
DTQ Q
"RTN","SDCO1",140,0)
 ;
"RTN","SDCO1",141,0)
DIE(SDCL,SDT,SDDA,DR) ; -- update appt data in ^SC
"RTN","SDCO1",142,0)
 N DA,DIE
"RTN","SDCO1",143,0)
 S DA(2)=SDCL,DA(1)=SDT,DA=SDDA,DIE="^SC("_DA(2)_",""S"","_DA(1)_",1,"
"RTN","SDCO1",144,0)
 D ^DIE K DQ,DE
"RTN","SDCO1",145,0)
DIEQ Q
"RTN","SDCO3")
0^20^B3913935
"RTN","SDCO3",1,0)
SDCO3 ;ALB/RMO - Provider - Check Out;08 DEC 1992 4:05 pm
"RTN","SDCO3",2,0)
 ;;5.3;Scheduling;**28,27,44,67,71,132,466**;08/13/93;Build 3
"RTN","SDCO3",3,0)
 ;
"RTN","SDCO3",4,0)
EN ;Entry point for SDCO PROVIDER protocol
"RTN","SDCO3",5,0)
 ; Input  -- SDOE
"RTN","SDCO3",6,0)
 ;
"RTN","SDCO3",7,0)
 S VALMBCK=""
"RTN","SDCO3",8,0)
 ;
"RTN","SDCO3",9,0)
 ; -- if OLD encounter, quit
"RTN","SDCO3",10,0)
 IF '$$EDITOK($G(SDOE),1) G ENQ
"RTN","SDCO3",11,0)
 ;
"RTN","SDCO3",12,0)
 ; -- call PCE interview
"RTN","SDCO3",13,0)
 N SDVISIT,SDHL
"RTN","SDCO3",14,0)
 S SDVISIT=$P($G(^SCE(+SDOE,0)),U,5)
"RTN","SDCO3",15,0)
 S X=$$INTV^PXAPI("PRV","SD","PIMS",SDVISIT)
"RTN","SDCO3",16,0)
 D BLD^SDCO S VALMBCK="R"
"RTN","SDCO3",17,0)
ENQ Q
"RTN","SDCO3",18,0)
 ;
"RTN","SDCO3",19,0)
PRASK(SDOE) ;Ask Provider on Check Out
"RTN","SDCO3",20,0)
 ; Input  -- SDOE      Outpatient Encounter IEN
"RTN","SDCO3",21,0)
 ; Output -- 0=No, 1=Yes/Required, 2=Yes/Not Required
"RTN","SDCO3",22,0)
 N SDCL,SDOE0,SDORG,Y
"RTN","SDCO3",23,0)
 S SDOE0=$G(^SCE(+SDOE,0)),SDCL=+$P(SDOE0,"^",4),SDORG=+$P(SDOE0,"^",8)
"RTN","SDCO3",24,0)
 I $$REQ^SDM1A(+SDOE0)'="CO" G PRASKQ
"RTN","SDCO3",25,0)
 I SDORG=1,'$$CLINIC^SDAMU(SDCL) G PRASKQ
"RTN","SDCO3",26,0)
 ;I "^1^2^"[("^"_SDORG_"^"),$$INP^SDAM2(+$P(SDOE0,"^",2),+SDOE0)="I" G PRASKQ  ;SD*5.3*466 allow provider check for inpatients 
"RTN","SDCO3",27,0)
 I +SDOE0<2961001 S Y=2 G PRASKQ
"RTN","SDCO3",28,0)
 I SDCL S Y=1 G PRASKQ
"RTN","SDCO3",29,0)
 I SDORG=3 S Y=1
"RTN","SDCO3",30,0)
PRASKQ Q +$G(Y)
"RTN","SDCO3",31,0)
 ;
"RTN","SDCO3",32,0)
SET(SDOE) ;Set-up Provider Array for Outpatient Encounter
"RTN","SDCO3",33,0)
 ; Input  -- SDOE      Outpatient Encounter IEN
"RTN","SDCO3",34,0)
 ; Output -- SDPRY     Provider Array Subscripted by a Number
"RTN","SDCO3",35,0)
 ;           SDCNT     Number of Array Entries
"RTN","SDCO3",36,0)
 N SDVA200,SDVPRV,SDPRVS
"RTN","SDCO3",37,0)
 K SDPRY
"RTN","SDCO3",38,0)
 D GETPRV^SDOE(SDOE,"SDPRVS")
"RTN","SDCO3",39,0)
 S (SDCNT,SDVPRV)=0
"RTN","SDCO3",40,0)
 F  S SDVPRV=$O(SDPRVS(SDVPRV)) Q:'SDVPRV  D
"RTN","SDCO3",41,0)
 . S SDVA200=+$G(SDPRVS(SDVPRV))
"RTN","SDCO3",42,0)
 . S SDCNT=SDCNT+1
"RTN","SDCO3",43,0)
 . S SDPRY(SDCNT)=SDVPRV_"^"_SDVA200
"RTN","SDCO3",44,0)
SETQ Q
"RTN","SDCO3",45,0)
 ;
"RTN","SDCO3",46,0)
LIST(SDPRY) ;List Provider Array
"RTN","SDCO3",47,0)
 ; Input  -- SDPRY     Provider Array Subscripted by a Number
"RTN","SDCO3",48,0)
 ; Output -- List Provider Array
"RTN","SDCO3",49,0)
 N I
"RTN","SDCO3",50,0)
 W !
"RTN","SDCO3",51,0)
 S I=0 F  S I=$O(SDPRY(I)) Q:'I  W !?2,I,"  ",$$PR^SDCO31(+$P(SDPRY(I),"^",2))
"RTN","SDCO3",52,0)
 Q
"RTN","SDCO3",53,0)
 ;
"RTN","SDCO3",54,0)
EDITOK(SDOE,SDMODE) ; -- ok to edit?
"RTN","SDCO3",55,0)
 ; input:  SDOE   := ien of 409.68                  [required]
"RTN","SDCO3",56,0)
 ;         SDMODE := 1 -- interactive ; 0 -- silent [required]
"RTN","SDCO3",57,0)
 ;
"RTN","SDCO3",58,0)
 ; returned:  1 -- yes, it's ok to edit or delete SDOE entry
"RTN","SDCO3",59,0)
 ;            0 -- no, cannot not change SDOE entry
"RTN","SDCO3",60,0)
 ;
"RTN","SDCO3",61,0)
 N DIR,SDOK
"RTN","SDCO3",62,0)
 S SDOK=$$NEW^SDPCE($P($G(^SCE(+$G(SDOE),0)),U))
"RTN","SDCO3",63,0)
 IF 'SDOK,SDMODE D OLDMSG
"RTN","SDCO3",64,0)
EDITOKQ Q SDOK
"RTN","SDCO3",65,0)
 ;
"RTN","SDCO3",66,0)
OLDMSG ; -- display message to user
"RTN","SDCO3",67,0)
 W !!,">>> Editing and deleting old encounters not allowed.",!
"RTN","SDCO3",68,0)
 N DIR
"RTN","SDCO3",69,0)
 S DIR(0)="E"
"RTN","SDCO3",70,0)
 S DIR("A")="Press Return key to continue"
"RTN","SDCO3",71,0)
 D ^DIR
"RTN","SDCO3",72,0)
 Q
"RTN","SDCO3",73,0)
 ;
"RTN","SDCOAM")
0^21^B20810656
"RTN","SDCOAM",1,0)
SDCOAM ;ALB/RMO - Appt Mgmt Actions - Check Out; 11 FEB 1993 10:00 am
"RTN","SDCOAM",2,0)
 ;;5.3;Scheduling;**1,20,27,66,132**;08/13/93;Build 3
"RTN","SDCOAM",3,0)
 ;
"RTN","SDCOAM",4,0)
CO(SDCOACT,SDCOACTD) ;Check Out Classification, Provider and Diagnosis
"RTN","SDCOAM",5,0)
 ;                Actions on Appt Mgmt
"RTN","SDCOAM",6,0)
 N DFN,SDCL,SDCOAP,SDDA,SDOE,SDT,VALMY
"RTN","SDCOAM",7,0)
 S VALMBCK=""
"RTN","SDCOAM",8,0)
 D EN^VALM2(XQORNOD(0))
"RTN","SDCOAM",9,0)
 D FULL^VALM1
"RTN","SDCOAM",10,0)
 S SDCOAP=0
"RTN","SDCOAM",11,0)
 F  S SDCOAP=$O(VALMY(SDCOAP)) Q:'SDCOAP  D
"RTN","SDCOAM",12,0)
 .I $D(^TMP("SDAMIDX",$J,SDCOAP)) K SDAT S SDAT=^(SDCOAP) D
"RTN","SDCOAM",13,0)
 ..W !!,^TMP("SDAM",$J,+SDAT,0)
"RTN","SDCOAM",14,0)
 ..S DFN=+$P(SDAT,"^",2),SDT=+$P(SDAT,"^",3),SDCL=+$P(SDAT,"^",4),SDDA=$$FIND^SDAM2(DFN,SDT,SDCL)
"RTN","SDCOAM",15,0)
 ..S SDOE=+$P($G(^DPT(DFN,"S",SDT,0)),"^",20)
"RTN","SDCOAM",16,0)
 ..I 'SDOE!('$$CODT^SDCOU(DFN,SDT,SDCL)) W !!,*7,">>> The appointment must have a check out date/time to update ",SDCOACTD,"." D PAUSE^VALM1 Q
"RTN","SDCOAM",17,0)
 ..D ACT(SDCOACT,SDOE,DFN,SDT,SDCL,SDDA,+SDAT)
"RTN","SDCOAM",18,0)
 S VALMBCK="R"
"RTN","SDCOAM",19,0)
 K SDAT
"RTN","SDCOAM",20,0)
COQ Q
"RTN","SDCOAM",21,0)
 ;
"RTN","SDCOAM",22,0)
ACT(SDCOACT,SDOE,DFN,SDT,SDCL,SDDA,SDLNE) ; -- Check Out Actions
"RTN","SDCOAM",23,0)
 N SDCOMF,SDCOQUIT,SDHL,SDVISIT,SDATA,SDHDL
"RTN","SDCOAM",24,0)
 ;
"RTN","SDCOAM",25,0)
 S SDVISIT=+$P($G(^SCE(+SDOE,0)),U,5)
"RTN","SDCOAM",26,0)
 ;
"RTN","SDCOAM",27,0)
 ; -- quit if not ok to edit
"RTN","SDCOAM",28,0)
 IF '$$EDITOK^SDCO3($G(SDOE),1) G ACTQ
"RTN","SDCOAM",29,0)
 ;
"RTN","SDCOAM",30,0)
 ; -- set pce action parameter
"RTN","SDCOAM",31,0)
 S SDPXACT=""
"RTN","SDCOAM",32,0)
 I $G(SDCOACT)="CL" S SDPXACT="SCC"
"RTN","SDCOAM",33,0)
 I $G(SDCOACT)="PR" S SDPXACT="PRV"
"RTN","SDCOAM",34,0)
 I $G(SDCOACT)="DX" S SDPXACT="POV"
"RTN","SDCOAM",35,0)
 I $G(SDCOACT)="CPT" S SDPXACT="CPT"
"RTN","SDCOAM",36,0)
 ;
"RTN","SDCOAM",37,0)
 ; -- quit if no action set
"RTN","SDCOAM",38,0)
 IF SDPXACT="" G ACTQ
"RTN","SDCOAM",39,0)
 ;
"RTN","SDCOAM",40,0)
 ; -- do pce interview then rebuild appt list
"RTN","SDCOAM",41,0)
 S X=$$INTV^PXAPI(SDPXACT,"SD","PIMS",.SDVISIT,.SDHL,DFN)
"RTN","SDCOAM",42,0)
 D BLD^SDAM
"RTN","SDCOAM",43,0)
ACTQ Q
"RTN","SDCOAM",44,0)
 ;
"RTN","SDCOAM",45,0)
PD ;Entry point for SDAM PATIENT DEMOGRAPHICS protocol
"RTN","SDCOAM",46,0)
 N SDCOAP,VALMY
"RTN","SDCOAM",47,0)
 S VALMBCK=""
"RTN","SDCOAM",48,0)
 D FULL^VALM1
"RTN","SDCOAM",49,0)
 I SDAMTYP="P" W !!,VALMHDR(1),! D DEM(SDFN)
"RTN","SDCOAM",50,0)
 I SDAMTYP="C" D
"RTN","SDCOAM",51,0)
 .D EN^VALM2(XQORNOD(0))
"RTN","SDCOAM",52,0)
 .S SDCOAP=0 F  S SDCOAP=$O(VALMY(SDCOAP)) Q:'SDCOAP  D
"RTN","SDCOAM",53,0)
 ..I $D(^TMP("SDAMIDX",$J,SDCOAP)) K SDAT S SDAT=^(SDCOAP) D
"RTN","SDCOAM",54,0)
 ...W !!,^TMP("SDAM",$J,+SDAT,0),!
"RTN","SDCOAM",55,0)
 ...D DEM(+$P(SDAT,"^",2))
"RTN","SDCOAM",56,0)
 S VALMBCK="R"
"RTN","SDCOAM",57,0)
PDQ Q
"RTN","SDCOAM",58,0)
 ;
"RTN","SDCOAM",59,0)
DEM(DFN) ;Demographics
"RTN","SDCOAM",60,0)
 D QUES^DGRPU1(DFN,"ADD")
"RTN","SDCOAM",61,0)
 Q
"RTN","SDCOAM",62,0)
 ;
"RTN","SDCOAM",63,0)
DC ;Entry point for SDAM DISCHARGE CLINIC protocol
"RTN","SDCOAM",64,0)
 N SDCOAP,VALMY
"RTN","SDCOAM",65,0)
 S VALMBCK=""
"RTN","SDCOAM",66,0)
 D FULL^VALM1
"RTN","SDCOAM",67,0)
 I SDAMTYP="P" W !!,VALMHDR(1),! D DIS(SDFN)
"RTN","SDCOAM",68,0)
 I SDAMTYP="C" D
"RTN","SDCOAM",69,0)
 .D EN^VALM2(XQORNOD(0))
"RTN","SDCOAM",70,0)
 .S SDCOAP=0 F  S SDCOAP=$O(VALMY(SDCOAP)) Q:'SDCOAP  D
"RTN","SDCOAM",71,0)
 ..I $D(^TMP("SDAMIDX",$J,SDCOAP)) K SDAT S SDAT=^(SDCOAP) D
"RTN","SDCOAM",72,0)
 ...W !!,^TMP("SDAM",$J,+SDAT,0),!
"RTN","SDCOAM",73,0)
 ...D DIS(+$P(SDAT,"^",2),$P(SDAT,"^",4))
"RTN","SDCOAM",74,0)
 S VALMBCK="R"
"RTN","SDCOAM",75,0)
DCQ Q
"RTN","SDCOAM",76,0)
 ;
"RTN","SDCOAM",77,0)
DIS(SDFN,SDCLN) ;Discharge from Clinic
"RTN","SDCOAM",78,0)
 N SDAMERR
"RTN","SDCOAM",79,0)
 D ^SDCD
"RTN","SDCOAM",80,0)
 I $D(SDAMERR) D PAUSE^VALM1
"RTN","SDCOAM",81,0)
 Q
"RTN","SDCOAM",82,0)
 ;
"RTN","SDCOAM",83,0)
DEL ;Entry point for SDAM DELETE CHECK OUT protocol
"RTN","SDCOAM",84,0)
 I '$D(^XUSEC("SD SUPERVISOR",DUZ)) W !!,*7,">>> You must have the 'SD SUPERVISOR' key to delete an appointment check out." D PAUSE^VALM1 S VALMBCK="R" G DELQ
"RTN","SDCOAM",85,0)
 N DFN,SDCL,SDCOAP,SDDA,SDOE,SDT,VALMY,VALSTP
"RTN","SDCOAM",86,0)
 S VALMBCK="",VALSTP="" ;VALSTP is used in scdxhldr to identify deletes
"RTN","SDCOAM",87,0)
 D EN^VALM2(XQORNOD(0))
"RTN","SDCOAM",88,0)
 D FULL^VALM1
"RTN","SDCOAM",89,0)
 S SDCOAP=0
"RTN","SDCOAM",90,0)
 F  S SDCOAP=$O(VALMY(SDCOAP)) Q:'SDCOAP  D
"RTN","SDCOAM",91,0)
 .I $D(^TMP("SDAMIDX",$J,SDCOAP)) K SDAT S SDAT=^(SDCOAP) D
"RTN","SDCOAM",92,0)
 ..W !!,^TMP("SDAM",$J,+SDAT,0)
"RTN","SDCOAM",93,0)
 ..S DFN=+$P(SDAT,"^",2),SDT=+$P(SDAT,"^",3),SDCL=+$P(SDAT,"^",4),SDDA=$$FIND^SDAM2(DFN,SDT,SDCL)
"RTN","SDCOAM",94,0)
 ..S SDOE=+$P($G(^DPT(DFN,"S",SDT,0)),"^",20)
"RTN","SDCOAM",95,0)
 ..I 'SDOE!('$$CODT^SDCOU(DFN,SDT,SDCL)) W !!,*7,">>> The appointment must have a check out date/time to delete." D PAUSE^VALM1 Q
"RTN","SDCOAM",96,0)
 ..I '$$ASK Q
"RTN","SDCOAM",97,0)
 ..N SDATA,SDELHDL
"RTN","SDCOAM",98,0)
 ..IF '$$EDITOK^SDCO3(SDOE,1) Q
"RTN","SDCOAM",99,0)
 ..S SDELHDL=$$HANDLE^SDAMEVT(1)
"RTN","SDCOAM",100,0)
 ..D EN^SDCODEL(SDOE,1,SDELHDL),PAUSE^VALM1
"RTN","SDCOAM",101,0)
 ..D BLD^SDAM
"RTN","SDCOAM",102,0)
 ..S SDOE=$$GETAPT^SDVSIT2(DFN,SDT,SDCL)
"RTN","SDCOAM",103,0)
 S VALMBCK="R"
"RTN","SDCOAM",104,0)
 K SDAT
"RTN","SDCOAM",105,0)
DELQ Q
"RTN","SDCOAM",106,0)
 ;
"RTN","SDCOAM",107,0)
ASK() ;Ask if user is sure they want to delete the check out
"RTN","SDCOAM",108,0)
 N DIR,DTOUT,DUOUT,Y
"RTN","SDCOAM",109,0)
 W !!,*7,">>> Deleting the appointment check out will also delete any check out related",!?4,"information.  This information may include classifications, procedures,",!?4,"providers and diagnoses."
"RTN","SDCOAM",110,0)
 S DIR("A")="Are you sure you want to delete the appointment check out"
"RTN","SDCOAM",111,0)
 S DIR("B")="NO",DIR(0)="Y" W ! D ^DIR
"RTN","SDCOAM",112,0)
 Q +$G(Y)
"RTN","SDCODEL")
0^22^B9522371
"RTN","SDCODEL",1,0)
SDCODEL ;ALB/RMO,ESW - Delete - Check Out; 27 APR 1993 3:00 pm ; 10/10/02 5:38pm
"RTN","SDCODEL",2,0)
 ;;5.3;Scheduling;**20,27,44,97,105,110,132,257**;Aug 13, 1993;Build 3
"RTN","SDCODEL",3,0)
 ;
"RTN","SDCODEL",4,0)
EN(SDOE,SDMOD,SDELHDL,SDELSRC) ;Delete Check Out
"RTN","SDCODEL",5,0)
 ; Input  -- SDOE     Outpatient Encounter file IEN
"RTN","SDCODEL",6,0)
 ;           SDMOD    1=Interactive and 0=Non-interactive
"RTN","SDCODEL",7,0)
 ;           SDELHDL  Check Out Deletion Handle  [Optional]
"RTN","SDCODEL",8,0)
 ;           SDELSRC  Source of delete
"RTN","SDCODEL",9,0)
 ; Output -- Delete Check Out
"RTN","SDCODEL",10,0)
 N DA,DFN,DE,DIE,DR,SDCL,SDDA,SDEVTF,SDOE0,SDOEP,SDORG,SDT,SDVSAV,SDVFLG
"RTN","SDCODEL",11,0)
 D SET(SDOE,.SDOE0,.SDT,.DFN,.SDCL,.SDORG,.SDDA)
"RTN","SDCODEL",12,0)
 S SDVSAV=$P(SDOE0,U,5)
"RTN","SDCODEL",13,0)
 ;
"RTN","SDCODEL",14,0)
 ; -- ok to delete?
"RTN","SDCODEL",15,0)
 IF '$$EDITOK^SDCO3(SDOE,SDMOD) G ENQ
"RTN","SDCODEL",16,0)
 ;
"RTN","SDCODEL",17,0)
 IF $G(SDELSRC)'="PCE" S X=$$DELVFILE^PXAPI("ALL",$P($G(^SCE(SDOE,0)),U,5),"","","",1)
"RTN","SDCODEL",18,0)
 S SDVFLG=1
"RTN","SDCODEL",19,0)
 ;
"RTN","SDCODEL",20,0)
 ; -- get handle if not passed and do 'before'
"RTN","SDCODEL",21,0)
 I '$G(SDELHDL) N SDATA,SDELHDL S SDEVTF=1 D EVT^SDCOU1(SDOE,"BEFORE",.SDELHDL,.SDATA)
"RTN","SDCODEL",22,0)
 ;
"RTN","SDCODEL",23,0)
 I $G(SDMOD) W !!,">>> Deleting check out information..."
"RTN","SDCODEL",24,0)
 ;
"RTN","SDCODEL",25,0)
 ; -- delete child data for appts, dispos and stop code addition
"RTN","SDCODEL",26,0)
 I "^1^2^3^"[("^"_SDORG_"^") D CHLD(SDOE,SDMOD) ;SD/257
"RTN","SDCODEL",27,0)
 ;
"RTN","SDCODEL",28,0)
 ; -- delete SDOE pointers and co d/t
"RTN","SDCODEL",29,0)
 I SDORG=1 D
"RTN","SDCODEL",30,0)
 .S DA(1)=DFN,DA=SDT,DIE="^DPT("_DFN_",""S"",",DR="21///@" D ^DIE
"RTN","SDCODEL",31,0)
 .I $G(SDMOD) W !?3,"...deleting check out date/time"
"RTN","SDCODEL",32,0)
 .S DR="303///@" D DIE^SDCO1(SDCL,SDT,+SDDA,DR)
"RTN","SDCODEL",33,0)
 I SDORG=3 D
"RTN","SDCODEL",34,0)
 .S DA(1)=DFN,DA=+SDDA,DIE="^DPT("_DFN_",""DIS"",",DR="18///@" D ^DIE
"RTN","SDCODEL",35,0)
 ;
"RTN","SDCODEL",36,0)
 ; -- do final deletes for sdoe
"RTN","SDCODEL",37,0)
 D CO(SDOE,SDMOD)
"RTN","SDCODEL",38,0)
 D OE(SDOE,SDMOD)
"RTN","SDCODEL",39,0)
 ;
"RTN","SDCODEL",40,0)
 I $G(SDMOD) W !,">>> done."
"RTN","SDCODEL",41,0)
 ;
"RTN","SDCODEL",42,0)
 ; -- if handle not passed, then 'after' and event
"RTN","SDCODEL",43,0)
 I $G(SDEVTF) D EVT^SDCOU1(SDOE,"AFTER",SDELHDL,.SDATA,SDOE0)
"RTN","SDCODEL",44,0)
 ;
"RTN","SDCODEL",45,0)
 ; -- call pce to make sure its data is gone
"RTN","SDCODEL",46,0)
 I $G(SDVFLG) D DEAD^PXUTLSTP(SDVSAV)
"RTN","SDCODEL",47,0)
ENQ Q
"RTN","SDCODEL",48,0)
 ;
"RTN","SDCODEL",49,0)
CHLD(SDOEP,SDMOD) ;Delete Children
"RTN","SDCODEL",50,0)
 N DFN,SDCL,SDDA,SDOE0,SDOEC,SDORG,SDT
"RTN","SDCODEL",51,0)
 S SDOEC=0
"RTN","SDCODEL",52,0)
 F  S SDOEC=$O(^SCE("APAR",SDOEP,SDOEC)) Q:'SDOEC  D
"RTN","SDCODEL",53,0)
 .D SET(SDOEC,.SDOE0,.SDT,.DFN,.SDCL,.SDORG,.SDDA)
"RTN","SDCODEL",54,0)
 .D OE(SDOEC,SDMOD)
"RTN","SDCODEL",55,0)
 Q
"RTN","SDCODEL",56,0)
 ;
"RTN","SDCODEL",57,0)
SET(SDOE,SDOE0,SDT,DFN,SDCL,SDORG,SDDA) ;Set Variables
"RTN","SDCODEL",58,0)
 S SDOE0=$G(^SCE(+SDOE,0)),SDT=+SDOE0,DFN=+$P(SDOE0,"^",2),SDCL=+$P(SDOE0,"^",4),SDORG=+$P(SDOE0,"^",8),SDDA=$P(SDOE0,"^",9)
"RTN","SDCODEL",59,0)
 Q
"RTN","SDCODEL",60,0)
 ;
"RTN","SDCODEL",61,0)
CO(SDOE,SDMOD) ;Delete Classification
"RTN","SDCODEL",62,0)
 N DA,DIK,SDFL,SDI
"RTN","SDCODEL",63,0)
 I $P($G(^SCE(SDOE,0)),"^",6) G COQ
"RTN","SDCODEL",64,0)
 I $O(^SDD(409.42,"AO",SDOE,0))>0 D
"RTN","SDCODEL",65,0)
 .I $G(SDMOD) W !?3,"...deleting classifications"
"RTN","SDCODEL",66,0)
 .D DEL(SDOE,409.42)
"RTN","SDCODEL",67,0)
COQ Q
"RTN","SDCODEL",68,0)
 ;
"RTN","SDCODEL",69,0)
DEL(SDOE,SDFL) ;Delete Classification
"RTN","SDCODEL",70,0)
 N DA,DIK,SDI
"RTN","SDCODEL",71,0)
 S DIK="^SDD("_SDFL_",",SDI=0
"RTN","SDCODEL",72,0)
 F  S SDI=$O(^SDD(SDFL,"AO",SDOE,SDI)) Q:'SDI  S DA=+$O(^(SDI,0)) D ^DIK
"RTN","SDCODEL",73,0)
 Q
"RTN","SDCODEL",74,0)
 ;
"RTN","SDCODEL",75,0)
OE(SDOE,SDMOD) ;Delete Outpatient Encounter
"RTN","SDCODEL",76,0)
 N DA,DIK,SDVSIT,SDORG,SDAT
"RTN","SDCODEL",77,0)
 IF '$$EDITOK^SDCO3(SDOE,SDMOD) G OEQ
"RTN","SDCODEL",78,0)
 S SDAT=$P($G(^SCE(+SDOE,0)),U,1)
"RTN","SDCODEL",79,0)
 S SDVSIT=$P($G(^SCE(SDOE,0)),U,5),SDORG=$P($G(^SCE(SDOE,0)),U,8)
"RTN","SDCODEL",80,0)
 S DA=SDOE,DIK="^SCE(" D ^DIK
"RTN","SDCODEL",81,0)
 S X=$$KILL^VSITKIL(SDVSIT)
"RTN","SDCODEL",82,0)
OEQ Q
"RTN","SDCODEL",83,0)
 ;
"RTN","SDCODEL",84,0)
COMDT(SDOE,SDMOD) ;Delete Check Out Process Completion Date
"RTN","SDCODEL",85,0)
 N DA,DE,DIE,DQ,DR
"RTN","SDCODEL",86,0)
 I $G(SDMOD) W !?3,"...deleting check out process completion date"
"RTN","SDCODEL",87,0)
 S DA=SDOE,DIE="^SCE(",DR=".07///@" D ^DIE
"RTN","SDCODEL",88,0)
 Q
"RTN","SDDSO")
0^23^B9613097
"RTN","SDDSO",1,0)
SDDSO ;BSN/GRR - DELETE ANCILLARY TESTS ;5/8/91  16:23
"RTN","SDDSO",2,0)
 ;;5.3;Scheduling;;Aug 13, 1993;Build 3
"RTN","SDDSO",3,0)
 D:'$D(DT) DT^SDUTL S HDT=DT,APL=""
"RTN","SDDSO",4,0)
RD W ! S DIC="^DPT(",DIC(0)="AEQM" D ^DIC G:X=""!(X="^") END I Y<0 W !,*7,*7,"PATIENT NOT FOUND",*7,*7 G RD
"RTN","SDDSO",5,0)
 S DA=+Y,DFN=DA,NAME=$P(Y,"^",2) W ! I $N(^DPT(DA,"S",HDT))'>0 G NO
"RTN","SDDSO",6,0)
 S NDT=HDT,L=0 F J=1:1 S NDT=$N(^DPT(DA,"S",NDT)) Q:NDT'>0  I $S($P(^(NDT,0),"^",2)']"":1,$P(^(0),"^",2)["I":1,1:0) D CHKSO S SC=+^(0),L=L+1 D FLEN S Z(L)=NDT_"^"_SC_"^"_APL_"^"_COMMENT
"RTN","SDDSO",7,0)
WH1 G:L'>0 NO F ZZ=1:1:L W !!,ZZ,") " S Y=$P($P(Z(ZZ),"^",1),".",1) D DT^SDM0 S X=$P(Z(ZZ),"^",1) X ^DD("FUNC",2,1) W " ",$J(X,8)," (",$P(Z(ZZ),"^",3)," MINUTES)  ",$P(^SC($P(Z(ZZ),"^",2),0),"^",1),"  ",$P(Z(ZZ),"^",4)
"RTN","SDDSO",8,0)
WH R !!,"DELETE TEST(S) FOR WHICH NUMBERED APPOINTMENT: ",APP:DTIME G:APP=""!(APP="^") RD G:APP["?" WH1 I APP'?1N.N W !,"INVALID ENTRY, MUST BE NUMERIC" G WH
"RTN","SDDSO",9,0)
 I APP<1!(APP>ZZ) W !,"ENTER A NUMBER BETWEEN 1 AND ",ZZ G WH
"RTN","SDDSO",10,0)
 S APP=+APP,(SD,S)=$P(Z(APP),"^",1),I=$P(Z(APP),"^",2)
"RTN","SDDSO",11,0)
 I Z(APP)'["(" W !,*7,"NO TEST ASSOCIATED WITH THIS APPOINTMENT" G WH1
"RTN","SDDSO",12,0)
 I $$CO^SDASO(DFN,S,"delete") G WH1
"RTN","SDDSO",13,0)
 K LAB,XRAY,EKG
"RTN","SDDSO",14,0)
 F ZDT="LAB","XRAY","EKG" D TST
"RTN","SDDSO",15,0)
 I '$D(LAB)&('$D(XRAY))&('$D(EKG)) W !,*7,"NOTHING DELETED" G RD
"RTN","SDDSO",16,0)
 S SD0=^DPT(DFN,"S",S,0)
"RTN","SDDSO",17,0)
 S ^(0)=$P(SD0,"^",1,2)_"^"_$S($D(LAB):"",1:$P(SD0,"^",3))_"^"_$S($D(XRAY):"",1:$P(SD0,"^",4))_"^"_$S($D(EKG):"",1:$P(SD0,"^",5))_"^"_$P(SD0,"^",6,99) G RD ;NAKED REFERENCE - ^DPT(DFN,"S",Date,0)
"RTN","SDDSO",18,0)
 ;
"RTN","SDDSO",19,0)
NO W !,"NO PENDING APPOINTMENTS",*7,*7,*7
"RTN","SDDSO",20,0)
 G RD
"RTN","SDDSO",21,0)
FLEN I $D(^SC(SC,"S",NDT)) F ZL=0:0 S ZL=$N(^SC(SC,"S",NDT,1,ZL)) Q:ZL<0  I +^(ZL,0)=DA S APL=$P(^SC(SC,"S",NDT,1,ZL,0),"^",2) Q
"RTN","SDDSO",22,0)
 Q
"RTN","SDDSO",23,0)
CHKSO S COMMENT="" F SDJ=3,4,5 I $P(^(0),"^",SDJ)]"" S:$L(COMMENT) COMMENT=COMMENT_"," S COMMENT=COMMENT_$S(SDJ=3:"LAB",SDJ=4:"XRAY",1:"EKG") ;NAKED REFERENCE - ^DPT(DFN,"S",Date,0)
"RTN","SDDSO",24,0)
 S:$L(COMMENT) COMMENT="("_COMMENT_" TEST SCHEDULED)" Q
"RTN","SDDSO",25,0)
TST Q:Z(APP)'[ZDT  S %=1,DTOUT=0 W !,"WANT TO DELETE ",ZDT," TEST" D YN^DICN I '% W !,"RESPOND YES OR NO" G TST
"RTN","SDDSO",26,0)
 W:DTOUT " NO" I '(%-1) S @ZDT="" W ?40,"DELETED"
"RTN","SDDSO",27,0)
 Q
"RTN","SDDSO",28,0)
END K %DT,APL,APP,COMMENT,DA,DFN,DIC,HDT,I,J,L,NAME,NDT,S,SB,SC,SD,SDJ,SI,SL,SS,ST,STARTDAY,STR,X,Y,Z,ZL,ZZ Q
"RTN","SDM")
0^24^B33704414
"RTN","SDM",1,0)
SDM ;SF/GFT,ALB/BOK - MAKE AN APPOINTMENT ; 4/21/05 10:22pm
"RTN","SDM",2,0)
 ;;5.3;Scheduling;**15,32,38,41,44,79,94,167,168,218,223,250,254,296,380,478,441**;AUG 13, 1993;Build 3
"RTN","SDM",3,0)
 ;                                           If defined...
"RTN","SDM",4,0)
 ; appt mgt vars:  SDFN := DFN of patient....will not be asked
"RTN","SDM",5,0)
 ;                SDCLN := ifn of clinic.....will not be asked    
"RTN","SDM",6,0)
 ;              SDAMERR := returned if error occurs
"RTN","SDM",7,0)
 ; 
"RTN","SDM",8,0)
 S:'$D(SDMM) SDMM=0
"RTN","SDM",9,0)
EN1 L  W !! D I^SDUTL I '$D(SDCLN) S DIC="^SC(",DIC(0)="AEMZQ",DIC("A")="Select CLINIC: ",DIC("S")="I $P(^(0),U,3)=""C"",'$G(^(""OOS""))" D ^DIC K DIC G:Y<0!'$D(^("SL")) END
"RTN","SDM",10,0)
 N SDRES S:$D(SDCLN) Y=+SDCLN S SDRES=$$CLNCK^SDUTL2(+Y,1)
"RTN","SDM",11,0)
 I 'SDRES W !,?5,"Clinic MUST be corrected before continuing." G END:$D(SDCLN),SDM
"RTN","SDM",12,0)
 K SDAPTYP,SDIN,SDRE,SDXXX S:$D(SDCLN) Y=+SDCLN
"RTN","SDM",13,0)
 S TMPYCLNC=Y,STPCOD=$P($G(^SC(+TMPYCLNC,0)),U,7) ;SD/478
"RTN","SDM",14,0)
 I $D(^SC(+Y,"I")) S SDIN=+^("I"),SDRE=+$P(^("I"),U,2)
"RTN","SDM",15,0)
 K SDINA I $D(SDIN),SDIN S SDINA=SDIN K SDIN
"RTN","SDM",16,0)
 I $D(SD),$D(SC),+Y'=+SC K SD
"RTN","SDM",17,0)
 S SL=$G(^SC(+Y,"SL")),X=$P(SL,U,3),STARTDAY=$S($L(X):X,1:8),SC=Y,SB=STARTDAY-1/100,X=$P(SL,U,6),HSI=$S(X=1:X,X:X,1:4),SI=$S(X="":4,X<3:4,X:X,1:4),STR="#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz",SDDIF=$S(HSI<3:8/HSI,1:2) K Y
"RTN","SDM",18,0)
 I $D(^SC(+SC,"SDPROT")),$P(^("SDPROT"),U)="Y",'$D(^SC(+SC,"SDPRIV",DUZ)) W !,*7,"Access to ",$$CNAM(+SC)," is prohibited!",!,"Only users with a special code may access this clinic.",*7 S:$D(SDCLN) SDAMERR="" G END:$D(SDCLN),SDM
"RTN","SDM",19,0)
 D CS^SDM1A S SDW="",WY="Y"
"RTN","SDM",20,0)
 I '$D(ORACTION),'$D(SDFN) S (DIC,DIE)="^DPT(",DIC(0)="AQZME" D ^DIC S DFN=+Y G:Y<0 END:$D(SDCLN),^SDM0:X[U,SDM
"RTN","SDM",21,0)
 S:$D(SDFN) DFN=SDFN
"RTN","SDM",22,0)
 I $D(^DPT(DFN,.35)),$P(^(.35),U)]"" W !?10,*7,"PATIENT HAS DIED." S:$D(SDFN) SDAMERR="" G END:$D(SDFN),SDM
"RTN","SDM",23,0)
 D ^SDM4 I $S('$D(COLLAT):1,COLLAT=7:1,1:0) G:$D(SDCLN) END G SDM
"RTN","SDM",24,0)
 ;-- get sub-category for appointment type
"RTN","SDM",25,0)
 S SDXSCAT=$$SUB^DGSAUTL(SDAPTYP,2,"")
"RTN","SDM",26,0)
 K SDXXX D EN G END:$D(SDCLN),SDM
"RTN","SDM",27,0)
EN K SDMLT1 W:$P(VAEL(9),U,2)]"" !!,?15,"MEANS TEST STATUS: ",$P(VAEL(9),U,2),!
"RTN","SDM",28,0)
 ; *** sck, mt blocking removed
"RTN","SDM",29,0)
 ;S X="EASMTCHK" X ^%ZOSF("TEST") I $T,$$MT^EASMTCHK(DFN,+$G(SDAPTYP),"M") S SDAMERR="" Q
"RTN","SDM",30,0)
 S Y=DFN,Y(0)=^DPT(DFN,0) I VADM(7)]"" W !?3,*7,VADM(7)
"RTN","SDM",31,0)
 I $D(^DGS(41.1,"B",DFN)) F I=0:0 S I=$O(^DGS(41.1,"B",DFN,I)) Q:I'>0  I $P(^DGS(41.1,I,0),U,2)'<DT&('$P(^DGS(41.1,I,0),U,13)) W !,"SCHEDULED FOR ADMISSION ON " S Y=$P(^(0),U,2) D DT^SDM0
"RTN","SDM",32,0)
PEND S %="" W:$O(^DPT(DFN,"S",DT))'>DT !,"NO PENDING APPOINTMENTS"
"RTN","SDM",33,0)
 I $O(^DPT(DFN,"S",DT))>DT D  G END:%<0,HELP:'%
"RTN","SDM",34,0)
 .S %=1 W !,"DISPLAY PENDING APPOINTMENTS:"
"RTN","SDM",35,0)
 .D YN^DICN
"RTN","SDM",36,0)
 .I %Y["^" S SDMLT1=1
"RTN","SDM",37,0)
 D:%=1
"RTN","SDM",38,0)
 .N DX,DY,SDXY,SDEND S SDXY="S DX=$X,DY=0"_$S($L($G(^%ZOSF("XY"))):" "_^("XY"),1:"") X SDXY
"RTN","SDM",39,0)
 .S CN=1
"RTN","SDM",40,0)
 .F Y=DT:0 S Y=$O(^DPT(DFN,"S",Y)) Q:Y'>0  I "I"[$P(^(Y,0),U,2) X:(($Y+4)>IOSL) "D OUT^SDUTL X SDXY" Q:$G(SDEND)  D CHKSO W:$X>9 ! W CN,".",?4 D DT^SDM0 W ?23 S DA=+SSC W SDLN,$S($D(^SC(DA,0)):$P(^(0),U),1:"DELETED CLINIC "),COV,"  ",SDAT16 D
"RTN","SDM",41,0)
 ..S CNIEN=0 F  S CNIEN=$O(^SC(+SSC,"S",HY,1,CNIEN)) Q:'+CNIEN  S CNPAT=$P($G(^SC(+SSC,"S",HY,1,CNIEN,0)),U) I CNPAT=DFN W:+$G(^SC(+SSC,"S",HY,1,CNIEN,"CONS")) " Consult Appt." S CN=CN+1 Q  ;SD/478
"RTN","SDM",42,0)
 ;Prompt for ETHNICITY if no value on file
"RTN","SDM",43,0)
 I '$O(^DPT(DFN,.06,0)) D
"RTN","SDM",44,0)
 .S DA=DFN,DR="6ETHNICITY",DIE="^DPT("
"RTN","SDM",45,0)
 .S DR(2,2.06)=".01ETHNICITY"
"RTN","SDM",46,0)
 .D ^DIE K DR
"RTN","SDM",47,0)
 ;Prompt for RACE if no value on file
"RTN","SDM",48,0)
 I '$O(^DPT(DFN,.02,0)) D
"RTN","SDM",49,0)
 .S DA=DFN,DR="2RACE",DIE="^DPT("
"RTN","SDM",50,0)
 .S DR(2,2.02)=".01RACE"
"RTN","SDM",51,0)
 .D ^DIE K DR
"RTN","SDM",52,0)
 I $S('$D(^DPT(DFN,.11)):1,$P(^(.11),U)="":1,1:0) N FLG S FLG(1)=1 D EN^DGREGAED(DFN,.FLG)
"RTN","SDM",53,0)
 Q:$D(SDXXX)
"RTN","SDM",54,0)
E S Y=$P(SL,U,5)
"RTN","SDM",55,0)
 S SDW="" I $D(^DPT(DFN,.1)) S SDW=^(.1) W !,"NOTE - PATIENT IS NOW IN WARD "_SDW
"RTN","SDM",56,0)
 Q:$D(SDXXX)
"RTN","SDM",57,0)
EN2 F X=0:0 S X=$O(^DPT(DFN,"DE",X)) Q:'$D(^(+X,0))  I ^(0)-SC=0!'(^(0)-Y) F XX=0:0 S XX=$O(^DPT(DFN,"DE",X,1,XX)) Q:XX<1  S SDDIS=$P(^(XX,0),U,3) I 'SDDIS D:'$D(SDMULT) A^SDCNSLT G ^SDM0
"RTN","SDM",58,0)
 I '$D(^SC(+Y,0)) S Y=+SC
"RTN","SDM",59,0)
 S Y=$P(^SC(Y,0),U)
"RTN","SDM",60,0)
 ; SCRESTA = Array of pt's teams causing restricted consults
"RTN","SDM",61,0)
 N SCRESTA
"RTN","SDM",62,0)
 S SCREST=$$RESTPT^SCAPMCU4(DFN,DT,"SCRESTA")
"RTN","SDM",63,0)
 IF SCREST D
"RTN","SDM",64,0)
 .N SCTM
"RTN","SDM",65,0)
 . S SCCLNM=Y
"RTN","SDM",66,0)
 . W !,?5,"Patient has restricted consults due to team assignment(s):"
"RTN","SDM",67,0)
 .S SCTM=0
"RTN","SDM",68,0)
 .F  S SCTM=$O(SCRESTA(SCTM)) Q:'SCTM  W !,?10,SCRESTA(SCTM)
"RTN","SDM",69,0)
 IF SCREST&'$G(SCOKCONS) D  Q
"RTN","SDM",70,0)
 .W !,?5,"This patient may only be given appointments and enrolled in clinics via"
"RTN","SDM",71,0)
 .W !,?15,"Make Consult Appointment Option, and"
"RTN","SDM",72,0)
 .W !,?15,"Edit Clinic Enrollment Data option"
"RTN","SDM",73,0)
 D:$G(SCREST) MAIL^SCMCCON(DFN,.SCCLNM,2,DT,"SCRESTA")
"RTN","SDM",74,0)
 K DR,SCREST,SCCLNM
"RTN","SDM",75,0)
 D:'$D(SDMULT) ^SDCNSLT ;SD/478
"RTN","SDM",76,0)
 G ^SDM0
"RTN","SDM",77,0)
 ;
"RTN","SDM",78,0)
CHKSO S COV=$S($P(^DPT(DFN,"S",Y,0),U,11)=1:" (COLLATERAL)",1:""),HY=Y,SSC=^(0),SDAT16=$S($D(^SD(409.1,+$P(SSC,U,16),0)):$P(^(0),U),1:"")
"RTN","SDM",79,0)
 F SDJ=3,4,5 I $P(^DPT(DFN,"S",HY,0),U,SDJ)]"" S Y=$P(^(0),U,SDJ) W:$X>9 ! W ?10,"*" D DT^SDM0 W ?32,$S(SDJ=3:"LAB",SDJ=4:"XRAY",1:"EKG")
"RTN","SDM",80,0)
 S SDLN="" F J=0:0 S J=$O(^SC(+SSC,"S",HY,1,J)) Q:'J  I $D(^(J,0)),+^(0)=DFN S SDLN="("_$P(^(0),U,2)_" MIN) " Q
"RTN","SDM",81,0)
 S Y=HY Q
"RTN","SDM",82,0)
 ;
"RTN","SDM",83,0)
END D KVAR^VADPT K SDAPTYP,SDSC,%,%DT,ASKC,COV,DA,DIC,DIE,DP,DR,HEY,HSI,HY,J,SB,SC,SDDIF,SDJ,SDLN,SD17,SDMAX,SDU,SDYC,SI,SL,SSC,STARTDAY,STR
"RTN","SDM",84,0)
 K WY,X,XX,Y,S,SD,SDAP16,SDEDT,SDTY,SM,SS,ST,ARG,CCX,CCXN,HX,I,PXR,SDINA,SDW,COLLAT,SDDIS I $D(SDMM) K:'SDMM SDMM
"RTN","SDM",85,0)
 K A,CC,CLNIEN,CN,CNIEN,CNPAT,CNSLTLNK,CNSULT,CNT,CONS,CPRSTAT,CW,DSH,DTENTR,DTIN,DTLMT,DTR,ND,P8,PROC,PT,PTIEN,PTNM,RTMP,NOSHOW,SCPTTM,SD1,SDAMSCN,SDATE,SDDOT,SDII,SDINC,SDINCM,SDLEN,SDNS,SDSI,SDST,SDSTR,SDSTRTDT
"RTN","SDM",86,0)
 K SDXSCAT,SENDER,SERVICE,SRV,STATUS,STPCOD,TMP,TMPYCLNC,TYPE
"RTN","SDM",87,0)
 I '$D(SDMLT) K SDMLT1
"RTN","SDM",88,0)
 Q
"RTN","SDM",89,0)
 ;
"RTN","SDM",90,0)
OERR S XQORQUIT=1 Q:'$D(ORVP)  S DFN=+ORVP G SDM
"RTN","SDM",91,0)
 ;
"RTN","SDM",92,0)
HELP W !,"YES - TO DISPLAY FUTURE APPOINTMENTS",!,"NO - FUTURE APPOINTMENTS NOT DISPLAYED" G PEND
"RTN","SDM",93,0)
 ;
"RTN","SDM",94,0)
CNAM(SDCL) ;Return clinic name
"RTN","SDM",95,0)
 ;Input: SDCL=clinic ien
"RTN","SDM",96,0)
 N SDX
"RTN","SDM",97,0)
 S SDX=$P($G(^SC(+SDCL,0)),U)
"RTN","SDM",98,0)
 Q $S($L(SDX):SDX,1:"this clinic")
"RTN","SDM0")
0^25^B88208979
"RTN","SDM0",1,0)
SDM0 ;SF/GFT - MAKE APPOINTMENT ; 11 Jun 2001  5:20 PM
"RTN","SDM0",2,0)
 ;;5.3;Scheduling;**140,167,206,186,223,237,241,384,334,547**;Aug 13, 1993;Build 3
"RTN","SDM0",3,0)
 I $D(SDXXX) S SDOK=1 Q
"RTN","SDM0",4,0)
 N SDSRTY,SDDATE,SDSDATE,SDSRFU,SDDMAX,SDONCE
"RTN","SDM0",5,0)
 ;Prompt for scheduling request type
"RTN","SDM0",6,0)
M N SDHX,SDXF,SDXD
"RTN","SDM0",7,0)
 Q:'$$SRTY(.SDSRTY)  S:SDSRTY SDDATE=DT
"RTN","SDM0",8,0)
 ;Calculate appointment follow-up indicator
"RTN","SDM0",9,0)
 S SDSRFU=$$PTFU(DFN,SC)
"RTN","SDM0",10,0)
 ;Determine maximum days for scheduling
"RTN","SDM0",11,0)
 S SDMAX(1)=$P($G(^SC(+SC,"SDP")),U,2) S:'SDMAX(1) SDMAX(1)=365
"RTN","SDM0",12,0)
 S (SDMAX,SDDMAX)=$$FMADD^XLFDT(DT,SDMAX(1))
"RTN","SDM0",13,0)
 ;Prompt for desired date
"RTN","SDM0",14,0)
 Q:'$$DDATE(.SDDATE,SDSRTY,.SDMAX)
"RTN","SDM0",15,0)
 ;If date and time, schedule appt. directly
"RTN","SDM0",16,0)
 W ! I SDDATE#1 S SDSDATE=SDDATE,SDDATE=SDDATE\1 G ^SDM1
"RTN","SDM0",17,0)
 S (X,Y)=SDDATE K SDHX
"RTN","SDM0",18,0)
 ;Find first available after specified date
"RTN","SDM0",19,0)
 I X="F"!(X="f") D SUP,DT1 G NEXT
"RTN","SDM0",20,0)
 ;Find next available appointment
"RTN","SDM0",21,0)
 I SDSRTY,SDDATE D SUP S SDSTRTDT=SDDATE D OVR^SDMULT0 G NEXT
"RTN","SDM0",22,0)
 ;
"RTN","SDM0",23,0)
EN S:$L(X)=1 X=$TR(X,"tnN","TTT") S:X="NOW" X="T" I X?.A!(+X=X),X<13,X'?1"T".E S X=X_" 1"
"RTN","SDM0",24,0)
 D  Q:Y<1
"RTN","SDM0",25,0)
 .N %DT
"RTN","SDM0",26,0)
 .S %DT="T" D ^%DT
"RTN","SDM0",27,0)
 .I Y<1 W !!,"Unable to evaluate date value """_X_""".",!
"RTN","SDM0",28,0)
 .Q
"RTN","SDM0",29,0)
 S:$S($D(DUZ)'[0:1,1:0) ^DISV(DUZ_U_+SC)=Y
"RTN","SDM0",30,0)
DISP S IOF=$S('$D(IOF):"!#",IOF']"":"!#",1:IOF) W @IOF S SDSOH=$S('$D(^SC(+SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1),SDAV=0
"RTN","SDM0",31,0)
 I $D(SDINA),Y'<SDINA,SDRE>Y!('SDRE) S SDHY=Y,Y=SDINA D DTS^SDUTL W !,*7,"Clinic is inactive ",$S(SDRE:"from ",1:"as of "),Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" to "_Y,1:"") S Y=SDHY K SDHY D PAUSE^VALM1 Q:'SDRE
"RTN","SDM0",32,0)
 S:Y#100=0 Y=Y+1 S X=Y D D:$E(X,4,5) S (SDX,X1)=X,X2=1 D C^%DTC S X=SDX K SDX G:SDAV ^SDM1 Q
"RTN","SDM0",33,0)
 ;
"RTN","SDM0",34,0)
NEXT D SET I $S('$D(FND):1,'FND:1,1:0) D  G EN
"RTN","SDM0",35,0)
 .K ^DISV($S($D(DUZ)'[0:DUZ,1:0)_U_+SC)
"RTN","SDM0",36,0)
 .I '$O(^SC(+SC,"ST",SDDATE-1)) S (X,Y)=SDDATE Q
"RTN","SDM0",37,0)
 .W $C(7),!?6,"No open slots found in the date range "
"RTN","SDM0",38,0)
 .W $$FMTE^XLFDT(SDDATE)," to ",$$FMTE^XLFDT(SDDMAX),"!",!
"RTN","SDM0",39,0)
 .H 3 S (X,Y)=SDDATE
"RTN","SDM0",40,0)
 .Q
"RTN","SDM0",41,0)
 S (X,Y)=SDAPP K SDXXX G DISP
"RTN","SDM0",42,0)
D W #!?36,$P(SC,U,2) S:$O(^SC(+SC,"T",0))>X X=+$O(^(0)) D DOW S I=Y+32,D=Y S SDXF=0 D WM I SDXF D WMH
"RTN","SDM0",43,0)
X1 S X1=X\100_$P("31^28^31^30^31^30^31^31^30^31^30^31",U,+$E(X,4,5)) ;28
"RTN","SDM0",44,0)
 ;SD*5.3*547 next line don't allow past dates to be added to pattern if prior to date DOW was added
"RTN","SDM0",45,0)
W I '$D(^SC(+SC,"ST",X,1)) S DWFLG=1,POP=0,XDT=X D DOWCHK K DWFLG,XDT G L:POP
"RTN","SDM0",46,0)
 I '$D(^SC(+SC,"ST",X,1)) S Y=D#7 G L:'$D(J(Y)),H:$D(^HOLIDAY(X))&('SDSOH) S SS=+$O(^SC(+SC,"T"_Y,X)) G L:SS'>0,L:^(SS,1)="" S ^SC(+SC,"ST",$P(X,"."),1)=$E($P($T(DAY),U,Y+2),1,2)_" "_$E(X,6,7)_$J("",SI+SI-6)_^(1),^(0)=$P(X,".")
"RTN","SDM0",47,0)
 S SDHX=X,SDAV=1 D:X>SM WM I SDXF<2 D WMH
"RTN","SDM0",48,0)
 I $D(^SC(+SC,"ST",X,1)),^(1)["["!(^(1)["CANCELLED")!($D(^HOLIDAY(X))) W !,$E(^SC(+SC,"ST",X,1),1,80) S:'$D(^HOLIDAY(X))&('SDAV) SDAV=1
"RTN","SDM0",49,0)
 I $Y>18 W ! Q
"RTN","SDM0",50,0)
L K POP
"RTN","SDM0",51,0)
 S X=X+1,D=D+1
"RTN","SDM0",52,0)
 I $D(SDINA),X>SDINA,SDRE>X!('SDRE) D:'SDAV NOAV S SDHY=Y,Y=SDINA D DTS^SDUTL W !,*7,?8,"Clinic is inactive ",$S(SDRE:"from ",1:"as of "),Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" to "_Y,1:"") S Y=SDHY K SDHY Q:'SDRE  D DIFF
"RTN","SDM0",53,0)
 G W:X'>X1 S X2=X-X1 D C^%DTC
"RTN","SDM0",54,0)
 I $D(SDINA),X>SDINA,SDRE>X!('SDRE) D:'SDAV NOAV S SDHY=Y,Y=SDINA D DTS^SDUTL W !,*7,?8,"Clinic is inactive ",$S(SDRE:"from ",1:"as of "),Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" to "_Y,1:"") S Y=SDHY K SDHY Q:'SDRE
"RTN","SDM0",55,0)
 G X1:D<I W ! D:'SDAV MNTH Q
"RTN","SDM0",56,0)
 ;
"RTN","SDM0",57,0)
NOAV W !,"No availability found between date chosen and inactivate date!" Q
"RTN","SDM0",58,0)
H S ^SC(+SC,"ST",X,1)="   "_$E(X,6,7)_"    "_$P(^(X,0),U,2),^(0)=X G W
"RTN","SDM0",59,0)
 ;
"RTN","SDM0",60,0)
WM W !?36 S Y=$E(X,1,5)_"00",SM=$S($E(X,4,5)[12:$E(X,1,3)+1_"01",1:$E(X,1,3)_$E(X,4,5)+1)_"00"
"RTN","SDM0",61,0)
 S SDXF=SDXF+1 I $E(X,6,7)>20 D
"RTN","SDM0",62,0)
 . S SDXD=$O(^SC(+SC,"ST",X-1)) Q:SDXD=""
"RTN","SDM0",63,0)
 . I $E(SDXD,4,5)'=$E(X,4,5) S SDXF=0
"RTN","SDM0",64,0)
 D:SDXF DT
"RTN","SDM0",65,0)
 Q
"RTN","SDM0",66,0)
WMH ;Write month heading lines
"RTN","SDM0",67,0)
 W !!," TIME",?SI+SI-1 F Y=STARTDAY:1:65\(SI+SI)+STARTDAY W $E("|"_$S('Y:0,1:(Y-1#12+1))_"                 ",1,SI+SI)
"RTN","SDM0",68,0)
 W !," DATE",?SI+SI-1,"|" K J F Y=0:1:6 I $D(^SC(+SC,"T"_Y)) S J(Y)=""
"RTN","SDM0",69,0)
 F Y=1:1:65\(SI+SI) W $J("|",SI+SI)
"RTN","SDM0",70,0)
 S SDXF=2
"RTN","SDM0",71,0)
 Q
"RTN","SDM0",72,0)
DT W $$FMTE^XLFDT(Y) Q
"RTN","SDM0",73,0)
 ;
"RTN","SDM0",74,0)
DOW S Y=$$DOW^XLFDT(X,1) Q
"RTN","SDM0",75,0)
 ;
"RTN","SDM0",76,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDM0",77,0)
MORDIS I '$D(SDHX) W *7," ??" G ADT^SDM1
"RTN","SDM0",78,0)
 S SDXF=0,X1=SDHX,X2=1 D C^%DTC
"RTN","SDM0",79,0)
MORD2 I $D(SDINA),SDINA'>X,SDRE>X!('SDRE) S SDHY=$S($D(Y):Y,1:""),Y=SDINA D DTS^SDUTL W *7,!,"Clinic is inactivated as of ",Y S Y=SDHY K SDHY G ADT^SDM1
"RTN","SDM0",80,0)
 G EN
"RTN","SDM0",81,0)
INPAT S SDI=$O(^DGPM("ATID1",DFN,9999999-X)) I SDI>0 D I1
"RTN","SDM0",82,0)
 S:'$D(SDINP) SDINP="" K SDI,SDI1 Q
"RTN","SDM0",83,0)
I1 F SDI1=0:0 S SDI1=$O(^DGPM("ATID1",DFN,SDI,SDI1)) Q:SDI1'>0  I $D(^DGPM(SDI1,0)) S SDX=^(0) I $S($P(SDX,U,17)']"":1,+^DGPM($P(SDX,U,17),0)>X!(+^DGPM($P(SDX,U,17),0)=0):1,1:0) S SDINP="I" Q
"RTN","SDM0",84,0)
 Q
"RTN","SDM0",85,0)
 ;
"RTN","SDM0",86,0)
SUP ;Set up variables for availability search
"RTN","SDM0",87,0)
 S SDNEXT=1,SDCT=1,G1=+SC,SDC(1)=SC,FND=0,SDAV=0 K SDC1
"RTN","SDM0",88,0)
 D SAVE S IOP=$S($D(ION):ION,1:"HOME") D ^%ZIS K IOP
"RTN","SDM0",89,0)
 Q
"RTN","SDM0",90,0)
 ;
"RTN","SDM0",91,0)
SET S I1="" F I=0:0 S I1=$O(SDZ(I1)) Q:I1']""  S @I1=SDZ(I1)
"RTN","SDM0",92,0)
 K SDZ Q
"RTN","SDM0",93,0)
SAVE K SDZ F I="SDDIF","STR","SC","DFN","SL","SI","HSI","SB" S Z="SDZ("_""""_I_""")" S:$D(@I) @Z=@I
"RTN","SDM0",94,0)
 Q
"RTN","SDM0",95,0)
MNTH W !," *** No availability found for one full calendar month",!,"  Search stopped at " S Y=X D DTS^SDUTL W Y," ***",! Q
"RTN","SDM0",96,0)
DIFF S X1=SDRE,X2=X D ^%DTC S D=D+X,X=SDRE,X1=X\100_28 Q
"RTN","SDM0",97,0)
 ;
"RTN","SDM0",98,0)
SRTY(SDSRTY) ;Prompt for scheduling request type
"RTN","SDM0",99,0)
 ;Input: SDSRTY=variable to return user response (pass by reference)
"RTN","SDM0",100,0)
 ;Output: '1' if successful, '0' otherwise
"RTN","SDM0",101,0)
 ;
"RTN","SDM0",102,0)
 I $G(DFN)<1 S SDSRTY="M" Q 1  ;patient not defined
"RTN","SDM0",103,0)
 I $G(SDMM)=1 S SDSRTY="M" Q 1  ;multiple appointment booking
"RTN","SDM0",104,0)
 N DIR,DTOUT,DUOUT
"RTN","SDM0",105,0)
 S DIR(0)="Y"
"RTN","SDM0",106,0)
 S DIR("A")="IS THIS A 'NEXT AVAILABLE' APPOINTMENT REQUEST"
"RTN","SDM0",107,0)
 S DIR("?")="Answer 'yes' if scheduling to the next available appointment is desired."
"RTN","SDM0",108,0)
 W ! D ^DIR I $D(DTOUT)!$D(DUOUT) Q 0
"RTN","SDM0",109,0)
 S SDSRTY=Y,SDSRTY(0)=$$TXRT^SDM1A(.SDSRTY) Q 1
"RTN","SDM0",110,0)
 ;
"RTN","SDM0",111,0)
PTFU(DFN,SC)    ;Determine if this is a follow-up (return to clinic within 24 months)
"RTN","SDM0",112,0)
 ;Input: DFN=patient ifn
"RTN","SDM0",113,0)
 ;Input: SC=clinic ifn
"RTN","SDM0",114,0)
 ;Output: '1' if seen within 24 months, '0' otherwise
"RTN","SDM0",115,0)
 ;
"RTN","SDM0",116,0)
 Q:'DFN!'SC 0  ;variable check
"RTN","SDM0",117,0)
 N SDBDT,SDT,SDX,SDY,SDZ,SDCP,SDCP1,SC0,SDENC,SDCT
"RTN","SDM0",118,0)
 ;set up variables
"RTN","SDM0",119,0)
 S SDBDT=(DT-20000)+.24,SDT=DT_.999999,(SDCT,SDY)=0
"RTN","SDM0",120,0)
 S SC0=$G(^SC(+SC,0)),SDX=$$CPAIR^SCRPW71(SC0,.SDCP)  ;get credit pair for this clinic
"RTN","SDM0",121,0)
 ;Iterate through encounters
"RTN","SDM0",122,0)
 W !!,"Calculating follow-up status"
"RTN","SDM0",123,0)
 F  S SDT=$O(^SCE("ADFN",DFN,SDT),-1) Q:SDT<SDBDT!SDY  D
"RTN","SDM0",124,0)
 .S SDENC=0 F  S SDENC=$O(^SCE("ADFN",DFN,SDT,SDENC)) Q:'SDENC!SDY  D
"RTN","SDM0",125,0)
 ..S SDENC0=$G(^SCE(SDENC,0))  ;get encounter node
"RTN","SDM0",126,0)
 ..Q:$P(SDENC0,U,6)  ;parent encounters only
"RTN","SDM0",127,0)
 ..S SDX=$P(SDENC0,U,4) Q:'SDX  ;get clinic
"RTN","SDM0",128,0)
 ..S SC0=$G(^SC(SDX,0))
"RTN","SDM0",129,0)
 ..S SDX=$$CPAIR^SCRPW71(SC0,.SDCP1)  ;get credit pair for encounter
"RTN","SDM0",130,0)
 ..S SDY=SDCP=SDCP1  ;compare credit pairs
"RTN","SDM0",131,0)
 ..S SDCT=SDCT+1 W:SDCT#10=0 "."
"RTN","SDM0",132,0)
 ..Q
"RTN","SDM0",133,0)
 .Q
"RTN","SDM0",134,0)
 Q SDY
"RTN","SDM0",135,0)
 ;
"RTN","SDM0",136,0)
DDATE(SDDATE,SDSRTY,SDMAX) ;Desired date selection
"RTN","SDM0",137,0)
 ;Input: SDDATE=variable to return date selection (pass by reference)
"RTN","SDM0",138,0)
 ;Input: SDSRTY=variable to return request type
"RTN","SDM0",139,0)
 ;Input: SDMAX=variable to return max. days to sched. (pass by ref.)
"RTN","SDM0",140,0)
 ;Output: '1' for success, otherwise '0'
"RTN","SDM0",141,0)
 ;
"RTN","SDM0",142,0)
 Q:SDSRTY 1
"RTN","SDM0",143,0)
 W !!?2,"Select one of the following:",!
"RTN","SDM0",144,0)
 W !?5,"'F'",?20,"for First available following a specified date"
"RTN","SDM0",145,0)
 W !?5,"Date",?20,"(or date computation such as 'T+2M') for a desired date"
"RTN","SDM0",146,0)
 I DFN>0 W !?5,"Date/time",?20,"to schedule a specific appointment - Note: PAST dates",!?20,"must include the Year in the input."  ;added note SD*5.3*547
"RTN","SDM0",147,0)
 W !?5,"'?'",?20,"for detailed help"
"RTN","SDM0",148,0)
DASK N DIR,X,Y,SDX,DTOUT,DUOUT
"RTN","SDM0",149,0)
 ;
"RTN","SDM0",150,0)
 ;BP OIFO/TEH PATCH SD*5.3*384 ; SD*5.3*547 added note to help text
"RTN","SDM0",151,0)
 ;
"RTN","SDM0",152,0)
 S DIR(0)="F^1:30"
"RTN","SDM0",153,0)
 S DIR("A")="ENTER THE DATE DESIRED FOR THIS APPOINTMENT"
"RTN","SDM0",154,0)
 S DIR("?",1)="  Enter the date that is desired for this appointment."
"RTN","SDM0",155,0)
 S DIR("?",2)="  NOTE: PAST dates must include the Year in the input."
"RTN","SDM0",156,0)
 S DIR("?",3)=""
"RTN","SDM0",157,0)
 S DIR("?",4)="  You may enter 'F' to find the first available slot after a specified date."
"RTN","SDM0",158,0)
 S DIR("?",5)="  You will be prompted for begin and end dates for this search."
"RTN","SDM0",159,0)
 S DIR("?",6)=""
"RTN","SDM0",160,0)
 S DIR("?",7)="  A date may be entered to begin the display of clinic availability at the"
"RTN","SDM0",161,0)
 I DFN<1 S DIR("?")="  requested date."
"RTN","SDM0",162,0)
 I DFN>0 D
"RTN","SDM0",163,0)
 .S DIR("?",8)="  requested date."
"RTN","SDM0",164,0)
 .S DIR("?",9)=""
"RTN","SDM0",165,0)
 .S DIR("?",10)="  The entry of a date/time will result in the scheduling of an appointment at"
"RTN","SDM0",166,0)
 .S DIR("?")="  that time, if possible."
"RTN","SDM0",167,0)
 .Q
"RTN","SDM0",168,0)
 W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT) 0
"RTN","SDM0",169,0)
 I Y=" " S SDX=$G(^DISV(DUZ_U_+SC)) I SDX?7N S (X,Y)=SDX
"RTN","SDM0",170,0)
 I $L(Y)=1,"fF"[Y D  Q 1
"RTN","SDM0",171,0)
 .W "    First available"
"RTN","SDM0",172,0)
 .S (SDDATE,SDSRTY)=$TR(Y,"f","F")
"RTN","SDM0",173,0)
 .Q
"RTN","SDM0",174,0)
 N %DT,SDX,SDI
"RTN","SDM0",175,0)
 S SDX="N^n^NOW^now^Now" F SDI=1:1:5 S:X=$P(SDX,U,SDI) X="T"
"RTN","SDM0",176,0)
 S %DT="EFT" D ^%DT
"RTN","SDM0",177,0)
 G:Y<1 DASK S SDDATE=Y
"RTN","SDM0",178,0)
 I DFN<1 S SDDATE=SDDATE\1
"RTN","SDM0",179,0)
 I DFN>0,Y'<DT,(Y\1)>SDMAX D  G DASK
"RTN","SDM0",180,0)
 .W !,$C(7)
"RTN","SDM0",181,0)
 .W "Scheduling cannot be more than ",SDMAX(1)," days in the future"
"RTN","SDM0",182,0)
 .Q
"RTN","SDM0",183,0)
 Q 1
"RTN","SDM0",184,0)
 ;
"RTN","SDM0",185,0)
DOWCHK ;SD*5.3*547 check if date is prior to date DOW was added to pattern
"RTN","SDM0",186,0)
 S (DY,DYW)="" S:'$D(DWFLG) DWFLG=0
"RTN","SDM0",187,0)
 I '$D(^SC(+SC,"ST",$P(XDT,"."),1)) D  Q:DWFLG  I POP D DWWRT Q
"RTN","SDM0",188,0)
 .S DY=$$DOW^XLFDT($P(XDT,"."))
"RTN","SDM0",189,0)
 .S DYW=$E(DY,1,2),DYW=$TR(DYW,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","SDM0",190,0)
 .S PCDT=$P(XDT,"."),CT=0,POP=1
"RTN","SDM0",191,0)
 .F  S PCDT=$O(^SC(+SC,"ST",PCDT),-1) Q:'PCDT!('POP)!(CT>30)  D
"RTN","SDM0",192,0)
 ..S CT=CT+1
"RTN","SDM0",193,0)
 ..Q:'$D(^SC(+SC,"ST",PCDT,0))
"RTN","SDM0",194,0)
 ..Q:'$D(^SC(+SC,"ST",PCDT,1))
"RTN","SDM0",195,0)
 ..Q:$E($G(^SC(+SC,"ST",PCDT,1)),1,2)'=DYW
"RTN","SDM0",196,0)
 ..I $E($G(^SC(+SC,"ST",PCDT,1)),1,2)=DYW S POP=0 Q
"RTN","SDM0",197,0)
 .Q
"RTN","SDM0",198,0)
 K PCDT,CT,DY,DYW
"RTN","SDM0",199,0)
 Q
"RTN","SDM0",200,0)
 ;
"RTN","SDM0",201,0)
DWWRT ;added SD*5.3*547
"RTN","SDM0",202,0)
 S DY=$TR(DY,"abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ")
"RTN","SDM0",203,0)
 W *7,!!,"That date is prior to the date ",DY," was added to the"
"RTN","SDM0",204,0)
 W !,"availability pattern for this clinic.",!!
"RTN","SDM0",205,0)
 K DY,DYW,PCDT,CT
"RTN","SDM0",206,0)
 Q
"RTN","SDM0",207,0)
 ;
"RTN","SDM0",208,0)
1 S SDNEXT="",SDCT=0 G RD^SDMULT
"RTN","SDM0",209,0)
DT1 S FND=0,%DT(0)=-SDMAX,%DT="AEF",%DT("A")="  START SEARCH FOR NEXT AVAILABLE FROM WHAT DATE: " D ^%DT K %DT G:"^"[X 1:$S('$D(SDNEXT):1,'SDNEXT:1,1:0),END^SDMULT0 G:Y<0 DT S (SDDATE,SDSTRTDT)=+Y
"RTN","SDM0",210,0)
LIM W !,"  ENTER LATEST DATE TO CHECK FOR 1ST AVAILABLE SLOT: " S Y=SDMAX D DT^DIQ R "// ",X:DTIME G:X["^"!'($T) END^SDMULT0 I X']"" G OVR^SDMULT0
"RTN","SDM0",211,0)
 I X?.E1"?" W !,"  The latest date for future bookings for ",$P(SDC(1),"^",2)," is: " S Y=SDMAX D DTS^SDUTL W Y,!,"  If you enter a date here, it must be less than this date to further limit the",!,"  search" G LIM
"RTN","SDM0",212,0)
 S %DT="EF",%DT(0)=-SDMAX D ^%DT K %DT G:Y<0!(Y<SDSTRTDT) LIM S:Y>0 (SDDMAX,SDMAX)=+Y
"RTN","SDM0",213,0)
 G OVR^SDMULT0
"RTN","SDM1")
0^26^B53130837
"RTN","SDM1",1,0)
SDM1 ;SF/GFT - MAKE APPOINTMENT ; 3/29/05 12:35pm [5/5/05 9:41am]  ; Compiled March 8, 2007 14:55:24  ; Compiled May 9, 2007 13:19:18  ; Compiled August 28, 2007 12:19:08
"RTN","SDM1",2,0)
 ;;5.3;Scheduling;**32,167,168,80,223,263,273,408,327,478,490,446,547**;Aug 13, 1993;Build 3
"RTN","SDM1",3,0)
1 L  Q:$D(SDXXX)  S CCXN=0 K MXOK,COV,SDPROT Q:DFN<0  S SC=+SC
"RTN","SDM1",4,0)
 S X1=DT,SDEDT=365 S:$D(^SC(SC,"SDP")) SDEDT=$P(^SC(SC,"SDP"),"^",2)
"RTN","SDM1",5,0)
 S X2=SDEDT D C^%DTC S SDEDT=X D WRT
"RTN","SDM1",6,0)
 I $D(^SC(SC,"SI")),$O(^("SI",0))>0 W !,*7,?8,"**** SPECIAL INSTRUCTIONS ****",! S %I=0 F %=0:1 S %I=$O(^SC(SC,"SI",%I)) Q:%I'>0  W ^(%I,0) W:% ! I '%,$O(^SC(SC,"SI",%I))>0 S POP=0 D SPIN Q:POP
"RTN","SDM1",7,0)
 I $D(SDINA),SDINA>DT D IN W !,?8,@SDMSG K SDMSG
"RTN","SDM1",8,0)
 G:SDMM RDTY^SDMM
"RTN","SDM1",9,0)
 ;
"RTN","SDM1",10,0)
ADT S:'$D(SDW) SDW=""
"RTN","SDM1",11,0)
 S SDSOH=$S('$D(^SC(SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1),CCX=""
"RTN","SDM1",12,0)
 S SDONCE=$G(SDONCE)+1  ;Prevent repetitive iteration
"RTN","SDM1",13,0)
 ; Section introduced in 446.
"RTN","SDM1",14,0)
 N SDDATE1,SDQT,Y  ; Do not allow progress if there is no availability > 120 days after the desired date.
"RTN","SDM1",15,0)
 S SDDATE1=$S($G(SDDATE)="":DT,1:SDDATE)
"RTN","SDM1",16,0)
 S Y="" D  Q:Y="^"
"RTN","SDM1",17,0)
 .F  Q:Y="^"!$$WLCL120^SDM2A(SC,SDDATE1)  D
"RTN","SDM1",18,0)
 ..S Y=$$WLCLASK^SDM2A() Q:Y="^"  ; Y=0: New date, Y=1: place on EWL, Y="^": quit
"RTN","SDM1",19,0)
 ..I Y=0 D  Q
"RTN","SDM1",20,0)
 ...N SDMAX,SDDMAX
"RTN","SDM1",21,0)
 ...S SDMAX(1)=$P($G(^SC(+SC,"SDP")),U,2) S:'SDMAX(1) SDMAX(1)=365
"RTN","SDM1",22,0)
 ...S (SDMAX,SDDMAX)=$$FMADD^XLFDT(DT,SDMAX(1))
"RTN","SDM1",23,0)
 ...S Y=$$DDATE^SDM0(.SDDATE,"0^0",.SDMAX) Q:'Y  ; Y=0: "^" entered, Y=1: date entered
"RTN","SDM1",24,0)
 ...D D^SDM0
"RTN","SDM1",25,0)
 ...S SDDATE1=SDDATE
"RTN","SDM1",26,0)
 ...Q
"RTN","SDM1",27,0)
 ..D WL^SDM2A(SC)
"RTN","SDM1",28,0)
 ..S Y="^"  ; quit
"RTN","SDM1",29,0)
 ..Q
"RTN","SDM1",30,0)
 .Q
"RTN","SDM1",31,0)
 ;
"RTN","SDM1",32,0)
 S X=$S(SDONCE<2:$G(SDSDATE),1:"")  ;Use default date/time if specified as 'desired date'  
"RTN","SDM1",33,0)
 I 'X R !,"DATE/TIME: ",X:DTIME Q:X="^"!'$$WLCL120A^SDM2A(X,SDDATE1,SC)  ;sd/327,446
"RTN","SDM1",34,0)
 I X="" D WL(SC) Q  ;sd/446
"RTN","SDM1",35,0)
 G:X="M"!(X="m") MORDIS^SDM0
"RTN","SDM1",36,0)
 I X="D"!(X="d") S X=$$REDDT() G:X>0 MORD2^SDM0 S X="" W "  ??",! G ADT
"RTN","SDM1",37,0)
 I X?1"?".E D  G ADT
"RTN","SDM1",38,0)
 .W !,"Enter a date/time for the appointment - PAST dates must include the YEAR"  ;SD*547 added note about past dates
"RTN","SDM1",39,0)
 .W:$D(SD) " or a space to choose the same date/time as the patient you have just previously scheduled into this clinic"
"RTN","SDM1",40,0)
 .W ".",!,"You may also select 'M' to display the next month's availability or"
"RTN","SDM1",41,0)
 .W !,"'D' to specify an earlier or later date to begin the availability display."
"RTN","SDM1",42,0)
 I X=" ",$D(SD),SD S Y=SD D AT^SDUTL W Y S Y=SD G OVR
"RTN","SDM1",43,0)
 I $E($P(X,"@",2),1,4)?1.4"0" K %DT S X=$P(X,"@"),X=$S($L(X):X,1:"T"),%DT="XF" D ^%DT G ADT:Y'>0 S X1=Y,X2=-1 D C^%DTC S X=X_.24
"RTN","SDM1",44,0)
 K %DT S %DT="TXEF" D ^%DT
"RTN","SDM1",45,0)
 ;SD*5.3*408  verify that day hasn't been canceled via "SET UP A CLINIC"
"RTN","SDM1",46,0)
 I $G(^SC(+SC,"ST",$P(Y,"."),1))'="",^SC(+SC,"ST",$P(Y,"."),1)'["[" D  G ADT
"RTN","SDM1",47,0)
 .W !,"There is no availability for this date/time.",!
"RTN","SDM1",48,0)
 I $P(Y,".",2)=24 S X1=$P(Y,"."),X2=1 D C^%DTC S Y=X_".000001"
"RTN","SDM1",49,0)
OVR I $D(^HOLIDAY($P(Y,"."),0)),'SDSOH W *7,?50,$P(^(0),U,2),"??" K SDSDATE G ADT
"RTN","SDM1",50,0)
 I $D(SDINA),$P(Y,".")'<SDINA,$S('$D(SDRE):1,SDRE>$P(Y,".")!('SDRE):1,1:0) D IN W !,*7,@SDMSG K SDMSG K SDSDATE G ADT
"RTN","SDM1",51,0)
 I Y#1=0 K SDSDATE G 1
"RTN","SDM1",52,0)
 I $P(Y,".")'<SDEDT W !,*7,"EXCEEDS MAXIMUM DAYS FOR FUTURE APPOINTMENT!!",*7 K SDSDATE G ADT
"RTN","SDM1",53,0)
 ;
"RTN","SDM1",54,0)
EN1 S (TMPD,X,SD)=Y,SM=0 D DOW  ;SD/478
"RTN","SDM1",55,0)
 F S=$P(SD,"."):0 S S=+$O(^DPT(DFN,"S",S)) Q:$P(S,".")-($P(SD,"."))  S I=+^(S,0) G ^SDM2:$P(^(0),U,2)'["C"
"RTN","SDM1",56,0)
 ;
"RTN","SDM1",57,0)
PRECAN I $D(^DPT(DFN,"S",SD,0)),$P(^(0),U,2)["P" S %=1 W !,"THIS TIME WAS PREVIOUSLY CANCELLED BY THE PATIENT",!,"ARE YOU SURE THAT YOU WANT TO PROCEED" D YN^DICN W:'% !,"ANSWER WITH (Y)ES OR (N)O" I (%-1) K SDSDATE G ADT
"RTN","SDM1",58,0)
 W !
"RTN","SDM1",59,0)
 ;SD*5.3*490 - AVCHK/AVCHK1 to check against pat DOB and clinic avail dt
"RTN","SDM1",60,0)
S S POP=0 D AVCHK G:POP 1
"RTN","SDM1",61,0)
 S POP=0 D AVCHK1 G:POP 1
"RTN","SDM1",62,0)
 ;SD*5.3*547 if selected date is prior to the date the day of the week was added to clinic, do not set the date into availability pattern
"RTN","SDM1",63,0)
 I '$D(^SC(SC,"ST",$P(SD,"."),1)) D
"RTN","SDM1",64,0)
 .S XDT=X,POP=0
"RTN","SDM1",65,0)
 .D DOWCHK^SDM0
"RTN","SDM1",66,0)
 .K XDT
"RTN","SDM1",67,0)
 .K:POP SDSDATE
"RTN","SDM1",68,0)
 G:POP 1
"RTN","SDM1",69,0)
 K POP
"RTN","SDM1",70,0)
 I '$D(^SC(SC,"ST",$P(SD,"."),1)) S SS=+$O(^SC(+SC,"T"_Y,SD)) G XW:SS'>0,XW:^(SS,1)="" S ^SC(+SC,"ST",$P(SD,"."),1)=$E($P($T(DAY),U,Y+2),1,2)_" "_$E(SD,6,7)_$J("",SI+SI-6)_^(1),^(0)=$P(SD,".")
"RTN","SDM1",71,0)
 ;
"RTN","SDM1",72,0)
LEN I $P(SL,U,2)]"" W !,"LENGTH OF APPOINTMENT (IN MINUTES): ",+SL,"// " R S:DTIME I S]"" G:$L(S)>3 LEN Q:U[S  S POP=0 D L G LEN:POP,S:S\5*5'=S,S:S>360,S:S<5 S SL=S_U_$P(SL,U,2,99)
"RTN","SDM1",73,0)
 ;
"RTN","SDM1",74,0)
SC S SDLOCK=$S('$D(SDLOCK):1,1:SDLOCK+1) G:SDLOCK>9 LOCK
"RTN","SDM1",75,0)
 L +^SC(SC,"ST",$P(SD,"."),1):$S($G(DILOCKTM)>0:DILOCKTM,1:5) G:'$T SC  ;SD*53.*547 new required lock functionality
"RTN","SDM1",76,0)
 S SDLOCK=0,S=^SC(SC,"ST",$P(SD,"."),1)
"RTN","SDM1",77,0)
 S I=SD#1-SB*100,ST=I#1*SI\.6+($P(I,".")*SI),SS=SL*HSI/60*SDDIF+ST+ST
"RTN","SDM1",78,0)
 G X:(I<1!'$F(S,"["))&(S'["CAN")
"RTN","SDM1",79,0)
 I SM<7 S %=$F(S,"[",SS-1) S:'%!($P(SL,"^",6)<3) %=999 I $F(S,"]",SS)'<%!(SDDIF=2&$E(S,ST+ST+1,SS-1)["[") S SM=7
"RTN","SDM1",80,0)
 ;
"RTN","SDM1",81,0)
SP I ST+ST>$L(S),$L(S)<80 S S=S_" " G SP
"RTN","SDM1",82,0)
 S SDNOT=1   ;SD*5.3*490 naked Do added below
"RTN","SDM1",83,0)
 F I=ST+ST:SDDIF:SS-SDDIF S ST=$E(S,I+1) S:ST="" ST=" " S Y=$E(STR,$F(STR,ST)-2) G C:S["CAN"!(ST="X"&($D(^SC(+SC,"ST",$P(SD,"."),"CAN")))),X:Y="" S:Y'?1NL&(SM<6) SM=6 S ST=$E(S,I+2,999) D  S:ST="" ST=" " S S=$E(S,1,I)_Y_ST
"RTN","SDM1",84,0)
 .Q:ST'=""
"RTN","SDM1",85,0)
 .Q:+SL'>+^SC(SC,"SL")
"RTN","SDM1",86,0)
 .S ST="   "
"RTN","SDM1",87,0)
 .Q
"RTN","SDM1",88,0)
 Q:SDMM  G OK^SDM1A:SM#9=0,^SDM3:$P(SL,U,7)]""&('$D(MXOK))
"RTN","SDM1",89,0)
 ;
"RTN","SDM1",90,0)
E G:'$D(^XUSEC("SDOB",DUZ)) NOOB
"RTN","SDM1",91,0)
 S %=2 W *7,!,$E($T(@SM),5,99),"...OK" D YN^DICN
"RTN","SDM1",92,0)
 I '% W !,"RESPOND YES OR NO" G E
"RTN","SDM1",93,0)
 S SM=9 G SC:'(%-1) K SDSDATE G 1
"RTN","SDM1",94,0)
 ;
"RTN","SDM1",95,0)
LOCK Q:SDMM  W !,*7,"ANOTHER USER HAS LOCKED THIS DATE - TRY AGAIN LATER" Q
"RTN","SDM1",96,0)
 ;
"RTN","SDM1",97,0)
6 ;;OVERBOOK!
"RTN","SDM1",98,0)
7 ;;THAT TIME IS NOT WITHIN SCHEDULED PERIOD!
"RTN","SDM1",99,0)
C S POP=1 W !,*7,"CAN'T BOOK WITHIN A CANCELLED TIME PERIOD!",!
"RTN","SDM1",100,0)
 Q:SDMM  K SDSDATE G 1
"RTN","SDM1",101,0)
 ;
"RTN","SDM1",102,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDM1",103,0)
 ;
"RTN","SDM1",104,0)
DOW S %=$E(X,1,3),Y=$E(X,4,5),Y=Y>2&'(%#4)+$E("144025036146",Y)
"RTN","SDM1",105,0)
 F %=%:-1:281 S Y=%#4=1+1+Y
"RTN","SDM1",106,0)
 S Y=$E(X,6,7)+Y#7 Q
"RTN","SDM1",107,0)
 ;
"RTN","SDM1",108,0)
X I SDMM S POP=1 Q
"RTN","SDM1",109,0)
 G:I<1 XW
"RTN","SDM1",110,0)
 S:Y'?1NL&(SM<6) SM=6
"RTN","SDM1",111,0)
 G OK^SDM1A:SM#9=0,^SDM3:$P(SL,U,7)]""&('$D(MXOK))
"RTN","SDM1",112,0)
XW W *7,"  WHEN??" K SDSDATE G 1
"RTN","SDM1",113,0)
 ;
"RTN","SDM1",114,0)
AVCHK ;added SD*5.3*490
"RTN","SDM1",115,0)
 I '$D(VADM) Q:'DFN  S VADM(3)=$P(^DPT(DFN,0),U,3)
"RTN","SDM1",116,0)
 Q:$P(X,".",1)=$P(VADM(3),U,1)
"RTN","SDM1",117,0)
 I $P(X,".",1)<$P(VADM(3),U,1) W *7,!!,"That date is prior to the patient's date of birth.",!! S POP=1 K SDSDATE Q
"RTN","SDM1",118,0)
 Q
"RTN","SDM1",119,0)
 ;
"RTN","SDM1",120,0)
AVCHK1 ;added SD*5.3*490
"RTN","SDM1",121,0)
 S AVDT=0,AVDT=$O(^SC(+SC,"T",AVDT)) Q:'AVDT
"RTN","SDM1",122,0)
 I $P(X,".",1)<AVDT W *7,!!,"That date is prior to the clinic's availability date.",!! S POP=1 K SDSDATE,AVDT Q
"RTN","SDM1",123,0)
 Q
"RTN","SDM1",124,0)
 ;
"RTN","SDM1",125,0)
NOOB W !,"NO OPEN SLOTS THEN",*7 K SDSDATE G 1
"RTN","SDM1",126,0)
 ;
"RTN","SDM1",127,0)
WRT W !,+SL," MINUTE APPOINTMENTS "
"RTN","SDM1",128,0)
 W $S($P(SL,U,2)["V":"(VARIABLE LENGTH)",1:"") Q
"RTN","SDM1",129,0)
 ;
"RTN","SDM1",130,0)
L S SDSL=$S($P(SL,"^",6)]"":60/$P(SL,"^",6),1:"") Q:'SDSL
"RTN","SDM1",131,0)
 I S\(SDSL)*(SDSL)'=S W *7,!,"Appt. length must = or be a multiple of the increment minutes per hour (",SDSL,")",! S POP=1
"RTN","SDM1",132,0)
 Q
"RTN","SDM1",133,0)
 ;
"RTN","SDM1",134,0)
IN S SDHY=$S($D(Y):Y,1:""),Y=SDINA D DTS^SDUTL S Y1=Y,Y=SDRE
"RTN","SDM1",135,0)
 D:Y DTS^SDUTL
"RTN","SDM1",136,0)
 S SDMSG="""*** Note: Clinic is scheduled to be inactivated on "","_""""_Y1_""""_$S(SDRE:",!,?10,"_""" and reactivated on "","_""""_Y_"""",1:""),Y=SDHY K Y1,SDHY
"RTN","SDM1",137,0)
 Q
"RTN","SDM1",138,0)
 ;
"RTN","SDM1",139,0)
SPIN W !,"There are more special instructions. Do you want to display them"
"RTN","SDM1",140,0)
 S %=2 D YN^DICN
"RTN","SDM1",141,0)
 I '% W !,"Enter Y to see the remaining special instructions, or N if you don't wish to see them" G SPIN
"RTN","SDM1",142,0)
 I (%-1) S POP=1 Q
"RTN","SDM1",143,0)
 W !,^SC(SC,"SI",%I,0),! Q
"RTN","SDM1",144,0)
 ;
"RTN","SDM1",145,0)
REDDT() ;Prompt for availability redisplay date
"RTN","SDM1",146,0)
 N %DT,X,Y
"RTN","SDM1",147,0)
 S %DT="AEX"
"RTN","SDM1",148,0)
 S %DT("A")="DATE TO BEGIN THE RE-DISPLAY OF CLINIC AVAILABILITY: "
"RTN","SDM1",149,0)
 W ! D ^%DT
"RTN","SDM1",150,0)
 Q Y
"RTN","SDM1",151,0)
WL(SC) ;Wait List Hook/teh patch 263 ;SD/327 passed 'SC'
"RTN","SDM1",152,0)
 Q:$G(SC)'>0
"RTN","SDM1",153,0)
 I '$D(^SC(SC)) Q
"RTN","SDM1",154,0)
 I $D(SC) S SDWLFLG=0 D
"RTN","SDM1",155,0)
 .I $D(^SDWL(409.32,"B",+SC)) S SDWLFLG=1
"RTN","SDM1",156,0)
 .I 'SDWLFLG S SDWLDSS=$P($G(^SC(+SC,0)),U,7) I $D(^SDWL(409.31,"B",SDWLDSS)) S SDWLFLG=2 D
"RTN","SDM1",157,0)
 ..I SDWLFLG=1 S SDWLSC=$O(^SDWL(409.32,"B",+SC,0)) I $P(^SDWL(409.32,SDWLSC,0),U,4) S SDWLFLG=0
"RTN","SDM1",158,0)
 .I SDWLFLG=2 S SDWLDS=$O(^SDWL(409.31,"E",DUZ(2),0)) I $D(^SDWL(409.31,SDWLDSS,"I",+SDWLDS,0)),$P(^(0),U,4) S SDWLFLG=0
"RTN","SDM1",159,0)
 .I SDWLFLG D
"RTN","SDM1",160,0)
 ..K SDWLSC,SDWLDSS,SDWLDS,SDWLFLG
"RTN","SDM1",161,0)
 ..S SDWLOPT=1,SDWLERR=0 D OPT^SDWLE D EN^SDWLKIL
"RTN","SDM1",162,0)
 Q
"RTN","SDM1A")
0^27^B59959589
"RTN","SDM1A",1,0)
SDM1A ;SF/GFT,ALB/TMP - MAKE APPOINTMENT ; 8/18/05 12:57pm  ; 6/22/09 6:16pm
"RTN","SDM1A",2,0)
 ;;5.3;Scheduling;**26,94,155,206,168,223,241,263,327,478,446,544**;Aug 13, 1993;Build 3
"RTN","SDM1A",3,0)
OK I $D(SDMLT) D ^SDM4 Q:X="^"!(SDMADE=2)
"RTN","SDM1A",4,0)
 S ^SC(SC,"ST",$P(SD,"."),1)=S,^DPT(DFN,"S",SD,0)=SC,^SC(SC,"S",SD,0)=SD S:'$D(^DPT(DFN,"S",0)) ^(0)="^2.98P^^" S:'$D(^SC(SC,"S",0)) ^(0)="^44.001DA^^" L
"RTN","SDM1A",5,0)
S1 L +^SC(SC,"S",SD,1):$G(DILOCKTM,5) W:'$T "Another user is editing this record.  Trying again.",! G:'$T S1 F SDY=1:1 I '$D(^SC(SC,"S",SD,1,SDY)) S:'$D(^(0)) ^(0)="^44.003PA^^" S ^(SDY,0)=DFN_U_(+SL)_"^^^^"_$G(DUZ)_U_DT L -^SC(SC,"S",SD,1) Q
"RTN","SDM1A",6,0)
 I SM S ^("OB")="O" ;NAKED REFERENCE - ^SC(IFN,"S",Date,1,SDY,"OB")
"RTN","SDM1A",7,0)
 I $D(^SC(SC,"RAD")),^("RAD")="Y"!(^("RAD")=1) S ^SC("ARAD",SC,SD,DFN)=""
"RTN","SDM1A",8,0)
 S SDINP=$$INP^SDAM2(DFN,SD)
"RTN","SDM1A",9,0)
 ;-- added sub-category
"RTN","SDM1A",10,0)
 S COV=3,SDYC="",COV=$S(COLLAT=1:1,1:3),SDYC=$S(COLLAT=7:1,1:"")
"RTN","SDM1A",11,0)
 S:SD<DT SDSRTY="W"
"RTN","SDM1A",12,0)
 S ^DPT(DFN,"S",SD,0)=SC_"^"_$$STATUS(SC,SDINP,SD)_"^^^^^"_COV_"^^^^"_SDYC_"^^^^^"_SDAPTYP_U_$G(SD17)_"^"_$G(DUZ)_U_DT_"^^^^^"_$G(SDXSCAT)_U_$P($G(SDSRTY),U,2)_U_$$NAVA^SDMANA(SC,SD,$P($G(SDSRTY),U,2)) ;544 added DUZ
"RTN","SDM1A",13,0)
 S ^DPT(DFN,"S",SD,1)=$G(SDDATE)_U_$G(SDSRFU)
"RTN","SDM1A",14,0)
 I $D(SDMULT) S SDCLNCND=^SC(SC,0),STPCOD=$P(SDCLNCND,U,7),TMPYCLNC=SC_U_$P(SDCLNCND,U) D A^SDCNSLT ;SD/478 MULTI CLINIC OPTION SELECTED
"RTN","SDM1A",15,0)
 ;xref DATE APPT. MADE field
"RTN","SDM1A",16,0)
 D
"RTN","SDM1A",17,0)
 .N DIV,DA,DIK
"RTN","SDM1A",18,0)
 .S DA=SD,DA(1)=DFN,DIK="^DPT(DA(1),""S"",",DIK(1)=20 D EN1^DIK
"RTN","SDM1A",19,0)
 .Q
"RTN","SDM1A",20,0)
 K:$D(^DPT(DFN,"S",SD,"R")) ^("R") K:$D(^DPT("ASDCN",SC,SD,DFN)) ^(DFN)
"RTN","SDM1A",21,0)
 S SDRT="A",SDTTM=SD,SDPL=SDY,SDSC=SC D RT^SDUTL
"RTN","SDM1A",22,0)
 W !,"   ",+SL,"-MINUTE APPOINTMENT MADE" K SDINP
"RTN","SDM1A",23,0)
 ;confirm request type & follow-up indicator
"RTN","SDM1A",24,0)
 I $D(SDSRTY(0)) D CONF(.SDSRTY,.SDSRFU,DFN,SD,SC) W !
"RTN","SDM1A",25,0)
 I $P(SD,".")'>DT,$D(^DPT(DFN,.321)) D EN1^SDM3
"RTN","SDM1A",26,0)
 ;Wait List SD*5.3*263
"RTN","SDM1A",27,0)
 ;I '$D(SDWLLIST) D ^SDWLR ;replaced with sd/372, see below
"RTN","SDM1A",28,0)
EWLCHK ;check if patient has any open EWL entries (SD/372)
"RTN","SDM1A",29,0)
 ;get appointment
"RTN","SDM1A",30,0)
 K ^TMP($J,"SDAMA301"),^TMP($J,"APPT")
"RTN","SDM1A",31,0)
 D APPT^SDWLEVAL(DFN,SD,SC)
"RTN","SDM1A",32,0)
 Q:'$D(^TMP($J,"APPT"))
"RTN","SDM1A",33,0)
 N SDEV D EN^SDWLEVAL(DFN,.SDEV) I SDEV,$L(SDEV(1))>0 D
"RTN","SDM1A",34,0)
 .K ^TMP("SDWLPL",$J),^TMP($J,"SDWLPL")
"RTN","SDM1A",35,0)
 .D INIT^SDWLPL(DFN,"M")
"RTN","SDM1A",36,0)
 .Q:'$D(^TMP($J,"SDWLPL"))
"RTN","SDM1A",37,0)
 .D LIST^SDWLPL("M",DFN)
"RTN","SDM1A",38,0)
 .F  Q:'$D(^TMP($J,"SDWLPL"))  N SDR D ANSW^SDWLEVAL(1,.SDR) I 'SDR D LIST^SDWLPL("M",DFN) D
"RTN","SDM1A",39,0)
 ..F  N SDR D ANSW^SDWLEVAL(0,.SDR) Q:'$D(^TMP($J,"SDWLPL"))  I 'SDR W !,"MUST ENTER A REASON NOT TO DISPOSITION MATCHED EWL ENTRY",!
"RTN","SDM1A",40,0)
 ;CREATE 120 FLAG IF APPLICABLE; appt created 
"RTN","SDM1A",41,0)
FLG N SDST S SDST=$G(^TMP($J,"APPT",1)) I +SDST>0 D
"RTN","SDM1A",42,0)
 .Q  ; sd/446
"RTN","SDM1A",43,0)
 .N SDT,SDDES,SDPAR,SDDES1,SDT1 S SDPAR=0 S SDT=+SDST,SDDES=$P(SDST,U,17) I SDDES="" S SDDES=DT ; today's date if no desired date
"RTN","SDM1A",44,0)
 .S X=SDT D H^%DTC S SDT1=%H
"RTN","SDM1A",45,0)
 .S X=SDDES D H^%DTC S SDDES1=%H
"RTN","SDM1A",46,0)
 .I SDT1-SDDES1>120 N SD120,SD120A S SD120=1,SD120A=1  D
"RTN","SDM1A",47,0)
 ..; CREATE ewl eN SDPR S SDPR=$S(SDDES=DT:"A",1:"F") entry with 120 flag
"RTN","SDM1A",48,0)
 ..N SDPR S SDPR=$S(SDDES=DT:"A",1:"F") ;10
"RTN","SDM1A",49,0)
 ..N SDWLIN S SDWLIN=+$P(SDST,U,15) ;2
"RTN","SDM1A",50,0)
 ..N SDWLSCPR S SDWLSCPR=0 I +$P(SDST,U,10)=11 S SDWLSCPR=1 ;15
"RTN","SDM1A",51,0)
 ..N SC,SDWLSCL S SC=+$P(SDST,U,2) D
"RTN","SDM1A",52,0)
 ...I $D(^SDWL(409.32,"B",SC)) S SDWLSCL=$O(^SDWL(409.32,"B",SC,"")) Q  ;8
"RTN","SDM1A",53,0)
 ...;create 409.32 entry
"RTN","SDM1A",54,0)
 ...N DA,DIC S DIC(0)="LX",X=SC,DIC="^SDWL(409.32," D FILE^DICN
"RTN","SDM1A",55,0)
 ...S SDWLSCL=DA
"RTN","SDM1A",56,0)
 ...S DIE="^SDWL(409.32,"
"RTN","SDM1A",57,0)
 ...S DR=".02////^S X=SDWLIN" D ^DIE
"RTN","SDM1A",58,0)
 ...S DR="1////^S X=DT"
"RTN","SDM1A",59,0)
 ...S DR=DR_";2////^S X=DUZ"
"RTN","SDM1A",60,0)
 ...D ^DIE S SDPAR=1
"RTN","SDM1A",61,0)
 ..N DA S DIC(0)="LX",(X,SDWLDFN)=+$P(SDST,U,4),X=SDWLDFN,DIC="^SDWL(409.3," D FILE^DICN
"RTN","SDM1A",62,0)
 ..F  L +^SDWL(409.3,DA):5 Q:$T  D
"RTN","SDM1A",63,0)
 ...I '$T W !,"Unable to acquire a lock on the Wait List file" Q
"RTN","SDM1A",64,0)
 ..; Update EWL variables.
"RTN","SDM1A",65,0)
 ..S SDWLDA=DA D EN^SDWLE11 ; get enrollee both SDWLDA and SDWLDFN have to be
"RTN","SDM1A",66,0)
 ..N SDWLCM S SDWLCM=" > 120 days; appt created"
"RTN","SDM1A",67,0)
 ..N SDWLSCPG S SDWLSCPG=$S($P($G(^DPT(SDWLDFN,.3)),U,1)="Y":$P(^(.3),U,2),1:"")
"RTN","SDM1A",68,0)
 ..S DR="1////^S X=DT"
"RTN","SDM1A",69,0)
 ..S DR=DR_";2////^S X=SDWLIN"
"RTN","SDM1A",70,0)
 ..S DR=DR_";4////^S X=4"
"RTN","SDM1A",71,0)
 ..S DR=DR_";8////^S X=SDWLSCL"
"RTN","SDM1A",72,0)
 ..S DR=DR_";9////^S X=DUZ"
"RTN","SDM1A",73,0)
 ..S DR=DR_";10////^S X=SDPR"
"RTN","SDM1A",74,0)
 ..S DR=DR_";11////^S X=2" ; by patient for this entry to avoid asking for provider
"RTN","SDM1A",75,0)
 ..S DR=DR_";14////^S X=SDWLSCPG"
"RTN","SDM1A",76,0)
 ..S DR=DR_";15////^S X=SDWLSCPR"
"RTN","SDM1A",77,0)
 ..S DR=DR_";22////^S X=SDDES"
"RTN","SDM1A",78,0)
 ..S DR=DR_";23////^S X=""O"""
"RTN","SDM1A",79,0)
 ..S DR=DR_";25////^S X=SDWLCM"
"RTN","SDM1A",80,0)
 ..S DR=DR_";36////^S X=SD120"
"RTN","SDM1A",81,0)
 ..S DR=DR_";39////^S X=SD120A"
"RTN","SDM1A",82,0)
 ..S DIE="^SDWL(409.3,"
"RTN","SDM1A",83,0)
 ..D ^DIE
"RTN","SDM1A",84,0)
 ..L -^SDWL(409.3,DA)
"RTN","SDM1A",85,0)
 ..D MESS^SDWL120(SDWLDFN,SC,SDT,SDPAR)
"RTN","SDM1A",86,0)
 ;continue appointment entry process
"RTN","SDM1A",87,0)
ORD S %=2 W !,"WANT PATIENT NOTIFIED OF LAB,X-RAY, OR EKG STOPS" D YN^DICN I '% W !,"  Enter YES to notify patient on appt. letter of LAB, X-RAY, or EKG stops" G ORD
"RTN","SDM1A",88,0)
 I '(%-1) D ORDY^SDM3
"RTN","SDM1A",89,0)
OTHER R !,"  OTHER INFO: ",D:DTIME I D["^" W !,*7,"'^' not allowed - hit return if no 'OTHER INFO' is to be entered" G OTHER
"RTN","SDM1A",90,0)
 S TMPD=D I $L(D)>150 D MSG^SDMM G OTHER ;SD/478
"RTN","SDM1A",91,0)
 I D]"",D?."?"!(D'?.ANP) W "  ENTER LAB, SCAN, ETC." G OTHER
"RTN","SDM1A",92,0)
 I $L($G(^SC(SC,"S",SD,1,SDY,0)))+$L(D)+$L(DT)+$S($D(DUZ):$L(DUZ),1:0)>250 D MSG^SDMM G OTHER  ; sd/446
"RTN","SDM1A",93,0)
 ;S $P(^(0),"^",4)=D,$P(^(0),U,6,7)=$S($D(DUZ):DUZ,1:"")_U_DT ;NAKED REFERENCE - ^SC(IFN,"S",Date,1,SDY,0)
"RTN","SDM1A",94,0)
 S $P(^(0),"^",4)=D ;NAKED REFERENCE - ^SC(IFN,"S",Date,1,SDY,0) 544 moved DUZ&DT to tag S1.  
"RTN","SDM1A",95,0)
 D:$D(TMP) LINK^SDCNSLT(SC,SDY,SD,CNSLTLNK) ;SD/478
"RTN","SDM1A",96,0)
 D:$D(TMP) EDITCS^SDCNSLT(SD,TMPD,TMPYCLNC,CNSLTLNK) ;SD/478
"RTN","SDM1A",97,0)
 K TMP  ;SD/478
"RTN","SDM1A",98,0)
XR I $S('$D(^SC(SC,"RAD")):1,^("RAD")="Y":0,^("RAD")=1:0,1:1) S %=2 W !,"WANT PREVIOUS X-RAY RESULTS SENT TO CLINIC" D YN^DICN G:'% HXR I '(%-1) S ^SC("ARAD",SC,SD,DFN)=""
"RTN","SDM1A",99,0)
SDMM S SDEMP=0 I COLLAT=7 S:SDEC'=SDCOL SDEMP=SDCOL G OV
"RTN","SDM1A",100,0)
 D ELIG^VADPT I $O(VAEL(1,0))>0 D ELIG^SDM4:"369"[SDAPTYP S SDEMP=$S(SDDECOD:SDDECOD,1:SDEMP)
"RTN","SDM1A",101,0)
OV Q:$D(SDZM)  K SDQ1,SDEC,SDCOL I +SDEMP S $P(^SC(SC,"S",SD,1,SDY,0),"^",10)=+SDEMP
"RTN","SDM1A",102,0)
 S SDMADE=1 D EVT Q
"RTN","SDM1A",103,0)
HXR W !,"  Enter YES to have previous XRAY results sent to the clinic" G XR
"RTN","SDM1A",104,0)
 Q
"RTN","SDM1A",105,0)
CS S SDCS=+$P(^SC(+SC,0),"^",7) I $S('$D(^DIC(40.7,SDCS,0)):1,'$P(^(0),"^",3):0,1:$P(^(0),"^",3)'>DT) W !!,*7,"** WARNING - CLINIC HAS AN INVALID OR INACTIVE STOP CODE!!!",!!
"RTN","SDM1A",106,0)
 S SDCS=+$P(^SC(+SC,0),"^",18) I $S('SDCS:0,'$D(^DIC(40.7,SDCS,0)):1,'$P(^(0),"^",3):0,1:$P(^(0),"^",3)'>DT) W !!,*7,"** WARNING - CLINIC HAS AN INVALID OR INACTIVE CREDIT STOP CODE!!!",!!
"RTN","SDM1A",107,0)
 K SDCS Q
"RTN","SDM1A",108,0)
STATUS(SDCL,SDINP,SDT) ; -- determine status for NEW appts
"RTN","SDM1A",109,0)
 Q $S(SDINP]"":SDINP,$$CHK(.SDCL,.SDT):"NT",1:"")
"RTN","SDM1A",110,0)
CHK(SDCL,SDT) ; -- should appt be NT'ed
"RTN","SDM1A",111,0)
 ; -- non-count clinic check := don't NT appt
"RTN","SDM1A",112,0)
 ; -- appt update executed   := need to NT appt
"RTN","SDM1A",113,0)
 ; -- otherwise              := don't NT appt
"RTN","SDM1A",114,0)
 Q $S($P($G(^SC(SDCL,0)),U,17)="Y":0,$D(^SDD(409.65,"AUPD",$P(SDT,"."))):1,1:0)
"RTN","SDM1A",115,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDM1A",116,0)
 D MAKE^SDAMEVT(DFN,SD,SC,SDY,0)
"RTN","SDM1A",117,0)
 Q
"RTN","SDM1A",118,0)
REQ(SDT) ; -- which is required check in(CI) or out(CO)
"RTN","SDM1A",119,0)
 Q $S($$REQDT()>SDT:"CI",1:"CO")
"RTN","SDM1A",120,0)
REQDT() ; -- co required date
"RTN","SDM1A",121,0)
 Q $S($P(^DG(43,1,"SCLR"),U,23):$P(^("SCLR"),U,23),1:2931001)
"RTN","SDM1A",122,0)
COCMP(DFN,SDT) ; -- date CO completed
"RTN","SDM1A",123,0)
 Q $P($G(^SCE(+$P($G(^DPT(DFN,"S",SDT,0)),U,20),0)),U,7)
"RTN","SDM1A",124,0)
CI(SDCL,SDT,SDDA,SDACT) ; -- ok to update DPT
"RTN","SDM1A",125,0)
 N C
"RTN","SDM1A",126,0)
 I '$$CHK(.SDCL,.SDT) G CIQ
"RTN","SDM1A",127,0)
 I $$REQ(SDT)'="CI" G CIQ
"RTN","SDM1A",128,0)
 I SDACT="SET",$D(^DPT(+^SC(SDCL,"S",SDT,1,SDDA,0),"S",SDT,0)),$P(^(0),U,2)="NT" S $P(^(0),U,2)=""
"RTN","SDM1A",129,0)
 I SDACT="KILL" S C=$G(^SC(SDCL,"S",SDT,1,SDDA,"C")) I $D(^DPT(+$G(^(0)),"S",SDT,0)),$P(^(0),U,2)="",'$P(C,U,3) S $P(^(0),U,2)="NT"
"RTN","SDM1A",130,0)
CIQ Q
"RTN","SDM1A",131,0)
CO(SDCL,SDT,SDDA,SDACT) ; -- ok to update DPT
"RTN","SDM1A",132,0)
 N DFN,C
"RTN","SDM1A",133,0)
 I '$$CHK(.SDCL,.SDT) G COQ
"RTN","SDM1A",134,0)
 I $$REQ(.SDT)'="CO" D  G COQ
"RTN","SDM1A",135,0)
 .I SDACT="SET",$D(^DPT(+^SC(SDCL,"S",SDT,1,SDDA,0),"S",SDT,0)),$P(^(0),U,2)="NT" S $P(^(0),U,2)=""
"RTN","SDM1A",136,0)
 .I SDACT="KILL" S C=$G(^SC(SDCL,"S",SDT,1,SDDA,"C")) I $D(^DPT(+$G(^(0)),"S",SDT,0)),$P(^(0),U,2)="",'C S $P(^(0),U,2)="NT"
"RTN","SDM1A",137,0)
 S DFN=+^SC(SDCL,"S",SDT,1,SDDA,0)
"RTN","SDM1A",138,0)
 D UPD(.DFN,.SDT,$$COCMP(.DFN,.SDT),$S(SDACT="SET":X,1:""))
"RTN","SDM1A",139,0)
COQ Q
"RTN","SDM1A",140,0)
UPD(DFN,SDT,SDCOCMP,SDCODT) ; -- update status
"RTN","SDM1A",141,0)
 N Y
"RTN","SDM1A",142,0)
 I $D(^DPT(DFN,"S",SDT,0)) S Y=$P(^(0),U,2) D
"RTN","SDM1A",143,0)
 .I 'SDCOCMP!('SDCODT) S:Y="" $P(^DPT(DFN,"S",SDT,0),U,2)="NT" Q
"RTN","SDM1A",144,0)
 .S:Y="NT" $P(^DPT(DFN,"S",SDT,0),U,2)=""
"RTN","SDM1A",145,0)
 Q
"RTN","SDM1A",146,0)
OE(SDOE,SDACT) ; -- called by x-ref on co completed field(#.07) in ^SCE
"RTN","SDM1A",147,0)
 N Y S Y=^SCE(SDOE,0)
"RTN","SDM1A",148,0)
 I $P(Y,U,8)'=1 G OEQ
"RTN","SDM1A",149,0)
 I $$REQ(+Y)'="CO" G OEQ
"RTN","SDM1A",150,0)
 I '$$CANT(+$P(Y,U,2),+Y,SDOE),'$$CHK(+$P(Y,U,4),+Y) G OEQ
"RTN","SDM1A",151,0)
 D UPD(+$P(Y,U,2),+Y,$S(SDACT="SET":X,1:""),$P($G(^SC(+$P(Y,U,4),"S",+Y,1,+$P(Y,U,9),"C")),U,3))
"RTN","SDM1A",152,0)
OEQ Q
"RTN","SDM1A",153,0)
CONF(SDSRTY,SDSRFU,DFN,SDT,SC) ;Confirm scheduling request type
"RTN","SDM1A",154,0)
 ;Input: SDSRTY=request type
"RTN","SDM1A",155,0)
 ;Input: SDSRFU=follow-up indicator
"RTN","SDM1A",156,0)
 ;Input: DFN=patient ien
"RTN","SDM1A",157,0)
 ;Input: SDT=appointment date/time
"RTN","SDM1A",158,0)
 ;Input: SC=clinic ifn
"RTN","SDM1A",159,0)
 N DIR,DIE,DA,DR,SDX,SDY,X,Y
"RTN","SDM1A",160,0)
 S DIR(0)="Y",DIR("B")="YES"
"RTN","SDM1A",161,0)
 S DIR("A")="THIS APPOINTMENT IS MARKED AS '"_SDSRTY(0)_"', IS THIS CORRECT"
"RTN","SDM1A",162,0)
 W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT)
"RTN","SDM1A",163,0)
 I 'Y S SDX='SDSRTY,SDX(0)=$$TXRT(.SDX) W !!,"THIS APPOINTMENT HAS NOW BEEN MARKED AS '"_$S('SDSRTY:"",1:"NOT ")_"NEXT AVAILABLE'."
"RTN","SDM1A",164,0)
 ;S DIR("A")="THIS APPOINTMENT IS DEFINED AS '"_$S(SDSRFU:"FOLLOW-UP",1:"OTHER THAN FOLLOW-UP")_"', OK"
"RTN","SDM1A",165,0)
 ;W ! D ^DIR Q:$D(DTOUT)!$D(DUOUT)
"RTN","SDM1A",166,0)
 ;I 'Y S SDY='SDSRFU W "  (changed)"
"RTN","SDM1A",167,0)
 Q:'$D(SDX)  S DR=""
"RTN","SDM1A",168,0)
 I $D(SDX) S DR="25///^S X=$P(SDX,U,2);26///^S X=$$NAVA^SDMANA(SC,SDT,$P(SDX,U,2))"
"RTN","SDM1A",169,0)
 ;I $D(SDY) S:$L(DR) DR=DR_";" S DR=DR_"26///^S X=SDY"
"RTN","SDM1A",170,0)
 S DA=SDT,DA(1)=DFN
"RTN","SDM1A",171,0)
 S DIE="^DPT(DA(1),""S""," D ^DIE
"RTN","SDM1A",172,0)
 Q
"RTN","SDM1A",173,0)
TXRT(SDSRTY)    ;Transform request type
"RTN","SDM1A",174,0)
 ;Input: SDSRTY=variable to return request type (pass by reference)
"RTN","SDM1A",175,0)
 ;Output: external text for SDSRTY(0)
"RTN","SDM1A",176,0)
 I SDSRTY S SDSRTY=SDSRTY_U_"N" Q "NEXT AVAILABLE"
"RTN","SDM1A",177,0)
 S SDSRTY=SDSRTY_U_"O" Q "NOT NEXT AVAILABLE"
"RTN","SDM1A",178,0)
CANT(DFN,SDT,SDOE) ;Determine if clinic appt. has been marked "NT"
"RTN","SDM1A",179,0)
 ;Output: '1' if appt. points to encounter and is marked "NT", otherwise '0'
"RTN","SDM1A",180,0)
 N SDAPP S SDAPP=$G(^DPT(DFN,"S",SDT,0))
"RTN","SDM1A",181,0)
 Q:$P(SDAPP,U,20)'=SDOE 0
"RTN","SDM1A",182,0)
 Q $P(SDAPP,U,2)="NT"
"RTN","SDM1A",183,0)
 ; -- Variable doc for above tags
"RTN","SDM1A",184,0)
 ;     SDCL := file 44 ien
"RTN","SDM1A",185,0)
 ;      SDT := appt date/time
"RTN","SDM1A",186,0)
 ;      DFN := file 2 ien
"RTN","SDM1A",187,0)
 ;     SDDA := ^SC(SDCL,"S",SDT,1,SDDA,0)
"RTN","SDM1A",188,0)
 ;    SDACT := current x-ref action 'set' or 'kill' 
"RTN","SDM1A",189,0)
 ;  SDCOCMP := check out completed date
"RTN","SDM1A",190,0)
 ;   SDCODT := check out date/time
"RTN","SDM1A",191,0)
 ;     SDOE := Outpatient Encounter ien
"RTN","SDM1A",192,0)
 ;    SDINP := inpatient status ('I' or null)    
"RTN","SDM1A",193,0)
 ;    SDINP := inpatient status ('I' or null)    
"RTN","SDM2")
0^28^B24545266
"RTN","SDM2",1,0)
SDM2 ;SF/GFT - MAKE APPOINTMENT ; 07 Jan 2000  6:30 PM
"RTN","SDM2",2,0)
 ;;5.3;Scheduling;**32,132,168,356,434,467,478**;Aug 13, 1993;Build 3
"RTN","SDM2",3,0)
 ;
"RTN","SDM2",4,0)
 ;SD/467 - call EWL to open its entry if matching appointment is canceled
"RTN","SDM2",5,0)
 W *7,!,"PATIENT ALREADY HAS APPOINTMENT "
"RTN","SDM2",6,0)
 N SDATA,SDCMHDL ; for evt dvr
"RTN","SDM2",7,0)
 I $D(^DPT(DFN,"S",SD,0)),$P(^(0),"^",2)'["C" S S=SD,I=+^(0) D FLEN W "(",APL," MINUTES) THEN" D IN,PROT G:$D(SDPROT) ^SDM1 R ".",!,"  DO YOU WANT TO CANCEL IT? ",X:DTIME S X=$$UP^XLFSTR(X) D:X?1"Y".A STAT G CAN:X?1"Y".A W "??",*7 G ^SDM1
"RTN","SDM2",8,0)
SDAY S %=1 W "ON THE SAME DAY (" D AT,IN W ") ...OK" D YN^DICN I '% W !,"RESPOND YES OR NO",!,"PATIENT ALREADY HAS APPOINTMENT " G SDAY
"RTN","SDM2",9,0)
 G ^SDM1:(%-1),PRECAN^SDM1
"RTN","SDM2",10,0)
 ;
"RTN","SDM2",11,0)
CAN Q:'$D(^SC(I,"SL"))  S SCI=I,DIV=$S($P(^SC(I,0),"^",15)]"":" "_$P(^(0),"^",15),1:" 1") I $D(^DPT("ASDPSD","C",DIV,I,S,DFN)) K ^(DFN)
"RTN","SDM2",12,0)
 S SD17=$P(^DPT(DFN,"S",S,0),"^") K ^SC("ARAD",I,S,DFN) S (DA,SDSY)=0 F SDSX=0:0 S SDSX=$O(^SC(I,"S",S,1,SDSX)) Q:'SDSX  Q:'$D(^(SDSX,0))  D C Q:SDSY&(DA)
"RTN","SDM2",13,0)
 I $D(^DPT("ASDPSD","B",DIV,$P(S,"."),DFN)) D CK1
"RTN","SDM2",14,0)
 G OUT:'SDSY S SL1=$P(^SC(I,"S",S,1,SDSY,0),U,2) I DA,'$D(^("OB")) K ^SC(I,"S",S,1,DA,"OB")
"RTN","SDM2",15,0)
 S SDRT="D",SDTTM=SD,SDPL=SDSY,SDSC=I D RT^SDUTL
"RTN","SDM2",16,0)
 I I'=SC D
"RTN","SDM2",17,0)
 .W !
"RTN","SDM2",18,0)
 .I $$BADADR^DGUTL3(DFN)>0 D  Q
"RTN","SDM2",19,0)
 ..W !!,"**BAD ADDRESS INDICATOR FOR THIS PATIENT. NO LETTER WILL BE PRINTED.**",!!
"RTN","SDM2",20,0)
 .S DIR("A")="DO YOU WISH TO PRINT LETTERS FOR THE CANCELLED APPOINTMENT"
"RTN","SDM2",21,0)
 .S DIR("A",1)="THIS IS THE ONLY OPPORTUNITY.",DIR("B")="YES"
"RTN","SDM2",22,0)
 .S DIR(0)="Y" D ^DIR W ! K DIR
"RTN","SDM2",23,0)
 .Q:(Y'=1)
"RTN","SDM2",24,0)
 .N SDWH,A,SC,SDCL S SDWH="P",A=+DFN,SDCL(1)=I_"^"_S N DFN
"RTN","SDM2",25,0)
 .S %ZIS("A")="Device for cancellation letter: ",%ZIS("B")=""
"RTN","SDM2",26,0)
 .N I,S,SDHX,SDP
"RTN","SDM2",27,0)
 .D ^%ZIS Q:POP  U IO
"RTN","SDM2",28,0)
 .D SDLET^SDCNP1A
"RTN","SDM2",29,0)
 .D ^%ZISC
"RTN","SDM2",30,0)
 N SCSNOD,SCLNK,SCSRV,SCGMR,SCSTPCOD
"RTN","SDM2",31,0)
 S SCSNOD=^SC(I,"S",S,1,SDSY,0),SCLNK=$P($G(^SC(I,"S",S,1,SDSY,"CONS")),U),SDADM="" S:'$D(STPCOD) STPCOD=$P($G(^SC(I,0)),U,7) K TMPD ;SD/478
"RTN","SDM2",32,0)
 I SCLNK'="" K ^SC("AWAS1",SCLNK) S SCSRV=$P($G(^GMR(123,SCLNK,0)),U,5),SCGMR=0 F  S SCGMR=$O(^GMR(123.5,SCSRV,688,SCGMR)) Q:'+SCGMR  S SCSTPCOD=$P(^GMR(123.5,SCSRV,688,SCGMR,0),U) I STPCOD=SCSTPCOD D
"RTN","SDM2",33,0)
 .S TMP=1 S:'$D(CNSLTLNK) CNSLTLNK=SCLNK Q  ;SD/478
"RTN","SDM2",34,0)
 K ^SC(I,"S",S,1,SDSY)
"RTN","SDM2",35,0)
 I '$D(^SC(I,"ST",$P(SD,"."),1)) G OUT
"RTN","SDM2",36,0)
 S SD1(1)=^SC(I,"SL"),SD1=$P(SD1(1),"^",3),SB1=$S(SD1:SD1,1:8)-1/100,SD1=$P(SD1(1),"^",6),HSI1=$S(SD1:SD1,1:4),SI1=$S(SD1="":4,SD1<3:4,SD1:SD1,1:4),SDDIF1=$S(HSI1<3:8/HSI1,1:2) K SD1
"RTN","SDM2",37,0)
 S S=^SC(I,"ST",$P(SD,"."),1),SDQ=SD#1-SB1*100,ST=SDQ#1*SI1\.6+($P(SDQ,".")*SI1),SS=SL1*HSI1/60
"RTN","SDM2",38,0)
 I SDQ'<1 F I=ST+ST:SDDIF1 S SDQ=$E(STR,$F(STR,$E(S,I+1))) Q:SDQ=""  S S=$E(S,1,I)_SDQ_$E(S,I+2,999),SS=SS-1 Q:SS'>0
"RTN","SDM2",39,0)
 S ^(1)=S K SL1,SB1,SDDIF1,HSI1,SI1,SDQ ;NAKED REFERENCE - ^SC(IFN,"ST",Date,1)
"RTN","SDM2",40,0)
OUT D EVT Q:$D(SDNSF)  D CANCEL^SDCNSLT W *7,!,"APPOINTMENT IN ",$P(^SC(SCI,0),"^",1)," CANCELLED!" S X=SD D DOW^SDM1 W !,"APPOINTMENT NOW BEING MADE IN ",$P(^SC(SC,0),"^",1) K SCI G S^SDM1  ;SD/478
"RTN","SDM2",41,0)
 ;
"RTN","SDM2",42,0)
C I +^SC(I,"S",S,1,SDSX,0)=DFN,$P(^(0),"^",9)'["C" S SDSY=SDSX Q
"RTN","SDM2",43,0)
 Q:'$D(^("OB"))!DA  S:^("OB")?1"O".E DA=SDSX Q  ;NAKED REFERENCE - ^SC(IFN,"S",Date,1,SDSX,"OB")
"RTN","SDM2",44,0)
 ;
"RTN","SDM2",45,0)
AT W "AT ",$E(S_0,9,10),":",$E(S_"000",11,12) Q
"RTN","SDM2",46,0)
IN W:SC-I&$D(^SC(I,0)) " IN ",$P(^(0),U,1) Q
"RTN","SDM2",47,0)
PROT K SDPROT
"RTN","SDM2",48,0)
 I $D(^SC(I,"SDPROT")),$P(^("SDPROT"),U)="Y",'$D(^SC(I,"SDPRIV",DUZ)) D  Q
"RTN","SDM2",49,0)
 .W !!,*7,">>> Access to ",$$CNAM(I)," is prohibited!"
"RTN","SDM2",50,0)
 .W !,"    Only users with a special code may access this clinic.",!
"RTN","SDM2",51,0)
 .S SDPROT=""
"RTN","SDM2",52,0)
 ;
"RTN","SDM2",53,0)
 I $$CODT^SDCOU(DFN,SD,I) D  Q
"RTN","SDM2",54,0)
 .W !?5,*7,">>> A check out date has been entered for this appointment!"
"RTN","SDM2",55,0)
 .W !?5,"    Please enter another date and time.   Thank you.",!
"RTN","SDM2",56,0)
 .S SDPROT=""
"RTN","SDM2",57,0)
 Q
"RTN","SDM2",58,0)
 ;
"RTN","SDM2",59,0)
CNAM(SDCL) ;Return clinic name
"RTN","SDM2",60,0)
 ;Input: SDCL=clinic ien
"RTN","SDM2",61,0)
 N SDX
"RTN","SDM2",62,0)
 S SDX=$P($G(^SC(+SDCL,0)),U)
"RTN","SDM2",63,0)
 Q $S($L(SDX):SDX,1:"this clinic")
"RTN","SDM2",64,0)
 ;
"RTN","SDM2",65,0)
FLEN S APL="" I $D(^SC(I,"S",SD)) F ZL=0:0 S ZL=$O(^SC(I,"S",SD,1,ZL)) Q:ZL=""  I +^(ZL,0)=DFN S APL=$P(^SC(I,"S",SD,1,ZL,0),"^",2)
"RTN","SDM2",66,0)
 Q
"RTN","SDM2",67,0)
 ;
"RTN","SDM2",68,0)
DISP G ^SDM1 ; LINE TAG IS NO LONGER USED
"RTN","SDM2",69,0)
 ;W !?4 K S F SDQ=Y:0 S SDQ=$N(^SC(SC,"S",SDQ)) Q:Y+1<SDQ!(SDQ<0)  F I=0:0 S I=$N(^SC(SC,"S",SDQ,1,I)) Q:I'>0  Q:'$D(^(I,0))  S ST=$S($P(^(0),U,4)="":"BLANK",1:"'"_$E($P(^(0),U,4),1,28)_"'"),S(ST)=$S($D(S(ST)):S(ST)+1,1:1)
"RTN","SDM2",70,0)
 ;I '$D(S) W "NO APPNT'S SCHEDULED YET" G ^SDM1
"RTN","SDM2",71,0)
 ;W "'OTHER' TYPES ALREADY SCHEDULED:   ",!
"RTN","SDM2",72,0)
 ;S S=0 F I=0:1 S S=$N(S(S)) G ^SDM1:S=-1 W:$X+$L(S)>72 ! W S,": ",S(S),"     "
"RTN","SDM2",73,0)
CK1 S SDZ=0 F SD1=$P(S,"."):0 S SD1=$O(^DPT(DFN,"S",SD1)) Q:'SD1!((SD1\1)'=(S\1))  I $P(^(SD1,0),"^",2)'["C",$P(^(0),"^",2)'["N" S SDZ=1 Q
"RTN","SDM2",74,0)
 Q:SDZ  F SD1=2,4 I $D(^SC("AAS",SD1,$P(S,"."),DFN)) S SDZ=1 Q
"RTN","SDM2",75,0)
 Q:SDZ  IF $D(^SCE(+$$EXAE^SDOE(DFN,S\1,S\1),0)) S SDX=1
"RTN","SDM2",76,0)
 Q:SDZ  K ^DPT("ASDPSD","B",DIV,$P(S,"."),DFN) Q
"RTN","SDM2",77,0)
STAT N X S SDCMHDL=$$HANDLE^SDAMEVT(1) D BEFORE^SDAMEVT(.SDATA,DFN,SD,I,"",SDCMHDL),NOW^%DTC
"RTN","SDM2",78,0)
 S $P(^DPT(DFN,"S",SD,0),"^",2)="C",$P(^(0),"^",14)=$E(%,1,12) S:$D(DUZ) $P(^(0),"^",12)=DUZ S ^DPT("ASDCN",+^(0),SD,DFN)=""
"RTN","SDM2",79,0)
 K ^TMP("SDWLREB",$J),^TMP($J,"SDWLPL") N SC S SC=+^DPT(DFN,"S",SD,0) D OPENEWL^SDWLREB(DFN,SD,SC,0) K ^TMP($J,"SDWLP")
"RTN","SDM2",80,0)
 I $D(^TMP("SDWLREB",$J)) D MESS^SDWLREB ; SD/467
"RTN","SDM2",81,0)
 Q
"RTN","SDM2",82,0)
 ;
"RTN","SDM2",83,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDM2",84,0)
 ; -- cancel event
"RTN","SDM2",85,0)
 D CANCEL^SDAMEVT(.SDATA,DFN,SDTTM,SDSC,SDPL,0,SDCMHDL)
"RTN","SDM2",86,0)
 Q
"RTN","SDM3")
0^29^B13081176
"RTN","SDM3",1,0)
SDM3 ;SF/GFT - MAKE APPOINTMENT ; 14 SEP 84  11:33 am
"RTN","SDM3",2,0)
 ;;5.3;Scheduling;**32**;Aug 13, 1993;Build 3
"RTN","SDM3",3,0)
 S I=$P(SD,".",1),(S,ST)=$P(SL,U,7) I ST F D=I-.01:0 S D=$N(^SC(SC,"S",D)) Q:$P(D,".",1)-I  F %=0:0 S %=$N(^SC(SC,"S",D,1,%)) Q:%'>0  I $P(^(%,0),"^",9)'["C",$D(^("OB")) S ST=ST-1
"RTN","SDM3",4,0)
 I ST<1,'$D(^XUSEC("SDMOB",DUZ)) W !,*7,"ONLY "_S_" OVERBOOK"_$E("S",S>1)_" ALLOWED PER DAY!!",! G ^SDM1
"RTN","SDM3",5,0)
 I ST<1 R !,"WILL EXCEED MAXIMUM ALLOWABLE OVERBOOKS, OK? YES// ",MXO:DTIME S:MXO="" MXO="Y" S MXO=$$UP^XLFSTR(MXO) G:MXO'["Y" ^SDM1 S S=^SC(SC,"ST",I,1),SM=9,MXOK="" G SC^SDM1
"RTN","SDM3",6,0)
 S S=^SC(SC,"ST",I,1) G E^SDM1
"RTN","SDM3",7,0)
ORDY S Y=SD D DTS^SDUTL S SODT=Y,(LAB,XRAY,EKG)="",SDWR=0
"RTN","SDM3",8,0)
ORD R !,"ENTER TYPE AND TIME (I.E. 'LAB@8:30'): ",ORD:DTIME G:ORD=""!(ORD="^") END
"RTN","SDM3",9,0)
 S ORD=$$UP^XLFSTR(ORD)
"RTN","SDM3",10,0)
 I ORD'["LAB"&(ORD'["XRAY")&(ORD'["X-RAY")&(ORD'["EKG") W !,"ENTER EITHER 'LAB', 'XRAY', OR 'EKG' FOLLOWED BY THE '@' AND THE TIME" G ORD
"RTN","SDM3",11,0)
 I '$F(ORD,"@") W !,"MUST ENTER THE '@' AFTER THE TYPE AND BEFORE THE TIME",*7 G ORD
"RTN","SDM3",12,0)
 S SDDT=SODT_"@"_$P(ORD,"@",2),X=SDDT,%DT="XT" D ^%DT G:Y<0 ERR
"RTN","SDM3",13,0)
 I $D(^DPT(DFN,"S",Y,0)),"I"[$P(^(0),U,2) S HSC=+^(0) W !,*7,"PATIENT ALREADY HAS APPOINTMENT AT THAT TIME IN ",$P(^SC(HSC,0),"^",1) G ORD
"RTN","SDM3",14,0)
 S:ORD["LAB" LAB=Y S:ORD["EKG" EKG=Y S:ORD["XRAY"!(ORD["X-RAY") XRAY=Y S SDWR=1 W "  SCHEDULED" G ORD
"RTN","SDM3",15,0)
ERR W !,"ENTER EITHER 'LAB', 'XRAY', OR 'EKG' FOLLOWED BY AN '@' AND THE TIME" G ORD
"RTN","SDM3",16,0)
END I 'SDWR K SDWR,LAB,ORD,SDDT,SODT,XRAY,EKG D CLEAN Q
"RTN","SDM3",17,0)
 F SDTY="LAB","XRAY","EKG" I @SDTY="" K @SDTY
"RTN","SDM3",18,0)
 S SDIE=$S($D(LAB):LAB,$P(^DPT(DFN,"S",SD,0),U,3)]"":$P(^(0),U,3),1:"")_"^"_$S($D(XRAY):XRAY,$P(^DPT(DFN,"S",SD,0),U,4)]"":$P(^(0),U,4),1:"")_"^"_$S($D(EKG):EKG,$P(^DPT(DFN,"S",SD,0),U,5)]"":$P(^(0),U,5),1:""),$P(^DPT(DFN,"S",SD,0),"^",3,5)=SDIE
"RTN","SDM3",19,0)
 K SDIE,SDWR,LAB,ORD,SDDT,SODT,XRAY,EKG,SDDISP
"RTN","SDM3",20,0)
CLEAN K A,CKDATE,CNT,COV,DISBEG,ENDATE,FND,GOT,HNDATE,HSI,HSTM,HY,I,INC,INCM,J,K,LEN,MIN,NDATE,NS,NSTM,REM,SB,SD1,SDATE,SDCT,SDDIF,SDDOT,SDDT,SDHX,SDJ,SDLN,SDMAX,SDSOH,SI,SL,SM,SS,SSC,ST,SDSTRTDT,STARTDAY,STIME,STM,STR
"RTN","SDM3",21,0)
 K WY,XX,Z Q
"RTN","SDM3",22,0)
EN1 S SDDISP="" I $D(^DPT(DFN,.321)) F SDI=1:1:3 I $P(^DPT(DFN,.321),"^",SDI)["Y" S SDDISP=1 Q
"RTN","SDM3",23,0)
 S DIV=1 I $S($D(^DIC(4,+$$SITE^VASITE,"DIV")):1,1:0),^("DIV")="Y",$P(^SC(SC,0),"^",15)]"" S DIV=$P(^(0),"^",15)
"RTN","SDM3",24,0)
 ;I SDDISP W:'$D(SDAUTO) !,*7,"This appointment needs special survey dispositioning" S:'$D(^DPT("ASDPSD","B"," "_DIV,$P(SD,"."),DFN)) ^(DFN)=0 S:'$D(^DPT("ASDPSD","C"," "_DIV,SC,SD,DFN)) ^(DFN)=$S($P(SD,".")-DT:"",1:"E")
"RTN","SDM3",25,0)
 I SDDISP S:'$D(^DPT("ASDPSD","B"," "_DIV,$P(SD,"."),DFN)) ^(DFN)=0 S:'$D(^DPT("ASDPSD","C"," "_DIV,SC,SD,DFN)) ^(DFN)=$S($P(SD,".")-DT:"",1:"E")
"RTN","SDM3",26,0)
 K SDI,SDDISP,SDAUTO Q
"RTN","SDM3",27,0)
EN1K Q:$S('$D(^DPT(X,.321)):1,^(.321)'["Y":1,1:0)
"RTN","SDM3",28,0)
 S SDIV=1 I $S($D(^DIC(4,+$$SITE^VASITE,"DIV")):1,1:0),^("DIV")="Y",$P(^SC(DA(2),0),"^",15)]"" S SDIV=$P(^(0),"^",15)
"RTN","SDM3",29,0)
 S SDDISP="" F I=1:1:3 I $P(^DPT(X,.321),"^",I)["Y" S SDDISP=1 Q
"RTN","SDM3",30,0)
 Q:'SDDISP  S DFN=X,S=DA(1) S:$D(DIV) DIV1=DIV S DIV=SDIV K ^DPT("ASDPSD","C"," "_DIV,DA(2),DA(1),X) D CK1^SDM2 S:$D(DIV1) DIV=DIV1 Q
"RTN","SDMM")
0^30^B45359086
"RTN","SDMM",1,0)
SDMM ;SF/GFT,MAN/GRR - MULTIPLE APPOINTMENTS ; 2/7/05 12:51pm  ; Compiled September 25, 2006 13:33:14
"RTN","SDMM",2,0)
 ;;5.3;Scheduling;**26,32,167,241,327,446**;Aug 13, 1993;Build 3
"RTN","SDMM",3,0)
 N SDHX,SDAPDT S SDMM=1 D ^SDM K SDMM Q
"RTN","SDMM",4,0)
RDTY K ^TMP($J,"APPT"),^TMP($J,"SDAMA301") ;SD/327
"RTN","SDMM",5,0)
 R !,"WANT TO MAKE DAILY OR WEEKLY APPOINTMENTS?: WEEKLY// ",SDTYP:DTIME Q:SDTYP["^"!('$T)  S:SDTYP="" SDTYP="W" S SDTYP=$$UP^XLFSTR($E(SDTYP)) I "WD"'[SDTYP W !,"ENTER 'D' FOR DAILY OR PRESS RETURN" G RDTY
"RTN","SDMM",6,0)
RD22 I SDTYP["D" S %=2 W !,"WANT APPOINTMENTS MADE ON SATURDAYS AND SUNDAYS" D YN^DICN S SDWE=$S(%<0:"^",%=2:"N",%=1:"Y",1:"?") Q:SDWE["^"  G:SDWE["?" HLP22
"RTN","SDMM",7,0)
ADT K SDERRFT S CCX=""
"RTN","SDMM",8,0)
 S X=$G(SDSDATE) S:X SDHX=X\1 K SDSDATE
"RTN","SDMM",9,0)
 W:X#1 !,"APPOINTMENT DATE/TIME REQUESTED: "
"RTN","SDMM",10,0)
 I '(X#1) R !,"DATE/TIME: ",X:DTIME I "^"[X K X,SD Q
"RTN","SDMM",11,0)
 I X="M"!(X="m") D MORDIS G ADT
"RTN","SDMM",12,0)
 I X="D"!(X="d") S X=$$REDDT^SDM1() D:X>0 MORD2 W:X="" $C(7),"  ??",! G ADT
"RTN","SDMM",13,0)
 I X?1"?".E D HLP1 G ADT
"RTN","SDMM",14,0)
 I X=" ",$G(SDAPDT) S Y=SDAPDT D AT^SDUTL W Y S Y=SDAPDT G OVR
"RTN","SDMM",15,0)
 I $E($P(X,"@",2),1,4)?1.4"0" K %DT S X=$P(X,"@"),X=$S($L(X):X,1:"T"),%DT="XF" D ^%DT G ADT:Y'>0 S X1=Y,X2=-1 D C^%DTC S X=X_.24
"RTN","SDMM",16,0)
 K %DT S %DT="TXEF" D ^%DT
"RTN","SDMM",17,0)
 I $P(Y,".",2)=24 S X1=$P(Y,"."),X2=1 D C^%DTC S Y=X_".000001"
"RTN","SDMM",18,0)
 S SDSOH=$S('$D(^SC(+SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1)
"RTN","SDMM",19,0)
OVR S SDY1=$P(Y,".") I $D(^HOLIDAY(SDY1,0)),'SDSOH W *7,?50,$P(^(0),U,2),"??" G ADT
"RTN","SDMM",20,0)
 I $D(SDINA),SDY1'<SDINA,$S('$D(SDRE):1,SDRE>SDY1!('SDRE):1,1:0) S SDY=Y,Y=SDINA D DTS^SDUTL W !,*7,"Clinic is scheduled to be inactivated on ",Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" and reactivated on "_Y,1:"") S Y=SDY K SDY G ADT
"RTN","SDMM",21,0)
 I Y#1=0 G ADT
"RTN","SDMM",22,0)
 D SDFT I $P(Y,".")'<SDEDT W !,*7,"EXCEEDS MAXIMUM DAYS FOR FUTURE APPOINTMENT!!",*7 G ADT
"RTN","SDMM",23,0)
LEN I $P(SL,U,2)]"" W !,"LENGTH OF APPOINTMENTS (IN MINUTES): ",+SL,"// " R S:DTIME I S]"" G:$L(S)>3 LEN Q:U[S  S POP=0 D L^SDM1 G LEN:POP I S\5*5=S,S'>360,S'<5 S SL=S_U_$P(SL,U,2,99)
"RTN","SDMM",24,0)
 S SDOT=Y#1,SDDAT=$P(Y,"."),X=Y D DOW^SDM0
"RTN","SDMM",25,0)
RDC W !,"FOR HOW MANY CONSECUTIVE ",$S(SDTYP["W":$P($T(DAY),"^",Y+2)_"DAY'S",1:"DAYS")," DO YOU WANT APPOINTMENTS SCHEDULED",!,"   AT " S X=SDOT D TM W X,"?: "
"RTN","SDMM",26,0)
 R SDCN:DTIME G:SDCN=""!(SDCN="^") ADT G HLP:SDCN'?.N,HLP:SDCN<1,HLP:SDCN>60
"RTN","SDMM",27,0)
 S Y=SDDAT_SDOT,SDMCNT=0,SDMADE=0
"RTN","SDMM",28,0)
OTHER R !,"  OTHER INFO: ",D:DTIME I D["^" W !,*7,"'^' not allowed - hit return if no 'OTHER INFO' is to be entered" G OTHER
"RTN","SDMM",29,0)
 I $L(D)>150 D MSG G OTHER
"RTN","SDMM",30,0)
 I D]"",D?."?"!(D'?.ANP) W "  ENTER LAB, SCAN, ETC." G OTHER
"RTN","SDMM",31,0)
 I $L(D)+$L(SDW)>250 D MSG G OTHER
"RTN","SDMM",32,0)
BEGIN S SDZM=1,SDZY=Y,SDX9=X,SDM9=D D SDMM^SDM1A K SDZM S Y=SDZY,X=SDX9,D=SDM9
"RTN","SDMM",33,0)
 F SDZ=1:1:SDCN D MAKE^SDMM1 Q:$D(SDERRFT)  D  Q:POP
"RTN","SDMM",34,0)
 .S:SDMADE SDMCNT=SDMCNT+1 I SDMADE,SDZ=1 S SDAPDT=SD
"RTN","SDMM",35,0)
 .S SDMADE=0,POP=0 D GETNEX:SDTYP["W",GETNXD:SDTYP["D"
"RTN","SDMM",36,0)
 .Q
"RTN","SDMM",37,0)
 G:$D(SDERRFT) ADT
"RTN","SDMM",38,0)
END W !,SDMCNT," APPOINTMENTS MADE",!
"RTN","SDMM",39,0)
 ;display all created appointments
"RTN","SDMM",40,0)
 I $D(^TMP($J,"APPT")) N SDEV D EN^SDWLEVAL(DFN,.SDEV) I SDEV,$L(SDEV(1))>0 D
"RTN","SDMM",41,0)
 .K ^TMP("SDWLPL",$J),^TMP($J,"SDWLPL")
"RTN","SDMM",42,0)
 .D INIT^SDWLPL(DFN,"M")
"RTN","SDMM",43,0)
 .Q:'$D(^TMP($J,"SDWLPL"))  ;
"RTN","SDMM",44,0)
 .;D LIST^SDWLPL("M",DFN) ;display EWL entries
"RTN","SDMM",45,0)
 .F  Q:'$D(^TMP($J,"SDWLPL"))  D LIST^SDWLPL("M",DFN) N SDR D ANSW^SDWLEVAL(1,.SDR) I 'SDR D  ;D LIST^SDWLPL("M",DFN) D
"RTN","SDMM",46,0)
 ..F  N SDR  D ANSW^SDWLEVAL(0,.SDR) Q:'$D(^TMP($J,"SDWLPL"))  I 'SDR W !,"MUST ENTER A REASON NOT TO DISPOSITION MATCHED EWL ENTRY",!
"RTN","SDMM",47,0)
 I $D(^TMP($J,"APPT")) N SDEV D EN^SDWLEVAL(DFN,.SDEV) I SDEV,$L(SDEV(1))>0 D
"RTN","SDMM",48,0)
 .;N SDTC D EWLANS^SDWLEVAL(.SDTC) ;user may reject EWL; 446/;
"RTN","SDMM",49,0)
 .;ask for selection of EWL to display
"RTN","SDMM",50,0)
 .;ASKS - returned answer (A/C/S/^)
"RTN","SDMM",51,0)
 .;    ^TMP("SDWLPL",$J) and ^TMP($J,"SDWLPL") are used
"RTN","SDMM",52,0)
 .;      to generate EWL open entries
"RTN","SDMM",53,0)
 .;I SDTC N SDCTN S SDCTN=0 F  N ASKS K ^TMP("SDWLPL",$J),^TMP($J,"SDWLPL") D ANS2^SDWLPL(DFN,.ASKS) Q:ASKS="^"  D  Q:SDCTN  ;446/;
"RTN","SDMM",54,0)
 .Q:'$D(^TMP($J,"SDWLPL"))  D ASKREM^SDWLEVAL S SDCTN=1 ;display and process selected open EWL entries  ;446/;
"RTN","SDMM",55,0)
 .;I 'SDTC Q  ;no EWL evaluation per user's decision
"RTN","SDMM",56,0)
 .Q
"RTN","SDMM",57,0)
 ;
"RTN","SDMM",58,0)
 K CCX,COLLAT,COV,D,I,POP,S,SC,SD,SDAPTYP,SDEDT,SDEMP,SDINA,SDLOCK,SDM9,SDMES,SDNOT,SDRE,SDSOH,SDW,SDWEE,SDX3,SDX7,SDX9,SDY1,SDYC,SDZ,SDZY,SDMES,SDCN,SDDAT,SDMADE,SDMCNT,SDOT,SDPL,SDRT,SDSC,SDTTM,SDTYP
"RTN","SDMM",59,0)
 K SDALLE,SDATD,SDAV,SDDECOD,SDEC,SDHX,SDIN,SDINP,SDOEL,SDT,SDY,%H,%T,C,DISYS,SDW,SDWE,SDX3,SDX7,SDX9,SDY1,SDYC,SDZY,SI,SL,SM,SS,X1,X2,Y,SDXF,% Q
"RTN","SDMM",60,0)
GETNEX I SDDAT#100<22 S SDDAT=SDDAT+7 S POP=0 D INACT Q:POP  G:$D(^HOLIDAY(SDDAT,0))&('SDSOH) GETNEX S Y=SDDAT_SDOT Q
"RTN","SDMM",61,0)
 S X1=SDDAT,X2=7 D C^%DTC S POP=0 D INACT Q:POP  S SDDAT=X G:$D(^HOLIDAY(SDDAT,0))&('SDSOH) GETNEX S Y=SDDAT_SDOT
"RTN","SDMM",62,0)
 Q
"RTN","SDMM",63,0)
GETNXD I SDDAT#100<28 S SDDAT=SDDAT+1 S POP=0 D INACT Q:POP  G:$D(^HOLIDAY(SDDAT,0))&('SDSOH) GETNXD S X=SDDAT D DOW^SDM0 S:SDWE["Y" Y=SDDAT_SDOT Q:SDWE["Y"  G:Y=0!(Y=6) GETNXD S Y=SDDAT_SDOT Q
"RTN","SDMM",64,0)
 S X1=SDDAT,X2=1 D C^%DTC S POP=0 D INACT Q:POP  S SDDAT=X G:$D(^HOLIDAY(SDDAT,0))&('SDSOH) GETNXD S X=SDDAT D DOW^SDM0 S:SDWE["Y" Y=SDDAT_SDOT Q:SDWE["Y"  G:Y=0!(Y=6) GETNXD S Y=SDDAT_SDOT
"RTN","SDMM",65,0)
 Q
"RTN","SDMM",66,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDMM",67,0)
 ;
"RTN","SDMM",68,0)
TM S X=$E($P(X,".",2)_"0000",1,4),%=X>1159 S:X>1259 X=X-1200 S X=X\100_":"_$E(X#100+100,2,3)_" "_$E("AP",%+1)_"M" Q
"RTN","SDMM",69,0)
HLP W !,"Enter the number of appointments you want made (between 1 and 60)." G RDC
"RTN","SDMM",70,0)
HLP22 W !,"ENTER 'YES' IF YOU WANT THE SYSTEM TO TRY TO MAKE APPOINTMENTS ON SATURDAYS AND SUNDAYS" G RD22
"RTN","SDMM",71,0)
INACT I $D(SDINA),SDINA'>SDDAT,SDRE>SDDAT!('SDRE) W !,*7,"Appointments can't be made while clinic is inactivated" S POP=1
"RTN","SDMM",72,0)
 Q
"RTN","SDMM",73,0)
HLP1 W !,"Enter a date/time for the appointment"
"RTN","SDMM",74,0)
 W:$D(SD) " or a space to choose the same date/time",!,"as the patient you have just previously scheduled into this clinic"
"RTN","SDMM",75,0)
 W ".",!,"You may also select 'M' to display the next month's availability or"
"RTN","SDMM",76,0)
 W !,"'D' to specify an earlier or later date to begin the availability display."
"RTN","SDMM",77,0)
 Q
"RTN","SDMM",78,0)
SDFT S X1=DT,SDEDT=$S($D(^SC(SC,"SDP")):$P(^("SDP"),U,2),1:365) S:'SDEDT SDEDT=365 S X2=SDEDT D C^%DTC S SDEDT=X Q
"RTN","SDMM",79,0)
MSG W !!?5,"Text entered at OTHER INFO prompt was too long.  Please re-enter.",! Q
"RTN","SDMM",80,0)
 ;
"RTN","SDMM",81,0)
MORDIS I '$D(SDHX) W *7," ??" G ADT
"RTN","SDMM",82,0)
 S SDXF=0,X1=SDHX,X2=1 D C^%DTC
"RTN","SDMM",83,0)
MORD2 I $D(SDINA),SDINA'>X,SDRE>X!('SDRE) S SDHY=$S($D(Y):Y,1:""),Y=SDINA D DTS^SDUTL W *7,!,"Clinic is inactivated as of ",Y S Y=SDHY K SDHY G ADT
"RTN","SDMM",84,0)
EN S:$L(X)=1 X=$TR(X,"tnN","TTT") S:X="NOW" X="T" I X?.A!(+X=X),X<13,X'?1"T".E S X=X_" 1"
"RTN","SDMM",85,0)
 D  Q:Y<1
"RTN","SDMM",86,0)
 .N %DT
"RTN","SDMM",87,0)
 .S %DT="T" D ^%DT
"RTN","SDMM",88,0)
 .I Y<1 W !!,"Unable to evaluate date value """_X_""".",!
"RTN","SDMM",89,0)
 .Q
"RTN","SDMM",90,0)
 S:$S($D(DUZ)'[0:1,1:0) ^DISV(DUZ_U_+SC)=Y
"RTN","SDMM",91,0)
DISP S IOF=$S('$D(IOF):"!#",IOF']"":"!#",1:IOF) W @IOF S SDSOH=$S('$D(^SC(+SC,"SL")):0,$P(^("SL"),"^",8)']"":0,1:1),SDAV=0
"RTN","SDMM",92,0)
 I $D(SDINA),Y'<SDINA,SDRE>Y!('SDRE) S SDHY=Y,Y=SDINA D DTS^SDUTL W !,*7,"Clinic is inactive ",$S(SDRE:"from ",1:"as of "),Y S Y=SDRE D:Y DTS^SDUTL W $S(SDRE:" to "_Y,1:"") S Y=SDHY K SDHY Q:'SDRE
"RTN","SDMM",93,0)
 S:Y#100=0 Y=Y+1 S X=Y D D^SDM0:$E(X,4,5) S (SDX,X1)=X,X2=1 D C^%DTC S X=SDX K SDX Q
"RTN","SDMM1")
0^31^B15400257
"RTN","SDMM1",1,0)
SDMM1 ;ALB/GRR - MULTIPLE BOOKINGS ; 2/7/05 8:16am
"RTN","SDMM1",2,0)
 ;;5.3;Scheduling;**28,206,168,327**;Aug 13, 1993;Build 3
"RTN","SDMM1",3,0)
MAKE S (SDX3,X,SD)=Y,SM=0 D DOW^SDM0 I $D(^DPT(DFN,"S",X)) S I=^(X,0) I $P(I,"^",2)'["C" W !,"PATIENT ALREADY HAS APPOINTMENT ON ",$P("JAN^FEB^MAR^APR^MAY^JUN^JUL^AUG^SEP^OCT^NOV^DEC","^",$E(X,4,5))," ",$E(X,6,7)," AT THAT TIME" Q
"RTN","SDMM1",4,0)
 S SDX7=X D SDFT^SDMM S X=SDX7 I $P(SDX3,".")'<SDEDT W !,*7,"EXCEEDS MAXIMUM DAYS FOR FUTURE APPOINTMENT!!",*7 Q
"RTN","SDMM1",5,0)
S S SDNOT=0 I '$D(^SC(SC,"ST",$P(X,"."),1)) S SS=$O(^SC(+SC,"T"_Y,X)) G X:'SS,X:^(SS,1)="" S ^SC(+SC,"ST",$P(X,"."),1)=$E($P($T(DAY),U,Y+2),1,2)_" "_$E(X,6,7)_$J("",SI+SI-6)_^(1),^(0)=$P(X,".")
"RTN","SDMM1",6,0)
SC S POP=0,SD=X D SC^SDM1 I SDLOCK W ! D DT W " HAS BEEN LOCKED BY ANOTHER USER - APPT NOT BOOKED" L  Q
"RTN","SDMM1",7,0)
 G X:POP,OK:SM#9=0 S SDY=Y,Y=X
"RTN","SDMM1",8,0)
 ;
"RTN","SDMM1",9,0)
 D OB I SDNOT=0 Q  ; check overbook/keys...quit if not ok
"RTN","SDMM1",10,0)
 S SM=9 G SC
"RTN","SDMM1",11,0)
 ;
"RTN","SDMM1",12,0)
OK S ^SC(SC,"ST",$P(X,"."),1)=S,^SC(SC,"S",X,0)=X S:'$D(^DPT(DFN,"S",0)) ^(0)="^2.98^^" S:'$D(^SC(SC,"S",0)) ^(0)="^44.001DA^^" L
"RTN","SDMM1",13,0)
S1 L ^SC(SC,"S",X,1):5 G:'$T S1 F Y=1:1 I '$D(^SC(SC,"S",X,1,Y)) S:'$D(^(0)) ^(0)="^44.003PA^^" S ^(Y,0)=DFN_U_(+SL)_U_U_D_U_U_$S($D(DUZ):DUZ,1:"")_U_DT_U_U_U_$S(+SDEMP:+SDEMP,1:"") S SDY=Y L  Q
"RTN","SDMM1",14,0)
 I SM S ^("OB")="O" ;NAKED REFERENCE - ^SC(IFN,"S",Date,1,"OB")
"RTN","SDMM1",15,0)
 I $D(^SC(SC,"RAD")),^("RAD")="Y"!(^("RAD")=1) S ^SC("ARAD",SC,X,DFN)=""
"RTN","SDMM1",16,0)
 S SDINP=$$INP^SDAM2(DFN,X)
"RTN","SDMM1",17,0)
 S COV=3,SDYC="",COV=$S(COLLAT=1:1,1:3),SDYC=$S(COLLAT=7:1,1:""),^DPT(DFN,"S",X,0)=SC_"^"_$$STATUS^SDM1A(SC,SDINP,X)_"^^^^^"_COV_"^^^^"_SDYC_"^^^^^"_SDAPTYP_"^^^"_DT_"^^^^^^M^0",SDMADE=1
"RTN","SDMM1",18,0)
 D XRDT(DFN,X)  ;xref DATE APPT. MADE field
"RTN","SDMM1",19,0)
 K:$D(^DPT("ASDCN",SC,X,DFN)) ^(DFN) K:$D(^DPT(DFN,"S",X,"R")) ^("R")
"RTN","SDMM1",20,0)
 S SDRT="A",SDTTM=X,SDPL=SDY,SDSC=SC D RT^SDUTL
"RTN","SDMM1",21,0)
 L  W !,"APPOINTMENT MADE ON " S Y=X D DT^DIQ
"RTN","SDMM1",22,0)
 ;check for open EWL entries and create TMP($J,"APPT";SD/327
"RTN","SDMM1",23,0)
 N SDEV,SD D EN^SDWLEVAL(DFN,.SDEV) S SD=X I SDEV D APPT^SDWLEVAL(DFN,SD,SC)
"RTN","SDMM1",24,0)
 D EVT
"RTN","SDMM1",25,0)
 Q
"RTN","SDMM1",26,0)
 ;
"RTN","SDMM1",27,0)
XRDT(DFN,X) ;cross reference DATE APPT. MADE field
"RTN","SDMM1",28,0)
 ;Input: DFN=patient ifn
"RTN","SDMM1",29,0)
 ;Input: X=appointment date
"RTN","SDMM1",30,0)
 N DIK,DA,DIV S DA=X,DA(1)=DFN
"RTN","SDMM1",31,0)
 S DIK="^DPT(DA(1),""S"",",DIK(1)=20 D EN1^DIK
"RTN","SDMM1",32,0)
 Q
"RTN","SDMM1",33,0)
 ;
"RTN","SDMM1",34,0)
NOOB S SDMES="NO OPEN SLOTS ON "
"RTN","SDMM1",35,0)
WRTER W !,SDMES D DT W:SDNOT " AT THAT TIME" S SDNOT=0 Q
"RTN","SDMM1",36,0)
DT W $P("JAN^FEB^MAR^APR^MAY^JUN^JUL^AUG^SEP^OCT^NOV^DEC","^",$E(X,4,5))," ",$E(X,6,7) Q
"RTN","SDMM1",37,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDMM1",38,0)
 ;
"RTN","SDMM1",39,0)
X L  I SDZ=1 W !,*7,"CLINIC DOES NOT MEET THEN!!" S SDERRFT=1 Q
"RTN","SDMM1",40,0)
 S SDMES="CLINIC DOES NOT MEET ON " G WRTER
"RTN","SDMM1",41,0)
 ;
"RTN","SDMM1",42,0)
EVT ; -- separate tag if need to NEW vars
"RTN","SDMM1",43,0)
 N D,SI,SC,SL,COLLAT D MAKE^SDAMEVT(DFN,SDTTM,SDSC,SDPL,0)
"RTN","SDMM1",44,0)
 Q
"RTN","SDMM1",45,0)
 ;
"RTN","SDMM1",46,0)
OB ; check for overbook keys
"RTN","SDMM1",47,0)
 N %,D,I,S,ST
"RTN","SDMM1",48,0)
 S SDNOT=1
"RTN","SDMM1",49,0)
 I '$D(^XUSEC("SDOB",DUZ)),'$D(^XUSEC("SDMOB",DUZ)) D NOOB G OBQ ; user has neither key
"RTN","SDMM1",50,0)
 S I=$P(SD,".",1),(S,ST)=$P(SL,U,7) ; counter of OBs for day = ST
"RTN","SDMM1",51,0)
 I ST F D=I-.01:0 S D=$O(^SC(SC,"S",D)) Q:$P(D,".",1)-I  F %=0:0 S %=$O(^SC(SC,"S",D,1,%)) Q:'%  I $P(^(%,0),"^",9)'["C",$D(^("OB")) S ST=ST-1
"RTN","SDMM1",52,0)
 I ST<1 D  G OBQ
"RTN","SDMM1",53,0)
 . I '$D(^XUSEC("SDMOB",DUZ)) W !,*7,"ONLY "_S_" OVERBOOK"_$E("S",S>1)_" ALLOWED PER DAY!!" D NOOB Q
"RTN","SDMM1",54,0)
 . S MXOK=$$DIR("WILL EXCEED MAXIMUM ALLOWABLE OVERBOOKS FOR "_$$FMTE^XLFDT(Y)_", OK","YES")
"RTN","SDMM1",55,0)
 . I 'MXOK S SM=9,SDNOT=0 Q
"RTN","SDMM1",56,0)
 . I MXOK S S=^SC(SC,"ST",I,1),SM=9,MXOK=""
"RTN","SDMM1",57,0)
 I '$D(^XUSEC("SDOB",DUZ)) D NOOB G OBQ
"RTN","SDMM1",58,0)
 I '$$DIR($$FMTE^XLFDT(Y)_" WILL BE AN OVERBOOK, OK","NO") S SM=9,SDNOT=0
"RTN","SDMM1",59,0)
OBQ Q
"RTN","SDMM1",60,0)
 ;
"RTN","SDMM1",61,0)
DIR(TEXT,DEF) ; reader processor
"RTN","SDMM1",62,0)
 ; Input:  TEXT as text of read
"RTN","SDMM1",63,0)
 ;         DEF as default response (if any)
"RTN","SDMM1",64,0)
 ;
"RTN","SDMM1",65,0)
 N DIR,DIROUT,DIRUT,DTOUT,DUOUT,X,Y
"RTN","SDMM1",66,0)
 S DIR(0)="Y",DIR("A")=TEXT
"RTN","SDMM1",67,0)
 I $G(DEF)]"" S DIR("B")=DEF
"RTN","SDMM1",68,0)
 D ^DIR
"RTN","SDMM1",69,0)
 W:'Y !
"RTN","SDMM1",70,0)
 Q Y
"RTN","SDMULT1")
0^32^B14570449
"RTN","SDMULT1",1,0)
SDMULT1 ;ALB/TMP - MAKE MULTI-CLINIC APPOINTMENTS ; 18 APR 86
"RTN","SDMULT1",2,0)
 ;;5.3;Scheduling;**32,41,167**;AUG 13, 1993;Build 3
"RTN","SDMULT1",3,0)
 ;
"RTN","SDMULT1",4,0)
FND I $D(SDNEXT) S SDPCM1=""
"RTN","SDMULT1",5,0)
 I $D(SDNEXT),$G(SDPCMM(SC))>2 K SDPCM1 G ACT
"RTN","SDMULT1",6,0)
 I $D(SDNEXT),+$G(SDPCMM(SC))<1 W @IOF
"RTN","SDMULT1",7,0)
 I '$D(SDNEXT) W @IOF
"RTN","SDMULT1",8,0)
 W !?25,"DATE: " S X=SDAPP D DOW^SDM0 W "(",$P($P($T(DAY),";",3),"^",Y+2),"DAY) " S Y=SDAPP D DT^DIQ W ! F G1=0:0 S G1=$O(SDC(G1)) Q:G1'>0  S SC=+SDC(G1) D S2 S X=SDAPP,SCPCMM(SC)=0 D PROC
"RTN","SDMULT1",9,0)
ACT I '$D(SDPCMM) W:'$D(SDNEXT) ! W !,"ENTER: ",!,?3,"'^' - EXIT  " W:'$D(SDNEXT) "'B' - BOOK  " W "'C' - CONTINUE SEARCH or  'R' - REDISPLAY: CONTINUE// " R X:DTIME G:X["^" END^SDMULT0 S X=$E(X) I X?1"?"!("BCR"'[X) D H1 G ACT
"RTN","SDMULT1",10,0)
 I '$D(SDPCMM),$D(SDNEXT) S SDNEXT=1
"RTN","SDMULT1",11,0)
 I $D(SDPCM1) S X="C"
"RTN","SDMULT1",12,0)
 I X["C"!(X']"") S FND=0 F I=1:1:SDCT S SDDT(I)=0
"RTN","SDMULT1",13,0)
 I  S X1=SDSTRTDT,X2=1 D C^%DTC S SDSTRTDT=X G LOOKA^SDMULT0
"RTN","SDMULT1",14,0)
 I X["R" G FND
"RTN","SDMULT1",15,0)
 I X["B",'$D(SDNEXT) G BOOK
"RTN","SDMULT1",16,0)
 I '$D(SDPCMM) K SDPCM1 D H1 G ACT
"RTN","SDMULT1",17,0)
PROC I $D(SDNEXT) S SDPCMM(SC)=$G(SDPCMM(SC))+1
"RTN","SDMULT1",18,0)
 I $D(SDNEXT),$G(SDPCMM(SC))>3 K SDPCM1 Q
"RTN","SDMULT1",19,0)
 S SDV="",$P(SDV," ",SI+SI-5)="" W !,"CLINIC: ",$P(SDC1(SC),"^",1),?50,"(",$P(SDC1(SC),"^",2)," MINUTES)",!,"-------" S LINE=" TIME"_SDV F Y=STARTDAY:1:65\(SI+SI)+STARTDAY S LINE=LINE_$E("|"_$S('Y:0,1:(Y-1#12+1))_"                 ",1,SI+SI)
"RTN","SDMULT1",20,0)
 W !,$E(LINE,1,80) S LINE(G1)=$E(LINE,1,80)
"RTN","SDMULT1",21,0)
 W !,$E(^SC(SC,"ST",SDAPP,1),1,80),! S LINE1(G1)=$E(^(1),1,80) Q
"RTN","SDMULT1",22,0)
H1 W !,"YOU MAY ENTER:",!,?10,"'^' TO EXIT" W:'$D(SDNEXT) !,?10,"'B' TO ENTER THE MAKE APPT ROUTINES AND BOOK THE APPOINTMENTS"
"RTN","SDMULT1",23,0)
 W !,?10,"'C' TO LOOK FOR THE NEXT DATE ALL CLINICS HAVE AN AVAILABLE TIME SLOT",!,?10,"'R' TO REDISPLAY THIS SAME SCREEN" Q
"RTN","SDMULT1",24,0)
 ;
"RTN","SDMULT1",25,0)
DAY ;;^SUN^MON^TUES^WEDNES^THURS^FRI^SATUR
"RTN","SDMULT1",26,0)
 ;
"RTN","SDMULT1",27,0)
BOOK D STARS
"RTN","SDMULT1",28,0)
 F G1=0:0 S G1=$O(SDC(G1)) Q:G1'>0  W !!,"Make appt in : ",$P(SDC(G1),"^",2),! S SC=+SDC(G1) D S2,S3,TM D:SDMADE MADE D:'SDMADE NOT
"RTN","SDMULT1",29,0)
 K COLLAT G END^SDMULT0
"RTN","SDMULT1",30,0)
MADE W !!,$P(^SC(+SDC(G1),"S",SD,1,SDY,0),"^",2)," minute appointment made in ",$P(SDC(G1),"^",2),! D STARS
"RTN","SDMULT1",31,0)
 Q
"RTN","SDMULT1",32,0)
NOT W !!,"No appt made in ",$P(SDC1(SC),"^"),! D STARS
"RTN","SDMULT1",33,0)
 Q
"RTN","SDMULT1",34,0)
STARS S SD0="",$P(SD0,"*",81)="" W !,SD0 K SD0 Q
"RTN","SDMULT1",35,0)
TM S SDMADE=0 R !!,"SCHEDULE TIME: ",X:DTIME Q:"^"[X!'($T)  I X?.E1"?"!(X'?1N.N) W !,"Enter the appointment time for this clinic" G TM
"RTN","SDMULT1",36,0)
 S X=$E(SDAPP,4,7)_$E(SDAPP,2,3)_"@"_X,%DT="TE" D ^%DT I Y<0 W *7,"   WHEN ??" G TM
"RTN","SDMULT1",37,0)
 K %DT S X=Y#1,Y=+Y I $D(^DPT(DFN,"S",Y,0)),$P(^(0),"^",2)'["C" S Y1=+^(0),Y1=$P(^SC(+Y1,0),"^") W !,*7,"Patient already has an appointment in ",Y1," at that time" K Y1 G TM
"RTN","SDMULT1",38,0)
 S:$P(SL,"^",2)]"" $P(SL,"^")=$P(SDC1(SC),"^",2) S SDMLT=1 K SDAPTYP D EN1^SDM1
"RTN","SDMULT1",39,0)
 G:'SDMADE!(SDMADE=2) TM Q
"RTN","SDMULT1",40,0)
S2 S SL=^SC(SC,"SL"),X=$P(SL,"^",3),STARTDAY=$S($L(X):X,1:8),X=$P(SL,"^",6),SI=$S(X="":4,X<3:4,X:X,1:4) Q
"RTN","SDMULT1",41,0)
S3 W !,LINE(G1),!,LINE1(G1)
"RTN","SDMULT1",42,0)
 S SB=STARTDAY-1/100,X=$P(SL,U,6),HSI=$S(X=1:X,X:X,1:4),STR="#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz",SDDIF=$S(HSI<3:8/HSI,1:2),SM=0
"RTN","SDMULT1",43,0)
 K MXOK S SD=SDAPP,(CCX,CCXN,DP)=""
"RTN","SDMULT1",44,0)
 Q
"RTN","SDPPTEM")
0^33^B45405058
"RTN","SDPPTEM",1,0)
SDPPTEM ;BP-CIOFO/KEITH - Patient Profile Team Info ; 8/27/99 10:39am
"RTN","SDPPTEM",2,0)
 ;;5.3;Scheduling;**41,177,297**;AUG 13, 1993;Build 3
"RTN","SDPPTEM",3,0)
 ;
"RTN","SDPPTEM",4,0)
 ;Gathering Team Information for Patient Profile
"RTN","SDPPTEM",5,0)
 ;
"RTN","SDPPTEM",6,0)
TDATA(DFN,VALMCNT,SDATE,SDPRT,SDCOL) ;Team information - gather, format and optionally print.
"RTN","SDPPTEM",7,0)
 ;Input: DFN=patient ifn
"RTN","SDPPTEM",8,0)
 ;Input: VALMCNT=variable to return number of lines (pass by reference)
"RTN","SDPPTEM",9,0)
 ;Input: SDATE=effective date (optional)
"RTN","SDPPTEM",10,0)
 ;Input: SDPRT=print flag, 'P' for PC info only, 'A' for all (optional)
"RTN","SDPPTEM",11,0)
 ;Input: SDCOL=column to print in conjunction with SDPRT flag (optional)
"RTN","SDPPTEM",12,0)
 ;
"RTN","SDPPTEM",13,0)
 Q:DFN'>0
"RTN","SDPPTEM",14,0)
 N SDI,SDATE,SDLIST,SDX,SDLN,SDY,SDPH,SDTEAM,SDPTA,SDII,SDIII,SDZ
"RTN","SDPPTEM",15,0)
 N SDTM,SDTMN,SDPO,SDPON,SDPR,SDPRN
"RTN","SDPPTEM",16,0)
 N PAGER,PHONE
"RTN","SDPPTEM",17,0)
 ;
"RTN","SDPPTEM",18,0)
 F SDI="SDPLIST","SDTEMP" K ^TMP(SDI,$J)
"RTN","SDPPTEM",19,0)
 S SDCOL=+$G(SDCOL),SDATE=$G(SDATE) S:SDATE<1 SDATE=DT
"RTN","SDPPTEM",20,0)
 F SDI="BEGIN","END" S SDATE(SDI)=SDATE
"RTN","SDPPTEM",21,0)
 S SDATE="SDATE",SDLIST="^TMP(""SDPLIST"",$J)",SDLN=2
"RTN","SDPPTEM",22,0)
 ;
"RTN","SDPPTEM",23,0)
 S SDI=$$GETALL^SCAPMCA(DFN,.SDATE,SDLIST)
"RTN","SDPPTEM",24,0)
 ;
"RTN","SDPPTEM",25,0)
 ;PC Team
"RTN","SDPPTEM",26,0)
 S SDI=0 F  S SDI=$O(^TMP("SDPLIST",$J,DFN,"PCTM",SDI)) Q:'SDI  D
"RTN","SDPPTEM",27,0)
 .S SDX=$G(^TMP("SDPLIST",$J,DFN,"PCTM",SDI)) Q:'$L(SDX)
"RTN","SDPPTEM",28,0)
 .S SDY=""
"RTN","SDPPTEM",29,0)
 .D S1("Primary Care Team",$P(SDX,U,2))
"RTN","SDPPTEM",30,0)
 .S SDPH=$P($G(^SCTM(404.51,+SDX,0)),U,2) D:$L(SDPH) S2("Phone",SDPH)
"RTN","SDPPTEM",31,0)
 .S:$P(SDX,U,3) SDPTA($P(SDX,U,3))=""
"RTN","SDPPTEM",32,0)
 .D STL(SDY)
"RTN","SDPPTEM",33,0)
 .Q
"RTN","SDPPTEM",34,0)
 ;
"RTN","SDPPTEM",35,0)
 ;AP
"RTN","SDPPTEM",36,0)
 S SDI=0 F  S SDI=$O(^TMP("SDPLIST",$J,DFN,"PCAP",SDI)) Q:'SDI  D
"RTN","SDPPTEM",37,0)
 .S SDX=$G(^TMP("SDPLIST",$J,DFN,"PCAP",SDI)) Q:'$L(SDX)
"RTN","SDPPTEM",38,0)
 .S SDY=""
"RTN","SDPPTEM",39,0)
 .D S1("Associate Provider",$P(SDX,U,2))
"RTN","SDPPTEM",40,0)
 .D S2("Position",$P(SDX,U,4))
"RTN","SDPPTEM",41,0)
 .D STL(SDY)
"RTN","SDPPTEM",42,0)
 .D PHONE($P(SDX,U,1))
"RTN","SDPPTEM",43,0)
 .S SDY=""
"RTN","SDPPTEM",44,0)
 .D S3("Pager",PAGER)
"RTN","SDPPTEM",45,0)
 .D S4("Phone",PHONE)
"RTN","SDPPTEM",46,0)
 .D STL(SDY)
"RTN","SDPPTEM",47,0)
 .Q
"RTN","SDPPTEM",48,0)
 ;PCP
"RTN","SDPPTEM",49,0)
 S SDI=0 F  S SDI=$O(^TMP("SDPLIST",$J,DFN,"PCPR",SDI)) Q:'SDI  D
"RTN","SDPPTEM",50,0)
 .S SDX=$G(^TMP("SDPLIST",$J,DFN,"PCPR",SDI)) Q:'$L(SDX)
"RTN","SDPPTEM",51,0)
 .S SDY=""
"RTN","SDPPTEM",52,0)
 .D S1("PC Provider",$P(SDX,U,2))
"RTN","SDPPTEM",53,0)
 .D S2("Position",$P(SDX,U,4))
"RTN","SDPPTEM",54,0)
 .D STL(SDY)
"RTN","SDPPTEM",55,0)
 .D PHONE($P(SDX,U,1))
"RTN","SDPPTEM",56,0)
 .S SDY=""
"RTN","SDPPTEM",57,0)
 .D S3("Pager",PAGER)
"RTN","SDPPTEM",58,0)
 .D S4("Phone",PHONE)
"RTN","SDPPTEM",59,0)
 .D STL(SDY)
"RTN","SDPPTEM",60,0)
 .Q
"RTN","SDPPTEM",61,0)
 ;
"RTN","SDPPTEM",62,0)
 I $G(SDPRT)="P" D PRT G TDQ
"RTN","SDPPTEM",63,0)
 S SDII=0
"RTN","SDPPTEM",64,0)
 F  S SDII=$O(^TMP("SDPLIST",$J,DFN,"NPCPOS",SDII)) Q:'SDII  D
"RTN","SDPPTEM",65,0)
 .S SDX=^TMP("SDPLIST",$J,DFN,"NPCPOS",SDII)
"RTN","SDPPTEM",66,0)
 .Q:'$D(SDPTA(+$P(SDX,U,11)))  S SDIII=0
"RTN","SDPPTEM",67,0)
 .F  S SDIII=$O(^TMP("SDPLIST",$J,DFN,"NPCPR",SDIII)) Q:'SDIII  D
"RTN","SDPPTEM",68,0)
 ..S SDZ=^TMP("SDPLIST",$J,DFN,"NPCPR",SDIII)
"RTN","SDPPTEM",69,0)
 ..Q:$P(SDZ,U,3)'=+SDX  S SDY=""
"RTN","SDPPTEM",70,0)
 ..D S1("Non-PC Provider",$P(SDZ,U,2)),S2("Position",$P(SDZ,U,4))
"RTN","SDPPTEM",71,0)
 ..D STL(SDY) Q
"RTN","SDPPTEM",72,0)
 .Q
"RTN","SDPPTEM",73,0)
 S SDI=0
"RTN","SDPPTEM",74,0)
 F  S SDI=$O(^TMP("SDPLIST",$J,DFN,"NPCTM",SDI)) Q:'SDI  D
"RTN","SDPPTEM",75,0)
 .S SDX=^TMP("SDPLIST",$J,DFN,"NPCTM",SDI)
"RTN","SDPPTEM",76,0)
 .S SDTEAM($P(SDX,U,2),+SDX)="",SDPTA=$P(SDX,U,3) Q:'SDPTA  D
"RTN","SDPPTEM",77,0)
 ..S SDII=0
"RTN","SDPPTEM",78,0)
 ..F  S SDII=$O(^TMP("SDPLIST",$J,DFN,"NPCPOS",SDII)) Q:'SDII  D
"RTN","SDPPTEM",79,0)
 ...S SDY=^TMP("SDPLIST",$J,DFN,"NPCPOS",SDII)
"RTN","SDPPTEM",80,0)
 ...Q:$P(SDY,U,11)'=SDPTA
"RTN","SDPPTEM",81,0)
 ...S SDTEAM($P(SDX,U,2),+SDX,$P(SDY,U,2),+SDY)="",SDIII=0
"RTN","SDPPTEM",82,0)
 ...F  S SDIII=$O(^TMP("SDPLIST",$J,DFN,"NPCPR",SDIII)) Q:'SDIII  D
"RTN","SDPPTEM",83,0)
 ....S SDZ=^TMP("SDPLIST",$J,DFN,"NPCPR",SDIII)
"RTN","SDPPTEM",84,0)
 ....Q:$P(SDZ,U,3)'=+SDY
"RTN","SDPPTEM",85,0)
 ....S SDTEAM($P(SDX,U,2),+SDX,$P(SDY,U,2),+SDY,$P(SDZ,U,2),+SDZ)=""
"RTN","SDPPTEM",86,0)
 ....Q
"RTN","SDPPTEM",87,0)
 ...Q
"RTN","SDPPTEM",88,0)
 ..Q
"RTN","SDPPTEM",89,0)
 .Q
"RTN","SDPPTEM",90,0)
 S SDTM="" F  S SDTM=$O(SDTEAM(SDTM)) Q:SDTM=""  D
"RTN","SDPPTEM",91,0)
 .S SDTMN=0 F  S SDTMN=$O(SDTEAM(SDTM,SDTMN)) Q:'SDTMN  D
"RTN","SDPPTEM",92,0)
 ..I SDLN>0 D STL("")
"RTN","SDPPTEM",93,0)
 ..S SDY="" D S1("Non-PC Team",SDTM)
"RTN","SDPPTEM",94,0)
 ..S SDPH=$P($G(^SCTM(404.51,+SDTMN,0)),U,2) D:$L(SDPH) S2("Phone",SDPH)
"RTN","SDPPTEM",95,0)
 ..D STL(SDY) S SDPO=""
"RTN","SDPPTEM",96,0)
 ..F  S SDPO=$O(SDTEAM(SDTM,SDTMN,SDPO)) Q:SDPO=""  S SDPON=0 D
"RTN","SDPPTEM",97,0)
 ...F  S SDPON=$O(SDTEAM(SDTM,SDTMN,SDPO,SDPON)) Q:'SDPON  D
"RTN","SDPPTEM",98,0)
 ....I $O(SDTEAM(SDTM,SDTMN,SDPO,SDPON,""))="" S SDY="" D S1("Non-PC Provider",""),S2("Position",SDPO),STL(SDY) Q
"RTN","SDPPTEM",99,0)
 ....S SDPR=""
"RTN","SDPPTEM",100,0)
 ....F  S SDPR=$O(SDTEAM(SDTM,SDTMN,SDPO,SDPON,SDPR)) Q:SDPR=""  D
"RTN","SDPPTEM",101,0)
 .....S SDPRN=0
"RTN","SDPPTEM",102,0)
 .....F  S SDPRN=$O(SDTEAM(SDTM,SDTMN,SDPO,SDPON,SDPR,SDPRN)) Q:'SDPRN  D
"RTN","SDPPTEM",103,0)
 ......S SDY=""
"RTN","SDPPTEM",104,0)
 ......D S1("Non-PC Provider",SDPR)
"RTN","SDPPTEM",105,0)
 ......D S2("Position",SDPO)
"RTN","SDPPTEM",106,0)
 ......D STL(SDY)
"RTN","SDPPTEM",107,0)
 ......D PHONE(SDPRN)
"RTN","SDPPTEM",108,0)
 ......S SDY=""
"RTN","SDPPTEM",109,0)
 ......D S3("Pager",PAGER)
"RTN","SDPPTEM",110,0)
 ......D S4("Phone",PHONE)
"RTN","SDPPTEM",111,0)
 ......D STL(SDY)
"RTN","SDPPTEM",112,0)
 ......Q
"RTN","SDPPTEM",113,0)
 .....Q
"RTN","SDPPTEM",114,0)
 ....Q
"RTN","SDPPTEM",115,0)
 ...Q
"RTN","SDPPTEM",116,0)
 ..Q
"RTN","SDPPTEM",117,0)
 .Q
"RTN","SDPPTEM",118,0)
 ;
"RTN","SDPPTEM",119,0)
 I $G(SDPRT)="A" D PRT G TDQ
"RTN","SDPPTEM",120,0)
 S SDY="",$E(SDY,29)="*** Team Information ***"
"RTN","SDPPTEM",121,0)
 S ^TMP("SDTEMP",$J,1)=SDY,^TMP("SDTEMP",$J,2)=""
"RTN","SDPPTEM",122,0)
 I SDLN=2 S SDY="",$E(SDY,20)="-- No team assignment information found --",^TMP("SDTEMP",$J,3)=SDY
"RTN","SDPPTEM",123,0)
 S GBL=$G(GBL,"") I $L(GBL)<1 S GBL=$S('$D(VALMAR):"^TMP(""SDPP"",$J)",$L(VALMAR)>1:VALMAR,1:"^TMP(""SDPP"",$J)")
"RTN","SDPPTEM",124,0)
 ;add line at bottom of array for readability
"RTN","SDPPTEM",125,0)
 S SDI=$O(^TMP("SDTEMP",$J,""),-1)+1,^TMP("SDTEMP",$J,SDI)=""
"RTN","SDPPTEM",126,0)
 ;respect the array count passed in to the function
"RTN","SDPPTEM",127,0)
 S (SDII,VALMCNT)=$O(@GBL@(""),-1)+1
"RTN","SDPPTEM",128,0)
 S SDI=0
"RTN","SDPPTEM",129,0)
 F  S SDI=$O(^TMP("SDTEMP",$J,SDI)) Q:'SDI  D
"RTN","SDPPTEM",130,0)
 .S SDX=^TMP("SDTEMP",$J,SDI),SDII=SDII+1
"RTN","SDPPTEM",131,0)
 .S @GBL@(SDII,0)=SDX,VALMCNT=$G(VALMCNT)+1
"RTN","SDPPTEM",132,0)
 .I SDLN<7,SDI>3 S SDII=SDII+1,@GBL@(SDII,0)="",VALMCNT=$G(VALMCNT)+1
"RTN","SDPPTEM",133,0)
 .Q
"RTN","SDPPTEM",134,0)
TDQ F SDI="SDPLIST","SDTEMP" K ^TMP(SDI,$J,DFN)
"RTN","SDPPTEM",135,0)
 Q
"RTN","SDPPTEM",136,0)
 ;
"RTN","SDPPTEM",137,0)
S1(SDT,SDX) ;Set first piece of string
"RTN","SDPPTEM",138,0)
 ;Input: SDT=subtitle
"RTN","SDPPTEM",139,0)
 ;Input: SDX=data value
"RTN","SDPPTEM",140,0)
 S SDY=$J(SDT,18)_": "_$E(SDX,1,28) Q
"RTN","SDPPTEM",141,0)
 ;
"RTN","SDPPTEM",142,0)
S2(SDT,SDX) ;Set second piece of string
"RTN","SDPPTEM",143,0)
 ;Input: SDT=subtitle
"RTN","SDPPTEM",144,0)
 ;Input: SDX=data value
"RTN","SDPPTEM",145,0)
 I $L($G(SDPRT)),SDCOL>0 Q
"RTN","SDPPTEM",146,0)
 S $E(SDY,53)=$J(SDT,8)_": "_$E(SDX,1,18) Q
"RTN","SDPPTEM",147,0)
 ;
"RTN","SDPPTEM",148,0)
S3(SDT,SDX) ;Set first piece of string that displays phone numbers
"RTN","SDPPTEM",149,0)
 ;Input: SDT=subtitle
"RTN","SDPPTEM",150,0)
 ;Input: SDX=data value
"RTN","SDPPTEM",151,0)
 S SDY=$J(SDT,30)_": "_$E(SDX,1,20)
"RTN","SDPPTEM",152,0)
 Q
"RTN","SDPPTEM",153,0)
 ;
"RTN","SDPPTEM",154,0)
S4(SDT,SDX) ;Set second piece of string that displays phone numbers
"RTN","SDPPTEM",155,0)
 ;Input: SDT=subtitle
"RTN","SDPPTEM",156,0)
 ;Input: SDX=data value
"RTN","SDPPTEM",157,0)
 I $L($G(SDPRT)),SDCOL>0 Q
"RTN","SDPPTEM",158,0)
 S $E(SDY,56)=$J(SDT,4)_": "_$E(SDX,1,20)
"RTN","SDPPTEM",159,0)
 Q
"RTN","SDPPTEM",160,0)
 ;
"RTN","SDPPTEM",161,0)
PHONE(IEN) ;Get provider's pager and phone numbers.
"RTN","SDPPTEM",162,0)
 ;Return: PAGER = Pager number
"RTN","SDPPTEM",163,0)
 ;        PHONE = Phone number
"RTN","SDPPTEM",164,0)
 NEW LIST
"RTN","SDPPTEM",165,0)
 S (PAGER,PHONE)=""
"RTN","SDPPTEM",166,0)
 Q:'$G(IEN)
"RTN","SDPPTEM",167,0)
 Q:'$$NEWPERSN^SCMCGU(IEN,"LIST")
"RTN","SDPPTEM",168,0)
 S PAGER=$P(LIST(IEN),U,5)
"RTN","SDPPTEM",169,0)
 S PHONE=$P(LIST(IEN),U,2)
"RTN","SDPPTEM",170,0)
 Q
"RTN","SDPPTEM",171,0)
 ;
"RTN","SDPPTEM",172,0)
STL(SDY) ;Set text line
"RTN","SDPPTEM",173,0)
 ;Input: SDY=string
"RTN","SDPPTEM",174,0)
 S SDLN=SDLN+1
"RTN","SDPPTEM",175,0)
 S ^TMP("SDTEMP",$J,SDLN)=SDY
"RTN","SDPPTEM",176,0)
 Q
"RTN","SDPPTEM",177,0)
 ;
"RTN","SDPPTEM",178,0)
PRT ;Write assignment information
"RTN","SDPPTEM",179,0)
 N SDI S SDI=0
"RTN","SDPPTEM",180,0)
 F  S SDI=$O(^TMP("SDTEMP",$J,SDI)) Q:'SDI  D
"RTN","SDPPTEM",181,0)
 .W !?(SDCOL),^TMP("SDTEMP",$J,SDI) Q
"RTN","SDPPTEM",182,0)
 Q
"RTN","SDPPTEM",183,0)
 ;
"RTN","SDPPTEM",184,0)
PCLINE(DFN,SDATE) ;PC provider, associate and team in a single line
"RTN","SDPPTEM",185,0)
 ;Input: DFN=patient ifn
"RTN","SDPPTEM",186,0)
 ;Input: SDATE=effective date (optional)
"RTN","SDPPTEM",187,0)
 ;Output: PC provider, associate and team formatted as 80 character
"RTN","SDPPTEM",188,0)
 ;        line, or "" if none
"RTN","SDPPTEM",189,0)
 ;
"RTN","SDPPTEM",190,0)
 N SDLIST,SDI,SDX,SDY,SDZ,SDL,SDC,SDTL
"RTN","SDPPTEM",191,0)
 Q:'DFN ""  S:$G(SDATE)<1 SDATE=DT S SDLIST="^TMP(""SDPLIST"",$J)"
"RTN","SDPPTEM",192,0)
 F SDI="BEGIN","END" S SDATE(SDI)=SDATE
"RTN","SDPPTEM",193,0)
 S SDATE="SDATE"
"RTN","SDPPTEM",194,0)
 S SDI=$$GETALL^SCAPMCA(DFN,.SDATE,SDLIST)
"RTN","SDPPTEM",195,0)
 S SDY="PC Prov: ^Assoc. Prov: ^Team: ",SDL=48,SDC=3,SDTL=0
"RTN","SDPPTEM",196,0)
 S SDX(1)=$$PCL("PCPR")
"RTN","SDPPTEM",197,0)
 S SDX(2)=$$PCL("PCAP")
"RTN","SDPPTEM",198,0)
 S SDX(3)=$$PCL("PCTM")
"RTN","SDPPTEM",199,0)
 K ^TMP("SDPLIST",$J,DFN)
"RTN","SDPPTEM",200,0)
 F SDI=1,2,3 S SDZ($L(SDX(SDI)),SDI)=""
"RTN","SDPPTEM",201,0)
 S SDI="" F  S SDI=$O(SDZ(SDI)) Q:SDI=""  D
"RTN","SDPPTEM",202,0)
 .S SDII=0 F  S SDII=$O(SDZ(SDI,SDII)) Q:'SDII  D
"RTN","SDPPTEM",203,0)
 ..I 'SDI S SDC=SDC-1 Q
"RTN","SDPPTEM",204,0)
 ..I SDI<(SDL\SDC) S SDX(SDII)=$P(SDY,U,SDII)_SDX(SDII),SDL=SDL-SDI,SDC=SDC-1 Q
"RTN","SDPPTEM",205,0)
 ..S SDX(SDII)=$P(SDY,U,SDII)_$E(SDX(SDII),1,(SDL\SDC))
"RTN","SDPPTEM",206,0)
 ..Q
"RTN","SDPPTEM",207,0)
 .Q
"RTN","SDPPTEM",208,0)
 F SDI=1,2,3 S SDTL=SDTL+$L(SDX(SDI))
"RTN","SDPPTEM",209,0)
 Q:SDTL=0 ""
"RTN","SDPPTEM",210,0)
 S SDX=SDX(1),$E(SDX,($L(SDX)+1+(80-SDTL\2)))=SDX(2),$E(SDX,81-$L(SDX(3)))=SDX(3)
"RTN","SDPPTEM",211,0)
 Q SDX
"RTN","SDPPTEM",212,0)
 ;
"RTN","SDPPTEM",213,0)
PCL(SDSUB) ;Get name value
"RTN","SDPPTEM",214,0)
 ;Input: SDSUB=node from GETALL^SCAPMCA
"RTN","SDPPTEM",215,0)
 N SDN
"RTN","SDPPTEM",216,0)
 S SDN=+$G(^TMP("SDPLIST",$J,DFN,"PCPOS",0))
"RTN","SDPPTEM",217,0)
 Q:SDN=0 ""
"RTN","SDPPTEM",218,0)
 Q:SDN>1 "[ambiguous data]"
"RTN","SDPPTEM",219,0)
 S SDN=+$G(^TMP("SDPLIST",$J,DFN,SDSUB,0))
"RTN","SDPPTEM",220,0)
 Q:SDN=0 ""
"RTN","SDPPTEM",221,0)
 Q:SDN>1 "[ambiguous data]"
"RTN","SDPPTEM",222,0)
 Q $P($G(^TMP("SDPLIST",$J,DFN,SDSUB,1)),U,2)
"RTN","SDWLD")
0^34^B24813208
"RTN","SDWLD",1,0)
SDWLD ;;IOFO BAY PINES/TEH - DISPLAY PENDING APPOINTMENTS;06/12/2002 ; 20 Aug 2002  2:10 PM  ; Compiled September 25, 2006 13:39:47
"RTN","SDWLD",2,0)
 ;;5.3;scheduling;**263,454,417,446**;AUG 13 1993;Build 3
"RTN","SDWLD",3,0)
 ;
"RTN","SDWLD",4,0)
 ;
"RTN","SDWLD",5,0)
 ;*********************************************************
"RTN","SDWLD",6,0)
 ;                                               CHANGE LOG
"RTN","SDWLD",7,0)
 ;                                               
"RTN","SDWLD",8,0)
 ;   DATE                        PATCH                   DESCRIPTION
"RTN","SDWLD",9,0)
 ;   ----                        -----                   -----------
"RTN","SDWLD",10,0)
 ;   
"RTN","SDWLD",11,0)
 ;   
"RTN","SDWLD",12,0)
 ;   ;ENTRY POINT FOR OPTION CALL
"RTN","SDWLD",13,0)
 ;
"RTN","SDWLD",14,0)
 ;       SDWLDFN = PATIENT IEN
"RTN","SDWLD",15,0)
 ;       SDWLSSN = PATIENT SSN
"RTN","SDWLD",16,0)
 ;       SDWLNAM = PATIENT NAME
"RTN","SDWLD",17,0)
 ;       
"RTN","SDWLD",18,0)
 ;    ;Patch SD*5.3*417 Display Team when displaying Position.   
"RTN","SDWLD",19,0)
 ;       
"RTN","SDWLD",20,0)
EN(SDWLDFN,SDWLSSN,SDWLNAM,SDTP) ;ENTRY POINT - INTIALIZE VARIABLES
"RTN","SDWLD",21,0)
 ;SDTP (optional) - EWL ENTRY STATUS
"RTN","SDWLD",22,0)
 I $G(SDTP)="" S SDTP="O"
"RTN","SDWLD",23,0)
 I SDTP'="O"&(SDTP'="C") Q  ;
"RTN","SDWLD",24,0)
 K ^TMP("SDWLD",$J) I $D(^SDWL(409.3,"B",SDWLDFN)) D
"RTN","SDWLD",25,0)
 .D GETDATA(SDTP)
"RTN","SDWLD",26,0)
 .Q:'SDWLCNT
"RTN","SDWLD",27,0)
 .D HD1
"RTN","SDWLD",28,0)
 .D DIS
"RTN","SDWLD",29,0)
 .D HD2
"RTN","SDWLD",30,0)
 .D DISPD
"RTN","SDWLD",31,0)
 Q
"RTN","SDWLD",32,0)
GETDATA(SDTP) ;GET PATIENT DATA FROM SD WAIT LIST FILE (^SDWL(409.3) 
"RTN","SDWLD",33,0)
 ;SDTP - EWL entry status
"RTN","SDWLD",34,0)
 ;       O - open
"RTN","SDWLD",35,0)
 ;       C - closed
"RTN","SDWLD",36,0)
 N SDWLWTE S SDWLCNT=0,SDWLWTE=0 D
"RTN","SDWLD",37,0)
 .I SDTP="C" N SDDENT,SDBEG,SDEND D SEL1(.SDDENT) D  I +SDDENT=0 Q  ;return 'begin^end' entry day 
"RTN","SDWLD",38,0)
 ..I +SDDENT=0 W !,"Entry Date range required for closed EWL selection" Q
"RTN","SDWLD",39,0)
 ..S SDBEG=$P(SDDENT,U),SDEND=$P(SDDENT,U,2)
"RTN","SDWLD",40,0)
 .S SDWLDA=0 F  S SDWLDA=$O(^SDWL(409.3,"B",SDWLDFN,SDWLDA)) Q:SDWLDA=""  D
"RTN","SDWLD",41,0)
 ..S SDWLDATA=$G(^SDWL(409.3,SDWLDA,0))
"RTN","SDWLD",42,0)
 ..;
"RTN","SDWLD",43,0)
 ..I $P(SDWLDATA,U,17)'[SDTP Q
"RTN","SDWLD",44,0)
 ..I $D(^SDWL(409.3,"ST",SDWLDA)) S SDWLWTE=1
"RTN","SDWLD",45,0)
 ..I $D(^SDWL(409.3,"SP",SDWLDA)) S SDWLPOS=1
"RTN","SDWLD",46,0)
 ..S SDWLDT=$P(SDWLDATA,U,2) I SDTP="C" I SDWLDT<SDBEG!(SDWLDT>SDEND) Q
"RTN","SDWLD",47,0)
 ..S SDWLCL=$P(SDWLDATA,U,4) I SDWLDT="" Q
"RTN","SDWLD",48,0)
 ..S SDWLCLN="" I $D(^SC(+SDWLCL,0)) S SDWLCLN=$E($P($G(^SC(SDWLCL,0)),U,2),1,6) I SDWLCLN="" Q
"RTN","SDWLD",49,0)
 ..S SDWLCNT=SDWLCNT+1,^TMP("SDWLD",$J,SDWLDFN,SDWLCNT)=SDWLDATA_"~"_SDWLDA,^TMP("SDWLD",$J,"B",SDWLCNT,SDWLDFN,SDWLDT,SDWLDA)=""
"RTN","SDWLD",50,0)
 ..K SDWLDATA
"RTN","SDWLD",51,0)
 Q
"RTN","SDWLD",52,0)
SEL1(SDDENT) K DIR,%DT(0) S SDWLDISC="",%DT="AE",%DT("A")="Start with Date Entered: " D ^%DT N SDWLBDT S SDWLBDT=Y I Y<1 S SDDENT="^" Q
"RTN","SDWLD",53,0)
 S %DT(0)=SDWLBDT,%DT("A")="End with Date Entered: " D ^%DT D SEL1(.SDDENT):Y<1 S SDWLEDT=Y K %DT(0),%DT("A")
"RTN","SDWLD",54,0)
 S SDDENT=SDWLBDT_U_SDWLEDT
"RTN","SDWLD",55,0)
DIS ;DISPLAY PATIENT DATA
"RTN","SDWLD",56,0)
 W !,?5,SDWLNAM,?35,SDWLSSN,!
"RTN","SDWLD",57,0)
 I $G(SDTP)'="C" W !,"Patient Currently is on Waiting List for the Following",!
"RTN","SDWLD",58,0)
 E  W !,"Patient is on closed Waiting List for the Following",!
"RTN","SDWLD",59,0)
 Q
"RTN","SDWLD",60,0)
DISPD ;DISPLAY WAIT LIST DATA  
"RTN","SDWLD",61,0)
 S (SDWLDT,SDWLCNT,SDWLCN)=""
"RTN","SDWLD",62,0)
 F  S SDWLCNT=$O(^TMP("SDWLD",$J,SDWLDFN,SDWLCNT)) Q:SDWLCNT=""  D
"RTN","SDWLD",63,0)
 .S X=$G(^TMP("SDWLD",$J,SDWLDFN,SDWLCNT)),SDWLDA=$P(X,"~",2),SDWLIN=$P(X,U,3),SDWLCL=$P(X,U,4),SDWLTY=$P(X,U,5),SDWLPRI=$P(X,U,11)
"RTN","SDWLD",64,0)
 .N SDWLDSP,SDWLSCO,SDWLSPO,SDWLSSO,SDWLSTO S SDWLDSP=$P(X,U,17)
"RTN","SDWLD",65,0)
 .S SDWLDT=$P(X,U,2),SDWLTYN=$$EXTERNAL^DILFD(409.3,4,,SDWLTY),SDWLPRIN=$$EXTERNAL^DILFD(409.3,10,,SDWLPRI)
"RTN","SDWLD",66,0)
 .S SDWLSTO=$P(X,U,22),SDWLSPO=$P(X,U,23),SDWLSSO=$P(X,U,24),SDWLSCO=$P(X,U,25)
"RTN","SDWLD",67,0)
 .S SDWLST=$P(X,U,6),SDWLSP=$P(X,U,7),SDWLSS=$P(X,U,8),SDWLSC=$P(X,U,9),SDWLWR="" D
"RTN","SDWLD",68,0)
 ..I SDWLST'="" S SDWLWR=$$EXTERNAL^DILFD(409.3,5,,SDWLST)
"RTN","SDWLD",69,0)
 ..I SDWLSTO["Y" S SDWLWR="OPEN"
"RTN","SDWLD",70,0)
 ..;SD*5.3*417
"RTN","SDWLD",71,0)
 ..I SDWLSP'="" S SDWLWR=$$EXTERNAL^DILFD(409.3,6,,SDWLSP) D
"RTN","SDWLD",72,0)
 ...I $D(^SCTM(404.57,SDWLSP)) S SDWLX=$P($G(^SCTM(404.57,SDWLSP,0)),U,2),SDWLX=$E($P($G(^SCTM(404.51,SDWLX,0)),U,1),1,10),SDWLWR=SDWLWR_" ("_SDWLX_")"
"RTN","SDWLD",73,0)
 ..I SDWLSPO["Y" S SDWLWR="OPEN"
"RTN","SDWLD",74,0)
 ..I SDWLSS'="" S SDWLWR=$$EXTERNAL^DILFD(409.3,7,,SDWLSS)
"RTN","SDWLD",75,0)
 ..I SDWLSSO["Y" S SDWLWR="OPEN"
"RTN","SDWLD",76,0)
 ..I SDWLSC'="" S SDWLWR=$$EXTERNAL^DILFD(409.3,8,,SDWLSC)
"RTN","SDWLD",77,0)
 ..I SDWLSCO["^" S SDWLWR="OPEN"
"RTN","SDWLD",78,0)
 .N YY,MM,DD S YY=$E(SDWLDT,1,3)+1700,YY=$E(YY,3,4),MM=$E(SDWLDT,4,5),DD=$E(SDWLDT,6,7),SDWLDTP=MM_DD_YY
"RTN","SDWLD",79,0)
 .S SDWLCLN="" I $D(^SC(+SDWLCL,0)) S SDWLCLN=$$GET1^DIQ(44,SDWLCL_",",1,,)
"RTN","SDWLD",80,0)
 .S SDWLINN=$E($P($G(^DIC(4,+SDWLIN,0)),U,1),1,8)
"RTN","SDWLD",81,0)
 .N SDWLDIS S SDWLDIS=$P($G(^SDWL(409.3,SDWLDA,"DIS")),U,3),SDWLDISN=$$EXTERNAL^DILFD(409.3,21,,SDWLDIS)
"RTN","SDWLD",82,0)
 .S SDWLCN=SDWLCN+1
"RTN","SDWLD",83,0)
 .W !,$J(SDWLCN,2)_".",?5,$E(SDWLTYN,1,14),?22,SDWLPRI,?25,$E(SDWLWR,1,19),?51,$E(SDWLINN,1,14) W:$D(SDWLDISC) ?67,SDWLDSP
"RTN","SDWLD",84,0)
 .W ?73,SDWLDTP
"RTN","SDWLD",85,0)
 K SDWLDT,SDWLIN,SDWLCL,SDWLTY,SDWLPRI,SDWLPRIN,SDWLTYN,SDWLST,SDWLSP,SDWLSS,SDWLSC,SDWLCLN,SDWLDTP,SDWLINN,SDWLDA,SDWLDISN
"RTN","SDWLD",86,0)
 K SDWLPRI,SDWLWR
"RTN","SDWLD",87,0)
 Q
"RTN","SDWLD",88,0)
HD1 ;TOF HEADER INFORMATION
"RTN","SDWLD",89,0)
 I '$D(SDWLHDR) S SDWLHDR="Wait List Display"
"RTN","SDWLD",90,0)
 W !!,?80-$L(SDWLHDR_$S($D(SDWLOP):" - "_SDWLOP,1:""))\2,SDWLHDR W:$D(SDWLOP) " - ",SDWLOP  ;SD*5.3*454 removed page feed
"RTN","SDWLD",91,0)
 W !
"RTN","SDWLD",92,0)
 Q
"RTN","SDWLD",93,0)
HD2 ;DATA HEADER
"RTN","SDWLD",94,0)
 W !," #",?4,"Wait List Type",?22,"P",?26,"Waiting",?51,"Institution" W:$D(SDWLDISC) ?65,"Status"
"RTN","SDWLD",95,0)
 W ?74,"Date"
"RTN","SDWLD",96,0)
 W !,?28,"For",?73,"Entered"
"RTN","SDWLD",97,0)
 Q
"RTN","SDWLDISP")
0^35^B62805335
"RTN","SDWLDISP",1,0)
SDWLDISP ;;IOFO BAY PINES/TEH - WAIT LIST - DISPOSITION WAIT LIST ENTRY;06/12/2002 ; 20 Aug 2002  2:10 PM  ; Compiled January 26, 2007 10:21:25
"RTN","SDWLDISP",2,0)
 ;;5.3;scheduling;**263,273,427,454,446**;AUG 13 1993;Build 3
"RTN","SDWLDISP",3,0)
 ;
"RTN","SDWLDISP",4,0)
 ;
"RTN","SDWLDISP",5,0)
 ;******************************************************************
"RTN","SDWLDISP",6,0)
 ;                             CHANGE LOG
"RTN","SDWLDISP",7,0)
 ;                                               
"RTN","SDWLDISP",8,0)
 ;   DATE                        PATCH                   DESCRIPTION
"RTN","SDWLDISP",9,0)
 ;   ----                        -----                   -----------
"RTN","SDWLDISP",10,0)
 ;  11/19/2002                 SD*5.3*273              EN1+4 CHECK FOR "^"
"RTN","SDWLDISP",11,0)
 ;  11/19/2002                 SD*5.3*273              REMOVED DIC("S") SCREEN FROM PAT
"RTN","SDWLDISP",12,0)
 ;  08/07/2008                 SD*5.3*446              check out EWL if DFN defined
"RTN","SDWLDISP",13,0)
 ;  04/12/2006                 SD*5.3*446              Inter-facility transfer/New Disposition type: CL
"RTN","SDWLDISP",14,0)
 ;
"RTN","SDWLDISP",15,0)
 ;
"RTN","SDWLDISP",16,0)
 ;
"RTN","SDWLDISP",17,0)
EN ;
"RTN","SDWLDISP",18,0)
 S SDWLERR=0
"RTN","SDWLDISP",19,0)
 I $D(SDWLLIST),SDWLLIST D
"RTN","SDWLDISP",20,0)
 .I $G(DFN)'>0 S SDWLERR=1 Q
"RTN","SDWLDISP",21,0)
 .I $D(DFN),'$D(^SDWL(409.3,"B",DFN)) D HD,1^VADPT,DEM^VADPT W !,VADM(1),?40,VA("PID"),*7,!,"This Patient has NO entries on the Electronic Wait List." S DIR(0)="E" D ^DIR S DUOUT=1 Q
"RTN","SDWLDISP",22,0)
 I $D(DUOUT) Q
"RTN","SDWLDISP",23,0)
 I 'SDWLERR,$D(SDWLLIST),SDWLLIST D HD S SDWLDFN=DFN K DIR,DIC,DR,DIE,VADM D 1^VADPT,DEM^VADPT W !,VADM(1),?40,VA("PID") S (SDWLBDT,SDWLEDT)="" D DIS G EN1
"RTN","SDWLDISP",24,0)
 K DIR,DIC,DR,DIE
"RTN","SDWLDISP",25,0)
 ;OPTION HEADER
"RTN","SDWLDISP",26,0)
 ;
"RTN","SDWLDISP",27,0)
 S SDWLOP=" - Disposition Patient" D HD
"RTN","SDWLDISP",28,0)
 ;
"RTN","SDWLDISP",29,0)
 ;PATIENT LOOK-UP FROM WAIT LIST PATIENT FILE (^SDWL(409.3,IEN,0).
"RTN","SDWLDISP",30,0)
 ;
"RTN","SDWLDISP",31,0)
 D PAT G END:'$D(SDWLDFN),END:SDWLDFN<0,END:SDWLDFN=""
"RTN","SDWLDISP",32,0)
 ;
"RTN","SDWLDISP",33,0)
 ;DISPLAY PATIENT DATA FROM ^SDWL(409.3,IEN,0).
"RTN","SDWLDISP",34,0)
 ;
"RTN","SDWLDISP",35,0)
 D DIS
"RTN","SDWLDISP",36,0)
 ;PROMPT USER FOR RECORD FOR DISPOSITIONING.
"RTN","SDWLDISP",37,0)
 ;
"RTN","SDWLDISP",38,0)
EN1 K DIR,DIC,DIE,DR,X,Y,SDWLERR S SDWLPS=$S(SDWLCN>1:1,SDWLCN=1:2,1:0),SDWLERR=0
"RTN","SDWLDISP",39,0)
 I SDWLPS=0 W !!,"Patient has no Wait List Entries to Disposition." S DIR(0)="E" D ^DIR G END
"RTN","SDWLDISP",40,0)
 I SDWLPS=1 S DIR(0)="FOA^^" S DIR("A")="Select Wait List (1-"_SDWLCN_") or '^' to Quit? "
"RTN","SDWLDISP",41,0)
 I SDWLPS=2 S DIR(0)="FOA^^" S DIR("A")="Disposition This 'ENTRY' or '^' to Quit? Yes // "
"RTN","SDWLDISP",42,0)
 W ! D ^DIR G END:X["^" S SDWLY=Y W !
"RTN","SDWLDISP",43,0)
 I SDWLPS=1 D
"RTN","SDWLDISP",44,0)
 .S SDWLERR=$S(X?1N.N:0,X?1"N".E:1,X?1"n".E:1,X="":1,X?1"Y".E:0,X?1"y".E:0,$D(DUOUT):1,X["^":1,1:2)
"RTN","SDWLDISP",45,0)
 I $D(SDWLERR),SDWLERR=2 W *7," Invalid Entry" G EN1
"RTN","SDWLDISP",46,0)
 I SDWLPS=2 D
"RTN","SDWLDISP",47,0)
 .S SDWLERR=$S(X="":0,X?1"Y".E:0,X?1"y":0,X?1"N".E:1,X?1"n".E:1,X["^":1,1:2)
"RTN","SDWLDISP",48,0)
 I SDWLERR=2 W *7," Invalid Entry" G EN1
"RTN","SDWLDISP",49,0)
 G END:SDWLERR
"RTN","SDWLDISP",50,0)
 I SDWLPS=2,'SDWLY S SDWLY=1
"RTN","SDWLDISP",51,0)
 S SDWLERR=0 I SDWLY?1N.N D  G EN1:SDWLERR
"RTN","SDWLDISP",52,0)
 .K DIR,DIC,DR
"RTN","SDWLDISP",53,0)
 .;
"RTN","SDWLDISP",54,0)
 .;CHECK FOR VALID ENTRY
"RTN","SDWLDISP",55,0)
 .;
"RTN","SDWLDISP",56,0)
 .I '$D(^TMP("SDWLD",$J,SDWLDFN,+SDWLY)) W " Invalid Entry " S SDWLERR=1 Q
"RTN","SDWLDISP",57,0)
 .S SDWLDA=$P($G(^TMP("SDWLD",$J,SDWLDFN,+SDWLY)),"~",2)
"RTN","SDWLDISP",58,0)
 .;
"RTN","SDWLDISP",59,0)
 .;LOCK DATA FILE
"RTN","SDWLDISP",60,0)
 .;
"RTN","SDWLDISP",61,0)
 .L ^SDWL(409.3,SDWLDA):5 I '$T W !,"Another User is Editing this Entry. Try Later." S DUOUT=1
"RTN","SDWLDISP",62,0)
 I $D(DUOUT) G END
"RTN","SDWLDISP",63,0)
 ;
"RTN","SDWLDISP",64,0)
 ;GET PATIENT DATA FROM ^SDWL(409.3,IEN,0).
"RTN","SDWLDISP",65,0)
 ;
"RTN","SDWLDISP",66,0)
 D GETDATA
"RTN","SDWLDISP",67,0)
 ;
"RTN","SDWLDISP",68,0)
 ;ENTER DISPOSITION
"RTN","SDWLDISP",69,0)
 ;  
"RTN","SDWLDISP",70,0)
 D EDIT G END:$D(DUOUT) I $D(SDWLERR) G END:SDWLERR
"RTN","SDWLDISP",71,0)
 W !,"*** Patient has been removed from Wait List. ***"
"RTN","SDWLDISP",72,0)
 K DIR,DIE,DR,DIC
"RTN","SDWLDISP",73,0)
 S DIR(0)="E" D ^DIR I $D(DUOUT) G END
"RTN","SDWLDISP",74,0)
 D END G EN
"RTN","SDWLDISP",75,0)
 ;
"RTN","SDWLDISP",76,0)
 Q
"RTN","SDWLDISP",77,0)
PAT ;PATIENT LOOK-UP
"RTN","SDWLDISP",78,0)
 ;
"RTN","SDWLDISP",79,0)
 S DIC(0)="EMNAQ",DIC=409.3 D ^DIC S (SDWLDFN,DFN)=$P(Y,U,2) G PAT1:DFN<0
"RTN","SDWLDISP",80,0)
 G PAT1:DFN=""
"RTN","SDWLDISP",81,0)
 S SDWLNAM=$$GET1^DIQ(2,DFN_",",.01)
"RTN","SDWLDISP",82,0)
 S X=$$GET1^DIQ(2,DFN_",",".351") I X'="" W !!,*7,"PATIENT'S DATE OF DEATH HAS BEEN RECORDED"  ;SD*5.3*454 allow user to disposition deceased patient
"RTN","SDWLDISP",83,0)
 D 1^VADPT
"RTN","SDWLDISP",84,0)
PAT1 Q
"RTN","SDWLDISP",85,0)
 ;
"RTN","SDWLDISP",86,0)
DIS ;DISPLAY DATA FOR PATIENT
"RTN","SDWLDISP",87,0)
 ;
"RTN","SDWLDISP",88,0)
 S SDWLDISC="",SDWLCN=0,SDWLHDR="Wait List Disposition"
"RTN","SDWLDISP",89,0)
 D EN^SDWLD(SDWLDFN,VA("PID"),VADM(1))
"RTN","SDWLDISP",90,0)
 K VADM,VAIN,VA,SDWLDISC
"RTN","SDWLDISP",91,0)
 Q
"RTN","SDWLDISP",92,0)
GETDATA ;PATIENT DATA RETRIEVAL
"RTN","SDWLDISP",93,0)
 ;
"RTN","SDWLDISP",94,0)
 S SDWLDATA=$G(^SDWL(409.3,SDWLDA,0))
"RTN","SDWLDISP",95,0)
 S SDWLIN=$P(SDWLDATA,U,3),SDWLCL=+$P(SDWLDATA,U,4),SDWLTY=$P(SDWLDATA,U,5),SDWLST=$P(SDWLDATA,U,6)
"RTN","SDWLDISP",96,0)
 S SDWLSP=$P(SDWLDATA,U,7),SDWLSS=$P(SDWLDATA,U,8),SDWLSC=$P(SDWLDATA,U,9),SDWLPRI=$P(SDWLDATA,U,10),SDWLRB=$P(SDWLDATA,U,11)
"RTN","SDWLDISP",97,0)
 S SDWLPROV=$P(SDWLDATA,U,12),SDWLDAPT=$P(SDWLDATA,U,16),SDWLST=$P(SDWLDATA,U,17),SDWLDUZ=DUZ,SDWLEDT=DT
"RTN","SDWLDISP",98,0)
 S SDWLSCL="" I SDWLSC S SDWLSCL=+$P(^SDWL(409.32,SDWLSC,0),U,1)
"RTN","SDWLDISP",99,0)
 I $D(^SDWL(409.3,SDWLDA,"DIS")) S SDWLDISP=$P(^SDWL(409.3,SDWLDA,"DIS"),U,3)
"RTN","SDWLDISP",100,0)
 Q
"RTN","SDWLDISP",101,0)
EDIT ;ENTER/EDIT DISPOSITION
"RTN","SDWLDISP",102,0)
 ;
"RTN","SDWLDISP",103,0)
 S SDWLDUZ=DUZ,SDWLERR=0 N DIR,DR,DIE,DIC,DA
"RTN","SDWLDISP",104,0)
 I $D(SDWLDISP) S DIR("B")=$$EXTERNAL^DILFD(409.3,21,,SDWLDISP)
"RTN","SDWLDISP",105,0)
 S DIR(0)="SO^D:DEATH;NC:REMOVED/NON-VA CARE;SA:REMOVED/SCHEDULED-ASSIGNED;CC:REMOVED/VA CONTRACT CARE;NN:REMOVED/NO LONGER NECESSARY;ER:ENTERED IN ERROR;CL:CLINIC CHANGE^"
"RTN","SDWLDISP",106,0)
 S DIR("L",1)="Disposition Reason:",DIR("L",2)="",DIR("L",3)="D DEATH",DIR("L",4)="NC REMOVED/NON-VA CARE",DIR("L",5)="SA REMOVED/SCHEDULED-ASSIGNED"
"RTN","SDWLDISP",107,0)
 S DIR("L",6)="CC REMOVED/VA CONTRACT CARE",DIR("L",7)="NN REMOVED/NO LONGER NECESSARY",DIR("L")="ER ENTERED IN ERROR"
"RTN","SDWLDISP",108,0)
 S:SDWLTY=4 DIR("L",8)="CL CLINIC CHANGE"
"RTN","SDWLDISP",109,0)
 D ^DIR
"RTN","SDWLDISP",110,0)
 I X="" S DUOUT=1 Q
"RTN","SDWLDISP",111,0)
 I X="^" S DUOUT=1 Q
"RTN","SDWLDISP",112,0)
 ;S SDWLDISP=$S(X["D":"D",X["d":"D",X["NC":"NC",X["nc":"NC",X["SA":"SA",X["sa":"SA",X["CC":"CC",X["cc":"CC",X["NN":"NN",X["nn":"NN",X["ER":"ER",X["er":"ER",1:0)
"RTN","SDWLDISP",113,0)
 ;I SDWLDISP=0 S SDWLERR=1
"RTN","SDWLDISP",114,0)
 S SDWLDISP=$TR(X,"acdelnrst","ACDELNRST") S:"^D^NC^SA^CC^NN^ER^TR^"_$S(SDWLTY=4:"CL^",1:"")'[("^"_SDWLDISP_"^") SDWLERR=1
"RTN","SDWLDISP",115,0)
 I SDWLERR W *7,"Invalid Entry" G EDIT
"RTN","SDWLDISP",116,0)
 I SDWLDISP="SA" I "3,4"[SDWLTY D PKAPP(SDWLDA,SDWLTY,.SDWLDATA) Q  ; QUIT OR NOT?
"RTN","SDWLDISP",117,0)
 I SDWLDISP="CL" S SDWLERR=$$EN^SDWLE7 Q:SDWLERR  ; OG ; 446
"RTN","SDWLDISP",118,0)
 S DIE("NO^")="NO EDITING"
"RTN","SDWLDISP",119,0)
 S DIE="^SDWL(409.3,",DA=SDWLDA,DR="21////^S X=SDWLDISP" D ^DIE
"RTN","SDWLDISP",120,0)
 S DR="19////^S X=DT" D ^DIE
"RTN","SDWLDISP",121,0)
 S DR="20////^S X=SDWLDUZ" D ^DIE
"RTN","SDWLDISP",122,0)
 S DR="23////^S X=""C""" D ^DIE
"RTN","SDWLDISP",123,0)
 I SDWLSCL K:$D(^SDWL(409.3,"SC",SDWLSCL,SDWLDA)) ^SDWL(409.3,"SC",SDWLSCL,SDWLDA)
"RTN","SDWLDISP",124,0)
 I SDWLSS K:$D(^SDWL(409.3,"SS",SDWLDFN,SDWLSS,SDWLDA)) ^SDWL(409.3,"SS",SDWLDFN,SDWLSS,SDWLDA)
"RTN","SDWLDISP",125,0)
 ; OG ; SD*5.3*446 Inter-facility transfer.
"RTN","SDWLDISP",126,0)
 D DIS^SDWLE6(SDWLDA)
"RTN","SDWLDISP",127,0)
 Q
"RTN","SDWLDISP",128,0)
PKAPP(SDWLDA,SDWLTY,SDWLDATA) ;identify appointemnt to close with
"RTN","SDWLDISP",129,0)
 ;SDWLDA -ien OF 409.3 to be closed
"RTN","SDWLDISP",130,0)
 ;SDWLTY - type of EWL entry
"RTN","SDWLDISP",131,0)
 ;SDWLDATA - 0 node of SDWLDA
"RTN","SDWLDISP",132,0)
 N SDCL,SDSP,SDORG,SDPCL,SDPSP S (SDCL,SDSP)="" N PROC S PROC=1
"RTN","SDWLDISP",133,0)
 S SDPCL=$$GET1^DIQ(409.3,SDWLDA_",",8,"I"),SDPSP=$$GET1^DIQ(409.3,SDWLDA_",",7,"I")
"RTN","SDWLDISP",134,0)
 I SDWLTY=4 S SDCL=$$GET1^DIQ(409.32,SDPCL_",",.01,"I")
"RTN","SDWLDISP",135,0)
 I SDWLTY=3 S SDSP=$$GET1^DIQ(409.31,SDPSP_",",.01,"I")
"RTN","SDWLDISP",136,0)
 S SDORG=$$GET1^DIQ(409.3,SDWLDA_",",1,"I")
"RTN","SDWLDISP",137,0)
 ;display app/encounters
"RTN","SDWLDISP",138,0)
 N SDDS,SDAP S SDDS=$$CHKENC^SDWLQSC1(DFN,SDORG,SDCL,SDSP,PROC)
"RTN","SDWLDISP",139,0)
 I SDWLDISP="SA" D
"RTN","SDWLDISP",140,0)
 .I $O(^TMP($J,"APPT",""))=$O(^TMP($J,"APPT",""),-1) S SDAP=$O(^TMP($J,"APPT","")) D  Q
"RTN","SDWLDISP",141,0)
 ..Q:SDAP=""
"RTN","SDWLDISP",142,0)
 ..D APPTD^SDWLEVAL D SING(SDWLDA,SDWLTY,SDWLDATA)
"RTN","SDWLDISP",143,0)
 .I $O(^TMP($J,"APPT",""))'=$O(^TMP($J,"APPT",""),-1) D APPTD^SDWLEVAL D  I SDAP="^" W !,"Disposition canceled by user",! Q
"RTN","SDWLDISP",144,0)
 ..W ! K DIR,X
"RTN","SDWLDISP",145,0)
 ..N STR,SS,SDA S SDA=$O(^TMP($J,"APPT",""),-1) I SDA=1 S DIR("B")=1
"RTN","SDWLDISP",146,0)
 ..S DIR(0)="N^1:"_SDA S DIR("A")="Select appt for Removal Reason or '^' to Quit>",DIR("?")="Select Appointment to close with the open EWL."
"RTN","SDWLDISP",147,0)
 ..D ^DIR
"RTN","SDWLDISP",148,0)
 ..S SDAP=X Q:X="^"!'X  D SING(SDWLDA,SDWLTY,SDWLDATA)
"RTN","SDWLDISP",149,0)
 Q:SDAP="^"  ;should we allow to quit or to proceed without filing an appointment?
"RTN","SDWLDISP",150,0)
 S DIE="^SDWL(409.3,",DA=SDWLDA,DR="21////^S X=SDWLDISP" D ^DIE
"RTN","SDWLDISP",151,0)
 S DR="19////^S X=DT" D ^DIE
"RTN","SDWLDISP",152,0)
 S DR="20////^S X=SDWLDUZ" D ^DIE
"RTN","SDWLDISP",153,0)
 S DR="23////^S X=""C""" D ^DIE
"RTN","SDWLDISP",154,0)
 Q
"RTN","SDWLDISP",155,0)
SING(SDWLDA,SDWLTY,SDWLDATA) ;called for filing with appointment if any
"RTN","SDWLDISP",156,0)
 S DIE="^SDWL(409.3,",DA=SDWLDA,DR="21////^S X=SDWLDISP" D ^DIE
"RTN","SDWLDISP",157,0)
 S DR="19////^S X=DT" D ^DIE
"RTN","SDWLDISP",158,0)
 S DR="20////^S X=SDWLDUZ" D ^DIE
"RTN","SDWLDISP",159,0)
 S DR="23////^S X=""C""" D ^DIE
"RTN","SDWLDISP",160,0)
 ;if "SA" update with appoint data
"RTN","SDWLDISP",161,0)
 ;get appt data to file (for a particular appt #)
"RTN","SDWLDISP",162,0)
 I SDWLDISP="SA" N SDA D DATP^SDWLEVAL(SDAP,.SDA) D
"RTN","SDWLDISP",163,0)
 .I $D(SDA) S DIE="^SDWL(409.3,",DA=SDWLDA D
"RTN","SDWLDISP",164,0)
 ..S DR="13////"_SDA(1)_";13.1////"_DT_";13.2////"_SDA(2)_";13.3////"_SDA(15)_";13.4////"_SDA(13)_";13.5////"_SDA(14)_";13.6////"_SDA(16)_";13.8////"_SDA(3)_";13.7////"_DUZ
"RTN","SDWLDISP",165,0)
 ..D ^DIE
"RTN","SDWLDISP",166,0)
 N SDWLSCL,SDWLSS,SDWLDFN
"RTN","SDWLDISP",167,0)
 S SDWLSCL=$P(SDWLDATA,U,9)
"RTN","SDWLDISP",168,0)
 ;S SDWLSCL=$P($G(^TMP($J,"SDWLPL",SDC)),U,9)
"RTN","SDWLDISP",169,0)
 S SDWLSS=$P(SDWLDATA,U,8)
"RTN","SDWLDISP",170,0)
 ;S SDWLSS=$P($G(^TMP($J,"SDWLPL",SDC)),U,10)
"RTN","SDWLDISP",171,0)
 I SDWLSCL K:$D(^SDWL(409.3,"SC",SDWLSCL,SDWLDA)) ^SDWL(409.3,"SC",SDWLSCL,SDWLDA)
"RTN","SDWLDISP",172,0)
 S SDWLDFN=$P($G(^TMP($J,"APPT",1)),U,4)
"RTN","SDWLDISP",173,0)
 I SDWLSS,SDWLDFN K:$D(^SDWL(409.3,"SS",SDWLDFN,SDWLSS,SDWLDA)) ^SDWL(409.3,"SS",SDWLDFN,SDWLSS,SDWLDA)
"RTN","SDWLDISP",174,0)
 Q
"RTN","SDWLDISP",175,0)
HD ;HEADER
"RTN","SDWLDISP",176,0)
 ;
"RTN","SDWLDISP",177,0)
 W:$D(IOF) @IOF W !!,?80-$L("Wait List - Disposition Patient")\2,"Wait List - Disposition Patient",!!
"RTN","SDWLDISP",178,0)
 ;
"RTN","SDWLDISP",179,0)
END ;QUIT OPTION
"RTN","SDWLDISP",180,0)
 K DIC,DIR,DR,DIE,SDWLDFN,DUOUT,SDWLSCL
"RTN","SDWLDISP",181,0)
 K SDWLCL,SDWSLCN,SDWLDA,SDWLDAPT,SDWLDATA,SDWLDFN,SDWLDISP,SDWLDUZ,SDWLEDT,SDWLERR,SDWLIN,SDWLNAM,SDWLOP,SDWLPRI
"RTN","SDWLDISP",182,0)
 K SDWLPROV,SDWLPS,SDWLRB,SDWLSC,SDWLSP,SDWLSS,SDWLST,SDWLTY,SDWLY,X,Y,SDWLHDR
"RTN","SDWLDISP",183,0)
 Q
"RTN","SDWLI")
0^36^B73452514
"RTN","SDWLI",1,0)
SDWLI ;BPOI/TEH - DISPLAY PENDING APPOINTMENTS;6/1/05
"RTN","SDWLI",2,0)
 ;;5.3;scheduling;**263,327,394,446,524,505**;08/13/93;Build 3
"RTN","SDWLI",3,0)
 ;
"RTN","SDWLI",4,0)
 ;
"RTN","SDWLI",5,0)
 ;******************************************************************
"RTN","SDWLI",6,0)
 ;                             CHANGE LOG
"RTN","SDWLI",7,0)
 ;                                               
"RTN","SDWLI",8,0)
 ;   DATE               PATCH          DESCRIPTION
"RTN","SDWLI",9,0)
 ;   ----             -----             -----------
"RTN","SDWLI",10,0)
 ;   04/22/2005      SD*5.3*327  DISPLAY APPOINTMENT INFORMATION
"RTN","SDWLI",11,0)
 ;   04/22/2005      SD*5.3*327  UNDEFINED ERROR HD+1
"RTN","SDWLI",12,0)
 ;   08/07/2006      SD*5.3*446  proceed only when DFN defined
"RTN","SDWLI",13,0)
 ;   04/14/2006      SD*5.3*446  INTER-FACILITY TRANSFER
"RTN","SDWLI",14,0)
 ;
"RTN","SDWLI",15,0)
 ;
"RTN","SDWLI",16,0)
EN ;NEW AND INITIALIZE VARIABLES
"RTN","SDWLI",17,0)
 S SDWLERR=0 N %DT,DD
"RTN","SDWLI",18,0)
 I $D(SDWLLIST),SDWLLIST D  Q:SDWLERR
"RTN","SDWLI",19,0)
 .I '$G(DFN) S SDWLERR=1 Q
"RTN","SDWLI",20,0)
 .I $D(DFN),DFN'="",'$D(^SDWL(409.3,"B",DFN)) D HD W *7,!,"This Patient has NO entries on the Electronic Wait List." S DIR(0)="E" D ^DIR S DUOUT=1 Q
"RTN","SDWLI",21,0)
 I $D(DUOUT) G END
"RTN","SDWLI",22,0)
 I 'SDWLERR,$D(SDWLLIST),SDWLLIST D 1^VADPT,DEM^VADPT S SDWLDFN=DFN D HD,SEL G END:$D(DUOUT) K DIR,DIC,DR,DIE,VADM S (SDWLBDT,SDWLEDT)="" K ^TMP("SDWLI",$J) G EN1
"RTN","SDWLI",23,0)
 K DIR,DIC,DR,DIE,VADM
"RTN","SDWLI",24,0)
 S (SDWLBDT,SDWLEDT)="" K ^TMP("SDWLI",$J)
"RTN","SDWLI",25,0)
 ;
"RTN","SDWLI",26,0)
 ;OPTION HEADER
"RTN","SDWLI",27,0)
 ;
"RTN","SDWLI",28,0)
 D HD
"RTN","SDWLI",29,0)
 ;
"RTN","SDWLI",30,0)
 ;PATIENT LOOK-UP FROM WAIT LIST PATIENT FILE (^SDWL(409.3,IEN,0).
"RTN","SDWLI",31,0)
 ;
"RTN","SDWLI",32,0)
 D SEL G EN:$D(DUOUT)
"RTN","SDWLI",33,0)
 D PAT Q:'$D(SDWLDFN)
"RTN","SDWLI",34,0)
 G END:SDWLDFN<0,END:SDWLDFN=""
"RTN","SDWLI",35,0)
 Q:$D(DUOUT)
"RTN","SDWLI",36,0)
EN1 K DIR,DIC,DR,DIE,SDWLDRG
"RTN","SDWLI",37,0)
 D GETFILE
"RTN","SDWLI",38,0)
 D DISP G EN:'$D(DUOUT)
"RTN","SDWLI",39,0)
 D END
"RTN","SDWLI",40,0)
 Q
"RTN","SDWLI",41,0)
PAT ;PATIENT LOOK-UP
"RTN","SDWLI",42,0)
 ;PATCH SD*5.3*524 - SET DIC("S") FOR SCREEN OF OPEN/CLOSED ENTRIES
"RTN","SDWLI",43,0)
 K DIC,DIC("S")
"RTN","SDWLI",44,0)
 I $D(SDWLY),SDWLY S DIC("S")="I $P(^SDWL(409.3,+Y,0),U,17)=""O"""
"RTN","SDWLI",45,0)
 S DIC(0)="EMNQA",DIC=409.3 D ^DIC S (SDWLDFN,DFN)=$P(Y,U,2)
"RTN","SDWLI",46,0)
 G PATEND:SDWLDFN=""
"RTN","SDWLI",47,0)
 Q:Y<0
"RTN","SDWLI",48,0)
 Q:$D(DUOUT)
"RTN","SDWLI",49,0)
 D 1^VADPT
"RTN","SDWLI",50,0)
PATEND Q
"RTN","SDWLI",51,0)
 ;
"RTN","SDWLI",52,0)
 ;PROMPT FOR DISPLAY 'OPEN' WAITING LIST ONLY OR PROMPT FOR BEGINNING AND ENDING DATES
"RTN","SDWLI",53,0)
 ;
"RTN","SDWLI",54,0)
SEL K SDWLDRG S DIR(0)="Y" S DIR("A")="Do You Want to View Only 'OPEN' Wait Lists",DIR("B")="YES"
"RTN","SDWLI",55,0)
 S DIR("?")="'Yes' for 'Open' and these Patient Record have not been dispositioned and 'No' for all Records."
"RTN","SDWLI",56,0)
 W ! D ^DIR S SDWLY=Y W !
"RTN","SDWLI",57,0)
 I X["^" S DUOUT=1 Q
"RTN","SDWLI",58,0)
 I SDWLY=0 D SEL1
"RTN","SDWLI",59,0)
 Q
"RTN","SDWLI",60,0)
SEL1 K DIR,%DT(0) S SDWLDISC="",%DT="AE",%DT("A")="Start with Date Entered: " D ^%DT G SEL:Y<1 S SDWLBDT=Y
"RTN","SDWLI",61,0)
 S %DT(0)=SDWLBDT,%DT("A")="End with Date Entered: " D ^%DT G SEL1:Y<1 S SDWLEDT=Y,SDWLDRG="" K %DT(0),%DT("A")
"RTN","SDWLI",62,0)
 Q
"RTN","SDWLI",63,0)
 ;
"RTN","SDWLI",64,0)
GETFILE ;GET DATA - OPTIONAL DATE RANGE IF SDWLDBT AND SDWLEDT VALID DATE RANGE
"RTN","SDWLI",65,0)
 ;
"RTN","SDWLI",66,0)
 K ^TMP("SDWLI",$J),SDWLDISX S SDWLDA=0,SDWLCNT=0 F  S SDWLDA=$O(^SDWL(409.3,"B",SDWLDFN,SDWLDA)) Q:SDWLDA=""  D
"RTN","SDWLI",67,0)
 .S SDWLDATA=$G(^SDWL(409.3,SDWLDA,0)) I '$D(SDWLDRG),SDWLY,$P(SDWLDATA,U,17)["C" Q
"RTN","SDWLI",68,0)
 .I '$P(SDWLDATA,U,3) Q
"RTN","SDWLI",69,0)
 .N SDWLAPP S SDWLAPP="" I $D(^SDWL(409.3,SDWLDA,"SDAPT")) S SDWLAPP=^("SDAPT") D  ;app data
"RTN","SDWLI",70,0)
 ..S SDWLAPP=SDWLAPP_"~"_$P(SDWLDATA,U,23)
"RTN","SDWLI",71,0)
 .N SDOP,SDOP1 S SDOP="" I $D(^SDWL(409.3,SDWLDA,1)) S SDOP=^(1),SDOP1=$$GET1^DIQ(409.3,SDWLDA_",",29),$P(SDOP,U)=SDOP1
"RTN","SDWLI",72,0)
 .I $D(^SDWL(409.3,SDWLDA,"DIS")) D
"RTN","SDWLI",73,0)
 ..S SDWLDISX=$G(^SDWL(409.3,SDWLDA,"DIS")),SDWLDIS=$P(SDWLDISX,U,3),SDWLDDUZ=$P(SDWLDISX,U,2)
"RTN","SDWLI",74,0)
 ..S SDWLDDT=$P(^SDWL(409.3,SDWLDA,"DIS"),U,1)
"RTN","SDWLI",75,0)
 ..S SDWLDIDT="" I SDWLDDT'="" S SDWLDIDT=$E(SDWLDDT,4,5)_"/"_$E(SDWLDDT,6,7)_"/"_$E(SDWLDDT,2,3)
"RTN","SDWLI",76,0)
 .I $D(^SDWL(409.3,SDWLDA,"DNR")) D
"RTN","SDWLI",77,0)
 ..S SDREM=$G(^SDWL(409.3,SDWLDA,"DNR")) S SDREMD=$P(SDWLDATA,U,14),SDREMU=$P(SDWLDATA,U,15)
"RTN","SDWLI",78,0)
 ..S SDREMDD="" I SDREMD'="" S SDREMDD=$E(SDREMD,4,5)_"/"_$E(SDREMD,6,7)_"/"_$E(SDREMD,2,3)
"RTN","SDWLI",79,0)
 ..S SDREMR=$$GET1^DIQ(409.3,SDWLDA_",",18),SDREMRC=$$GET1^DIQ(409.3,SDWLDA_",",18.1,"I")
"RTN","SDWLI",80,0)
 .S SDWLST=$P(SDWLDATA,U,6),SDWLSP=$P(SDWLDATA,U,7),SDWLSS=$P(SDWLDATA,U,8),SDWLSC=$P(SDWLDATA,U,9),SDWLDT=$P(SDWLDATA,U,2)
"RTN","SDWLI",81,0)
 .S SDWLPROV=$P(SDWLDATA,U,13) I $D(SDWLDRG) D  I SDNOK Q
"RTN","SDWLI",82,0)
 ..S SDNOK=0
"RTN","SDWLI",83,0)
 ..I SDWLDT<SDWLBDT!(SDWLDT>SDWLEDT) S SDNOK=1 Q
"RTN","SDWLI",84,0)
 .;
"RTN","SDWLI",85,0)
 .;IF STATUS IS CLOSED DO NOT DISPLAY RECORD
"RTN","SDWLI",86,0)
 .;
"RTN","SDWLI",87,0)
 .S SDWLCNT=SDWLCNT+1,^TMP("SDWLI",$J,SDWLCNT)=SDWLDATA_"~"_SDWLDA
"RTN","SDWLI",88,0)
 .I $D(SDWLDISX) D 
"RTN","SDWLI",89,0)
 ..S ^TMP("SDWLI",$J,SDWLCNT,"DIS")=SDWLDIS_"^"_SDWLDDUZ_"^"_SDWLDIDT
"RTN","SDWLI",90,0)
 ..I SDWLAPP>0 S ^TMP("SDWLI",$J,SDWLCNT,"SDAPT")=SDWLAPP
"RTN","SDWLI",91,0)
 ..I SDOP'="" S ^TMP("SDWLI",$J,SDWLCNT,"SDOP")=SDOP
"RTN","SDWLI",92,0)
 .I $D(SDREM) D
"RTN","SDWLI",93,0)
 ..S ^TMP("SDWLI",$J,SDWLCNT,"REM")=SDREMR_U_SDREMRC_U_SDREMU_U_SDREMDD
"RTN","SDWLI",94,0)
 .S ^TMP("SDWLI",$J)=SDWLCNT
"RTN","SDWLI",95,0)
 .K SDWLDISX,SDREM
"RTN","SDWLI",96,0)
 Q
"RTN","SDWLI",97,0)
 ;
"RTN","SDWLI",98,0)
DISP ;Display Wait List Data
"RTN","SDWLI",99,0)
 S (SDWLDT,SDWLCNT,SDWLCN)="",SDWLCT=$G(^TMP("SDWLI",$J)) I 'SDWLCT W !!,"No 'OPEN' Wait List Records to Display.",!! K DIR S DIR(0)="E" D ^DIR S DUOUT="" Q
"RTN","SDWLI",100,0)
 F  S SDWLCNT=$O(^TMP("SDWLI",$J,SDWLCNT)) Q:SDWLCNT=""  D  I $D(DUOUT) Q
"RTN","SDWLI",101,0)
 .N SDWLDISX,SDWLR,SDWLCLPT
"RTN","SDWLI",102,0)
 .I $D(^TMP("SDWLI",$J,SDWLCNT,"DIS")) S SDWLDISX=$G(^TMP("SDWLI",$J,SDWLCNT,"DIS"))
"RTN","SDWLI",103,0)
 .I $D(^TMP("SDWLI",$J,SDWLCNT,"REM")) S SDWLR=$G(^TMP("SDWLI",$J,SDWLCNT,"REM")) D
"RTN","SDWLI",104,0)
 ..S SDREMR=$P(SDWLR,U),SDREMRC=$P(SDWLR,U,2),SDREMU=$P(SDWLR,U,3),SDREMDD=$P(SDWLR,U,4)
"RTN","SDWLI",105,0)
 .S X=$G(^TMP("SDWLI",$J,SDWLCNT)),SDWLDA=$P(X,"~",2),SDWLIN=$P(X,U,3),SDWLCL=$P(X,U,4),SDWLTY=$P(X,U,5),SDWLPRI=$P(X,U,11)
"RTN","SDWLI",106,0)
 .S SDWLTYP=$S(SDWLTY=1:$P(X,U,6),SDWLTY=2:$P(X,U,7),SDWLTY=3:$P(X,U,8),SDWLTY=4:$P(X,U,9),1:"")
"RTN","SDWLI",107,0)
 .S SDWLTYN=$S(SDWLTY=1:5,SDWLTY=2:6,SDWLTY=3:7,SDWLTY=4:8),SDWLCOM=$P($P(X,U,18),"~",1)
"RTN","SDWLI",108,0)
 .S SDWLDUZ=$P(X,U,10),SDWLPRV=$P(X,U,12),SDWLPROV=$P(X,U,13),SDWLX=$P(X,"~",3) D
"RTN","SDWLI",109,0)
 ..I $D(SDWLDISX) S SDWLDIS=$P(SDWLDISX,U,1),SDWLDDUZ=$P(SDWLDISX,U,2),SDWLDIDT=$P(SDWLDISX,U,3)
"RTN","SDWLI",110,0)
 .S SDWLDT=$P(X,U,2),YY=$E(SDWLDT,1,3)+1700,YY=$E(YY,3,4),MM=$E(SDWLDT,4,5),DD=$E(SDWLDT,6,7),SDWLDTP=MM_"/"_DD_"/"_YY
"RTN","SDWLI",111,0)
 .S SDWLDTD=$P(X,U,16),YY=$E(SDWLDTD,1,3)+1700,YY=$E(YY,3,4),MM=$E(SDWLDTD,4,5),DD=$E(SDWLDTD,6,7),SDWLDTD=MM_"/"_DD_"/"_YY
"RTN","SDWLI",112,0)
 .;PATCH SD*5.3*394 See Note.
"RTN","SDWLI",113,0)
 .N SDWLSCP
"RTN","SDWLI",114,0)
 .S SDWLSCP=+$P($G(^SDWL(409.3,SDWLDA,"SC")),U,2)
"RTN","SDWLI",115,0)
 .W !,"# ",$J(SDWLCNT,3),!
"RTN","SDWLI",116,0)
 .W !,"Wait List - ",$$EXTERNAL^DILFD(409.3,4,,SDWLTY),?55,"Date Entered - ",SDWLDTP
"RTN","SDWLI",117,0)
 .W !,?15 S X=$$EXTERNAL^DILFD(409.3,SDWLTYN,,SDWLTYP) W X
"RTN","SDWLI",118,0)
 .S SDWLP=0 I SDWLPRI W !,"Priority - ",$$EXTERNAL^DILFD(409.3,10,,SDWLPRI) S SDWLP=1
"RTN","SDWLI",119,0)
 .I $D(SDWLSCP) W !,"Service Connected Priority - ",$$EXTERNAL^DILFD(409.3,15,,SDWLSCP)
"RTN","SDWLI",120,0)
 .W:SDWLP ?15 W:'SDWLP ! W "Institution - ",$$EXTERNAL^DILFD(409.3,2,,SDWLIN)
"RTN","SDWLI",121,0)
 .W !,"Entered by - " S X=$$EXTERNAL^DILFD(409.3,9,,SDWLDUZ) W X
"RTN","SDWLI",122,0)
 .S SDWRB=0 I SDWLPRV W !,"Requested By - ",$$EXTERNAL^DILFD(409.3,11,,SDWLPRV),?55,"Date Desired - ",SDWLDTD
"RTN","SDWLI",123,0)
 .I SDWLPRV=1 W !,"Provider - ",$$EXTERNAL^DILFD(409.3,12,,SDWLPROV)
"RTN","SDWLI",124,0)
 .I $D(SDWLCOM),SDWLCOM'="" W !,"Comments - ",SDWLCOM
"RTN","SDWLI",125,0)
 .I $D(^TMP("SDWLI",$J,SDWLCNT,"SDOP")) N SDOP S SDOP=^("SDOP") W !,"Reopen Reason: ",$P(SDOP,U) D
"RTN","SDWLI",126,0)
 ..I $P(SDOP,U,2)'="" W !,"Reopen comment: ",$P(SDOP,U,2)
"RTN","SDWLI",127,0)
 .I $D(^TMP("SDWLI",$J,SDWLCNT,"REM")) W !,"Non Removal Reason - ",SDREMR,!,"Non Remove Reason entered by - ",$$GET1^DIQ(200,SDREMU_",",.01,"I") D
"RTN","SDWLI",128,0)
 ..I $L(SDREMRC)>0 W !,"Non Removal Comment - ",SDREMRC
"RTN","SDWLI",129,0)
 ..W !,"Non Removal entry date - ",SDREMDD
"RTN","SDWLI",130,0)
 .I $D(^TMP("SDWLI",$J,SDWLCNT,"DIS")) W !,"Disposition - ",$$EXTERNAL^DILFD(409.3,21,,SDWLDIS),?51,"Disposition Date - ",SDWLDIDT D 
"RTN","SDWLI",131,0)
 ..W !,"Dispositioned by - ",$$EXTERNAL^DILFD(409.3,20,,SDWLDDUZ)
"RTN","SDWLI",132,0)
 .I $D(^TMP("SDWLI",$J,SDWLCNT,"SDAPT")) N SDAP S SDAP=^("SDAPT") D
"RTN","SDWLI",133,0)
 ..W !,"Appointment scheduled for " S Y=$P(SDAP,"~",2) D DD^%DT W Y
"RTN","SDWLI",134,0)
 ..W !?3,"Made on: " S Y=+SDAP D DD^%DT W Y,?30,"For clinic: " N SDC S SDC=$P(SDAP,U,2) S SDC=$$GET1^DIQ(44,SDC_",",.01) W SDC
"RTN","SDWLI",135,0)
 ..N SDAIN S SDAIN=$P(SDAP,U,3),SDAIN=$$GET1^DIQ(4,SDAIN_",",.01)
"RTN","SDWLI",136,0)
 ..W !?3,"Appt Institution: ",SDAIN
"RTN","SDWLI",137,0)
 ..N SDCR S SDCR=$P(SDAP,U,4),SDCR=$$GET1^DIQ(40.7,SDCR_",",.01)
"RTN","SDWLI",138,0)
 ..W ?40,"Appt Specialty: ",SDCR
"RTN","SDWLI",139,0)
 ..N SAPS S SAPS=$P(SDAP,U,8),SAPS=$P(SAPS,"~") I SAPS="CC" W !,"Appointment Status: Canceled by Clinic"
"RTN","SDWLI",140,0)
 .S SDWLCLPT=$$GET1^DIQ(409.3,SDWLDA,37,"I")  ; SD*5.3*446
"RTN","SDWLI",141,0)
 .D:SDWLCLPT  ; SD*5.3*446
"RTN","SDWLI",142,0)
 ..W !,"Clinic changed from: ",$$GET1^DIQ(409.3,SDWLCLPT,8)
"RTN","SDWLI",143,0)
 ..W:SDWLIN'=$$GET1^DIQ(409.3,SDWLCLPT,2,"I") " (",$$GET1^DIQ(409.3,SDWLCLPT,2),")"
"RTN","SDWLI",144,0)
 ..Q
"RTN","SDWLI",145,0)
 .; Inter-facility Transfer. SD*5.3*446
"RTN","SDWLI",146,0)
 .I $$GETTRN^SDWLIFT1(SDWLDA,.SDWLINNM,.SDWLSTN) D ENS^%ZISS W !,IOINHI,"In transfer to ",SDWLINNM," (",SDWLSTN,")",IOINORM D KILL^%ZISS
"RTN","SDWLI",147,0)
 .D GETS^DIQ(409.3,SDWLDA,"32;33;34;36;38;39","TMP")
"RTN","SDWLI",148,0)
 .K SDWLIN,SDWLCL,SDWLTY,SDWLPRI,SDWLDUZ,SDWLPRV,SDWLDT,SDWLDTD,SDWLDIS,SDWLDIDT,SDWLTYN,SDWLCOM,SDWLPROV,SDWLDISX,DIR,DIE,DR,SDWLINNM,SDWLSTN
"RTN","SDWLI",149,0)
 .W !,"*****",! K DIR S DIR(0)="E" D ^DIR  D
"RTN","SDWLI",150,0)
 ..I X["^" S DUOUT=1 Q
"RTN","SDWLI",151,0)
 ..I 'Y S DUOUT=1 Q
"RTN","SDWLI",152,0)
 ..;I '$G(SDWLLIST) D HD
"RTN","SDWLI",153,0)
 Q
"RTN","SDWLI",154,0)
HD ;Header
"RTN","SDWLI",155,0)
 W:$D(IOF) @IOF W !!,?80-$L("Wait List - Inquiry")\2,"Wait List - Inquiry ",!
"RTN","SDWLI",156,0)
 ;SD*5.3*327 - Correct undefined.
"RTN","SDWLI",157,0)
 I '$D(SDWLDFN) W !! Q 
"RTN","SDWLI",158,0)
 N DFN S DFN=SDWLDFN D DEM^VADPT
"RTN","SDWLI",159,0)
 W:$D(VADM) !,VADM(1),?40 I $D(VA("PID")) W VA("PID")
"RTN","SDWLI",160,0)
 W !!
"RTN","SDWLI",161,0)
 K DUOUT
"RTN","SDWLI",162,0)
 Q
"RTN","SDWLI",163,0)
END ;
"RTN","SDWLI",164,0)
 K DIR,DIC,DR,DIE,SDWLDFN,DUOUT
"RTN","SDWLI",165,0)
 K SDNOK,SDWLBDT,SDWLCL,SDWLCN,SDWLCNT,SDWLCOM,SDWLCT,SDWLDA,SDWLDATA,SDWLDDT,SDWLDDUZ,SDWLDFN,SDWLDIDT,SDWLDIS,SDWLDISX
"RTN","SDWLI",166,0)
 K SDWLDRG,SDWLDT,SDWLDTD,SDWLDTP,SDWLDUZ,SDLWEDT,SDWLIN,SDLWP,SDWLPRI,SDWLPROV,SDLWPRV,SDWLSC,SDWLSP,SDWLSS,SDLWST,SDWLTY
"RTN","SDWLI",167,0)
 K SDWLTYN,SDSWLTYP,SDLWX,SDWLY,SDWRB,SDWLBDT,SDWLDISC,SDWLERR,SDWLPRON,SDXSCAT,SDWLP,SDWLTYP
"RTN","SDWLI",168,0)
 K SDREMD,SDREMDD,SDREMR,SDREMRC,SDREMU,MM,SDWLEDT,SDWLLIST,SDWLST,SDWLX,VA,X,Y,YY
"RTN","SDWLI",169,0)
 Q
"VER")
8.0^22.0
**END**
**END**
